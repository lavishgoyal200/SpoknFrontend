import"../vendor-webrtc-adapter-DdV2dwuB.js";import{a as Hs}from"../vendor-axios-Dq7h7Pqt.js";import{u as Bs}from"../vendor-ua-parser-js-CeJ9L3zE.js";import{l as Ue}from"../vendor-sdp-transform-qbGOjOZn.js";import{B as E,t as pt,s as j,m as x,d as B,c as ne,o as Le,a as Pe,R as xt,p as Ws,b as kt,e as Ye,f as Qe,g as is,h as qs,i as Js,j as Gs}from"../vendor-rxjs-BlCF6R4j.js";import{M as T,P as fe,t as ze,i as Ks}from"../vendor-@protobuf-ts/runtime-GQ2FS7C6.js";import{R as Ys,S as Qs,s as Q}from"../vendor-@protobuf-ts/runtime-rpc-0IXjfGUg.js";import{T as Ht,a as zs}from"../vendor-@protobuf-ts/twirp-transport-BVWF-r8X.js";const ct={AVAILABLE:"available",DISABLED:"disabled",AUTO_ON:"auto-on"},N={BLOCK_USERS:"block-users",CHANGE_MAX_DURATION:"change-max-duration",CREATE_CALL:"create-call",CREATE_REACTION:"create-reaction",ENABLE_NOISE_CANCELLATION:"enable-noise-cancellation",END_CALL:"end-call",JOIN_BACKSTAGE:"join-backstage",JOIN_CALL:"join-call",JOIN_ENDED_CALL:"join-ended-call",MUTE_USERS:"mute-users",PIN_FOR_EVERYONE:"pin-for-everyone",READ_CALL:"read-call",REMOVE_CALL_MEMBER:"remove-call-member",SCREENSHARE:"screenshare",SEND_AUDIO:"send-audio",SEND_VIDEO:"send-video",START_BROADCAST_CALL:"start-broadcast-call",START_CLOSED_CAPTIONS_CALL:"start-closed-captions-call",START_FRAME_RECORD_CALL:"start-frame-record-call",START_RECORD_CALL:"start-record-call",START_TRANSCRIPTION_CALL:"start-transcription-call",STOP_BROADCAST_CALL:"stop-broadcast-call",STOP_CLOSED_CAPTIONS_CALL:"stop-closed-captions-call",STOP_FRAME_RECORD_CALL:"stop-frame-record-call",STOP_RECORD_CALL:"stop-record-call",STOP_TRANSCRIPTION_CALL:"stop-transcription-call",UPDATE_CALL:"update-call",UPDATE_CALL_MEMBER:"update-call-member",UPDATE_CALL_PERMISSIONS:"update-call-permissions",UPDATE_CALL_SETTINGS:"update-call-settings"};class ns extends Error{constructor({message:t,code:i,status:e,response:n,unrecoverable:a}){super(t),this.name="ErrorFromResponse",this.code=i,this.response=n,this.status=e,this.unrecoverable=a}toJSON(){const t=[["status",this.status],["code",this.code],["unrecoverable",this.unrecoverable]],i=[];for(const[e,n]of t)typeof n<"u"&&n!==null&&i.push(`${e}: ${n}`);return{message:`(${i.join(", ")}) - ${this.message}`,stack:this.stack,name:this.name}}}var Me;(function(s){s[s.NULL_VALUE=0]="NULL_VALUE"})(Me||(Me={}));class Zs extends T{constructor(){super("google.protobuf.Struct",[{no:1,name:"fields",kind:"map",K:9,V:{kind:"message",T:()=>he}}])}internalJsonWrite(t,i){let e={};for(let[n,a]of Object.entries(t.fields))e[n]=he.toJson(a);return e}internalJsonRead(t,i,e){if(!Ks(t))throw new globalThis.Error("Unable to parse message "+this.typeName+" from JSON "+ze(t)+".");e||(e=this.create());for(let[n,a]of globalThis.Object.entries(t))e.fields[n]=he.fromJson(a);return e}}const Fe=new Zs;class Xs extends T{constructor(){super("google.protobuf.Value",[{no:1,name:"null_value",kind:"enum",oneof:"kind",T:()=>["google.protobuf.NullValue",Me]},{no:2,name:"number_value",kind:"scalar",oneof:"kind",T:1},{no:3,name:"string_value",kind:"scalar",oneof:"kind",T:9},{no:4,name:"bool_value",kind:"scalar",oneof:"kind",T:8},{no:5,name:"struct_value",kind:"message",oneof:"kind",T:()=>Fe},{no:6,name:"list_value",kind:"message",oneof:"kind",T:()=>Bt}])}internalJsonWrite(t,i){if(t.kind.oneofKind===void 0)throw new globalThis.Error;switch(t.kind.oneofKind){case void 0:throw new globalThis.Error;case"boolValue":return t.kind.boolValue;case"nullValue":return null;case"numberValue":let e=t.kind.numberValue;if(typeof e=="number"&&!Number.isFinite(e))throw new globalThis.Error;return e;case"stringValue":return t.kind.stringValue;case"listValue":let n=this.fields.find(r=>r.no===6);if((n==null?void 0:n.kind)!=="message")throw new globalThis.Error;return n.T().toJson(t.kind.listValue);case"structValue":let a=this.fields.find(r=>r.no===5);if((a==null?void 0:a.kind)!=="message")throw new globalThis.Error;return a.T().toJson(t.kind.structValue)}}internalJsonRead(t,i,e){switch(e||(e=this.create()),typeof t){case"number":e.kind={oneofKind:"numberValue",numberValue:t};break;case"string":e.kind={oneofKind:"stringValue",stringValue:t};break;case"boolean":e.kind={oneofKind:"boolValue",boolValue:t};break;case"object":t===null?e.kind={oneofKind:"nullValue",nullValue:Me.NULL_VALUE}:globalThis.Array.isArray(t)?e.kind={oneofKind:"listValue",listValue:Bt.fromJson(t)}:e.kind={oneofKind:"structValue",structValue:Fe.fromJson(t)};break;default:throw new globalThis.Error("Unable to parse "+this.typeName+" from JSON "+ze(t))}return e}}const he=new Xs;class ei extends T{constructor(){super("google.protobuf.ListValue",[{no:1,name:"values",kind:"message",repeat:2,T:()=>he}])}internalJsonWrite(t,i){return t.values.map(e=>he.toJson(e))}internalJsonRead(t,i,e){if(!globalThis.Array.isArray(t))throw new globalThis.Error("Unable to parse "+this.typeName+" from JSON "+ze(t));e||(e=this.create());let n=t.map(a=>he.fromJson(a));return e.values.push(...n),e}}const Bt=new ei;class ti extends T{constructor(){super("google.protobuf.Timestamp",[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}])}now(){const t=this.create(),i=Date.now();return t.seconds=fe.from(Math.floor(i/1e3)).toString(),t.nanos=i%1e3*1e6,t}toDate(t){return new Date(fe.from(t.seconds).toNumber()*1e3+Math.ceil(t.nanos/1e6))}fromDate(t){const i=this.create(),e=t.getTime();return i.seconds=fe.from(Math.floor(e/1e3)).toString(),i.nanos=(e%1e3+(e<0&&e%1e3!==0?1e3:0))*1e6,i}internalJsonWrite(t,i){let e=fe.from(t.seconds).toNumber()*1e3;if(e<Date.parse("0001-01-01T00:00:00Z")||e>Date.parse("9999-12-31T23:59:59Z"))throw new Error("Unable to encode Timestamp to JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");if(t.nanos<0)throw new Error("Unable to encode invalid Timestamp to JSON. Nanos must not be negative.");let n="Z";if(t.nanos>0){let a=(t.nanos+1e9).toString().substring(1);a.substring(3)==="000000"?n="."+a.substring(0,3)+"Z":a.substring(6)==="000"?n="."+a.substring(0,6)+"Z":n="."+a+"Z"}return new Date(e).toISOString().replace(".000Z",n)}internalJsonRead(t,i,e){if(typeof t!="string")throw new Error("Unable to parse Timestamp from JSON "+ze(t)+".");let n=t.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("Unable to parse Timestamp from JSON. Invalid format.");let a=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(a))throw new Error("Unable to parse Timestamp from JSON. Invalid value.");if(a<Date.parse("0001-01-01T00:00:00Z")||a>Date.parse("9999-12-31T23:59:59Z"))throw new globalThis.Error("Unable to parse Timestamp from JSON. Must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive.");return e||(e=this.create()),e.seconds=fe.from(a/1e3).toString(),e.nanos=0,n[7]&&(e.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),e}}const ke=new ti;var L;(function(s){s[s.PUBLISHER_UNSPECIFIED=0]="PUBLISHER_UNSPECIFIED",s[s.SUBSCRIBER=1]="SUBSCRIBER"})(L||(L={}));var we;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.POOR=1]="POOR",s[s.GOOD=2]="GOOD",s[s.EXCELLENT=3]="EXCELLENT"})(we||(we={}));var Z;(function(s){s[s.LOW_UNSPECIFIED=0]="LOW_UNSPECIFIED",s[s.MID=1]="MID",s[s.HIGH=2]="HIGH",s[s.OFF=3]="OFF"})(Z||(Z={}));var b;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.AUDIO=1]="AUDIO",s[s.VIDEO=2]="VIDEO",s[s.SCREEN_SHARE=3]="SCREEN_SHARE",s[s.SCREEN_SHARE_AUDIO=4]="SCREEN_SHARE_AUDIO"})(b||(b={}));var ae;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.PUBLISH_TRACK_NOT_FOUND=100]="PUBLISH_TRACK_NOT_FOUND",s[s.PUBLISH_TRACKS_MISMATCH=101]="PUBLISH_TRACKS_MISMATCH",s[s.PUBLISH_TRACK_OUT_OF_ORDER=102]="PUBLISH_TRACK_OUT_OF_ORDER",s[s.PUBLISH_TRACK_VIDEO_LAYER_NOT_FOUND=103]="PUBLISH_TRACK_VIDEO_LAYER_NOT_FOUND",s[s.LIVE_ENDED=104]="LIVE_ENDED",s[s.PARTICIPANT_NOT_FOUND=200]="PARTICIPANT_NOT_FOUND",s[s.PARTICIPANT_MIGRATING_OUT=201]="PARTICIPANT_MIGRATING_OUT",s[s.PARTICIPANT_MIGRATION_FAILED=202]="PARTICIPANT_MIGRATION_FAILED",s[s.PARTICIPANT_MIGRATING=203]="PARTICIPANT_MIGRATING",s[s.PARTICIPANT_RECONNECT_FAILED=204]="PARTICIPANT_RECONNECT_FAILED",s[s.PARTICIPANT_MEDIA_TRANSPORT_FAILURE=205]="PARTICIPANT_MEDIA_TRANSPORT_FAILURE",s[s.PARTICIPANT_SIGNAL_LOST=206]="PARTICIPANT_SIGNAL_LOST",s[s.CALL_NOT_FOUND=300]="CALL_NOT_FOUND",s[s.REQUEST_VALIDATION_FAILED=400]="REQUEST_VALIDATION_FAILED",s[s.UNAUTHENTICATED=401]="UNAUTHENTICATED",s[s.PERMISSION_DENIED=403]="PERMISSION_DENIED",s[s.TOO_MANY_REQUESTS=429]="TOO_MANY_REQUESTS",s[s.INTERNAL_SERVER_ERROR=500]="INTERNAL_SERVER_ERROR",s[s.SFU_SHUTTING_DOWN=600]="SFU_SHUTTING_DOWN",s[s.SFU_FULL=700]="SFU_FULL"})(ae||(ae={}));var ee;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.REACT=1]="REACT",s[s.ANGULAR=2]="ANGULAR",s[s.ANDROID=3]="ANDROID",s[s.IOS=4]="IOS",s[s.FLUTTER=5]="FLUTTER",s[s.REACT_NATIVE=6]="REACT_NATIVE",s[s.UNITY=7]="UNITY",s[s.GO=8]="GO",s[s.PLAIN_JAVASCRIPT=9]="PLAIN_JAVASCRIPT"})(ee||(ee={}));var ve;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.USER_MUTED=1]="USER_MUTED",s[s.PERMISSION_REVOKED=2]="PERMISSION_REVOKED",s[s.MODERATION=3]="MODERATION"})(ve||(ve={}));var je;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.SHUTTING_DOWN=1]="SHUTTING_DOWN",s[s.REBALANCE=2]="REBALANCE"})(je||(je={}));var de;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.ENDED=1]="ENDED",s[s.LIVE_ENDED=2]="LIVE_ENDED",s[s.KICKED=3]="KICKED",s[s.SESSION_ENDED=4]="SESSION_ENDED"})(de||(de={}));var w;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.DISCONNECT=1]="DISCONNECT",s[s.FAST=2]="FAST",s[s.REJOIN=3]="REJOIN",s[s.MIGRATE=4]="MIGRATE"})(w||(w={}));var Ve;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.NONE=1]="NONE",s[s.LIGHT=2]="LIGHT",s[s.MODERATE=3]="MODERATE",s[s.SEVERE=4]="SEVERE",s[s.CRITICAL=5]="CRITICAL",s[s.EMERGENCY=6]="EMERGENCY",s[s.SHUTDOWN=7]="SHUTDOWN"})(Ve||(Ve={}));var xe;(function(s){s[s.UNSPECIFIED=0]="UNSPECIFIED",s[s.NOMINAL=1]="NOMINAL",s[s.FAIR=2]="FAIR",s[s.SERIOUS=3]="SERIOUS",s[s.CRITICAL=4]="CRITICAL"})(xe||(xe={}));class si extends T{constructor(){super("stream.video.sfu.models.CallState",[{no:1,name:"participants",kind:"message",repeat:2,T:()=>re},{no:2,name:"started_at",kind:"message",T:()=>ke},{no:3,name:"participant_count",kind:"message",T:()=>wt},{no:4,name:"pins",kind:"message",repeat:2,T:()=>vt}])}}const as=new si;class ii extends T{constructor(){super("stream.video.sfu.models.ParticipantCount",[{no:1,name:"total",kind:"scalar",T:13},{no:2,name:"anonymous",kind:"scalar",T:13}])}}const wt=new ii;class ni extends T{constructor(){super("stream.video.sfu.models.Pin",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9}])}}const vt=new ni;class ai extends T{constructor(){super("stream.video.sfu.models.Participant",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"published_tracks",kind:"enum",repeat:1,T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:4,name:"joined_at",kind:"message",T:()=>ke},{no:5,name:"track_lookup_prefix",kind:"scalar",T:9},{no:6,name:"connection_quality",kind:"enum",T:()=>["stream.video.sfu.models.ConnectionQuality",we,"CONNECTION_QUALITY_"]},{no:7,name:"is_speaking",kind:"scalar",T:8},{no:8,name:"is_dominant_speaker",kind:"scalar",T:8},{no:9,name:"audio_level",kind:"scalar",T:2},{no:10,name:"name",kind:"scalar",T:9},{no:11,name:"image",kind:"scalar",T:9},{no:12,name:"custom",kind:"message",T:()=>Fe},{no:13,name:"roles",kind:"scalar",repeat:2,T:9}])}}const re=new ai;class ri extends T{constructor(){super("stream.video.sfu.models.StreamQuality",[{no:1,name:"video_quality",kind:"enum",T:()=>["stream.video.sfu.models.VideoQuality",Z,"VIDEO_QUALITY_"]},{no:2,name:"user_id",kind:"scalar",T:9}])}}const oi=new ri;class ci extends T{constructor(){super("stream.video.sfu.models.VideoDimension",[{no:1,name:"width",kind:"scalar",T:13},{no:2,name:"height",kind:"scalar",T:13}])}}const _e=new ci;class li extends T{constructor(){super("stream.video.sfu.models.VideoLayer",[{no:1,name:"rid",kind:"scalar",T:9},{no:2,name:"video_dimension",kind:"message",T:()=>_e},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"fps",kind:"scalar",T:13},{no:6,name:"quality",kind:"enum",T:()=>["stream.video.sfu.models.VideoQuality",Z,"VIDEO_QUALITY_"]}])}}const rs=new li;class hi extends T{constructor(){super("stream.video.sfu.models.SubscribeOption",[{no:1,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:2,name:"codecs",kind:"message",repeat:2,T:()=>Y}])}}const Et=new hi;class di extends T{constructor(){super("stream.video.sfu.models.PublishOption",[{no:1,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:2,name:"codec",kind:"message",T:()=>Y},{no:3,name:"bitrate",kind:"scalar",T:5},{no:4,name:"fps",kind:"scalar",T:5},{no:5,name:"max_spatial_layers",kind:"scalar",T:5},{no:6,name:"max_temporal_layers",kind:"scalar",T:5},{no:7,name:"video_dimension",kind:"message",T:()=>_e},{no:8,name:"id",kind:"scalar",T:5},{no:9,name:"use_single_layer",kind:"scalar",T:8}])}}const ue=new di;class ui extends T{constructor(){super("stream.video.sfu.models.Codec",[{no:16,name:"payload_type",kind:"scalar",T:13},{no:10,name:"name",kind:"scalar",T:9},{no:14,name:"clock_rate",kind:"scalar",T:13},{no:15,name:"encoding_parameters",kind:"scalar",T:9},{no:12,name:"fmtp",kind:"scalar",T:9}])}}const Y=new ui;let pi=class extends T{constructor(){super("stream.video.sfu.models.ICETrickle",[{no:1,name:"peer_type",kind:"enum",T:()=>["stream.video.sfu.models.PeerType",L,"PEER_TYPE_"]},{no:2,name:"ice_candidate",kind:"scalar",T:9},{no:3,name:"session_id",kind:"scalar",T:9}])}};const It=new pi;class mi extends T{constructor(){super("stream.video.sfu.models.TrackInfo",[{no:1,name:"track_id",kind:"scalar",T:9},{no:2,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:5,name:"layers",kind:"message",repeat:2,T:()=>rs},{no:6,name:"mid",kind:"scalar",T:9},{no:7,name:"dtx",kind:"scalar",T:8},{no:8,name:"stereo",kind:"scalar",T:8},{no:9,name:"red",kind:"scalar",T:8},{no:10,name:"muted",kind:"scalar",T:8},{no:11,name:"codec",kind:"message",T:()=>Y},{no:12,name:"publish_option_id",kind:"scalar",T:5}])}}const Ze=new mi;let gi=class extends T{constructor(){super("stream.video.sfu.models.Error",[{no:1,name:"code",kind:"enum",T:()=>["stream.video.sfu.models.ErrorCode",ae,"ERROR_CODE_"]},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"should_retry",kind:"scalar",T:8}])}};const G=new gi;class fi extends T{constructor(){super("stream.video.sfu.models.ClientDetails",[{no:1,name:"sdk",kind:"message",T:()=>cs},{no:2,name:"os",kind:"message",T:()=>ls},{no:3,name:"browser",kind:"message",T:()=>hs},{no:4,name:"device",kind:"message",T:()=>us}])}}const os=new fi;class Si extends T{constructor(){super("stream.video.sfu.models.Sdk",[{no:1,name:"type",kind:"enum",T:()=>["stream.video.sfu.models.SdkType",ee,"SDK_TYPE_"]},{no:2,name:"major",kind:"scalar",T:9},{no:3,name:"minor",kind:"scalar",T:9},{no:4,name:"patch",kind:"scalar",T:9}])}}const cs=new Si;class bi extends T{constructor(){super("stream.video.sfu.models.OS",[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"architecture",kind:"scalar",T:9}])}}const ls=new bi;class Ti extends T{constructor(){super("stream.video.sfu.models.Browser",[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"version",kind:"scalar",T:9}])}}const hs=new Ti;class Ci extends T{constructor(){super("stream.video.sfu.models.RTMPIngress",[{no:1,name:"width",kind:"scalar",T:13},{no:2,name:"height",kind:"scalar",T:13},{no:3,name:"frame_rate",kind:"scalar",T:1},{no:4,name:"software",kind:"scalar",T:9},{no:5,name:"version",kind:"scalar",T:9},{no:6,name:"encoder",kind:"scalar",T:9},{no:7,name:"remote_addr",kind:"scalar",T:9}])}}const ds=new Ci;class yi extends T{constructor(){super("stream.video.sfu.models.Device",[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"version",kind:"scalar",T:9}])}}const us=new yi;class ki extends T{constructor(){super("stream.video.sfu.models.Call",[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:9},{no:3,name:"created_by_user_id",kind:"scalar",T:9},{no:4,name:"host_user_id",kind:"scalar",T:9},{no:5,name:"custom",kind:"message",T:()=>Fe},{no:6,name:"created_at",kind:"message",T:()=>ke},{no:7,name:"updated_at",kind:"message",T:()=>ke}])}}const wi=new ki;class vi extends T{constructor(){super("stream.video.sfu.models.CallGrants",[{no:1,name:"can_publish_audio",kind:"scalar",T:8},{no:2,name:"can_publish_video",kind:"scalar",T:8},{no:3,name:"can_screenshare",kind:"scalar",T:8}])}}const ps=new vi;class Ei extends T{constructor(){super("stream.video.sfu.models.InputDevices",[{no:1,name:"available_devices",kind:"scalar",repeat:2,T:9},{no:2,name:"current_device",kind:"scalar",T:9},{no:3,name:"is_permitted",kind:"scalar",T:8}])}}const mt=new Ei;class Ii extends T{constructor(){super("stream.video.sfu.models.AndroidState",[{no:1,name:"thermal_state",kind:"enum",T:()=>["stream.video.sfu.models.AndroidThermalState",Ve,"ANDROID_THERMAL_STATE_"]},{no:2,name:"is_power_saver_mode",kind:"scalar",T:8}])}}const ms=new Ii;class _i extends T{constructor(){super("stream.video.sfu.models.AppleState",[{no:1,name:"thermal_state",kind:"enum",T:()=>["stream.video.sfu.models.AppleThermalState",xe,"APPLE_THERMAL_STATE_"]},{no:2,name:"is_low_power_mode_enabled",kind:"scalar",T:8}])}}const gs=new _i;class Ri extends T{constructor(){super("stream.video.sfu.models.PerformanceStats",[{no:1,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:2,name:"codec",kind:"message",T:()=>Y},{no:3,name:"avg_frame_time_ms",kind:"scalar",T:2},{no:4,name:"avg_fps",kind:"scalar",T:2},{no:5,name:"video_dimension",kind:"message",T:()=>_e},{no:6,name:"target_bitrate",kind:"scalar",T:5}])}}const He=new Ri;var Xo=Object.freeze({__proto__:null,AndroidState:ms,get AndroidThermalState(){return Ve},AppleState:gs,get AppleThermalState(){return xe},Browser:hs,Call:wi,get CallEndedReason(){return de},CallGrants:ps,CallState:as,ClientDetails:os,Codec:Y,get ConnectionQuality(){return we},Device:us,Error:G,get ErrorCode(){return ae},get GoAwayReason(){return je},ICETrickle:It,InputDevices:mt,OS:ls,Participant:re,ParticipantCount:wt,get PeerType(){return L},PerformanceStats:He,Pin:vt,PublishOption:ue,RTMPIngress:ds,Sdk:cs,get SdkType(){return ee},StreamQuality:oi,SubscribeOption:Et,TrackInfo:Ze,get TrackType(){return b},get TrackUnpublishReason(){return ve},VideoDimension:_e,VideoLayer:rs,get VideoQuality(){return Z},get WebsocketReconnectStrategy(){return w}});class Pi extends T{constructor(){super("stream.video.sfu.signal.StartNoiseCancellationRequest",[{no:1,name:"session_id",kind:"scalar",T:9}])}}const Di=new Pi;class Oi extends T{constructor(){super("stream.video.sfu.signal.StartNoiseCancellationResponse",[{no:1,name:"error",kind:"message",T:()=>G}])}}const Ai=new Oi;class Ni extends T{constructor(){super("stream.video.sfu.signal.StopNoiseCancellationRequest",[{no:1,name:"session_id",kind:"scalar",T:9}])}}const Ui=new Ni;class Li extends T{constructor(){super("stream.video.sfu.signal.StopNoiseCancellationResponse",[{no:1,name:"error",kind:"message",T:()=>G}])}}const $i=new Li;class Mi extends T{constructor(){super("stream.video.sfu.signal.Reconnection",[{no:1,name:"time_seconds",kind:"scalar",T:2},{no:2,name:"strategy",kind:"enum",T:()=>["stream.video.sfu.models.WebsocketReconnectStrategy",w,"WEBSOCKET_RECONNECT_STRATEGY_"]}])}}const Fi=new Mi;class ji extends T{constructor(){super("stream.video.sfu.signal.Telemetry",[{no:1,name:"connection_time_seconds",kind:"scalar",oneof:"data",T:2},{no:2,name:"reconnection",kind:"message",oneof:"data",T:()=>Fi}])}}const Vi=new ji;class xi extends T{constructor(){super("stream.video.sfu.signal.SendStatsRequest",[{no:1,name:"session_id",kind:"scalar",T:9},{no:2,name:"subscriber_stats",kind:"scalar",T:9},{no:3,name:"publisher_stats",kind:"scalar",T:9},{no:4,name:"webrtc_version",kind:"scalar",T:9},{no:5,name:"sdk",kind:"scalar",T:9},{no:6,name:"sdk_version",kind:"scalar",T:9},{no:7,name:"audio_devices",kind:"message",T:()=>mt},{no:8,name:"video_devices",kind:"message",T:()=>mt},{no:9,name:"android",kind:"message",oneof:"deviceState",T:()=>ms},{no:10,name:"apple",kind:"message",oneof:"deviceState",T:()=>gs},{no:11,name:"telemetry",kind:"message",T:()=>Vi},{no:12,name:"rtmp",kind:"message",T:()=>ds},{no:13,name:"subscriber_rtc_stats",kind:"scalar",T:9},{no:14,name:"publisher_rtc_stats",kind:"scalar",T:9},{no:15,name:"rtc_stats",kind:"scalar",T:9},{no:16,name:"encode_stats",kind:"message",repeat:2,T:()=>He},{no:17,name:"decode_stats",kind:"message",repeat:2,T:()=>He},{no:18,name:"unified_session_id",kind:"scalar",T:9}])}}const Hi=new xi;class Bi extends T{constructor(){super("stream.video.sfu.signal.SendStatsResponse",[{no:1,name:"error",kind:"message",T:()=>G}])}}const Wi=new Bi;class qi extends T{constructor(){super("stream.video.sfu.signal.ICERestartRequest",[{no:1,name:"session_id",kind:"scalar",T:9},{no:2,name:"peer_type",kind:"enum",T:()=>["stream.video.sfu.models.PeerType",L,"PEER_TYPE_"]}])}}const Ji=new qi;class Gi extends T{constructor(){super("stream.video.sfu.signal.ICERestartResponse",[{no:1,name:"error",kind:"message",T:()=>G}])}}const Ki=new Gi;class Yi extends T{constructor(){super("stream.video.sfu.signal.UpdateMuteStatesRequest",[{no:1,name:"session_id",kind:"scalar",T:9},{no:3,name:"mute_states",kind:"message",repeat:2,T:()=>en}])}}const Qi=new Yi;class zi extends T{constructor(){super("stream.video.sfu.signal.UpdateMuteStatesResponse",[{no:4,name:"error",kind:"message",T:()=>G}])}}const Zi=new zi;class Xi extends T{constructor(){super("stream.video.sfu.signal.TrackMuteState",[{no:1,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:2,name:"muted",kind:"scalar",T:8}])}}const en=new Xi;class tn extends T{constructor(){super("stream.video.sfu.signal.AudioMuteChanged",[{no:1,name:"muted",kind:"scalar",T:8}])}}new tn;class sn extends T{constructor(){super("stream.video.sfu.signal.VideoMuteChanged",[{no:2,name:"muted",kind:"scalar",T:8}])}}new sn;class nn extends T{constructor(){super("stream.video.sfu.signal.UpdateSubscriptionsRequest",[{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"tracks",kind:"message",repeat:2,T:()=>_t}])}}const an=new nn;class rn extends T{constructor(){super("stream.video.sfu.signal.UpdateSubscriptionsResponse",[{no:4,name:"error",kind:"message",T:()=>G}])}}const on=new rn;class cn extends T{constructor(){super("stream.video.sfu.signal.TrackSubscriptionDetails",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:4,name:"dimension",kind:"message",T:()=>_e}])}}const _t=new cn;class ln extends T{constructor(){super("stream.video.sfu.signal.SendAnswerRequest",[{no:1,name:"peer_type",kind:"enum",T:()=>["stream.video.sfu.models.PeerType",L,"PEER_TYPE_"]},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"session_id",kind:"scalar",T:9}])}}const hn=new ln;class dn extends T{constructor(){super("stream.video.sfu.signal.SendAnswerResponse",[{no:4,name:"error",kind:"message",T:()=>G}])}}const un=new dn;class pn extends T{constructor(){super("stream.video.sfu.signal.ICETrickleResponse",[{no:4,name:"error",kind:"message",T:()=>G}])}}const mn=new pn;class gn extends T{constructor(){super("stream.video.sfu.signal.SetPublisherRequest",[{no:1,name:"sdp",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"tracks",kind:"message",repeat:2,T:()=>Ze}])}}const fn=new gn;class Sn extends T{constructor(){super("stream.video.sfu.signal.SetPublisherResponse",[{no:1,name:"sdp",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"ice_restart",kind:"scalar",T:8},{no:4,name:"error",kind:"message",T:()=>G}])}}const bn=new Sn,lt=new Qs("stream.video.sfu.signal.SignalServer",[{name:"SetPublisher",options:{},I:fn,O:bn},{name:"SendAnswer",options:{},I:hn,O:un},{name:"IceTrickle",options:{},I:It,O:mn},{name:"UpdateSubscriptions",options:{},I:an,O:on},{name:"UpdateMuteStates",options:{},I:Qi,O:Zi},{name:"IceRestart",options:{},I:Ji,O:Ki},{name:"SendStats",options:{},I:Hi,O:Wi},{name:"StartNoiseCancellation",options:{},I:Di,O:Ai},{name:"StopNoiseCancellation",options:{},I:Ui,O:$i}]);class Tn extends T{constructor(){super("stream.video.sfu.event.SfuEvent",[{no:1,name:"subscriber_offer",kind:"message",oneof:"eventPayload",T:()=>ia},{no:2,name:"publisher_answer",kind:"message",oneof:"eventPayload",T:()=>aa},{no:3,name:"connection_quality_changed",kind:"message",oneof:"eventPayload",T:()=>oa},{no:4,name:"audio_level_changed",kind:"message",oneof:"eventPayload",T:()=>ga},{no:5,name:"ice_trickle",kind:"message",oneof:"eventPayload",T:()=>It},{no:6,name:"change_publish_quality",kind:"message",oneof:"eventPayload",T:()=>wa},{no:10,name:"participant_joined",kind:"message",oneof:"eventPayload",T:()=>zn},{no:11,name:"participant_left",kind:"message",oneof:"eventPayload",T:()=>Xn},{no:12,name:"dominant_speaker_changed",kind:"message",oneof:"eventPayload",T:()=>da},{no:13,name:"join_response",kind:"message",oneof:"eventPayload",T:()=>Yn},{no:14,name:"health_check_response",kind:"message",oneof:"eventPayload",T:()=>Fn},{no:16,name:"track_published",kind:"message",oneof:"eventPayload",T:()=>Vn},{no:17,name:"track_unpublished",kind:"message",oneof:"eventPayload",T:()=>Hn},{no:18,name:"error",kind:"message",oneof:"eventPayload",T:()=>Rn},{no:19,name:"call_grants_updated",kind:"message",oneof:"eventPayload",T:()=>Ea},{no:20,name:"go_away",kind:"message",oneof:"eventPayload",T:()=>_a},{no:21,name:"ice_restart",kind:"message",oneof:"eventPayload",T:()=>On},{no:22,name:"pins_updated",kind:"message",oneof:"eventPayload",T:()=>In},{no:23,name:"call_ended",kind:"message",oneof:"eventPayload",T:()=>Pa},{no:24,name:"participant_updated",kind:"message",oneof:"eventPayload",T:()=>ta},{no:25,name:"participant_migration_complete",kind:"message",oneof:"eventPayload",T:()=>vn},{no:27,name:"change_publish_options",kind:"message",oneof:"eventPayload",T:()=>yn}])}}const Wt=new Tn;class Cn extends T{constructor(){super("stream.video.sfu.event.ChangePublishOptions",[{no:1,name:"publish_options",kind:"message",repeat:2,T:()=>ue},{no:2,name:"reason",kind:"scalar",T:9}])}}const yn=new Cn;class kn extends T{constructor(){super("stream.video.sfu.event.ChangePublishOptionsComplete",[])}}new kn;class wn extends T{constructor(){super("stream.video.sfu.event.ParticipantMigrationComplete",[])}}const vn=new wn;class En extends T{constructor(){super("stream.video.sfu.event.PinsChanged",[{no:1,name:"pins",kind:"message",repeat:2,T:()=>vt}])}}const In=new En;class _n extends T{constructor(){super("stream.video.sfu.event.Error",[{no:4,name:"error",kind:"message",T:()=>G},{no:5,name:"reconnect_strategy",kind:"enum",T:()=>["stream.video.sfu.models.WebsocketReconnectStrategy",w,"WEBSOCKET_RECONNECT_STRATEGY_"]}])}}const Rn=new _n;class Pn extends T{constructor(){super("stream.video.sfu.event.ICETrickle",[{no:1,name:"peer_type",kind:"enum",T:()=>["stream.video.sfu.models.PeerType",L,"PEER_TYPE_"]},{no:2,name:"ice_candidate",kind:"scalar",T:9}])}}new Pn;class Dn extends T{constructor(){super("stream.video.sfu.event.ICERestart",[{no:1,name:"peer_type",kind:"enum",T:()=>["stream.video.sfu.models.PeerType",L,"PEER_TYPE_"]}])}}const On=new Dn;class An extends T{constructor(){super("stream.video.sfu.event.SfuRequest",[{no:1,name:"join_request",kind:"message",oneof:"requestPayload",T:()=>fs},{no:2,name:"health_check_request",kind:"message",oneof:"requestPayload",T:()=>$n},{no:3,name:"leave_call_request",kind:"message",oneof:"requestPayload",T:()=>Un}])}}const Se=new An;class Nn extends T{constructor(){super("stream.video.sfu.event.LeaveCallRequest",[{no:1,name:"session_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9}])}}const Un=new Nn;class Ln extends T{constructor(){super("stream.video.sfu.event.HealthCheckRequest",[])}}const $n=new Ln;class Mn extends T{constructor(){super("stream.video.sfu.event.HealthCheckResponse",[{no:1,name:"participant_count",kind:"message",T:()=>wt}])}}const Fn=new Mn;class jn extends T{constructor(){super("stream.video.sfu.event.TrackPublished",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:4,name:"participant",kind:"message",T:()=>re}])}}const Vn=new jn;class xn extends T{constructor(){super("stream.video.sfu.event.TrackUnpublished",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:4,name:"cause",kind:"enum",T:()=>["stream.video.sfu.models.TrackUnpublishReason",ve,"TRACK_UNPUBLISH_REASON_"]},{no:5,name:"participant",kind:"message",T:()=>re}])}}const Hn=new xn;class Bn extends T{constructor(){super("stream.video.sfu.event.JoinRequest",[{no:1,name:"token",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"subscriber_sdp",kind:"scalar",T:9},{no:8,name:"publisher_sdp",kind:"scalar",T:9},{no:4,name:"client_details",kind:"message",T:()=>os},{no:5,name:"migration",kind:"message",T:()=>Gn},{no:6,name:"fast_reconnect",kind:"scalar",T:8},{no:7,name:"reconnect_details",kind:"message",T:()=>qn},{no:9,name:"preferred_publish_options",kind:"message",repeat:2,T:()=>ue},{no:10,name:"preferred_subscribe_options",kind:"message",repeat:2,T:()=>Et}])}}const fs=new Bn;class Wn extends T{constructor(){super("stream.video.sfu.event.ReconnectDetails",[{no:1,name:"strategy",kind:"enum",T:()=>["stream.video.sfu.models.WebsocketReconnectStrategy",w,"WEBSOCKET_RECONNECT_STRATEGY_"]},{no:3,name:"announced_tracks",kind:"message",repeat:2,T:()=>Ze},{no:4,name:"subscriptions",kind:"message",repeat:2,T:()=>_t},{no:5,name:"reconnect_attempt",kind:"scalar",T:13},{no:6,name:"from_sfu_id",kind:"scalar",T:9},{no:7,name:"previous_session_id",kind:"scalar",T:9},{no:8,name:"reason",kind:"scalar",T:9}])}}const qn=new Wn;class Jn extends T{constructor(){super("stream.video.sfu.event.Migration",[{no:1,name:"from_sfu_id",kind:"scalar",T:9},{no:2,name:"announced_tracks",kind:"message",repeat:2,T:()=>Ze},{no:3,name:"subscriptions",kind:"message",repeat:2,T:()=>_t}])}}const Gn=new Jn;class Kn extends T{constructor(){super("stream.video.sfu.event.JoinResponse",[{no:1,name:"call_state",kind:"message",T:()=>as},{no:2,name:"reconnected",kind:"scalar",T:8},{no:3,name:"fast_reconnect_deadline_seconds",kind:"scalar",T:5},{no:4,name:"publish_options",kind:"message",repeat:2,T:()=>ue}])}}const Yn=new Kn;class Qn extends T{constructor(){super("stream.video.sfu.event.ParticipantJoined",[{no:1,name:"call_cid",kind:"scalar",T:9},{no:2,name:"participant",kind:"message",T:()=>re}])}}const zn=new Qn;class Zn extends T{constructor(){super("stream.video.sfu.event.ParticipantLeft",[{no:1,name:"call_cid",kind:"scalar",T:9},{no:2,name:"participant",kind:"message",T:()=>re}])}}const Xn=new Zn;class ea extends T{constructor(){super("stream.video.sfu.event.ParticipantUpdated",[{no:1,name:"call_cid",kind:"scalar",T:9},{no:2,name:"participant",kind:"message",T:()=>re}])}}const ta=new ea;class sa extends T{constructor(){super("stream.video.sfu.event.SubscriberOffer",[{no:1,name:"ice_restart",kind:"scalar",T:8},{no:2,name:"sdp",kind:"scalar",T:9}])}}const ia=new sa;class na extends T{constructor(){super("stream.video.sfu.event.PublisherAnswer",[{no:1,name:"sdp",kind:"scalar",T:9}])}}const aa=new na;class ra extends T{constructor(){super("stream.video.sfu.event.ConnectionQualityChanged",[{no:1,name:"connection_quality_updates",kind:"message",repeat:2,T:()=>la}])}}const oa=new ra;class ca extends T{constructor(){super("stream.video.sfu.event.ConnectionQualityInfo",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"connection_quality",kind:"enum",T:()=>["stream.video.sfu.models.ConnectionQuality",we,"CONNECTION_QUALITY_"]}])}}const la=new ca;class ha extends T{constructor(){super("stream.video.sfu.event.DominantSpeakerChanged",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9}])}}const da=new ha;class ua extends T{constructor(){super("stream.video.sfu.event.AudioLevel",[{no:1,name:"user_id",kind:"scalar",T:9},{no:2,name:"session_id",kind:"scalar",T:9},{no:3,name:"level",kind:"scalar",T:2},{no:4,name:"is_speaking",kind:"scalar",T:8}])}}const pa=new ua;class ma extends T{constructor(){super("stream.video.sfu.event.AudioLevelChanged",[{no:1,name:"audio_levels",kind:"message",repeat:2,T:()=>pa}])}}const ga=new ma;class fa extends T{constructor(){super("stream.video.sfu.event.AudioSender",[{no:2,name:"codec",kind:"message",T:()=>Y},{no:3,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:4,name:"publish_option_id",kind:"scalar",T:5}])}}const Sa=new fa;class ba extends T{constructor(){super("stream.video.sfu.event.VideoLayerSetting",[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"active",kind:"scalar",T:8},{no:3,name:"max_bitrate",kind:"scalar",T:5},{no:4,name:"scale_resolution_down_by",kind:"scalar",T:2},{no:6,name:"codec",kind:"message",T:()=>Y},{no:7,name:"max_framerate",kind:"scalar",T:13},{no:8,name:"scalability_mode",kind:"scalar",T:9}])}}const Ta=new ba;class Ca extends T{constructor(){super("stream.video.sfu.event.VideoSender",[{no:2,name:"codec",kind:"message",T:()=>Y},{no:3,name:"layers",kind:"message",repeat:2,T:()=>Ta},{no:4,name:"track_type",kind:"enum",T:()=>["stream.video.sfu.models.TrackType",b,"TRACK_TYPE_"]},{no:5,name:"publish_option_id",kind:"scalar",T:5}])}}const ya=new Ca;class ka extends T{constructor(){super("stream.video.sfu.event.ChangePublishQuality",[{no:1,name:"audio_senders",kind:"message",repeat:2,T:()=>Sa},{no:2,name:"video_senders",kind:"message",repeat:2,T:()=>ya}])}}const wa=new ka;class va extends T{constructor(){super("stream.video.sfu.event.CallGrantsUpdated",[{no:1,name:"current_grants",kind:"message",T:()=>ps},{no:2,name:"message",kind:"scalar",T:9}])}}const Ea=new va;class Ia extends T{constructor(){super("stream.video.sfu.event.GoAway",[{no:1,name:"reason",kind:"enum",T:()=>["stream.video.sfu.models.GoAwayReason",je,"GO_AWAY_REASON_"]}])}}const _a=new Ia;class Ra extends T{constructor(){super("stream.video.sfu.event.CallEnded",[{no:1,name:"reason",kind:"enum",T:()=>["stream.video.sfu.models.CallEndedReason",de,"CALL_ENDED_REASON_"]}])}}const Pa=new Ra;var D;(function(s){s.UNKNOWN="UNKNOWN",s.VISIBLE="VISIBLE",s.INVISIBLE="INVISIBLE"})(D||(D={}));var K;(function(s){s[s.IMMEDIATE=20]="IMMEDIATE",s[s.FAST=100]="FAST",s[s.MEDIUM=600]="MEDIUM",s[s.SLOW=1200]="SLOW"})(K||(K={}));class Da{constructor(t){this._transport=t,this.typeName=lt.typeName,this.methods=lt.methods,this.options=lt.options}setPublisher(t,i){const e=this.methods[0],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}sendAnswer(t,i){const e=this.methods[1],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}iceTrickle(t,i){const e=this.methods[2],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}updateSubscriptions(t,i){const e=this.methods[3],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}updateMuteStates(t,i){const e=this.methods[4],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}iceRestart(t,i){const e=this.methods[5],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}sendStats(t,i){const e=this.methods[6],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}startNoiseCancellation(t,i){const e=this.methods[7],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}stopNoiseCancellation(t,i){const e=this.methods[8],n=this._transport.mergeOptions(i);return Q("unary",this._transport,e,n,t)}}const Oa={baseUrl:"",sendJson:!0,timeout:5*1e3,jsonOptions:{ignoreUnknownFields:!0}},Aa=s=>({interceptUnary(t,i,e,n){return n.meta={...n.meta,...s},t(i,e,n)}}),Na=(s,t)=>({interceptUnary:(i,e,n,a)=>{const r=i(e,n,a);return s(t,`Invoked SFU RPC method ${e.name}`,{request:r.request,headers:r.requestHeaders,response:r.response}),r}}),Ua=s=>{const t=(e,n,a)=>s(`${e}OnFailure`,[a,n]),i={SendStats:!0};return{interceptUnary(e,n,a,r){if(i[n.name])return e(n,a,r);s(n.name,a);const c=e(n,a,r);return c.then(d=>{var g;const p=(g=d.response)==null?void 0:g.error;p&&t(n.name,a,p)},d=>t(n.name,a,d)),c}}},La=s=>{const t=new zs({...Oa,...s});return new Da(t)},X=s=>new Promise(t=>setTimeout(t,s));function gt(s){return s&&(Object.prototype.toString.call(s)==="[object Function]"||typeof s=="function"||s instanceof Function)}const ce={TOKEN_EXPIRED:40,WS_CLOSED_SUCCESS:1e3};function Re(s){const t=Math.min(500+s*2e3,5e3),i=Math.min(Math.max(250,(s-1)*2e3),5e3);return Math.floor(Math.random()*(t-i)+i)}function be(s){let t="";for(let i=0;i<s.length;i++)t+=s[i].toString(16).padStart(2,"0");return t}function ft(){const s=Ma(16);return s[6]=s[6]&15|64,s[8]=s[8]&191|128,[be(s.subarray(0,4)),be(s.subarray(4,6)),be(s.subarray(6,8)),be(s.subarray(8,10)),be(s.subarray(10,16))].join("-")}const $a=typeof crypto<"u"&&crypto.getRandomValues?crypto.getRandomValues.bind(crypto):function(t){const i=Math.pow(2,8*t.byteLength/t.length);for(let e=0;e<t.length;e++)t[e]=Math.random()*i};function Ma(s){const t=new Uint8Array(s);return $a(t),t}function St(s){typeof window<"u"&&window.addEventListener&&(window.addEventListener("offline",s),window.addEventListener("online",s))}function Ss(s){typeof window<"u"&&window.removeEventListener&&(window.removeEventListener("offline",s),window.removeEventListener("online",s))}function Fa(s){return!s.status||s.status<200||300<=s.status}function ja(s){return s.code!==void 0}const M=()=>{var s;return typeof navigator>"u"?!1:((s=navigator.product)==null?void 0:s.toLowerCase())==="reactnative"},qt=Object.freeze({trace:0,debug:1,info:2,warn:3,error:4});let bs,Rt="info";const Ts=(s,t,...i)=>{let e;switch(s){case"error":if(M()){t=`ERROR: ${t}`,e=console.info;break}e=console.error;break;case"warn":if(M()){t=`WARN: ${t}`,e=console.info;break}e=console.warn;break;case"info":e=console.info;break;case"trace":e=console.trace;break;default:e=console.log;break}e(t,...i)},Va=(s,t)=>{bs=s,xa(t)},xa=s=>{Rt=s},bt=()=>Rt,R=s=>{const t=bs||Ts,i=(s||[]).filter(Boolean).join(":");return(n,a,...r)=>{qt[n]>=qt[Rt]&&t(n,`[${i}]: ${a}`,...r)}},z=async(s,t)=>{var n;let i=0,e;do{i>0&&await X(Re(i));try{e=await s()}catch(a){const r=a instanceof Ys&&a.code===Ht[Ht.cancelled],c=(t==null?void 0:t.aborted)??!1;if(r||c)throw a;R(["sfu-client","rpc"])("debug",`rpc failed (${i})`,a),i++}}while(!e||(n=e.response.error)!=null&&n.shouldRetry);return e},Jt=async s=>{const t=new RTCPeerConnection;t.addTransceiver("video",{direction:s}),t.addTransceiver("audio",{direction:s});const e=(await t.createOffer()).sdp??"";return t.getTransceivers().forEach(n=>{var a;(a=n.stop)==null||a.call(n)}),t.close(),e},Tt=s=>s?(s=s.toLowerCase(),s==="vp9"||s==="av1"||s==="video/vp9"||s==="video/av1"):!1,Ha={subscriberOffer:void 0,publisherAnswer:void 0,connectionQualityChanged:void 0,audioLevelChanged:void 0,iceTrickle:void 0,changePublishQuality:void 0,participantJoined:void 0,participantLeft:void 0,dominantSpeakerChanged:void 0,joinResponse:void 0,healthCheckResponse:void 0,trackPublished:void 0,trackUnpublished:void 0,error:void 0,callGrantsUpdated:void 0,goAway:void 0,iceRestart:void 0,pinsUpdated:void 0,callEnded:void 0,participantUpdated:void 0,participantMigrationComplete:void 0,changePublishOptions:void 0},Gt=s=>Object.prototype.hasOwnProperty.call(Ha,s);class Ba{constructor(){this.logger=R(["Dispatcher"]),this.subscribers={},this.dispatch=(t,i="0")=>{const e=t.eventPayload.oneofKind;if(!e)return;const n=t.eventPayload[e];this.logger("debug",`Dispatching ${e}, tag=${i}`,n);const a=this.subscribers[e];if(a)for(const r of a)try{r(n)}catch(c){this.logger("warn","Listener failed with error",c)}},this.on=(t,i)=>{var e;return((e=this.subscribers)[t]??(e[t]=[])).push(i),()=>{this.off(t,i)}},this.off=(t,i)=>{this.subscribers[t]=(this.subscribers[t]||[]).filter(e=>e!==i)}}}class Wa{constructor(){this.subscriberCandidates=new xt,this.publisherCandidates=new xt,this.push=t=>{const i=qa(t);i&&(t.peerType===L.SUBSCRIBER?this.subscriberCandidates.next(i):t.peerType===L.PUBLISHER_UNSPECIFIED?this.publisherCandidates.next(i):R(["sfu-client"])("warn","ICETrickle, Unknown peer type",t))},this.dispose=()=>{this.subscriberCandidates.complete(),this.publisherCandidates.complete()}}}const qa=s=>{try{return JSON.parse(s.iceCandidate)}catch(t){R(["sfu-client"])("error","Failed to parse ICE Trickle",t,s);return}},W=Cs(Ga),ht=Cs(Ka),pe=new Map;function Ja(s){return pe.has(s)}async function dt(s){let t;for(;t=pe.get(s);)await t.promise}function Cs(s){return function(i,e){const{cb:n,onContinued:a}=s(i,e),r=pe.get(i);r==null||r.onContinued();const c=r?r.promise.then(n,n):n();return pe.set(i,{promise:c,onContinued:a}),c}}function Ga(s,t){let i=!1;return{cb:()=>t().finally(()=>{i||pe.delete(s)}),onContinued:()=>i=!0}}function Ka(s,t){const i=new AbortController;return{cb:()=>i.signal.aborted?Promise.resolve("canceled"):t(i.signal).finally(()=>{i.signal.aborted||pe.delete(s)}),onContinued:()=>i.abort()}}const Ya=s=>typeof s=="function",O=s=>{let t,i;if(ne([s]).subscribe({next:([e])=>{t=e},error:e=>{i=e}}).unsubscribe(),i)throw i;return t},U=(s,t)=>{const i=Ya(t)?t(O(s)):t;return s.next(i),i},ys=(s,t)=>{const i=s.getValue(),e=U(s,t);return{lastValue:i,value:e,rollback:()=>U(s,i)}},J=(s,t,i=e=>R(["RxUtils"])("warn","An observable emitted an error",e))=>{const e=s.subscribe({next:t,error:i});return()=>{e.unsubscribe()}},Xe=(s,t)=>{const i=Symbol();return J(s,e=>{W(i,()=>t(e))})};var ec=Object.freeze({__proto__:null,createSafeAsyncSubscription:Xe,createSubscription:J,getCurrentValue:O,setCurrentValue:U,updateValue:ys}),y;(function(s){s.UNKNOWN="unknown",s.IDLE="idle",s.RINGING="ringing",s.JOINING="joining",s.JOINED="joined",s.LEFT="left",s.RECONNECTING="reconnecting",s.MIGRATING="migrating",s.RECONNECTING_FAILED="reconnecting-failed",s.OFFLINE="offline"})(y||(y={}));class Qa{constructor(){this.connectedUserSubject=new E(void 0),this.callsSubject=new E([]),this.setConnectedUser=t=>U(this.connectedUserSubject,t),this.setCalls=t=>U(this.callsSubject,t),this.registerCall=t=>{this.calls.find(i=>i.cid===t.cid)||this.setCalls(i=>[...i,t])},this.unregisterCall=t=>(R(["client-state"])("trace",`Unregistering call: ${t.cid}`),this.setCalls(e=>e.filter(n=>n!==t))),this.findCall=(t,i)=>this.calls.find(e=>e.type===t&&e.id===i),this.connectedUserSubject.subscribe(async t=>{if(!t){const i=R(["client-state"]);for(const e of this.calls)e.state.callingState!==y.LEFT&&(i("info",`User disconnected, leaving call: ${e.cid}`),await e.leave({message:"client.disconnectUser() called"}).catch(n=>{i("error",`Error leaving call: ${e.cid}`,n)}))}})}get connectedUser(){return O(this.connectedUserSubject)}get calls(){return O(this.callsSubject)}}class za{constructor(t){this.getCurrentValue=O,this.connectedUser$=t.connectedUserSubject.asObservable(),this.calls$=t.callsSubject.asObservable()}get connectedUser(){return O(this.connectedUser$)}get calls(){return O(this.calls$)}}const te=(...s)=>(t,i)=>{for(const e of s){const n=e(t,i);if(n!==0)return n}return 0},ks=s=>t=>(i,e)=>s(i,e)?t(i,e):0,le=s=>s.publishedTracks.includes(b.VIDEO),De=s=>s.publishedTracks.includes(b.AUDIO),ie=s=>s.publishedTracks.includes(b.SCREEN_SHARE),Za=s=>s.publishedTracks.includes(b.SCREEN_SHARE_AUDIO),tc=s=>!!s.pin&&(s.pin.isLocalPin||s.pin.pinnedAt>0),et=(s,t)=>s.isDominantSpeaker&&!t.isDominantSpeaker?-1:!s.isDominantSpeaker&&t.isDominantSpeaker?1:0,tt=(s,t)=>s.isSpeaking&&!t.isSpeaking?-1:!s.isSpeaking&&t.isSpeaking?1:0,ws=(s,t)=>ie(s)&&!ie(t)?-1:!ie(s)&&ie(t)?1:0,st=(s,t)=>le(s)&&!le(t)?-1:!le(s)&&le(t)?1:0,it=(s,t)=>De(s)&&!De(t)?-1:!De(s)&&De(t)?1:0,Pt=(s,t)=>{if(s.pin&&t.pin){if(!s.pin.isLocalPin&&t.pin.isLocalPin)return-1;if(s.pin.isLocalPin&&!t.pin.isLocalPin)return 1;if(s.pin.pinnedAt>t.pin.pinnedAt)return-1;if(s.pin.pinnedAt<t.pin.pinnedAt)return 1}return s.pin&&!t.pin?-1:!s.pin&&t.pin?1:0},nt=s=>(t,i)=>{var e,n,a,r;return((e=t.reaction)==null?void 0:e.type)===s&&((n=i.reaction)==null?void 0:n.type)!==s?-1:((a=t.reaction)==null?void 0:a.type)!==s&&((r=i.reaction)==null?void 0:r.type)===s?1:0},Xa=(...s)=>(t,i)=>Oe(t,s)&&!Oe(i,s)?-1:!Oe(t,s)&&Oe(i,s)?1:0,Oe=(s,t)=>(s.roles||[]).some(i=>t.includes(i)),Dt=ks((s,t)=>{var i,e;return((i=s.viewportVisibilityState)==null?void 0:i.videoTrack)===D.INVISIBLE||((e=t.viewportVisibilityState)==null?void 0:e.videoTrack)===D.INVISIBLE}),er=ks((s,t)=>{var i,e,n,a;return((i=s.viewportVisibilityState)==null?void 0:i.videoTrack)===D.INVISIBLE||((e=s.viewportVisibilityState)==null?void 0:e.videoTrack)===D.UNKNOWN||((n=t.viewportVisibilityState)==null?void 0:n.videoTrack)===D.INVISIBLE||((a=t.viewportVisibilityState)==null?void 0:a.videoTrack)===D.UNKNOWN}),Be=te(Pt,ws,Dt(te(et,tt,nt("raised-hand"),st,it))),sc=te(Pt,ws,et,Dt(te(tt,nt("raised-hand"),st,it)));te(Pt,er(te(et,tt,nt("raised-hand"),st,it)));const Kt=te(Dt(te(et,tt,nt("raised-hand"),st,it)),Xa("admin","host","speaker")),Yt={broadcasting:!1,hls:{playlist_url:"",status:""},rtmps:[]};class tr{constructor(){this.backstageSubject=new E(!0),this.blockedUserIdsSubject=new E([]),this.createdAtSubject=new E(new Date),this.endedAtSubject=new E(void 0),this.startsAtSubject=new E(void 0),this.updatedAtSubject=new E(new Date),this.createdBySubject=new E(void 0),this.customSubject=new E({}),this.egressSubject=new E(void 0),this.ingressSubject=new E(void 0),this.recordingSubject=new E(!1),this.sessionSubject=new E(void 0),this.settingsSubject=new E(void 0),this.transcribingSubject=new E(!1),this.captioningSubject=new E(!1),this.endedBySubject=new E(void 0),this.thumbnailsSubject=new E(void 0),this.membersSubject=new E([]),this.ownCapabilitiesSubject=new E([]),this.callingStateSubject=new E(y.UNKNOWN),this.startedAtSubject=new E(void 0),this.participantCountSubject=new E(0),this.anonymousParticipantCountSubject=new E(0),this.participantsSubject=new E([]),this.callStatsReportSubject=new E(void 0),this.closedCaptionsSubject=new E([]),this.orphanedTracks=[],this.logger=R(["CallState"]),this.sortParticipantsBy=Be,this.closedCaptionsTasks=new Map,this.dispose=()=>{for(const[e,n]of this.closedCaptionsTasks.entries())clearTimeout(n),this.closedCaptionsTasks.delete(e)},this.setSortParticipantsBy=e=>{this.sortParticipantsBy=e,this.setCurrentValue(this.participantsSubject,n=>n)},this.getCurrentValue=O,this.setCurrentValue=U,this.setParticipantCount=e=>this.setCurrentValue(this.participantCountSubject,e),this.setStartedAt=e=>this.setCurrentValue(this.startedAtSubject,e),this.setCaptioning=e=>ys(this.captioningSubject,e),this.setAnonymousParticipantCount=e=>this.setCurrentValue(this.anonymousParticipantCountSubject,e),this.setParticipants=e=>this.setCurrentValue(this.participantsSubject,e),this.setCallingState=e=>this.setCurrentValue(this.callingStateSubject,e),this.setCallStatsReport=e=>this.setCurrentValue(this.callStatsReportSubject,e),this.setMembers=e=>{this.setCurrentValue(this.membersSubject,e)},this.setOwnCapabilities=e=>this.setCurrentValue(this.ownCapabilitiesSubject,e),this.setBackstage=e=>this.setCurrentValue(this.backstageSubject,e),this.setEndedAt=e=>this.setCurrentValue(this.endedAtSubject,e),this.findParticipantBySessionId=e=>this.participants.find(n=>n.sessionId===e),this.getParticipantLookupBySessionId=()=>this.participants.reduce((e,n)=>(e[n.sessionId]=n,e),{}),this.updateParticipant=(e,n)=>{const a=this.findParticipantBySessionId(e);if(!a){this.logger("warn",`Participant with sessionId ${e} not found`);return}const r=typeof n=="function"?n(a):n,c={...a,...r};return this.setParticipants(d=>d.map(p=>p.sessionId===e?c:p))},this.updateOrAddParticipant=(e,n)=>this.setParticipants(a=>{let r=!0;const c=a.map(d=>d.sessionId===e?(r=!1,{...d,...n}):d);return r&&c.push(n),c}),this.updateParticipants=e=>Object.keys(e).length===0?this.participants:this.setParticipants(n=>n.map(a=>{const r=e[a.sessionId];return r?{...a,...r}:a})),this.updateParticipantTracks=(e,n)=>this.updateParticipants(Object.entries(n).reduce((a,[r,c])=>{c.dimension&&(c.dimension.height=Math.ceil(c.dimension.height),c.dimension.width=Math.ceil(c.dimension.width));const d=e==="videoTrack"?"videoDimension":e==="screenShareTrack"?"screenShareDimension":void 0;return d&&(a[r]={[d]:c.dimension}),a},{})),this.updateFromEvent=e=>{const n=this.eventHandlers[e.type];n&&n(e)},this.setServerSidePins=e=>{const n=e.reduce((a,r)=>(a[r.sessionId]=Date.now(),a),{});return this.setParticipants(a=>a.map(r=>{const c=n[r.sessionId];return c?{...r,pin:{isLocalPin:!1,pinnedAt:c}}:r.pin&&!r.pin.isLocalPin?{...r,pin:void 0}:r}))},this.registerOrphanedTrack=e=>{this.orphanedTracks.push(e)},this.removeOrphanedTrack=e=>{this.orphanedTracks=this.orphanedTracks.filter(n=>n.id!==e)},this.takeOrphanedTracks=e=>{const n=this.orphanedTracks.filter(a=>a.trackLookupPrefix===e);return n.length>0&&(this.orphanedTracks=this.orphanedTracks.filter(a=>a.trackLookupPrefix!==e)),n},this.updateClosedCaptionSettings=e=>{this.closedCaptionsSettings={...this.closedCaptionsSettings,...e}},this.updateFromCallResponse=e=>{this.setBackstage(e.backstage),this.setCurrentValue(this.blockedUserIdsSubject,e.blocked_user_ids),this.setCurrentValue(this.createdAtSubject,new Date(e.created_at)),this.setCurrentValue(this.updatedAtSubject,new Date(e.updated_at)),this.setCurrentValue(this.startsAtSubject,e.starts_at?new Date(e.starts_at):void 0),this.setEndedAt(e.ended_at?new Date(e.ended_at):void 0),this.setCurrentValue(this.createdBySubject,e.created_by),this.setCurrentValue(this.customSubject,e.custom),this.setCurrentValue(this.egressSubject,e.egress),this.setCurrentValue(this.ingressSubject,e.ingress),this.setCurrentValue(this.recordingSubject,e.recording);const n=this.setCurrentValue(this.sessionSubject,e.session);this.updateParticipantCountFromSession(n),this.setCurrentValue(this.settingsSubject,e.settings),this.setCurrentValue(this.transcribingSubject,e.transcribing),this.setCurrentValue(this.captioningSubject,e.captioning),this.setCurrentValue(this.thumbnailsSubject,e.thumbnails)},this.updateFromSfuCallState=(e,n,a)=>{const{participants:r,participantCount:c,startedAt:d,pins:p}=e,g=(a==null?void 0:a.announcedTracks.map(m=>m.trackType))??[];this.setParticipants(()=>{const m=this.getParticipantLookupBySessionId();return r.map(o=>{const l=m[o.sessionId],h=o.sessionId===n;return Object.assign({},l,o,{isLocalParticipant:h,publishedTracks:h?g:o.publishedTracks,viewportVisibilityState:(l==null?void 0:l.viewportVisibilityState)??{videoTrack:D.UNKNOWN,screenShareTrack:D.UNKNOWN}})})}),this.setParticipantCount((c==null?void 0:c.total)||0),this.setAnonymousParticipantCount((c==null?void 0:c.anonymous)||0),this.setStartedAt(d?ke.toDate(d):new Date),this.setServerSidePins(p)},this.updateFromMemberRemoved=e=>{this.updateFromCallResponse(e.call),this.setCurrentValue(this.membersSubject,n=>n.filter(a=>e.members.indexOf(a.user_id)===-1))},this.updateFromMemberAdded=e=>{this.updateFromCallResponse(e.call),this.setCurrentValue(this.membersSubject,n=>[...n,...e.members])},this.updateFromHLSBroadcastStopped=()=>{this.setCurrentValue(this.egressSubject,(e=Yt)=>({...e,broadcasting:!1,hls:{...e.hls,status:""}}))},this.updateFromHLSBroadcastingFailed=()=>{this.setCurrentValue(this.egressSubject,(e=Yt)=>({...e,broadcasting:!1,hls:{...e.hls,status:""}}))},this.updateParticipantCountFromSession=e=>{if(!e||this.callingState===y.JOINED)return;const n=Object.values(e.participants_count_by_role).reduce((r,c)=>r+c,0),a=Math.max(n,e.participants.length);this.setParticipantCount(a),this.setAnonymousParticipantCount(e.anonymous_participant_count||0)},this.updateFromSessionParticipantCountUpdate=e=>{const n=this.setCurrentValue(this.sessionSubject,a=>a&&{...a,anonymous_participant_count:e.anonymous_participant_count,participants_count_by_role:e.participants_count_by_role});this.updateParticipantCountFromSession(n)},this.updateFromSessionParticipantLeft=e=>{const n=this.setCurrentValue(this.sessionSubject,a=>{if(!a)return a;const{participants:r,participants_count_by_role:c}=a,{user:d,user_session_id:p}=e.participant;return{...a,participants:r.filter(g=>g.user_session_id!==p),participants_count_by_role:{...c,[d.role]:Math.max(0,(c[d.role]||0)-1)}}});this.updateParticipantCountFromSession(n)},this.updateFromSessionParticipantJoined=e=>{const n=this.setCurrentValue(this.sessionSubject,a=>{if(!a)return a;const{participants:r,participants_count_by_role:c}=a,{user:d,user_session_id:p}=e.participant;let g=!0;const m=r.map(l=>l.user_session_id===p?(g=!1,e.participant):l);g&&m.push(e.participant);const o=g?1:0;return{...a,participants:m,participants_count_by_role:{...c,[d.role]:(c[d.role]||0)+o}}});this.updateParticipantCountFromSession(n)},this.updateMembers=e=>{this.updateFromCallResponse(e.call),this.setCurrentValue(this.membersSubject,n=>n.map(a=>{const r=e.members.find(c=>c.user_id===a.user_id);return r||a}))},this.updateParticipantReaction=e=>{const{user:n,custom:a,type:r,emoji_code:c}=e.reaction;this.setParticipants(d=>d.map(p=>p.userId!==n.id?p:{...p,reaction:{type:r,emoji_code:c,custom:a}}))},this.unblockUser=e=>{this.setCurrentValue(this.blockedUserIdsSubject,n=>n&&n.filter(a=>a!==e.user.id))},this.blockUser=e=>{this.setCurrentValue(this.blockedUserIdsSubject,n=>[...n||[],e.user.id])},this.updateOwnCapabilities=e=>{var n;e.user.id===((n=this.localParticipant)==null?void 0:n.userId)&&this.setCurrentValue(this.ownCapabilitiesSubject,e.own_capabilities)},this.updateFromClosedCaptions=e=>{this.setCurrentValue(this.closedCaptionsSubject,n=>{const{closed_caption:a}=e,r=o=>`${o.speaker_id}/${o.start_time}`,c=r(a);if(n.some(o=>r(o)===c))return n;const p=[...n,a],{visibilityDurationMs:g=2700,maxVisibleCaptions:m=2}=this.closedCaptionsSettings||{};if(g>0){const o=setTimeout(()=>{this.setCurrentValue(this.closedCaptionsSubject,l=>l.filter(h=>h!==a)),this.closedCaptionsTasks.delete(c)},g);this.closedCaptionsTasks.set(c,o);for(let l=0;l<p.length-m;l++){const h=r(p[l]),u=this.closedCaptionsTasks.get(h);clearTimeout(u),this.closedCaptionsTasks.delete(h)}}return p.slice(-m)})},this.rawParticipants$=this.participantsSubject.asObservable().pipe(j({bufferSize:1,refCount:!0})),this.participants$=this.participantsSubject.asObservable().pipe(x(e=>e.sort(this.sortParticipantsBy)),j({bufferSize:1,refCount:!0})),this.localParticipant$=this.participants$.pipe(x(e=>e.find(n=>n.isLocalParticipant)),j({bufferSize:1,refCount:!0})),this.remoteParticipants$=this.participants$.pipe(x(e=>e.filter(n=>!n.isLocalParticipant)),j({bufferSize:1,refCount:!0})),this.pinnedParticipants$=this.participants$.pipe(x(e=>e.filter(n=>!!n.pin)),j({bufferSize:1,refCount:!0})),this.dominantSpeaker$=this.participants$.pipe(x(e=>e.find(n=>n.isDominantSpeaker)),j({bufferSize:1,refCount:!0})),this.hasOngoingScreenShare$=this.participants$.pipe(x(e=>e.some(n=>ie(n))),B(),j({bufferSize:1,refCount:!0})),this.createdAt$=this.createdAtSubject.asObservable(),this.endedAt$=this.endedAtSubject.asObservable(),this.startsAt$=this.startsAtSubject.asObservable(),this.startedAt$=this.startedAtSubject.asObservable(),this.updatedAt$=this.updatedAtSubject.asObservable(),this.callStatsReport$=this.callStatsReportSubject.asObservable(),this.members$=this.membersSubject.asObservable(),this.createdBy$=this.createdBySubject.asObservable(),this.custom$=this.customSubject.asObservable(),this.egress$=this.egressSubject.asObservable(),this.ingress$=this.ingressSubject.asObservable(),this.session$=this.sessionSubject.asObservable(),this.settings$=this.settingsSubject.asObservable(),this.endedBy$=this.endedBySubject.asObservable(),this.thumbnails$=this.thumbnailsSubject.asObservable(),this.closedCaptions$=this.closedCaptionsSubject.asObservable();const t=(e,n)=>{if(e.length!==n.length)return!1;for(const a of e)if(!n.includes(a))return!1;for(const a of n)if(!e.includes(a))return!1;return!0},i=(e,n)=>e.asObservable().pipe(B(n));this.anonymousParticipantCount$=i(this.anonymousParticipantCountSubject),this.blockedUserIds$=i(this.blockedUserIdsSubject,t),this.backstage$=i(this.backstageSubject),this.callingState$=i(this.callingStateSubject),this.ownCapabilities$=i(this.ownCapabilitiesSubject,t),this.participantCount$=i(this.participantCountSubject),this.recording$=i(this.recordingSubject),this.transcribing$=i(this.transcribingSubject),this.captioning$=i(this.captioningSubject),this.eventHandlers={"call.frame_recording_ready":void 0,"call.moderation_blur":void 0,"call.moderation_warning":void 0,"call.permission_request":void 0,"call.recording_ready":void 0,"call.rtmp_broadcast_failed":void 0,"call.rtmp_broadcast_started":void 0,"call.rtmp_broadcast_stopped":void 0,"call.stats_report_ready":void 0,"call.transcription_ready":void 0,"call.user_muted":void 0,"connection.error":void 0,"connection.ok":void 0,"health.check":void 0,"user.updated":void 0,custom:void 0,"call.accepted":e=>this.updateFromCallResponse(e.call),"call.blocked_user":this.blockUser,"call.closed_caption":this.updateFromClosedCaptions,"call.closed_captions_failed":()=>{this.setCurrentValue(this.captioningSubject,!1)},"call.closed_captions_started":()=>{this.setCurrentValue(this.captioningSubject,!0)},"call.closed_captions_stopped":()=>{this.setCurrentValue(this.captioningSubject,!1)},"call.created":e=>this.updateFromCallResponse(e.call),"call.deleted":e=>this.updateFromCallResponse(e.call),"call.ended":e=>{this.updateFromCallResponse(e.call),this.setCurrentValue(this.endedBySubject,e.user)},"call.frame_recording_failed":e=>{this.updateFromCallResponse(e.call)},"call.frame_recording_started":e=>{this.updateFromCallResponse(e.call)},"call.frame_recording_stopped":e=>{this.updateFromCallResponse(e.call)},"call.hls_broadcasting_failed":this.updateFromHLSBroadcastingFailed,"call.hls_broadcasting_started":e=>{this.updateFromCallResponse(e.call)},"call.hls_broadcasting_stopped":this.updateFromHLSBroadcastStopped,"call.live_started":e=>this.updateFromCallResponse(e.call),"call.member_added":this.updateFromMemberAdded,"call.member_removed":this.updateFromMemberRemoved,"call.member_updated_permission":this.updateMembers,"call.member_updated":this.updateMembers,"call.notification":e=>{this.updateFromCallResponse(e.call),this.setMembers(e.members)},"call.permissions_updated":this.updateOwnCapabilities,"call.reaction_new":this.updateParticipantReaction,"call.recording_started":()=>this.setCurrentValue(this.recordingSubject,!0),"call.recording_stopped":()=>this.setCurrentValue(this.recordingSubject,!1),"call.recording_failed":()=>this.setCurrentValue(this.recordingSubject,!1),"call.rejected":e=>this.updateFromCallResponse(e.call),"call.ring":e=>this.updateFromCallResponse(e.call),"call.missed":e=>this.updateFromCallResponse(e.call),"call.session_ended":e=>this.updateFromCallResponse(e.call),"call.session_participant_count_updated":this.updateFromSessionParticipantCountUpdate,"call.session_participant_joined":this.updateFromSessionParticipantJoined,"call.session_participant_left":this.updateFromSessionParticipantLeft,"call.session_started":e=>this.updateFromCallResponse(e.call),"call.transcription_started":()=>{this.setCurrentValue(this.transcribingSubject,!0)},"call.transcription_stopped":()=>{this.setCurrentValue(this.transcribingSubject,!1)},"call.transcription_failed":()=>{this.setCurrentValue(this.transcribingSubject,!1)},"call.unblocked_user":this.unblockUser,"call.updated":e=>this.updateFromCallResponse(e.call)}}get participantCount(){return this.getCurrentValue(this.participantCount$)}get startedAt(){return this.getCurrentValue(this.startedAt$)}get captioning(){return this.getCurrentValue(this.captioning$)}get anonymousParticipantCount(){return this.getCurrentValue(this.anonymousParticipantCount$)}get participants(){return this.getCurrentValue(this.participants$)}get rawParticipants(){return this.getCurrentValue(this.rawParticipants$)}get localParticipant(){return this.getCurrentValue(this.localParticipant$)}get remoteParticipants(){return this.getCurrentValue(this.remoteParticipants$)}get dominantSpeaker(){return this.getCurrentValue(this.dominantSpeaker$)}get pinnedParticipants(){return this.getCurrentValue(this.pinnedParticipants$)}get hasOngoingScreenShare(){return this.getCurrentValue(this.hasOngoingScreenShare$)}get callingState(){return this.getCurrentValue(this.callingState$)}get callStatsReport(){return this.getCurrentValue(this.callStatsReport$)}get isCallStatsReportObserved(){return this.callStatsReportSubject.observed}get members(){return this.getCurrentValue(this.members$)}get ownCapabilities(){return this.getCurrentValue(this.ownCapabilities$)}get backstage(){return this.getCurrentValue(this.backstage$)}get blockedUserIds(){return this.getCurrentValue(this.blockedUserIds$)}get createdAt(){return this.getCurrentValue(this.createdAt$)}get endedAt(){return this.getCurrentValue(this.endedAt$)}get startsAt(){return this.getCurrentValue(this.startsAt$)}get updatedAt(){return this.getCurrentValue(this.updatedAt$)}get createdBy(){return this.getCurrentValue(this.createdBy$)}get custom(){return this.getCurrentValue(this.custom$)}get egress(){return this.getCurrentValue(this.egress$)}get ingress(){return this.getCurrentValue(this.ingress$)}get recording(){return this.getCurrentValue(this.recording$)}get session(){return this.getCurrentValue(this.session$)}get settings(){return this.getCurrentValue(this.settings$)}get transcribing(){return this.getCurrentValue(this.transcribing$)}get endedBy(){return this.getCurrentValue(this.endedBy$)}get thumbnails(){return this.getCurrentValue(this.thumbnails$)}get closedCaptions(){return this.getCurrentValue(this.closedCaptions$)}}class Ot extends Error{constructor(t){super(t.message),this.name="NegotiationError",this.error=t}}const We=s=>{const t=[];return s.forEach(i=>{t.push(i)}),t},vs=s=>({id:s.id,tracks:s.getTracks().map(t=>({id:t.id,kind:t.kind,label:t.label,enabled:t.enabled,muted:t.muted,readyState:t.readyState}))}),sr=s=>{const{sdk:t,...i}=s,e=Es(t),n=Is(t);return{sdkName:e,sdkVersion:n,...i}},Es=s=>s&&s.type===ee.REACT?"stream-react":s&&s.type===ee.REACT_NATIVE?"stream-react-native":"stream-js",Is=s=>s?`${s.major}.${s.minor}.${s.patch}`:"0.0.0-development",Ct=()=>typeof navigator>"u"?!1:/^((?!chrome|android).)*safari/i.test(navigator.userAgent||""),at=()=>{var s;return typeof navigator>"u"?!1:(s=navigator.userAgent)==null?void 0:s.includes("Firefox")},ir=()=>{var s;return typeof navigator>"u"?!1:(s=navigator.userAgent)==null?void 0:s.includes("Chrome")};var ic=Object.freeze({__proto__:null,isChrome:ir,isFirefox:at,isSafari:Ct});const nr=({subscriber:s,publisher:t,state:i,datacenter:e,pollingIntervalInMs:n=2e3})=>{const a=R(["stats"]),r=async(h,u)=>h==="subscriber"&&s?s.getStats(u):h==="publisher"&&t?t.getStats(u):void 0,c=async(h,u)=>{const f=h==="subscriber"?s:t;if(!f)return[];const S=[];for(const C of u){const k=await f.getStats(C),_=Qt(k,{trackKind:C.kind,kind:h,publisher:void 0});S.push(_)}return S},d=h=>{g.add(h),m()},p=h=>{g.delete(h),m()},g=new Set,m=async()=>{const h={};if(g.size>0){const _=new Set(g);for(const v of i.participants){if(!_.has(v.sessionId))continue;const{audioStream:I,isLocalParticipant:P,sessionId:A,userId:F,videoStream:V}=v,q=P?"publisher":"subscriber";try{const $=P?(t==null?void 0:t.getPublishedTracks())||[]:[...(V==null?void 0:V.getVideoTracks())||[],...(I==null?void 0:I.getAudioTracks())||[]];h[A]=await c(q,$)}catch($){a("warn",`Failed to collect ${q} stats for ${F}`,$)}}}const[u,f]=await Promise.all([r("subscriber"),t?r("publisher"):void 0]),S=(_,v)=>ar(Qt(_,{kind:v,trackKind:"video",publisher:t})),C=u?S(u,"subscriber"):yt(),k=f?S(f,"publisher"):yt();i.setCallStatsReport({datacenter:e,publisherStats:k,subscriberStats:C,subscriberRawStats:u,publisherRawStats:f,participants:h,timestamp:Date.now()})};let o;if(n>0){const h=async()=>{i.isCallStatsReportObserved&&await m().catch(u=>{a("debug","Failed to collect stats",u)}),o=setTimeout(h,n)};h()}return{getRawStatsForTrack:r,getStatsForStream:c,startReportingStatsFor:d,stopReportingStatsFor:p,stop:()=>{o&&clearTimeout(o)}}},Qt=(s,t)=>{const{trackKind:i,kind:e,publisher:n}=t,a=e==="subscriber"?"inbound-rtp":"outbound-rtp",r=We(s),c=r.filter(d=>d.type===a&&d.kind===i).map(d=>{const p=d,g=r.find(h=>h.type==="codec"&&h.id===p.codecId),m=r.find(h=>h.type==="transport"&&h.id===p.transportId);let o;if(m&&m.dtlsState==="connected"){const h=r.find(u=>u.type==="candidate-pair"&&u.id===m.selectedCandidatePairId);o=h==null?void 0:h.currentRoundTripTime}let l;if(e==="publisher"&&n){const h=at(),u=r.find(f=>f.type==="media-source"&&(h?!0:f.id===p.mediaSourceId));u&&(l=n.getTrackType(u.trackIdentifier))}return{bytesSent:p.bytesSent,bytesReceived:p.bytesReceived,codec:g==null?void 0:g.mimeType,currentRoundTripTime:o,frameHeight:p.frameHeight,frameWidth:p.frameWidth,framesPerSecond:p.framesPerSecond,jitter:p.jitter,kind:p.kind,mediaSourceId:p.mediaSourceId,qualityLimitationReason:p.qualityLimitationReason,rid:p.rid,ssrc:p.ssrc,trackType:l}});return{rawStats:s,streams:c,timestamp:Date.now()}},yt=s=>({rawReport:s??{streams:[],timestamp:Date.now()},totalBytesSent:0,totalBytesReceived:0,averageJitterInMs:0,averageRoundTripTimeInMs:0,qualityLimitationReasons:"none",highestFrameWidth:0,highestFrameHeight:0,highestFramesPerSecond:0,codec:"",codecPerTrackType:{},timestamp:Date.now()}),ar=s=>{const t=yt(s);let i=-1;const e=(d,p)=>d*p,n=new Set,a=s.streams,r=a.reduce((d,p)=>{d.totalBytesSent+=p.bytesSent||0,d.totalBytesReceived+=p.bytesReceived||0,d.averageJitterInMs+=p.jitter||0,d.averageRoundTripTimeInMs+=p.currentRoundTripTime||0;const g=e(p.frameWidth||0,p.frameHeight||0);return g>i&&(d.highestFrameWidth=p.frameWidth||0,d.highestFrameHeight=p.frameHeight||0,d.highestFramesPerSecond=p.framesPerSecond||0,i=g),n.add(p.qualityLimitationReason||""),d},t);a.length>0&&(r.averageJitterInMs=Math.round(r.averageJitterInMs/a.length*1e3),r.averageRoundTripTimeInMs=Math.round(r.averageRoundTripTimeInMs/a.length*1e3),r.codec=a[0].codec||"",r.codecPerTrackType=a.reduce((d,p)=>(p.trackType&&(d[p.trackType]=p.codec||""),d),{}));const c=[n.has("cpu")&&"cpu",n.has("bandwidth")&&"bandwidth",n.has("other")&&"other"].filter(Boolean).join(", ");return c&&(r.qualityLimitationReasons=c),r},rr="1.25.0",[or,cr,lr]=rr.split(".");let qe={type:ee.PLAIN_JAVASCRIPT,major:or,minor:cr,patch:lr},hr,dr,ur={oneofKind:void 0};const nc=s=>{qe=s},pr=()=>qe,mr=()=>ur,zt=async()=>{if(M())return{sdk:qe,os:hr,device:dr};const s=navigator.userAgentData;let t;if(s&&s.getHighEntropyValues)try{t=await s.getHighEntropyValues(["platform","platformVersion"])}catch{}const i=new Bs.UAParser(navigator.userAgent),{browser:e,os:n,device:a,cpu:r}=i.getResult();return{sdk:qe,browser:{name:e.name||navigator.userAgent,version:e.version||""},os:{name:(t==null?void 0:t.platform)||n.name||"",version:(t==null?void 0:t.platformVersion)||n.version||"",architecture:r.architecture||""},device:{name:[a.vendor,a.model,a.type].filter(Boolean).join(" "),version:""}}};class gr{constructor(t,{options:i,clientDetails:e,subscriber:n,publisher:a,microphone:r,camera:c,state:d,tracer:p,unifiedSessionId:g}){this.logger=R(["SfuStatsReporter"]),this.inputDevices=new Map,this.observeDevice=(l,h)=>{var f;const{browserPermissionState$:u}=l.state;(f=this.unsubscribeDevicePermissionsSubscription)==null||f.call(this),this.unsubscribeDevicePermissionsSubscription=J(ne([u,this.state.ownCapabilities$]),([S,C])=>{var _;(_=this.unsubscribeListDevicesSubscription)==null||_.call(this);const k=h==="mic"?C.includes(N.SEND_AUDIO):C.includes(N.SEND_VIDEO);if(S!=="granted"||!k){this.inputDevices.set(h,{currentDevice:"",availableDevices:[],isPermitted:!1});return}this.unsubscribeListDevicesSubscription=J(ne([l.listDevices(),l.state.selectedDevice$]),([v,I])=>{const P=v.find(A=>A.deviceId===I);this.inputDevices.set(h,{currentDevice:(P==null?void 0:P.label)||I||"",availableDevices:v.map(A=>A.label),isPermitted:!0})})})},this.sendConnectionTime=l=>{this.sendTelemetryData({data:{oneofKind:"connectionTimeSeconds",connectionTimeSeconds:l}})},this.sendReconnectionTime=(l,h)=>{this.sendTelemetryData({data:{oneofKind:"reconnection",reconnection:{strategy:l,timeSeconds:h}}})},this.sendTelemetryData=l=>{this.run(l).catch(h=>{this.logger("warn","Failed to send telemetry data",h)})},this.run=async l=>{var v,I,P,A,F,V,q;const[h,u]=await Promise.all([this.subscriber.stats.get(),(v=this.publisher)==null?void 0:v.stats.get()]);(I=this.subscriber.tracer)==null||I.trace("getstats",h.delta),u&&((A=(P=this.publisher)==null?void 0:P.tracer)==null||A.trace("getstats",u.delta));const f=(F=this.subscriber.tracer)==null?void 0:F.take(),S=(q=(V=this.publisher)==null?void 0:V.tracer)==null?void 0:q.take(),C=this.tracer.take(),k=this.sfuClient.getTrace(),_=[...C.snapshot,...(k==null?void 0:k.snapshot)??[],...(S==null?void 0:S.snapshot)??[],...(f==null?void 0:f.snapshot)??[]];try{await this.sfuClient.sendStats({sdk:this.sdkName,sdkVersion:this.sdkVersion,webrtcVersion:this.webRTCVersion,subscriberStats:JSON.stringify(We(h.stats)),publisherStats:u?JSON.stringify(We(u.stats)):"[]",subscriberRtcStats:"",publisherRtcStats:"",rtcStats:JSON.stringify(_),encodeStats:(u==null?void 0:u.performanceStats)??[],decodeStats:h.performanceStats,audioDevices:this.inputDevices.get("mic"),videoDevices:this.inputDevices.get("camera"),unifiedSessionId:this.unifiedSessionId,deviceState:mr(),telemetry:l})}catch($){throw S==null||S.rollback(),f==null||f.rollback(),C.rollback(),k==null||k.rollback(),$}},this.start=()=>{this.options.reporting_interval_ms<=0||(this.observeDevice(this.microphone,"mic"),this.observeDevice(this.camera,"camera"),clearInterval(this.intervalId),this.intervalId=setInterval(()=>{this.run().catch(l=>{this.logger("warn","Failed to report stats",l)})},this.options.reporting_interval_ms))},this.stop=()=>{var l,h;(l=this.unsubscribeDevicePermissionsSubscription)==null||l.call(this),this.unsubscribeDevicePermissionsSubscription=void 0,(h=this.unsubscribeListDevicesSubscription)==null||h.call(this),this.unsubscribeListDevicesSubscription=void 0,this.inputDevices.clear(),clearInterval(this.intervalId),this.intervalId=void 0,clearTimeout(this.timeoutId),this.timeoutId=void 0},this.flush=()=>{this.run().catch(l=>{this.logger("warn","Failed to flush report stats",l)})},this.scheduleOne=l=>{clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.run().catch(h=>{this.logger("warn","Failed to report stats",h)})},l)},this.sfuClient=t,this.options=i,this.subscriber=n,this.publisher=a,this.microphone=r,this.camera=c,this.state=d,this.tracer=p,this.unifiedSessionId=g;const{sdk:m,browser:o}=e;this.sdkName=Es(m),this.sdkVersion=Is(m),this.webRTCVersion=`${(o==null?void 0:o.name)||""}-${(o==null?void 0:o.version)||""}`||"N/A"}}const fr=(s,t)=>{s.addEventListener("icecandidate",e=>{t("onicecandidate",e.candidate)}),s.addEventListener("track",e=>{const n=e.streams.map(a=>`stream:${a.id}`);t("ontrack",`${e.track.kind}:${e.track.id} ${n}`)}),s.addEventListener("signalingstatechange",()=>{t("signalingstatechange",s.signalingState)}),s.addEventListener("iceconnectionstatechange",()=>{t("iceconnectionstatechange",s.iceConnectionState)}),s.addEventListener("icegatheringstatechange",()=>{t("icegatheringstatechange",s.iceGatheringState)}),s.addEventListener("connectionstatechange",()=>{t("connectionstatechange",s.connectionState)}),s.addEventListener("negotiationneeded",()=>{t("negotiationneeded",void 0)}),s.addEventListener("datachannel",({channel:e})=>{t("datachannel",[e.id,e.label])});const i=s.close;s.close=function(){return t("close",void 0),i.call(this)};for(const e of["createOffer","createAnswer","setLocalDescription","setRemoteDescription","addIceCandidate"]){const n=s[e];n&&(s[e]=async function(...r){try{t(e,r);const c=await n.apply(this,r);return t(`${e}OnSuccess`,c),c}catch(c){throw t(`${e}OnFailure`,c.toString()),c}})}};class Sr{constructor(t,i,e){this.previousStats={},this.frameTimeHistory=[],this.fpsHistory=[],this.get=async()=>{const n=await this.pc.getStats(),a=br(n),r=this.withOverrides(this.peerType===L.SUBSCRIBER?this.getDecodeStats(a):this.getEncodeStats(a)),c=Tr(this.previousStats,a);return this.previousStats=a,this.frameTimeHistory=this.frameTimeHistory.slice(-2),this.fpsHistory=this.fpsHistory.slice(-2),{performanceStats:r,delta:c,stats:n}},this.getEncodeStats=n=>{const a=[];for(const r of Object.values(n)){if(r.type!=="outbound-rtp")continue;const{codecId:c,framesSent:d=0,kind:p,id:g,totalEncodeTime:m=0,framesPerSecond:o=0,frameHeight:l=0,frameWidth:h=0,targetBitrate:u=0,mediaSourceId:f}=r;if(p==="audio"||!this.previousStats[g])continue;const S=this.previousStats[g],C=m-(S.totalEncodeTime||0),k=d-(S.framesSent||0),_=k>0?C/k*1e3:0;this.frameTimeHistory.push(_),this.fpsHistory.push(o);let v=b.VIDEO;if(f&&n[f]){const I=n[f];v=this.trackIdToTrackType.get(I.trackIdentifier)||v}a.push({trackType:v,codec:Zt(n,c),avgFrameTimeMs:Ae(this.frameTimeHistory),avgFps:Ae(this.fpsHistory),targetBitrate:Math.round(u),videoDimension:{width:h,height:l}})}return a},this.getDecodeStats=n=>{let a,r=0;for(const f of Object.values(n)){if(f.type!=="inbound-rtp")continue;const S=f,{kind:C,frameWidth:k=0,frameHeight:_=0}=S,v=k*_;C==="video"&&v>r&&(a=S,r=v)}if(!a||!this.previousStats[a.id])return[];const c=this.previousStats[a.id],{framesDecoded:d=0,framesPerSecond:p=0,totalDecodeTime:g=0,trackIdentifier:m}=a,o=g-(c.totalDecodeTime||0),l=d-(c.framesDecoded||0),h=l>0?o/l*1e3:0;this.frameTimeHistory.push(h),this.fpsHistory.push(p);const u=this.trackIdToTrackType.get(m)||b.VIDEO;return[He.create({trackType:u,codec:Zt(n,a.codecId),avgFrameTimeMs:Ae(this.frameTimeHistory),avgFps:Ae(this.fpsHistory),videoDimension:{width:a.frameWidth,height:a.frameHeight}})]},this.withOverrides=n=>{if(this.costOverrides)for(const a of n){const r=this.costOverrides.get(a.trackType);r!==void 0&&(a.avgFrameTimeMs=r+(a.avgFrameTimeMs||0)/1e3)}return n},this.setCost=(n,a=b.VIDEO)=>{this.costOverrides||(this.costOverrides=new Map),this.costOverrides.set(a,n)},this.pc=t,this.peerType=i,this.trackIdToTrackType=e}}const br=s=>{const t={};return s.forEach((i,e)=>{t[e]=i}),t},Tr=(s,t)=>{t=JSON.parse(JSON.stringify(t));for(const[n,a]of Object.entries(t))if(delete a.id,!!s[n])for(const[r,c]of Object.entries(a))c===s[n][r]&&delete a[r];let i=-1/0;const e=Object.values(t);for(const n of e)n.timestamp>i&&(i=n.timestamp);for(const n of e)n.timestamp===i&&(n.timestamp=0);return t.timestamp=i,t},Ae=s=>s.reduce((t,i)=>t+i,0)/s.length,Zt=(s,t)=>{if(!t||!s[t])return;const i=s[t];return Y.create({name:i.mimeType.split("/").pop(),clockRate:i.clockRate,payloadType:i.payloadType,fmtp:i.sdpFmtpLine})};class At{constructor(t){this.buffer=[],this.enabled=!0,this.setEnabled=i=>{this.enabled!==i&&(this.enabled=i,this.buffer=[])},this.trace=(i,e)=>{this.enabled&&this.buffer.push([i,this.id,e,Date.now()])},this.take=()=>{const i=this.buffer;return this.buffer=[],{snapshot:i,rollback:()=>{this.buffer.unshift(...i)}}},this.dispose=()=>{this.buffer=[]},this.id=t}}class _s{constructor(t,{sfuClient:i,connectionConfig:e,state:n,dispatcher:a,onReconnectionNeeded:r,logTag:c,enableTracing:d,iceRestartDelay:p=2500}){if(this.isIceRestarting=!1,this.isDisposed=!1,this.trackIdToTrackType=new Map,this.subscriptions=[],this.lock=Math.random().toString(36).slice(2),this.createPeerConnection=g=>{const m=new RTCPeerConnection(g);return m.addEventListener("icecandidate",this.onIceCandidate),m.addEventListener("icecandidateerror",this.onIceCandidateError),m.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),m.addEventListener("icegatheringstatechange",this.onIceGatherChange),m.addEventListener("signalingstatechange",this.onSignalingChange),m.addEventListener("connectionstatechange",this.onConnectionStateChange),m},this.tryRestartIce=()=>{this.restartIce().catch(g=>{var l;const m="restartICE() failed, initiating reconnect";this.logger("error",m,g);const o=g instanceof Ot&&g.error.code===ae.PARTICIPANT_SIGNAL_LOST?w.FAST:w.REJOIN;(l=this.onReconnectionNeeded)==null||l.call(this,o,m)})},this.on=(g,m)=>{this.subscriptions.push(this.dispatcher.on(g,o=>{const l=`pc.${this.lock}.${g}`;W(l,async()=>m(o)).catch(h=>{this.isDisposed||this.logger("warn",`Error handling ${g}`,h)})}))},this.addTrickledIceCandidates=()=>{var o;const{iceTrickleBuffer:g}=this.sfuClient,m=this.peerType===L.SUBSCRIBER?g.subscriberCandidates:g.publisherCandidates;(o=this.unsubscribeIceTrickle)==null||o.call(this),this.unsubscribeIceTrickle=Xe(m,async l=>this.pc.addIceCandidate(l).catch(h=>{this.isDisposed||this.logger("warn","ICE candidate error",h,l)}))},this.setSfuClient=g=>{this.sfuClient=g},this.getStats=g=>this.pc.getStats(g),this.getTrackType=g=>this.trackIdToTrackType.get(g),this.isHealthy=()=>{const g=new Set(["failed","closed"]),m=this.pc.iceConnectionState,o=this.pc.connectionState;return!g.has(m)&&!g.has(o)},this.onIceCandidate=g=>{const{candidate:m}=g;if(!m){this.logger("debug","null ice candidate");return}const o=this.asJSON(m);this.sfuClient.iceTrickle({peerType:this.peerType,iceCandidate:o}).catch(l=>{this.isDisposed||this.logger("warn","ICETrickle failed",l)})},this.asJSON=g=>{if(!g.usernameFragment){const m=g.candidate.split(" "),o=m.findIndex(h=>h==="ufrag")+1,l=m[o];return JSON.stringify({...g,usernameFragment:l})}return JSON.stringify(g.toJSON())},this.onConnectionStateChange=async()=>{var m;const g=this.pc.connectionState;if(this.logger("debug","Connection state changed",g),this.tracer&&(g==="connected"||g==="failed"))try{const o=await this.stats.get();this.tracer.trace("getstats",o.delta)}catch(o){this.tracer.trace("getstatsOnFailure",o.toString())}if(g==="failed"){(m=this.onReconnectionNeeded)==null||m.call(this,w.REJOIN,"Connection failed");return}this.handleConnectionStateUpdate(g)},this.onIceConnectionStateChange=()=>{const g=this.pc.iceConnectionState;this.logger("debug","ICE connection state changed",g),this.handleConnectionStateUpdate(g)},this.handleConnectionStateUpdate=g=>{const{callingState:m}=this.state;if(m!==y.OFFLINE&&m!==y.RECONNECTING&&!this.isIceRestarting)switch(g){case"failed":this.logger("info","restartICE due to failed connection"),this.tryRestartIce();break;case"disconnected":this.logger("info","disconnected connection, scheduling restartICE"),clearTimeout(this.iceRestartTimeout),this.iceRestartTimeout=setTimeout(()=>{const o=this.pc.iceConnectionState;(o==="disconnected"||o==="failed")&&this.tryRestartIce()},this.iceRestartDelay);break;case"connected":this.iceRestartTimeout&&(this.logger("info","connected connection, canceling restartICE"),clearTimeout(this.iceRestartTimeout),this.iceRestartTimeout=void 0);break}},this.onIceCandidateError=g=>{const m=g instanceof RTCPeerConnectionIceErrorEvent?`${g.errorCode}: ${g.errorText}`:g;this.logger("debug","ICE Candidate error",m)},this.onIceGatherChange=()=>{this.logger("debug","ICE Gathering State",this.pc.iceGatheringState)},this.onSignalingChange=()=>{this.logger("debug","Signaling state changed",this.pc.signalingState)},this.peerType=t,this.sfuClient=i,this.state=n,this.dispatcher=a,this.iceRestartDelay=p,this.onReconnectionNeeded=r,this.logger=R([t===L.SUBSCRIBER?"Subscriber":"Publisher",c]),this.pc=this.createPeerConnection(e),this.stats=new Sr(this.pc,t,this.trackIdToTrackType),d){const g=`${c}-${t===L.SUBSCRIBER?"sub":"pub"}`;this.tracer=new At(g),this.tracer.trace("create",{url:i.edgeName,...e}),fr(this.pc,this.tracer.trace)}}dispose(){var t;clearTimeout(this.iceRestartTimeout),this.iceRestartTimeout=void 0,this.onReconnectionNeeded=void 0,this.isDisposed=!0,this.detachEventHandlers(),this.pc.close(),(t=this.tracer)==null||t.dispose()}detachEventHandlers(){var i;const t=this.pc;t.removeEventListener("icecandidate",this.onIceCandidate),t.removeEventListener("icecandidateerror",this.onIceCandidateError),t.removeEventListener("signalingstatechange",this.onSignalingChange),t.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),t.removeEventListener("icegatheringstatechange",this.onIceGatherChange),(i=this.unsubscribeIceTrickle)==null||i.call(this),this.subscriptions.forEach(e=>e())}}class Cr{constructor(){this.cache=[],this.layers=[],this.transceiverOrder=[],this.add=(t,i)=>{this.cache.push({publishOption:t,transceiver:i}),this.transceiverOrder.push(i)},this.get=t=>{var i;return(i=this.findTransceiver(t))==null?void 0:i.transceiver},this.has=t=>!!this.get(t),this.find=t=>this.cache.find(t),this.items=()=>this.cache,this.indexOf=t=>this.transceiverOrder.indexOf(t),this.getLayers=t=>{const i=this.layers.find(e=>e.publishOption.id===t.id&&e.publishOption.trackType===t.trackType);return i==null?void 0:i.layers},this.setLayers=(t,i=[])=>{const e=this.findLayer(t);e?e.layers=i:this.layers.push({publishOption:t,layers:i})},this.findTransceiver=t=>this.cache.find(i=>i.publishOption.id===t.id&&i.publishOption.trackType===t.trackType),this.findLayer=t=>this.layers.find(i=>i.publishOption.id===t.id&&i.publishOption.trackType===t.trackType)}}const Ee=(s,t)=>{R(["helpers"])("warn",t,s)},Nt=s=>{switch(s){case b.SCREEN_SHARE:return"screenShareStream";case b.SCREEN_SHARE_AUDIO:return"screenShareAudioStream";case b.VIDEO:return"videoStream";case b.AUDIO:return"audioStream";case b.UNSPECIFIED:throw new Error("Track type is unspecified");default:Ee(s,"Unknown track type")}},yr=s=>{switch(s){case"audio":return b.AUDIO;case"video":return b.VIDEO;case"screenshare":return b.SCREEN_SHARE;case"screenshare_audio":return b.SCREEN_SHARE_AUDIO;default:Ee(s,"Unknown mute type")}},kr=s=>{switch(s){case"TRACK_TYPE_AUDIO":return b.AUDIO;case"TRACK_TYPE_VIDEO":return b.VIDEO;case"TRACK_TYPE_SCREEN_SHARE":return b.SCREEN_SHARE;case"TRACK_TYPE_SCREEN_SHARE_AUDIO":return b.SCREEN_SHARE_AUDIO;default:return}},Ut=s=>s===b.AUDIO||s===b.SCREEN_SHARE_AUDIO,wr={q:3e5,h:75e4,f:125e4},vr=s=>{if(!s)return;const t=e=>n=>n.rid===e;return[{...s.find(t("f"))||s.find(t("h"))||s.find(t("q")),rid:"q"}]},Er=s=>s==="q"?Z.LOW_UNSPECIFIED:s==="h"?Z.MID:Z.HIGH,Ir=(s=[])=>s.map(t=>({rid:t.rid||"",bitrate:t.maxBitrate||0,fps:t.maxFramerate||0,quality:Er(t.rid||""),videoDimension:{width:t.width,height:t.height}})),_r=(s,t)=>`L${s}T${t}${s>1?"_KEY":""}`,Xt=(s,t)=>{if(Ut(t.trackType))return;const i=[],e=s.getSettings(),{width:n=0,height:a=0}=e,{bitrate:r,codec:c,fps:d,maxSpatialLayers:p=3,maxTemporalLayers:g=3,videoDimension:m={width:1280,height:720},useSingleLayer:o}=t,l=Rr(m,n,a,r);let h=1,u=1;const f=Tt(c==null?void 0:c.name);for(const S of["f","h","q"].slice(0,p)){const C={active:!0,rid:S,width:Math.round(n/h),height:Math.round(a/h),maxBitrate:Math.round(l/u)||wr[S],maxFramerate:d};f?C.scalabilityMode=_r(o?1:p,g):C.scaleResolutionDownBy=h,h*=2,u*=2,i.unshift(C)}return Pr(e,i,o)},Rr=(s,t,i,e)=>{const{width:n,height:a}=s;if(t<n||i<a){const r=t*i,c=n*a,d=r/c;return Math.round(e*d)}return e},Pr=(s,t,i)=>{let e;const n=Math.max(s.width||0,s.height||0);n<=320?e=t.filter(r=>r.rid==="f"):n<=640?e=t.filter(r=>r.rid!=="q"):e=t;const a=["q","h","f"];return e.map((r,c,d)=>({...r,rid:a[c],active:i&&c<d.length-1?!1:r.active}))},Dr=(s,t,i)=>{if(s.mid)return s.mid;if(!i)return String(t);const e=s.sender.track,a=Ue.parse(i).media.find(r=>{var c;return r.type===e.kind&&(((c=r.msid)==null?void 0:c.includes(e.id))??!0)});return typeof(a==null?void 0:a.mid)<"u"?String(a.mid):t<0?"":String(t)},Or=(s,t)=>{const i=new Set,e=Ue.parse(s);for(const a of e.media){if(a.type!=="audio")continue;const r=a.rtp.find(c=>c.codec==="opus");if(r)for(const c of a.fmtp)c.payload===r.payload&&c.config.includes("stereo=1")&&i.add(a.mid)}if(i.size===0)return t;const n=Ue.parse(t);for(const a of n.media){if(a.type!=="audio"||!i.has(a.mid))continue;const r=a.rtp.find(c=>c.codec==="opus");if(r)for(const c of a.fmtp)c.payload===r.payload&&!c.config.includes("stereo=1")&&(c.config+=";stereo=1")}return Ue.write(n)};class Ar extends _s{constructor({publishOptions:t,...i}){super(L.PUBLISHER_UNSPECIFIED,i),this.transceiverCache=new Cr,this.clonedTracks=new Set,this.publish=async(e,n)=>{if(!this.publishOptions.some(a=>a.trackType===n))throw new Error(`No publish options found for ${b[n]}`);for(const a of this.publishOptions){if(a.trackType!==n)continue;const r=this.cloneTrack(e),c=this.transceiverCache.get(a);if(!c)await this.addTransceiver(r,a);else{const d=c.sender.track;await this.updateTransceiver(c,r,n),M()||this.stopTrack(d)}}},this.addTransceiver=async(e,n)=>{var g;const a=Xt(e,n),r=Tt((g=n.codec)==null?void 0:g.name)?vr(a):a,c=this.pc.addTransceiver(e,{direction:"sendonly",sendEncodings:r}),d=c.sender.getParameters();d.degradationPreference="maintain-framerate",await c.sender.setParameters(d);const p=n.trackType;this.logger("debug",`Added ${b[p]} transceiver`),this.transceiverCache.add(n,c),this.trackIdToTrackType.set(e.id,p),await this.negotiate()},this.updateTransceiver=async(e,n,a)=>{const r=e.sender;r.track&&this.trackIdToTrackType.delete(r.track.id),await r.replaceTrack(n),n&&this.trackIdToTrackType.set(n.id,a)},this.syncPublishOptions=async()=>{for(const e of this.publishOptions){const{trackType:n}=e;if(!this.isPublishing(n)||this.transceiverCache.has(e))continue;const a=this.transceiverCache.find(c=>!!c.transceiver.sender.track&&c.publishOption.trackType===n);if(!a||!a.transceiver)continue;const r=this.cloneTrack(a.transceiver.sender.track);await this.addTransceiver(r,e)}for(const e of this.transceiverCache.items()){const{publishOption:n,transceiver:a}=e;this.publishOptions.some(c=>c.id===n.id&&c.trackType===n.trackType)||(this.stopTrack(a.sender.track),await this.updateTransceiver(a,null,n.trackType))}},this.isPublishing=e=>{for(const n of this.transceiverCache.items()){if(e&&n.publishOption.trackType!==e)continue;const a=n.transceiver.sender.track;if(a&&a.readyState==="live"&&a.enabled)return!0}return!1},this.stopTracks=(...e)=>{for(const n of this.transceiverCache.items()){const{publishOption:a,transceiver:r}=n;e.includes(a.trackType)&&this.stopTrack(r.sender.track)}},this.stopAllTracks=()=>{for(const{transceiver:e}of this.transceiverCache.items())this.stopTrack(e.sender.track);for(const e of this.clonedTracks)this.stopTrack(e)},this.changePublishQuality=async e=>{var f;const{trackType:n,layers:a,publishOptionId:r}=e,c=a.filter(S=>S.active),d="Update publish quality:";this.logger("info",`${d} requested layers by SFU:`,c);const p=this.transceiverCache.find(S=>S.publishOption.id===r&&S.publishOption.trackType===n),g=p==null?void 0:p.transceiver.sender;if(!g)return this.logger("warn",`${d} no video sender found.`);const m=g.getParameters();if(m.encodings.length===0)return this.logger("warn",`${d} there are no encodings set.`);const o=(f=p==null?void 0:p.publishOption.codec)==null?void 0:f.name,l=o&&Tt(o);let h=!1;for(const S of m.encodings){const C=l?c[0]:c.find(A=>A.name===S.rid)??(m.encodings.length===1?c[0]:void 0),k=!!(C!=null&&C.active);if(k!==S.active&&(S.active=k,h=!0),!C)continue;const{maxFramerate:_,scaleResolutionDownBy:v,maxBitrate:I,scalabilityMode:P}=C;v>=1&&v!==S.scaleResolutionDownBy&&(S.scaleResolutionDownBy=v,h=!0),I>0&&I!==S.maxBitrate&&(S.maxBitrate=I,h=!0),_>0&&_!==S.maxFramerate&&(S.maxFramerate=_,h=!0),P&&P!==S.scalabilityMode&&(S.scalabilityMode=P,h=!0)}const u=m.encodings.filter(S=>S.active);if(!h)return this.logger("info",`${d} no change:`,u);await g.setParameters(m),this.logger("info",`${d} enabled rids:`,u)},this.restartIce=async()=>{this.logger("debug","Restarting ICE connection");const e=this.pc.signalingState;if(this.isIceRestarting||e==="have-local-offer"){this.logger("debug","ICE restart is already in progress");return}await this.negotiate({iceRestart:!0})},this.negotiate=async e=>W(`publisher.negotiate.${this.lock}`,async()=>{const n=await this.pc.createOffer(e),a=this.getAnnouncedTracks(n.sdp);if(!a.length)throw new Error("Can't negotiate without any tracks");try{this.isIceRestarting=(e==null?void 0:e.iceRestart)??!1,await this.pc.setLocalDescription(n);const{sdp:r=""}=n,{response:c}=await this.sfuClient.setPublisher({sdp:r,tracks:a});if(c.error)throw new Ot(c.error);const{sdp:d}=c;await this.pc.setRemoteDescription({type:"answer",sdp:d})}catch(r){throw this.pc.signalingState==="have-local-offer"&&await this.pc.setLocalDescription({type:"rollback"}),r}finally{this.isIceRestarting=!1}this.addTrickledIceCandidates()}),this.getPublishedTracks=()=>{const e=[];for(const{transceiver:n}of this.transceiverCache.items()){const a=n.sender.track;a&&a.readyState==="live"&&e.push(a)}return e},this.getAnnouncedTracks=e=>{const n=[];for(const a of this.transceiverCache.items()){const{transceiver:r,publishOption:c}=a;r.sender.track&&n.push(this.toTrackInfo(r,c,e))}return n},this.getAnnouncedTracksForReconnect=()=>{var a;const e=(a=this.pc.localDescription)==null?void 0:a.sdp,n=[];for(const r of this.publishOptions){const c=this.transceiverCache.get(r);!c||!c.sender.track||n.push(this.toTrackInfo(c,r,e))}return n},this.toTrackInfo=(e,n,a)=>{var l;const r=e.sender.track,c=r.readyState==="live",d=c?Xt(r,n):this.transceiverCache.getLayers(n);this.transceiverCache.setLayers(n,d);const p=Ut(n.trackType),g=p&&r.getSettings().channelCount===2,m=this.transceiverCache.indexOf(e),o=(l=this.state.settings)==null?void 0:l.audio;return{trackId:r.id,layers:Ir(d),trackType:n.trackType,mid:Dr(e,m,a),stereo:g,dtx:p&&!!(o!=null&&o.opus_dtx_enabled),red:p&&!!(o!=null&&o.redundant_coding_enabled),muted:!c,codec:n.codec,publishOptionId:n.id}},this.cloneTrack=e=>{const n=e.clone();return this.clonedTracks.add(n),n},this.stopTrack=e=>{e&&(e.stop(),this.clonedTracks.delete(e))},this.publishOptions=t,this.on("iceRestart",e=>{e.peerType===L.PUBLISHER_UNSPECIFIED&&this.tryRestartIce()}),this.on("changePublishQuality",async e=>{for(const n of e.videoSenders)await this.changePublishQuality(n)}),this.on("changePublishOptions",e=>(this.publishOptions=e.publishOptions,this.syncPublishOptions()))}dispose(){super.dispose(),this.stopAllTracks(),this.clonedTracks.clear()}}class Nr extends _s{constructor(t){super(L.SUBSCRIBER,t),this.restartIce=async()=>{if(this.logger("debug","Restarting ICE connection"),this.pc.signalingState==="have-remote-offer"){this.logger("debug","ICE restart is already in progress");return}if(this.pc.connectionState==="new"){this.logger("debug","ICE connection is not yet established, skipping restart.");return}const i=this.isIceRestarting;this.isIceRestarting=!0;try{const{response:e}=await this.sfuClient.iceRestart({peerType:L.SUBSCRIBER});if(e.error)throw new Ot(e.error)}catch(e){throw this.isIceRestarting=i,e}},this.handleOnTrack=i=>{const[e]=i.streams,[n,a]=e.id.split(":"),r=this.state.participants.find(m=>m.trackLookupPrefix===n);this.logger("debug",`[onTrack]: Got remote ${a} track for userId: ${r==null?void 0:r.userId}`,i.track.id,i.track);const c=`${r==null?void 0:r.userId} ${a}:${n}`;i.track.addEventListener("mute",()=>{this.logger("info",`[onTrack]: Track muted: ${c}`)}),i.track.addEventListener("unmute",()=>{this.logger("info",`[onTrack]: Track unmuted: ${c}`)}),i.track.addEventListener("ended",()=>{this.logger("info",`[onTrack]: Track ended: ${c}`),this.state.removeOrphanedTrack(e.id)});const d=kr(a);if(!d)return this.logger("error",`Unknown track type: ${a}`);if(this.trackIdToTrackType.set(i.track.id,d),!r){this.logger("warn",`[onTrack]: Received track for unknown participant: ${n}`,i),this.state.registerOrphanedTrack({id:e.id,trackLookupPrefix:n,track:e,trackType:d});return}const p=Nt(d);if(!p){this.logger("error",`Unknown track type: ${a}`);return}const g=r[p];this.state.updateParticipant(r.sessionId,{[p]:e}),g&&(this.logger("info",`[onTrack]: Cleaning up previous remote ${i.track.kind} tracks for userId: ${r.userId}`),g.getTracks().forEach(m=>{m.stop(),g.removeTrack(m)}))},this.negotiate=async i=>{await this.pc.setRemoteDescription({type:"offer",sdp:i.sdp}),this.addTrickledIceCandidates();const e=await this.pc.createAnswer();e.sdp&&(e.sdp=Or(i.sdp,e.sdp)),await this.pc.setLocalDescription(e),await this.sfuClient.sendAnswer({peerType:L.SUBSCRIBER,sdp:e.sdp||""}),this.isIceRestarting=!1},this.pc.addEventListener("track",this.handleOnTrack),this.on("subscriberOffer",async i=>this.negotiate(i).catch(e=>{this.logger("error","Negotiation failed.",e)}))}detachEventHandlers(){super.detachEventHandlers(),this.pc.removeEventListener("track",this.handleOnTrack)}}const Ur=s=>{const{endpoint:t,onMessage:i,logTag:e}=s,n=R(["SfuClientWS",e]);n("debug","Creating signaling WS channel:",t);const a=new WebSocket(t);return a.binaryType="arraybuffer",a.addEventListener("error",r=>{n("error","Signaling WS channel error",r)}),a.addEventListener("close",r=>{n("info","Signaling WS channel is closed",r)}),a.addEventListener("open",r=>{n("info","Signaling WS channel is open",r)}),a.addEventListener("message",r=>{try{const c=r.data instanceof ArrayBuffer?Wt.fromBinary(new Uint8Array(r.data)):Wt.fromJsonString(r.data.toString());i(c)}catch(c){n("error","Failed to decode a message. Check whether the Proto models match.",{event:r,error:c})}}),a},Lr=s=>({bundlePolicy:"max-bundle",iceServers:s.map(t=>({urls:t.urls,username:t.username,credential:t.password}))});function Ie(s){let t=!0;const i=s.then(n=>({status:"resolved",result:n}),n=>({status:"rejected",error:n})).finally(()=>t=!1),e=()=>i.then(n=>{if(n.status==="rejected")throw n.error;return n.result});return e.checkPending=()=>t,e}const Ce=()=>{let s,t;const i=new Promise((c,d)=>{s=c,t=d});let e=!1,n=!1;return{promise:i,resolve:c=>{e=!0,s(c)},reject:c=>{n=!0,t(c)},isResolved:()=>e,isRejected:()=>n}},es=Symbol("uninitialized");function oe(s){let t=es;return()=>(t===es&&(t=s()),t)}const $r={src:`const timerIdMapping = new Map();
self.addEventListener('message', (event) => {
    const request = event.data;
    switch (request.type) {
        case 'setTimeout':
        case 'setInterval':
            timerIdMapping.set(request.id, (request.type === 'setTimeout' ? setTimeout : setInterval)(() => {
                tick(request.id);
                if (request.type === 'setTimeout') {
                    timerIdMapping.delete(request.id);
                }
            }, request.timeout));
            break;
        case 'clearTimeout':
        case 'clearInterval':
            (request.type === 'clearTimeout' ? clearTimeout : clearInterval)(timerIdMapping.get(request.id));
            timerIdMapping.delete(request.id);
            break;
    }
});
function tick(id) {
    const message = { type: 'tick', id };
    self.postMessage(message);
}`};class Mr{constructor(){this.currentTimerId=1,this.callbacks=new Map,this.fallback=!1}setup({useTimerWorker:t=!0}={}){if(!t){this.fallback=!0;return}try{const i=$r.src,e=new Blob([i],{type:"application/javascript; charset=utf-8"}),n=URL.createObjectURL(e);this.worker=new Worker(n,{name:"str-timer-worker"}),this.worker.addEventListener("message",a=>{var d;const{type:r,id:c}=a.data;r==="tick"&&((d=this.callbacks.get(c))==null||d())})}catch(i){R(["timer-worker"])("error",i),this.fallback=!0}}destroy(){var t;this.callbacks.clear(),(t=this.worker)==null||t.terminate(),this.worker=void 0,this.fallback=!1}get ready(){return this.fallback||!!this.worker}setInterval(t,i){return this.setTimer("setInterval",t,i)}clearInterval(t){this.clearTimer("clearInterval",t)}setTimeout(t,i){return this.setTimer("setTimeout",t,i)}clearTimeout(t){this.clearTimer("clearTimeout",t)}setTimer(t,i,e){if(this.ready||this.setup(),this.fallback)return(t==="setTimeout"?setTimeout:setInterval)(i,e);const n=this.getTimerId();return this.callbacks.set(n,()=>{i(),t==="setTimeout"&&this.callbacks.delete(n)}),this.sendMessage({type:t,id:n,timeout:e}),n}clearTimer(t,i){if(i){if(this.ready||this.setup(),this.fallback){(t==="clearTimeout"?clearTimeout:clearInterval)(i);return}this.callbacks.delete(i),this.sendMessage({type:t,id:i})}}getTimerId(){return this.currentTimerId++}sendMessage(t){if(!this.worker)throw new Error("Cannot use timer worker before it's set up");this.worker.postMessage(t)}}let Rs=!1;const Fr=()=>{Rs=!0},Je=oe(()=>{const s=new Mr;return s.setup({useTimerWorker:Rs}),s});class H{constructor({dispatcher:t,credentials:i,sessionId:e,logTag:n,joinResponseTimeout:a=5e3,onSignalClose:r,streamClient:c,enableTracing:d}){this.iceTrickleBuffer=new Wa,this.isLeaving=!1,this.isClosingClean=!1,this.pingIntervalInMs=5*1e3,this.unhealthyTimeoutInMs=15*1e3,this.joinResponseTask=Ce(),this.abortController=new AbortController,this.createWebSocket=()=>{const m={callEnded:!0,changePublishQuality:!0,changePublishOptions:!0,connectionQualityChanged:!0,error:!0,goAway:!0};this.signalWs=Ur({logTag:this.logTag,endpoint:`${this.credentials.server.ws_endpoint}?tag=${this.logTag}`,onMessage:o=>{var h;this.lastMessageTimestamp=new Date,this.scheduleConnectionCheck();const l=o.eventPayload.oneofKind;m[l]&&((h=this.tracer)==null||h.trace(l,o)),this.dispatcher.dispatch(o,this.logTag)}}),this.signalReady=Ie(Promise.race([new Promise((o,l)=>{const h=()=>{this.signalWs.removeEventListener("open",h),o(this.signalWs)};this.signalWs.addEventListener("open",h),this.signalWs.addEventListener("close",u=>{this.handleWebSocketClose(u),l(new Error("SFU WS closed or connection can't be established"))})}),new Promise((o,l)=>{setTimeout(()=>l(new Error("SFU WS connection timed out")),this.joinResponseTimeout)})]))},this.cleanUpWebSocket=()=>{this.signalWs.removeEventListener("close",this.handleWebSocketClose)},this.handleWebSocketClose=m=>{var o;this.signalWs.removeEventListener("close",this.handleWebSocketClose),Je().clearInterval(this.keepAliveInterval),clearTimeout(this.connectionCheckTimeout),(o=this.onSignalClose)==null||o.call(this,`${m.code} ${m.reason}`)},this.close=(m=H.NORMAL_CLOSURE,o)=>{this.isClosingClean=m!==H.ERROR_CONNECTION_UNHEALTHY,this.signalWs.readyState===WebSocket.OPEN&&(this.logger("debug",`Closing SFU WS connection: ${m} - ${o}`),this.signalWs.close(m,`js-client: ${o}`),this.cleanUpWebSocket()),this.dispose()},this.dispose=()=>{var m;this.logger("debug","Disposing SFU client"),this.unsubscribeIceTrickle(),this.unsubscribeNetworkChanged(),clearInterval(this.keepAliveInterval),clearTimeout(this.connectionCheckTimeout),clearTimeout(this.migrateAwayTimeout),this.abortController.abort(),(m=this.migrationTask)==null||m.resolve(),this.iceTrickleBuffer.dispose()},this.getTrace=()=>{var m;return(m=this.tracer)==null?void 0:m.take()},this.leaveAndClose=async m=>{await this.joinTask;try{this.isLeaving=!0,await this.notifyLeave(m)}catch(o){this.logger("debug","Error notifying SFU about leaving call",o)}this.close(H.NORMAL_CLOSURE,m.substring(0,115))},this.updateSubscriptions=async m=>(await this.joinTask,z(()=>this.rpc.updateSubscriptions({sessionId:this.sessionId,tracks:m}),this.abortController.signal)),this.setPublisher=async m=>(await this.joinTask,z(()=>this.rpc.setPublisher({...m,sessionId:this.sessionId}),this.abortController.signal)),this.sendAnswer=async m=>(await this.joinTask,z(()=>this.rpc.sendAnswer({...m,sessionId:this.sessionId}),this.abortController.signal)),this.iceTrickle=async m=>(await this.joinTask,z(()=>this.rpc.iceTrickle({...m,sessionId:this.sessionId}),this.abortController.signal)),this.iceRestart=async m=>(await this.joinTask,z(()=>this.rpc.iceRestart({...m,sessionId:this.sessionId}),this.abortController.signal)),this.updateMuteStates=async m=>(await this.joinTask,z(()=>this.rpc.updateMuteStates({muteStates:m,sessionId:this.sessionId}),this.abortController.signal)),this.sendStats=async m=>(await this.joinTask,this.rpc.sendStats({...m,sessionId:this.sessionId})),this.startNoiseCancellation=async()=>(await this.joinTask,z(()=>this.rpc.startNoiseCancellation({sessionId:this.sessionId}),this.abortController.signal)),this.stopNoiseCancellation=async()=>(await this.joinTask,z(()=>this.rpc.stopNoiseCancellation({sessionId:this.sessionId}),this.abortController.signal)),this.enterMigration=async(m={})=>{var u;this.isLeaving=!0;const{timeout:o=7*1e3}=m;(u=this.migrationTask)==null||u.reject(new Error("Cancelled previous migration"));const l=this.migrationTask=Ce(),h=this.dispatcher.on("participantMigrationComplete",()=>{h(),clearTimeout(this.migrateAwayTimeout),l.resolve()});return this.migrateAwayTimeout=setTimeout(()=>{h(),l.reject(new Error(`Migration (${this.logTag}) failed to complete in ${o}ms`))},o),l.promise},this.join=async m=>{var f;await this.signalReady(),(this.joinResponseTask.isResolved()||this.joinResponseTask.isRejected())&&(this.joinResponseTask=Ce());const o=this.joinResponseTask;let l;const h=this.dispatcher.on("joinResponse",S=>{this.logger("debug","Received joinResponse",S),clearTimeout(l),h(),this.keepAlive(),o.resolve(S)});l=setTimeout(()=>{h(),o.reject(new Error('Waiting for "joinResponse" has timed out'))},this.joinResponseTimeout);const u=Se.create({requestPayload:{oneofKind:"joinRequest",joinRequest:fs.create({...m,sessionId:this.sessionId,token:this.credentials.token})}});return(f=this.tracer)==null||f.trace("joinRequest",u),await this.send(u),o.promise},this.ping=async()=>this.send(Se.create({requestPayload:{oneofKind:"healthCheckRequest",healthCheckRequest:{}}})),this.notifyLeave=async m=>this.send(Se.create({requestPayload:{oneofKind:"leaveCallRequest",leaveCallRequest:{sessionId:this.sessionId,reason:m}}})),this.send=async m=>{await this.signalReady();const o=Se.toJson(m);if(this.signalWs.readyState!==WebSocket.OPEN){this.logger("debug","Signal WS is not open. Skipping message",o);return}this.logger("debug",`Sending message to: ${this.edgeName}`,o),this.signalWs.send(Se.toBinary(m))},this.keepAlive=()=>{const m=Je();m.clearInterval(this.keepAliveInterval),this.keepAliveInterval=m.setInterval(()=>{this.ping().catch(o=>{this.logger("error","Error sending healthCheckRequest to SFU",o)})},this.pingIntervalInMs)},this.scheduleConnectionCheck=()=>{clearTimeout(this.connectionCheckTimeout),this.connectionCheckTimeout=setTimeout(()=>{this.lastMessageTimestamp&&new Date().getTime()-this.lastMessageTimestamp.getTime()>this.unhealthyTimeoutInMs&&this.close(H.ERROR_CONNECTION_UNHEALTHY,`SFU connection unhealthy. Didn't receive any message for ${this.unhealthyTimeoutInMs}ms`)},this.unhealthyTimeoutInMs)},this.dispatcher=t,this.sessionId=e||ft(),this.onSignalClose=r,this.credentials=i;const{server:p,token:g}=i;this.edgeName=p.edge_name,this.joinResponseTimeout=a,this.logTag=n,this.logger=R(["SfuClient",n]),this.tracer=d?new At(`${n}-${this.edgeName}`):void 0,this.rpc=La({baseUrl:p.url,interceptors:[Aa({Authorization:`Bearer ${g}`}),this.tracer&&Ua(this.tracer.trace),bt()==="trace"&&Na(this.logger,"trace")].filter(m=>!!m)}),this.unsubscribeIceTrickle=t.on("iceTrickle",m=>{this.iceTrickleBuffer.push(m)}),this.unsubscribeNetworkChanged=c.on("network.changed",m=>{var o;m.online?(o=this.networkAvailableTask)==null||o.resolve():this.networkAvailableTask=Ce()}),this.createWebSocket()}get isHealthy(){return this.signalWs.readyState===WebSocket.OPEN&&this.joinResponseTask.isResolved()}get joinTask(){return this.joinResponseTask.promise}}H.NORMAL_CLOSURE=1e3;H.ERROR_CONNECTION_UNHEALTHY=4001;H.DISPOSE_OLD_SOCKET=4100;H.JOIN_FAILED=4101;const jr=s=>async function(i){if(i.user.id===s.currentUserId)return;const{state:e}=s;i.call.created_by.id===s.currentUserId&&e.callingState===y.RINGING&&await s.join()},Vr=s=>async function(i){if(i.user.id===s.currentUserId)return;const{call:e}=i,{session:n}=e;if(!n){s.logger("warn","No call session provided. Ignoring call.rejected event.",i);return}const a=n.rejected_by,{members:r,callingState:c}=s.state;if(c!==y.RINGING){s.logger("info","Call is not in ringing mode (it is either accepted or rejected already). Ignoring call.rejected event.",i);return}s.isCreatedByMe?r.filter(p=>p.user_id!==s.currentUserId).every(p=>a[p.user_id])&&(s.logger("info","everyone rejected, leaving the call"),await s.leave({reject:!0,reason:"cancel",message:"ring: everyone rejected"})):a[e.created_by.id]&&(s.logger("info","call creator rejected, leaving call"),await s.leave({message:"ring: creator rejected"}))},xr=s=>function(){const{callingState:i}=s.state;i!==y.IDLE&&i!==y.LEFT&&s.leave({message:"call.ended event received",reject:!1}).catch(e=>{s.logger("error","Failed to leave call after call.ended ",e)})},Hr=s=>s.on("callEnded",async t=>{if(s.state.callingState!==y.LEFT)try{if(t.reason===de.LIVE_ENDED){s.state.setBackstage(!0);const{hasPermission:e}=s.permissionsContext;if(e(N.JOIN_BACKSTAGE))return}s.state.setEndedAt(new Date);const i=de[t.reason];await s.leave({message:`callEnded received: ${i}`})}catch(i){s.logger("error","Failed to leave call after being ended by the SFU",i)}}),Br=s=>function(i){const{currentGrants:e}=i;if(e){const{canPublishAudio:n,canPublishVideo:a,canScreenshare:r}=e,c={[N.SEND_AUDIO]:n,[N.SEND_VIDEO]:a,[N.SCREENSHARE]:r},d=s.ownCapabilities.filter(p=>c[p]!==!1);Object.entries(c).forEach(([p,g])=>{g&&!d.includes(p)&&d.push(p)}),s.setOwnCapabilities(d)}},Wr=(s,t)=>s.on("connectionQualityChanged",i=>{const{connectionQualityUpdates:e}=i;e&&t.updateParticipants(e.reduce((n,a)=>{const{sessionId:r,connectionQuality:c}=a;return n[r]={connectionQuality:c},n},{}))}),qr=(s,t)=>s.on("healthCheckResponse",i=>{const{participantCount:e}=i;e&&(t.setParticipantCount(e.total),t.setAnonymousParticipantCount(e.anonymous))}),Jr=(s,t)=>s.on("error",i=>{i.error&&i.error.code!==ae.LIVE_ENDED||(t.state.setBackstage(!0),t.permissionsContext.hasPermission(N.JOIN_BACKSTAGE)||t.leave({message:"live ended"}).catch(e=>{t.logger("error","Failed to leave call after live ended",e)}))}),Gr=s=>s.on("error",t=>{if(!t.error)return;const i=R(["SfuClient"]),{error:e,reconnectStrategy:n}=t;i("error","SFU reported error",{code:ae[e.code],reconnectStrategy:w[n],message:e.message,shouldRetry:e.shouldRetry})}),Kr=s=>function(i){const{pins:e}=i;s.setServerSidePins(e)},Yr=s=>s.on("trackUnpublished",async t=>{const{cause:i,type:e,sessionId:n}=t,{localParticipant:a}=s.state;if(i===ve.MODERATION&&n===(a==null?void 0:a.sessionId)){const r=s.logger;r("info",`Local participant's ${b[e]} track is muted remotely`);try{e===b.VIDEO?await s.camera.disable():e===b.AUDIO?await s.microphone.disable():e===b.SCREEN_SHARE||e===b.SCREEN_SHARE_AUDIO?await s.screenShare.disable():r("warn","Unsupported track type to soft mute",b[e])}catch(c){r("error","Failed to stop publishing",c)}}}),$e=(s,...t)=>{for(const i of t)s.includes(i)||s.push(i);return s},Qr=s=>function(i){const{participant:e}=i;if(!e)return;const n=Lt(s,e);s.updateOrAddParticipant(e.sessionId,Object.assign(e,n,{viewportVisibilityState:{videoTrack:D.UNKNOWN,screenShareTrack:D.UNKNOWN}}))},zr=s=>function(i){const{participant:e}=i;e&&s.setParticipants(n=>n.filter(a=>a.sessionId!==e.sessionId))},Zr=s=>function(i){const{participant:e}=i;e&&s.updateParticipant(e.sessionId,e)},Xr=s=>function(i){const{type:e,sessionId:n}=i;if(i.participant){const a=Lt(s,i.participant),r=Object.assign(i.participant,a);s.updateOrAddParticipant(n,r)}else s.updateParticipant(n,a=>({publishedTracks:$e([...a.publishedTracks],e)}))},eo=s=>function(i){const{type:e,sessionId:n}=i;if(i.participant){const a=Lt(s,i.participant),r=Object.assign(i.participant,a);s.updateOrAddParticipant(n,r)}else s.updateParticipant(n,a=>({publishedTracks:a.publishedTracks.filter(r=>r!==e)}))},Lt=(s,t)=>{const i=s.takeOrphanedTracks(t.trackLookupPrefix);if(!i.length)return;const e={};for(const n of i){const a=Nt(n.trackType);a&&(e[a]=n.track)}return e},to=(s,t)=>s.on("dominantSpeakerChanged",i=>{var n;const{sessionId:e}=i;e!==((n=t.dominantSpeaker)==null?void 0:n.sessionId)&&t.setParticipants(a=>a.map(r=>r.sessionId===e?{...r,isDominantSpeaker:!0}:r.isDominantSpeaker?{...r,isDominantSpeaker:!1}:r))}),so=(s,t)=>s.on("audioLevelChanged",i=>{const{audioLevels:e}=i;t.updateParticipants(e.reduce((n,a)=>(n[a.sessionId]={audioLevel:a.level,isSpeaking:a.isSpeaking},n),{}))}),io=(s,t)=>{const i=s.state,e=[s.on("call.ended",xr(s)),Hr(s),Jr(t,s),Gr(t),Wr(t,i),qr(t,i),s.on("participantJoined",Qr(i)),s.on("participantLeft",zr(i)),s.on("participantUpdated",Zr(i)),s.on("trackPublished",Xr(i)),s.on("trackUnpublished",eo(i)),so(t,i),to(t,i),s.on("callGrantsUpdated",Br(i)),s.on("pinsUpdated",Kr(i)),Yr(s)];return s.ringing&&e.push(Ps(s)),()=>{e.forEach(n=>n())}},Ps=s=>{const t={"call.accepted":jr(s),"call.rejected":Vr(s)},i=Object.keys(t).map(e=>{const n=e;return s.on(n,t[n])});return()=>{i.forEach(e=>e())}},no=.35;class ao{constructor(){this.elementHandlerMap=new Map,this.observer=null,this.queueSet=new Set,this.setViewport=(t,i)=>{const e=()=>{var n;(n=this.observer)==null||n.disconnect(),this.observer=null,this.elementHandlerMap.clear()};return this.observer=new IntersectionObserver(n=>{n.forEach(a=>{const r=this.elementHandlerMap.get(a.target);r==null||r(a)})},{root:t,...i,threshold:(i==null?void 0:i.threshold)??no}),this.queueSet.size&&(this.queueSet.forEach(([n,a])=>{t.contains(n)&&(this.observer.observe(n),this.elementHandlerMap.set(n,a))}),this.queueSet.clear()),e},this.observe=(t,i)=>{const e=[t,i],n=()=>{var a;this.elementHandlerMap.delete(t),(a=this.observer)==null||a.unobserve(t),this.queueSet.delete(e)};return this.elementHandlerMap.has(t)?n:this.observer?(this.observer.root.contains(t)&&(this.elementHandlerMap.set(t,i),this.observer.observe(t)),n):(this.queueSet.add(e),n)}}}const ts={videoTrack:D.UNKNOWN,screenShareTrack:D.UNKNOWN},Ne=Symbol("globalOverrideKey");class ro{constructor(t,i){this.viewportTracker=new ao,this.logger=R(["DynascaleManager"]),this.pendingSubscriptionsUpdate=null,this.videoTrackSubscriptionOverridesSubject=new E({}),this.videoTrackSubscriptionOverrides$=this.videoTrackSubscriptionOverridesSubject.asObservable(),this.incomingVideoSettings$=this.videoTrackSubscriptionOverrides$.pipe(x(e=>{const{[Ne]:n,...a}=e;return{enabled:(n==null?void 0:n.enabled)!==!1,preferredResolution:n!=null&&n.enabled?n.dimension:void 0,participants:Object.fromEntries(Object.entries(a).map(([r,c])=>[r,{enabled:(c==null?void 0:c.enabled)!==!1,preferredResolution:c!=null&&c.enabled?c.dimension:void 0}])),isParticipantVideoEnabled:r=>{var c,d;return((c=e[r])==null?void 0:c.enabled)??((d=e[Ne])==null?void 0:d.enabled)??!0}}}),j(1)),this.dispose=async()=>{this.pendingSubscriptionsUpdate&&clearTimeout(this.pendingSubscriptionsUpdate);const e=this.getOrCreateAudioContext();e&&e.state!=="closed"&&(document.removeEventListener("click",this.resumeAudioContext),await e.close(),this.audioContext=void 0)},this.setVideoTrackSubscriptionOverrides=(e,n)=>n?U(this.videoTrackSubscriptionOverridesSubject,a=>({...a,...Object.fromEntries(n.map(r=>[r,e]))})):U(this.videoTrackSubscriptionOverridesSubject,e?{[Ne]:e}:{}),this.applyTrackSubscriptions=(e=K.SLOW)=>{this.pendingSubscriptionsUpdate&&clearTimeout(this.pendingSubscriptionsUpdate);const n=()=>{var a;this.pendingSubscriptionsUpdate=null,(a=this.sfuClient)==null||a.updateSubscriptions(this.trackSubscriptions).catch(r=>{this.logger("debug","Failed to update track subscriptions",r)})};e?this.pendingSubscriptionsUpdate=setTimeout(n,e):n()},this.trackElementVisibility=(e,n,a)=>{const r=this.viewportTracker.observe(e,c=>{this.callState.updateParticipant(n,d=>{const p=d.viewportVisibilityState??ts,g=c.isIntersecting||document.fullscreenElement===e?D.VISIBLE:D.INVISIBLE;return{...d,viewportVisibilityState:{...p,[a]:g}}})});return()=>{r(),this.callState.updateParticipant(n,c=>{const d=c.viewportVisibilityState??ts;return{...c,viewportVisibilityState:{...d,[a]:D.UNKNOWN}}})}},this.setViewport=e=>this.viewportTracker.setViewport(e),this.bindVideoElement=(e,n,a)=>{const r=this.callState.findParticipantBySessionId(n);if(!r)return;const c=(u,f)=>{f&&(f.width===0||f.height===0)&&(this.logger("debug","Ignoring 0x0 dimension",r),f=void 0),this.callState.updateParticipantTracks(a,{[n]:{dimension:f}}),this.applyTrackSubscriptions(u)},d=this.callState.participants$.pipe(x(u=>u.find(f=>f.sessionId===n)),pt(u=>!!u),B(),j({bufferSize:1,refCount:!0}));let p;const g=r.isLocalParticipant?null:d.pipe(x(u=>{var f;return(f=u.viewportVisibilityState)==null?void 0:f[a]}),B()).subscribe(u=>{if(!p){p=u??D.UNKNOWN;return}if(p=u??D.UNKNOWN,u===D.INVISIBLE)return c(K.MEDIUM,void 0);c(K.MEDIUM,{width:e.clientWidth,height:e.clientHeight})});let m;const o=r.isLocalParticipant?null:new ResizeObserver(()=>{const u={width:e.clientWidth,height:e.clientHeight};if(!m){m=u;return}if(m.width===u.width&&m.height===u.height||p===D.INVISIBLE)return;const S=Math.max(u.width/m.width,u.height/m.height)>1.2?K.IMMEDIATE:K.MEDIUM;c(S,{width:e.clientWidth,height:e.clientHeight}),m=u});o==null||o.observe(e);const l=r.isLocalParticipant?null:d.pipe(Pe("publishedTracks"),x(u=>a==="videoTrack"?le(u):ie(u)),B()).subscribe(u=>{u?c(K.IMMEDIATE,{width:e.clientWidth,height:e.clientHeight}):c(K.FAST,void 0)});e.autoplay=!0,e.playsInline=!0,e.muted=!0;const h=d.pipe(Pe(a==="videoTrack"?"videoStream":"screenShareStream")).subscribe(u=>{const f=a==="videoTrack"?u.videoStream:u.screenShareStream;e.srcObject!==f&&(e.srcObject=f??null,(Ct()||at())&&setTimeout(()=>{e.srcObject=f??null,e.play().catch(S=>{this.logger("warn","Failed to play stream",S)})},25))});return()=>{c(K.FAST,void 0),g==null||g.unsubscribe(),l==null||l.unsubscribe(),h.unsubscribe(),o==null||o.disconnect()}},this.bindAudioElement=(e,n,a)=>{const r=this.callState.findParticipantBySessionId(n);if(!r||r.isLocalParticipant)return;const c=this.callState.participants$.pipe(x(h=>h.find(u=>u.sessionId===n)),pt(h=>!!h),B(),j({bufferSize:1,refCount:!0})),d=(h,u)=>{h&&("setSinkId"in e&&e.setSinkId(h).catch(f=>{this.logger("warn","Can't to set AudioElement sinkId",f)}),u&&"setSinkId"in u&&u.setSinkId(h).catch(f=>{this.logger("warn","Can't to set AudioContext sinkId",f)}))};let p,g;const m=c.pipe(Pe(a==="screenShareAudioTrack"?"screenShareAudioStream":"audioStream")).subscribe(h=>{const u=a==="screenShareAudioTrack"?h.screenShareAudioStream:h.audioStream;e.srcObject!==u&&setTimeout(()=>{if(e.srcObject=u??null,!u)return;const f=this.getOrCreateAudioContext();f?(e.muted=!0,p==null||p.disconnect(),p=f.createMediaStreamSource(u),g??(g=f.createGain()),g.gain.value=h.audioVolume??this.speaker.state.volume,p.connect(g).connect(f.destination),this.resumeAudioContext()):(e.muted=!1,e.play().catch(C=>{this.logger("warn","Failed to play audio stream",C)}));const{selectedDevice:S}=this.speaker.state;S&&d(S,f)})}),o="setSinkId"in e?this.speaker.state.selectedDevice$.subscribe(h=>{const u=this.getOrCreateAudioContext();d(h,u)}):null,l=ne([this.speaker.state.volume$,c.pipe(Pe("audioVolume"))]).subscribe(([h,u])=>{const f=u.audioVolume??h;e.volume=f,g&&(g.gain.value=f)});return e.autoplay=!0,()=>{o==null||o.unsubscribe(),l.unsubscribe(),m.unsubscribe(),e.srcObject=null,p==null||p.disconnect(),g==null||g.disconnect()}},this.getOrCreateAudioContext=()=>{if(this.audioContext||!Ct())return this.audioContext;const e=new AudioContext;return e.state==="suspended"&&document.addEventListener("click",this.resumeAudioContext),this.audioContext=e},this.resumeAudioContext=()=>{var e;((e=this.audioContext)==null?void 0:e.state)==="suspended"&&this.audioContext.resume().catch(n=>this.logger("warn","Can't resume audio context",n)).then(()=>{document.removeEventListener("click",this.resumeAudioContext)})},this.callState=t,this.speaker=i}setSfuClient(t){this.sfuClient=t}get trackSubscriptions(){const t=[];for(const i of this.callState.remoteParticipants){if(i.videoDimension&&le(i)){const e=this.videoTrackSubscriptionOverrides[i.sessionId]??this.videoTrackSubscriptionOverrides[Ne];(e==null?void 0:e.enabled)!==!1&&t.push({userId:i.userId,sessionId:i.sessionId,trackType:b.VIDEO,dimension:(e==null?void 0:e.dimension)??i.videoDimension})}i.screenShareDimension&&ie(i)&&t.push({userId:i.userId,sessionId:i.sessionId,trackType:b.SCREEN_SHARE,dimension:i.screenShareDimension}),Za(i)&&t.push({userId:i.userId,sessionId:i.sessionId,trackType:b.SCREEN_SHARE_AUDIO})}return t}get videoTrackSubscriptionOverrides(){return O(this.videoTrackSubscriptionOverrides$)}}class oo{constructor(){this.permissions=[],this.setPermissions=t=>{this.permissions=t||[]},this.setCallSettings=t=>{this.settings=t},this.hasPermission=t=>this.permissions.includes(t),this.canPublish=t=>{switch(t){case b.AUDIO:return this.hasPermission(N.SEND_AUDIO);case b.VIDEO:return this.hasPermission(N.SEND_VIDEO);case b.SCREEN_SHARE:case b.SCREEN_SHARE_AUDIO:return this.hasPermission(N.SCREENSHARE);case b.UNSPECIFIED:return!1;default:Ee(t,"Unknown track type")}},this.canRequest=(t,i=this.settings)=>{if(!i)return!1;const{audio:e,video:n,screensharing:a}=i;switch(t){case N.SEND_AUDIO:return e.access_request_enabled;case N.SEND_VIDEO:return n.access_request_enabled;case N.SCREENSHARE:return a.access_request_enabled;default:return!1}}}}class ye{constructor(t,i={sortParticipantsBy:Be}){this.name=t,this.options=i}}class co{constructor(t){this.register=i=>{this.callTypes[i.name]=i},this.unregister=i=>{delete this.callTypes[i]},this.get=i=>(this.callTypes[i]||this.register(new ye(i)),this.callTypes[i]),this.callTypes=t.reduce((i,e)=>(i[e.name]=e,i),{})}}const lo=new co([new ye("default",{sortParticipantsBy:Be}),new ye("development",{sortParticipantsBy:Be}),new ye("livestream",{sortParticipantsBy:Kt}),new ye("audio_room",{sortParticipantsBy:Kt})]);class Ds{constructor(t){this.permission=t,this.disposeController=new AbortController,this.wasPrompted=!1,this.listeners=new Set,this.logger=R(["permissions"]);const i=this.disposeController.signal;this.ready=(async()=>{const e=()=>{M()?this.setState("granted"):this.setState("prompt")};if(!ho())return e();try{const n=await navigator.permissions.query({name:t.queryName});i.aborted||(this.setState(n.state),n.addEventListener("change",()=>this.setState(n.state),{signal:i}))}catch(n){this.logger("debug","Failed to query permission status",n),e()}})()}dispose(){this.state=void 0,this.disposeController.abort()}async getState(){if(await this.ready,!this.state)throw new Error("BrowserPermission instance possibly disposed");return this.state}async prompt({forcePrompt:t=!1,throwOnNotAllowed:i=!1}={}){return await W(`permission-prompt-${this.permission.queryName}`,async()=>{if(await this.getState()!=="prompt"||this.wasPrompted&&!t){const e=this.state==="granted";if(!e&&i)throw new Error("Permission was not granted previously, and prompting again is not allowed");return e}try{this.wasPrompted=!0,this.setState("prompting");const e=await navigator.mediaDevices.getUserMedia(this.permission.constraints);return To(e),this.setState("granted"),!0}catch(e){if(e&&typeof e=="object"&&"name"in e&&(e.name==="NotAllowedError"||e.name==="SecurityError")){if(this.logger("info","Browser permission was not granted",{permission:this.permission}),this.setState("denied"),i)throw e;return!1}throw this.logger("error","Failed to getUserMedia",{error:e,permission:this.permission}),this.setState("prompt"),e}})}listen(t){return this.listeners.add(t),this.state&&t(this.state),()=>this.listeners.delete(t)}asObservable(){return this.getStateObservable().pipe(x(t=>t!=="denied"))}asStateObservable(){return this.getStateObservable()}getIsPromptingObservable(){return this.getStateObservable().pipe(x(t=>t==="prompting"))}getStateObservable(){return Gs(t=>this.listen(t),(t,i)=>i())}setState(t){this.state!==t&&(this.state=t,this.listeners.forEach(i=>i(t)))}}function ho(){var s;return!M()&&typeof navigator<"u"&&!!((s=navigator.permissions)!=null&&s.query)}const $t=(s,t)=>is((async()=>{let i=await navigator.mediaDevices.enumerateDevices();return i.some(n=>n.kind===t&&n.label==="")&&await s.prompt()&&(i=await navigator.mediaDevices.enumerateDevices()),i.filter(n=>n.kind===t&&n.label!==""&&n.deviceId!=="default")})()),uo=()=>typeof document>"u"?!1:"setSinkId"in document.createElement("audio"),Os={audio:{autoGainControl:!0,noiseSuppression:!0,echoCancellation:!0}},As={video:{width:1280,height:720}},me=oe(()=>new Ds({constraints:Os,queryName:"microphone"})),Ge=oe(()=>new Ds({constraints:As,queryName:"camera"})),rt=oe(()=>navigator.mediaDevices.addEventListener?qs(navigator.mediaDevices,"devicechange").pipe(x(()=>{}),Js(500)):is([])),po=oe(()=>kt(rt(),me().asObservable()).pipe(Ye(void 0),Qe(()=>$t(me(),"audioinput")),j(1))),mo=oe(()=>kt(rt(),Ge().asObservable()).pipe(Ye(void 0),Qe(()=>$t(Ge(),"videoinput")),j(1))),go=oe(()=>kt(rt(),me().asObservable()).pipe(Ye(void 0),Qe(()=>$t(me(),"audiooutput")),j(1)));let fo=0;const Ns=async(s,t)=>{const i=`navigator.mediaDevices.getUserMedia.${fo++}.`;try{t==null||t.trace(i,s);const e=await navigator.mediaDevices.getUserMedia(s);if(t==null||t.trace(`${i}OnSuccess`,vs(e)),at()&&navigator.mediaDevices.dispatchEvent(new Event("devicechange")),s.video){const[n]=e.getVideoTracks();if(n){const{width:a,height:r}=n.getSettings(),c=s.video;(a!==c.width||r!==c.height)&&(t==null||t.trace(`${i}Warn`,`Requested resolution ${c.width}x${c.height} but got ${a}x${r}`))}}return e}catch(e){throw t==null||t.trace(`${i}OnFailure`,e.name),e}};function Us(s){if(!s||typeof s!="object")return!1;if("name"in s&&typeof s.name=="string"){const t=s.name;if(["OverconstrainedError","NotFoundError"].includes(t))return!0}return!!("message"in s&&typeof s.message=="string"&&s.message.startsWith("OverconstrainedError"))}const Ls=async(s,t)=>{const i={audio:{...Os.audio,...s}};try{return await me().prompt({throwOnNotAllowed:!0,forcePrompt:!0}),await Ns(i,t)}catch(e){if(Us(e)&&(s!=null&&s.deviceId)){const{deviceId:n,...a}=s;return R(["devices"])("warn","Failed to get audio stream, will try again with relaxed constraints",{error:e,constraints:i,relaxedConstraints:a}),Ls(a)}throw R(["devices"])("error","Failed to get audio stream",{error:e,constraints:i}),e}},$s=async(s,t)=>{const i={video:{...As.video,...s}};try{return await Ge().prompt({throwOnNotAllowed:!0,forcePrompt:!0}),await Ns(i,t)}catch(e){if(Us(e)&&(s!=null&&s.deviceId)){const{deviceId:n,...a}=s;return R(["devices"])("warn","Failed to get video stream, will try again with relaxed constraints",{error:e,constraints:i,relaxedConstraints:a}),$s(a)}throw R(["devices"])("error","Failed to get video stream",{error:e,constraints:i}),e}};let So=0;const bo=async(s,t)=>{const i=`navigator.mediaDevices.getDisplayMedia.${So++}.`;try{const e={systemAudio:"include",...s,video:typeof(s==null?void 0:s.video)=="boolean"?s.video:{width:{max:2560},height:{max:1440},frameRate:{ideal:30},...s==null?void 0:s.video},audio:typeof(s==null?void 0:s.audio)=="boolean"?s.audio:{channelCount:{ideal:2},echoCancellation:!1,autoGainControl:!1,noiseSuppression:!1,...s==null?void 0:s.audio}};t==null||t.trace(i,e);const n=await navigator.mediaDevices.getDisplayMedia(e);return t==null||t.trace(`${i}OnSuccess`,vs(n)),n}catch(e){throw t==null||t.trace(`${i}OnFailure`,e.name),R(["devices"])("error","Failed to get screen share stream",e),e}},Ke=typeof navigator<"u"&&typeof navigator.mediaDevices<"u"?rt().pipe(Ye(void 0),Qe(()=>navigator.mediaDevices.enumerateDevices()),j(1)):void 0,To=s=>{s.active&&(s.getTracks().forEach(t=>{t.stop()}),typeof s.release=="function"&&s.release())},Ms=()=>/Mobi/i.test(navigator.userAgent);class Mt{constructor(t,i,e){this.stopOnLeave=!0,this.subscriptions=[],this.isTrackStoppedDueToTrackEnd=!1,this.filters=[],this.statusChangeConcurrencyTag=Symbol("statusChangeConcurrencyTag"),this.filterRegistrationConcurrencyTag=Symbol("filterRegistrationConcurrencyTag"),this.dispose=()=>{this.subscriptions.forEach(n=>n())},this.call=t,this.state=i,this.trackType=e,this.logger=R([`${b[e].toLowerCase()} manager`]),Ke&&!M()&&(this.trackType===b.AUDIO||this.trackType===b.VIDEO)&&this.handleDisconnectedOrReplacedDevices()}listDevices(){return this.getDevices()}get enabled(){return this.state.status==="enabled"}async enable(){this.state.prevStatus=this.state.optimisticStatus,this.state.optimisticStatus!=="enabled"&&(this.state.setPendingStatus("enabled"),await ht(this.statusChangeConcurrencyTag,async t=>{try{await this.unmuteStream(),this.state.setStatus("enabled")}finally{t.aborted||this.state.setPendingStatus(this.state.status)}}))}async disable(t=!1){this.state.prevStatus=this.state.optimisticStatus,!(!t&&this.state.optimisticStatus==="disabled")&&(this.state.setPendingStatus("disabled"),await ht(this.statusChangeConcurrencyTag,async i=>{try{const e=t||this.state.disableMode==="stop-tracks";await this.muteStream(e),this.state.setStatus("disabled")}finally{i.aborted||this.state.setPendingStatus(this.state.status)}}))}async statusChangeSettled(){await dt(this.statusChangeConcurrencyTag)}async resume(){this.state.prevStatus==="enabled"&&this.state.status!=="enabled"&&await this.enable()}async toggle(){return this.state.optimisticStatus==="enabled"?await this.disable():await this.enable()}registerFilter(t){const i={start:t,stop:void 0};return this.call.tracer.trace(`registerFilter.${b[this.trackType]}`,null),{registered:W(this.filterRegistrationConcurrencyTag,async()=>{await dt(this.statusChangeConcurrencyTag),this.filters.push(i),await this.applySettingsToStream()}),unregister:()=>W(this.filterRegistrationConcurrencyTag,async()=>{var n;await dt(this.statusChangeConcurrencyTag),(n=i.stop)==null||n.call(i),this.filters=this.filters.filter(a=>a!==i),await this.applySettingsToStream()})}}setDefaultConstraints(t){this.state.setDefaultConstraints(t)}async select(t){if(M())throw new Error("This method is not supported in React Native. Please visit https://getstream.io/video/docs/reactnative/core/camera-and-microphone/#speaker-management for reference.");const i=this.state.selectedDevice;if(t!==i)try{this.state.setDevice(t),await this.applySettingsToStream()}catch(e){throw this.state.setDevice(i),e}}async applySettingsToStream(){await ht(this.statusChangeConcurrencyTag,async t=>{if(this.enabled)try{if(await this.muteStream(),this.state.setStatus("disabled"),t.aborted)return;await this.unmuteStream(),this.state.setStatus("enabled")}finally{t.aborted||this.state.setPendingStatus(this.state.status)}})}publishStream(t){return this.call.publish(t,this.trackType)}stopPublishStream(){return this.call.stopPublish(this.trackType)}getTracks(){var t;return((t=this.state.mediaStream)==null?void 0:t.getTracks())??[]}async muteStream(t=!0){const i=this.state.mediaStream;if(!i)return;this.logger("debug",`${t?"Stopping":"Disabling"} stream`),this.call.state.callingState===y.JOINED&&await this.stopPublishStream(),this.muteLocalStream(t),this.getTracks().every(n=>n.readyState==="ended")&&(typeof i.release=="function"&&i.release(),this.state.setMediaStream(void 0,void 0),this.filters.forEach(n=>{var a;return(a=n.stop)==null?void 0:a.call(n)}))}disableTracks(){this.getTracks().forEach(t=>{t.enabled&&(t.enabled=!1)})}enableTracks(){this.getTracks().forEach(t=>{t.enabled||(t.enabled=!0)})}stopTracks(){this.getTracks().forEach(t=>{t.readyState==="live"&&t.stop()})}muteLocalStream(t){this.state.mediaStream&&(t?this.stopTracks():this.disableTracks())}async unmuteStream(){this.logger("debug","Starting stream");let t,i;if(this.state.mediaStream&&this.getTracks().every(e=>e.readyState==="live"))t=this.state.mediaStream,this.enableTracks();else{const n={...this.state.defaultConstraints,deviceId:this.state.selectedDevice?{exact:this.state.selectedDevice}:void 0},a=r=>async c=>{if(!r)return c;const d=await r;return c.getTracks().forEach(p=>{const g=p.stop;p.stop=function(){g.call(p),d.getTracks().forEach(o=>{o.kind===p.kind&&o.stop()})}}),d.getTracks().forEach(p=>{const g=()=>{c.getTracks().forEach(m=>{p.kind===m.kind&&(m.stop(),m.dispatchEvent(new Event("ended")))})};p.addEventListener("ended",g),this.subscriptions.push(()=>{p.removeEventListener("ended",g)})}),c};i=this.getStream(n),t=await this.filters.reduce((r,c)=>r.then(d=>{const{stop:p,output:g}=c.start(d);return c.stop=p,g}).then(a(r),d=>(this.logger("warn","Filter failed to start and will be ignored",d),r)),i)}if(this.call.state.callingState===y.JOINED&&await this.publishStream(t),this.state.mediaStream!==t){this.state.setMediaStream(t,await i);const e=async()=>{await this.statusChangeSettled(),this.enabled&&(this.isTrackStoppedDueToTrackEnd=!0,setTimeout(()=>{this.isTrackStoppedDueToTrackEnd=!1},2e3),await this.disable())},n=a=>()=>{!Ms()||this.trackType!==b.VIDEO||this.call.notifyTrackMuteState(a,this.trackType).catch(r=>{this.logger("warn","Error while notifying track mute state",r)})};t.getTracks().forEach(a=>{const r=n(!0),c=n(!1);a.addEventListener("mute",r),a.addEventListener("unmute",c),a.addEventListener("ended",e),this.subscriptions.push(()=>{a.removeEventListener("mute",r),a.removeEventListener("unmute",c),a.removeEventListener("ended",e)})})}}get mediaDeviceKind(){return this.trackType===b.AUDIO?"audioinput":this.trackType===b.VIDEO?"videoinput":""}handleDisconnectedOrReplacedDevices(){this.subscriptions.push(J(ne([Ke.pipe(Ws()),this.state.selectedDevice$]),async([[t,i],e])=>{try{if(!e)return;await this.statusChangeSettled();let n=!1,a=!1;const r=this.findDevice(i,e),c=this.findDevice(t,e);!r&&c?n=!0:r&&c&&r.deviceId===c.deviceId&&r.groupId!==c.groupId&&(a=!0),n&&(await this.disable(),await this.select(void 0)),a&&(this.isTrackStoppedDueToTrackEnd&&this.state.status==="disabled"?(await this.enable(),this.isTrackStoppedDueToTrackEnd=!1):await this.applySettingsToStream())}catch(n){this.logger("warn","Unexpected error while handling disconnected or replaced device",n)}}))}findDevice(t,i){const e=this.mediaDeviceKind;return t.find(n=>n.deviceId===i&&n.kind===e)}}class Ft{constructor(t="stop-tracks",i){this.disableMode=t,this.statusSubject=new E(void 0),this.optimisticStatusSubject=new E(void 0),this.mediaStreamSubject=new E(void 0),this.selectedDeviceSubject=new E(void 0),this.defaultConstraintsSubject=new E(void 0),this.mediaStream$=this.mediaStreamSubject.asObservable(),this.selectedDevice$=this.selectedDeviceSubject.asObservable().pipe(B()),this.status$=this.statusSubject.asObservable().pipe(B()),this.optimisticStatus$=this.optimisticStatusSubject.asObservable().pipe(B()),this.defaultConstraints$=this.defaultConstraintsSubject.asObservable(),this.hasBrowserPermission$=i?i.asObservable().pipe(j(1)):Le(!0),this.browserPermissionState$=i?i.asStateObservable().pipe(j(1)):Le("prompt"),this.isPromptingPermission$=i?i.getIsPromptingObservable().pipe(j(1)):Le(!1)}get status(){return O(this.status$)}get optimisticStatus(){return O(this.optimisticStatus$)}get selectedDevice(){return O(this.selectedDevice$)}get mediaStream(){return O(this.mediaStream$)}setStatus(t){U(this.statusSubject,t)}setPendingStatus(t){U(this.optimisticStatusSubject,t)}setMediaStream(t,i){U(this.mediaStreamSubject,t),i&&this.setDevice(this.getDeviceIdFromStream(i))}setDevice(t){U(this.selectedDeviceSubject,t)}get defaultConstraints(){return O(this.defaultConstraints$)}setDefaultConstraints(t){U(this.defaultConstraintsSubject,t)}}class Co extends Ft{constructor(){super("stop-tracks",Ge()),this.directionSubject=new E(void 0),this.direction$=this.directionSubject.asObservable().pipe(B())}get direction(){return O(this.direction$)}setDirection(t){U(this.directionSubject,t)}setMediaStream(t,i){var e;if(super.setMediaStream(t,i),t){const n=M()?this.direction:((e=t.getVideoTracks()[0])==null?void 0:e.getSettings().facingMode)==="environment"?"back":"front";this.setDirection(n)}}getDeviceIdFromStream(t){const[i]=t.getVideoTracks();return i==null?void 0:i.getSettings().deviceId}}class yo extends Mt{constructor(t){super(t,new Co,b.VIDEO),this.targetResolution={width:1280,height:720}}isDirectionSupportedByDevice(){return M()||Ms()}async selectDirection(t){if(!this.isDirectionSupportedByDevice()){this.logger("warn","Setting direction is not supported on this device");return}if(this.state.setDirection(t),this.state.setDevice(void 0),M()){const i=this.getTracks()[0];await(i==null?void 0:i.applyConstraints({facingMode:t==="front"?"user":"environment"}));return}this.getTracks().forEach(i=>i.stop());try{await this.unmuteStream()}catch(i){throw i instanceof Error&&i.name==="NotReadableError"&&(await this.muteStream(),await this.unmuteStream()),i}}async flip(){const t=this.state.direction==="front"?"back":"front";await this.selectDirection(t)}async selectTargetResolution(t){if(this.targetResolution.height=t.height,this.targetResolution.width=t.width,this.state.optimisticStatus==="enabled")try{await this.statusChangeSettled()}catch(i){this.logger("warn","could not apply target resolution",i)}if(this.enabled&&this.state.mediaStream){const[i]=this.state.mediaStream.getVideoTracks();if(!i)return;const{width:e,height:n}=i.getSettings();(e!==this.targetResolution.width||n!==this.targetResolution.height)&&(await this.applySettingsToStream(),this.logger("debug",`${e}x${n} target resolution applied to media stream`))}}async apply(t,i){var m;const e=!!((m=this.call.state.localParticipant)!=null&&m.videoStream),n=this.call.permissionsContext.hasPermission(N.SEND_AUDIO);if(e||!n)return;await this.statusChangeSettled();const{target_resolution:a,camera_facing:r,camera_default_on:c}=t;let{width:d,height:p}=a;if(d<p&&([d,p]=[p,d]),await this.selectTargetResolution({width:d,height:p}),!this.state.direction&&!this.state.selectedDevice&&this.state.setDirection(r==="front"?"front":"back"),!i)return;const{mediaStream:g}=this.state;this.enabled&&g?await this.publishStream(g):this.state.status===void 0&&c&&await this.enable()}getDevices(){return mo()}getStream(t){return t.width=this.targetResolution.width,t.height=this.targetResolution.height,!t.deviceId&&this.state.direction&&this.isDirectionSupportedByDevice()&&(t.facingMode=this.state.direction==="front"?"user":"environment"),$s(t,this.call.tracer)}}class ko extends Ft{constructor(t){super(t,me()),this.speakingWhileMutedSubject=new E(!1),this.speakingWhileMuted$=this.speakingWhileMutedSubject.asObservable().pipe(B())}get speakingWhileMuted(){return O(this.speakingWhileMuted$)}setSpeakingWhileMuted(t){U(this.speakingWhileMutedSubject,t)}getDeviceIdFromStream(t){const[i]=t.getAudioTracks();return i==null?void 0:i.getSettings().deviceId}}const wo=500,vo=150,Eo=128,Io=(s,t,i={})=>{const{detectionFrequencyInMs:e=wo,audioLevelThreshold:n=vo,fftSize:a=Eo,destroyStreamOnStop:r=!0}=i,c=new AudioContext,d=c.createAnalyser();d.fftSize=a;const p=c.createMediaStreamSource(s);p.connect(d);const g=setInterval(()=>{var u;const m=new Uint8Array(d.frequencyBinCount);d.getByteFrequencyData(m);const o=m.some(f=>f>=n),l=m.reduce((f,S)=>f+S,0)/m.length,h=l>n?100:Math.round(l/n*100);(u=s.getAudioTracks()[0])!=null&&u.enabled?t({isSoundDetected:o,audioLevel:h}):t({isSoundDetected:!1,audioLevel:0})},e);return async function(){clearInterval(g),p.disconnect(),d.disconnect(),c.state!=="closed"&&await c.close(),r&&s.getTracks().forEach(o=>{o.stop(),s.removeTrack(o)})}};class _o{constructor(){this.pc1=new RTCPeerConnection({}),this.pc2=new RTCPeerConnection({})}async start(t){try{this.cleanupAudioStream();const i=await navigator.mediaDevices.getUserMedia({audio:!0});this.audioStream=i,this.pc1.addEventListener("icecandidate",async r=>{await this.pc2.addIceCandidate(r.candidate)}),this.pc2.addEventListener("icecandidate",async r=>{await this.pc1.addIceCandidate(r.candidate)}),this.pc2.addEventListener("track",r=>{r.streams[0].getTracks().forEach(c=>{c._setVolume(0)})}),i.getTracks().forEach(r=>this.pc1.addTrack(r,i));const e=await this.pc1.createOffer({});await this.pc2.setRemoteDescription(e),await this.pc1.setLocalDescription(e);const n=await this.pc2.createAnswer();await this.pc1.setRemoteDescription(n),await this.pc2.setLocalDescription(n);const a=this.onSpeakingDetectedStateChange(t);return()=>{a(),this.stop()}}catch(i){return R(["RNSpeechDetector"])("error","error handling permissions: ",i),()=>{}}}stop(){this.pc1.close(),this.pc2.close(),this.cleanupAudioStream()}onSpeakingDetectedStateChange(t){let e=.13,n=!1,a,r;const c=[],d=10,p=1.1,g=.9,m=500,o=5e3,h=setInterval(async()=>{try{const u=await this.pc1.getStats(),S=We(u).find(C=>C.type==="media-source"&&C.kind==="audio");if(S){const{audioLevel:C}=S;if(C){c.push(C),c.length>d&&c.shift();const k=c.reduce((_,v)=>_+v,0)/c.length;k<e*p?r||(r=setTimeout(()=>{e=Math.min(k*g,.13)},o)):(clearTimeout(r),r=void 0),k>e*1.5&&(n||(n=!0,t({isSoundDetected:!0,audioLevel:C})),clearTimeout(a),a=setTimeout(()=>{n=!1,t({isSoundDetected:!1,audioLevel:0})},m))}}}catch(u){R(["RNSpeechDetector"])("error","error checking audio level from stats",u)}},100);return()=>{clearInterval(h),clearTimeout(a),clearTimeout(r)}}cleanupAudioStream(){this.audioStream&&(this.audioStream.getTracks().forEach(t=>t.stop()),typeof this.audioStream.release=="function"&&this.audioStream.release())}}class Ro extends Mt{constructor(t,i="stop-tracks"){super(t,new ko(i),b.AUDIO),this.speakingWhileMutedNotificationEnabled=!0,this.soundDetectorConcurrencyTag=Symbol("soundDetectorConcurrencyTag"),this.subscriptions.push(Xe(ne([this.call.state.callingState$,this.call.state.ownCapabilities$,this.state.selectedDevice$,this.state.status$]),async([e,n,a,r])=>{try{if(e===y.LEFT&&await this.stopSpeakingWhileMutedDetection(),e!==y.JOINED||!this.speakingWhileMutedNotificationEnabled)return;n.includes(N.SEND_AUDIO)?r==="disabled"?await this.startSpeakingWhileMutedDetection(a):await this.stopSpeakingWhileMutedDetection():await this.stopSpeakingWhileMutedDetection()}catch(c){this.logger("warn","Could not enable speaking while muted",c)}})),this.subscriptions.push(J(this.call.state.callingState$,e=>{var a,r;if(!this.noiseCancellationRegistration||!this.noiseCancellation)return;((r=(a=this.call.state.settings)==null?void 0:a.audio.noise_cancellation)==null?void 0:r.mode)===ct.AUTO_ON&&e===y.JOINED?this.noiseCancellationRegistration.then(()=>{var c;return(c=this.noiseCancellation)!=null&&c.canAutoEnable?this.noiseCancellation.canAutoEnable():!0}).then(c=>{var d;c&&((d=this.noiseCancellation)==null||d.enable())}).catch(c=>(this.logger("warn","Failed to enable noise cancellation",c),this.call.notifyNoiseCancellationStopped())):e===y.LEFT&&this.noiseCancellationRegistration.then(()=>{var c;return(c=this.noiseCancellation)==null?void 0:c.disable()}).catch(c=>{this.logger("warn","Failed to disable noise cancellation",c)})}))}async enableNoiseCancellation(t){const{ownCapabilities:i,settings:e}=this.call.state;if(!i.includes(N.ENABLE_NOISE_CANCELLATION))throw new Error("Noise cancellation is not available.");const a=e==null?void 0:e.audio.noise_cancellation;if(!a||a.mode===ct.DISABLED)throw new Error("Noise cancellation is disabled for this call type.");try{if(this.noiseCancellation=t,this.noiseCancellationChangeUnsubscribe=this.noiseCancellation.on("change",r=>{this.call.tracer.trace("noiseCancellation.enabled",r),r?this.call.notifyNoiseCancellationStarting().catch(c=>{this.logger("warn","notifyNoiseCancellationStart failed",c)}):this.call.notifyNoiseCancellationStopped().catch(c=>{this.logger("warn","notifyNoiseCancellationStop failed",c)})}),M())this.noiseCancellationRegistration=Promise.resolve();else{const r=this.registerFilter(t.toFilter());this.noiseCancellationRegistration=r.registered,this.unregisterNoiseCancellation=r.unregister,await this.noiseCancellationRegistration}if(a.mode===ct.AUTO_ON&&this.call.state.callingState===y.JOINED){let r=!0;t.canAutoEnable&&(r=await t.canAutoEnable()),r&&t.enable()}}catch(r){throw this.logger("warn","Failed to enable noise cancellation",r),await this.disableNoiseCancellation().catch(c=>{this.logger("warn","Failed to disable noise cancellation",c)}),r}}async disableNoiseCancellation(){var t;await(((t=this.unregisterNoiseCancellation)==null?void 0:t.call(this))??Promise.resolve()).then(()=>{var i;return(i=this.noiseCancellation)==null?void 0:i.disable()}).then(()=>{var i;return(i=this.noiseCancellationChangeUnsubscribe)==null?void 0:i.call(this)}).catch(i=>{this.logger("warn","Failed to unregister noise cancellation",i)}),await this.call.notifyNoiseCancellationStopped()}async enableSpeakingWhileMutedNotification(){this.speakingWhileMutedNotificationEnabled=!0,this.state.status==="disabled"&&await this.startSpeakingWhileMutedDetection(this.state.selectedDevice)}async disableSpeakingWhileMutedNotification(){this.speakingWhileMutedNotificationEnabled=!1,await this.stopSpeakingWhileMutedDetection()}async apply(t,i){var r;if(!i)return;const e=!!((r=this.call.state.localParticipant)!=null&&r.audioStream),n=this.call.permissionsContext.hasPermission(N.SEND_AUDIO);if(e||!n)return;await this.statusChangeSettled();const{mediaStream:a}=this.state;this.enabled&&a?await this.publishStream(a):this.state.status===void 0&&t.mic_default_on&&await this.enable()}getDevices(){return po()}getStream(t){return Ls(t,this.call.tracer)}async startSpeakingWhileMutedDetection(t){await W(this.soundDetectorConcurrencyTag,async()=>{if(await this.stopSpeakingWhileMutedDetection(),M()){this.rnSpeechDetector=new _o;const i=await this.rnSpeechDetector.start(e=>{this.state.setSpeakingWhileMuted(e.isSoundDetected)});this.soundDetectorCleanup=()=>{i(),this.rnSpeechDetector=void 0}}else{const i=await this.getStream({deviceId:{exact:t}});this.soundDetectorCleanup=Io(i,e=>{this.state.setSpeakingWhileMuted(e.isSoundDetected)})}})}async stopSpeakingWhileMutedDetection(){await W(this.soundDetectorConcurrencyTag,async()=>{if(!this.soundDetectorCleanup)return;const t=this.soundDetectorCleanup;this.soundDetectorCleanup=void 0,this.state.setSpeakingWhileMuted(!1),await t()})}}class Po extends Ft{constructor(){super(...arguments),this.audioEnabledSubject=new E(!0),this.settingsSubject=new E(void 0),this.audioEnabled$=this.audioEnabledSubject.asObservable().pipe(B()),this.settings$=this.settingsSubject.asObservable(),this.getDeviceIdFromStream=t=>{const[i]=t.getTracks();return i==null?void 0:i.getSettings().deviceId}}get audioEnabled(){return O(this.audioEnabled$)}setAudioEnabled(t){U(this.audioEnabledSubject,t)}get settings(){return O(this.settings$)}setSettings(t){U(this.settingsSubject,t)}}class Do extends Mt{constructor(t){super(t,new Po,b.SCREEN_SHARE),this.subscriptions.push(J(t.state.settings$,i=>{const e=i==null?void 0:i.screensharing.target_resolution;e&&this.setDefaultConstraints({video:{width:e.width,height:e.height}})}))}enableScreenShareAudio(){this.state.setAudioEnabled(!0)}async disableScreenShareAudio(){var t;this.state.setAudioEnabled(!1),(t=this.call.publisher)!=null&&t.isPublishing(b.SCREEN_SHARE_AUDIO)&&await this.call.stopPublish(b.SCREEN_SHARE_AUDIO)}getSettings(){return this.state.settings}setSettings(t){this.state.setSettings(t)}getDevices(){return Le([])}async getStream(t){this.state.audioEnabled||(t.audio=!1);const i=await bo(t,this.call.tracer),[e]=i.getVideoTracks(),{contentHint:n}=this.state.settings||{};return typeof n<"u"&&e&&"contentHint"in e&&(this.call.tracer.trace("navigator.mediaDevices.getDisplayMedia.contentHint",n),e.contentHint=n),i}async stopPublishStream(){return this.call.stopPublish(b.SCREEN_SHARE,b.SCREEN_SHARE_AUDIO)}async select(){throw new Error("Not supported")}}class Oo{constructor(t){this.selectedDeviceSubject=new E(""),this.volumeSubject=new E(1),this.isDeviceSelectionSupported=uo(),this.tracer=t,this.selectedDevice$=this.selectedDeviceSubject.asObservable().pipe(B()),this.volume$=this.volumeSubject.asObservable().pipe(B())}get selectedDevice(){return O(this.selectedDevice$)}get volume(){return O(this.volume$)}setDevice(t){U(this.selectedDeviceSubject,t),this.tracer.trace("navigator.mediaDevices.setSinkId",t)}setVolume(t){U(this.volumeSubject,t)}}class Ao{constructor(t){this.subscriptions=[],this.dispose=()=>{this.subscriptions.forEach(i=>i.unsubscribe())},this.call=t,this.state=new Oo(t.tracer),Ke&&!M()&&this.subscriptions.push(ne([Ke,this.state.selectedDevice$]).subscribe(([i,e])=>{if(!e)return;i.find(a=>a.deviceId===e&&a.kind==="audiooutput")||this.select("")}))}listDevices(){if(M())throw new Error("This feature is not supported in React Native. Please visit https://getstream.io/video/docs/reactnative/core/camera-and-microphone/#speaker-management for more details");return go()}select(t){if(M())throw new Error("This feature is not supported in React Native. Please visit https://getstream.io/video/docs/reactnative/core/camera-and-microphone/#speaker-management for more details");this.state.setDevice(t)}setVolume(t){if(M())throw new Error("This feature is not supported in React Native. Please visit https://getstream.io/video/docs/reactnative/core/camera-and-microphone/#speaker-management for more details");if(t&&(t<0||t>1))throw new Error("Volume must be between 0 and 1");this.state.setVolume(t)}setParticipantVolume(t,i){if(M())throw new Error("This feature is not supported in React Native. Please visit https://getstream.io/video/docs/reactnative/core/camera-and-microphone/#speaker-management for more details");if(i&&(i<0||i>1))throw new Error("Volume must be between 0 and 1, or undefined");this.call.state.updateParticipant(t,{audioVolume:i})}}class Te{constructor({type:t,id:i,streamClient:e,members:n,ownCapabilities:a,sortParticipantsBy:r,clientStore:c,ringing:d=!1,watching:p=!1}){this.state=new tr,this.permissionsContext=new oo,this.tracer=new At(null),this.dispatcher=new Ba,this.statsReportingIntervalInMs=2e3,this.sfuClientTag=0,this.reconnectConcurrencyTag=Symbol("reconnectConcurrencyTag"),this.reconnectAttempts=0,this.reconnectStrategy=w.UNSPECIFIED,this.reconnectReason="",this.fastReconnectDeadlineSeconds=0,this.disconnectionTimeoutSeconds=0,this.lastOfflineTimestamp=0,this.trackPublishOrder=[],this.hasJoinedOnce=!1,this.deviceSettingsAppliedOnce=!1,this.initialized=!1,this.joinLeaveConcurrencyTag=Symbol("joinLeaveConcurrencyTag"),this.leaveCallHooks=new Set,this.streamClientEventHandlers=new Map,this.setup=async()=>{await W(this.joinLeaveConcurrencyTag,async()=>{this.initialized||(this.leaveCallHooks.add(this.on("all",o=>{this.state.updateFromEvent(o)})),this.leaveCallHooks.add(this.on("changePublishOptions",o=>{this.currentPublishOptions=o.publishOptions})),this.leaveCallHooks.add(io(this,this.dispatcher)),this.registerEffects(),this.registerReconnectHandlers(),this.state.callingState===y.LEFT&&this.state.setCallingState(y.IDLE),this.initialized=!0)})},this.registerEffects=()=>{this.leaveCallHooks.add(J(this.state.settings$,o=>{o&&this.permissionsContext.setCallSettings(o)})),this.leaveCallHooks.add(Xe(this.state.ownCapabilities$,this.handleOwnCapabilitiesUpdated)),this.leaveCallHooks.add(J(this.state.blockedUserIds$,async o=>{if(!o||o.length===0)return;const l=this.currentUserId;l&&o.includes(l)&&(this.logger("info","Leaving call because of being blocked"),await this.leave({message:"user blocked"}).catch(h=>{this.logger("error","Error leaving call after being blocked",h)}))})),this.leaveCallHooks.add(J(this.state.session$,o=>{var S;if(!this.ringing)return;const l=(S=this.clientStore.connectedUser)==null?void 0:S.id;if(!l)return;const h=!!(o!=null&&o.accepted_by[l]),u=!!(o!=null&&o.rejected_by[l]);(h||u)&&this.cancelAutoDrop(),(h&&this.state.callingState===y.RINGING||u)&&!Ja(this.joinLeaveConcurrencyTag)&&this.leave().catch(()=>{this.logger("error","Could not leave a call that was accepted or rejected elsewhere")})})),this.leaveCallHooks.add(J(this.ringingSubject,o=>{var _,v;if(!o)return;const l=this.state.session,h=(_=this.clientStore.connectedUser)==null?void 0:_.id,u=l==null?void 0:l.ended_at,f=(v=this.state.createdBy)==null?void 0:v.id,S=l==null?void 0:l.rejected_by,C=l==null?void 0:l.accepted_by;let k=!1;u?k=!0:f&&S?S[f]&&(k=!0):h&&S?S[h]&&(k=!0):h&&C&&C[h]&&(k=!0),k?this.state.callingState!==y.IDLE&&this.state.setCallingState(y.IDLE):(this.state.callingState===y.IDLE&&this.state.setCallingState(y.RINGING),this.scheduleAutoDrop(),this.leaveCallHooks.add(Ps(this)))}))},this.handleOwnCapabilitiesUpdated=async o=>{if(this.permissionsContext.setPermissions(o),!this.publisher)return;const l={[N.SEND_AUDIO]:b.AUDIO,[N.SEND_VIDEO]:b.VIDEO,[N.SCREENSHARE]:b.SCREEN_SHARE};for(const[h,u]of Object.entries(l))if(!this.permissionsContext.hasPermission(h))try{switch(u){case b.AUDIO:this.microphone.enabled&&await this.microphone.disable();break;case b.VIDEO:this.camera.enabled&&await this.camera.disable();break;case b.SCREEN_SHARE:this.screenShare.enabled&&await this.screenShare.disable();break}}catch(S){this.logger("error","Can't disable mic/camera/screenshare after revoked permissions",S)}},this.on=(o,l)=>{if(Gt(o))return this.dispatcher.on(o,l);const h=this.streamClient.on(o,u=>{const f=u;f.call_cid&&f.call_cid===this.cid&&l(f)});return this.streamClientEventHandlers.set(l,h),()=>{this.off(o,l)}},this.off=(o,l)=>{if(Gt(o))return this.dispatcher.off(o,l);const h=this.streamClientEventHandlers.get(l);h&&h()},this.leave=async({reject:o,reason:l,message:h}={})=>{if(this.state.callingState===y.LEFT)throw new Error("Cannot leave call that has already been left.");await W(this.joinLeaveConcurrencyTag,async()=>{var S,C,k,_,v,I;const u=this.state.callingState;if(u===y.LEFT)return;if(u===y.JOINING&&await new Promise(A=>{this.state.callingState$.pipe(pt(F=>F!==y.JOINED,!0)).subscribe(()=>A())}),u===y.RINGING&&o!==!1)if(o)await this.reject(l??"decline");else{const P=this.state.remoteParticipants.length>0;this.isCreatedByMe&&!P&&await this.reject("cancel")}(S=this.statsReporter)==null||S.stop(),this.statsReporter=void 0,(C=this.sfuStatsReporter)==null||C.flush(),(k=this.sfuStatsReporter)==null||k.stop(),this.sfuStatsReporter=void 0,(_=this.subscriber)==null||_.dispose(),this.subscriber=void 0,(v=this.publisher)==null||v.dispose(),this.publisher=void 0,await((I=this.sfuClient)==null?void 0:I.leaveAndClose(h??l??"user is leaving the call")),this.sfuClient=void 0,this.dynascaleManager.setSfuClient(void 0),await this.dynascaleManager.dispose(),this.state.setCallingState(y.LEFT),this.state.setParticipants([]),this.state.dispose(),this.leaveCallHooks.forEach(P=>P()),this.initialized=!1,this.hasJoinedOnce=!1,this.unifiedSessionId=void 0,this.ringingSubject.next(!1),this.cancelAutoDrop(),this.clientStore.unregisterCall(this),this.camera.dispose(),this.microphone.dispose(),this.screenShare.dispose(),this.speaker.dispose();const f=[];this.camera.stopOnLeave&&f.push(this.camera.disable(!0)),this.microphone.stopOnLeave&&f.push(this.microphone.disable(!0)),this.screenShare.stopOnLeave&&f.push(this.screenShare.disable(!0)),await Promise.all(f)})},this.updateFromRingingEvent=async o=>{await this.setup();const{created_by:l,settings:h}=o.call,u=this.state.members.find(S=>S.user.id===l.id);u?this.state.setMembers([u,...o.members]):this.state.setMembers(o.members),this.state.updateFromCallResponse(o.call),this.watching=!0,this.ringingSubject.next(!0);const f=this.clientStore.calls.filter(S=>S.cid!==this.cid);this.clientStore.setCalls([this,...f]),await this.applyDeviceConfig(h,!1)},this.get=async o=>{await this.setup();const l=await this.streamClient.get(this.streamClientBasePath,o);return this.state.updateFromCallResponse(l.call),this.state.setMembers(l.members),this.state.setOwnCapabilities(l.own_capabilities),o!=null&&o.ring&&this.ringingSubject.next(!0),this.streamClient._hasConnectionID()&&(this.watching=!0,this.clientStore.registerCall(this)),await this.applyDeviceConfig(l.call.settings,!1),l},this.getOrCreate=async o=>{await this.setup();const l=await this.streamClient.post(this.streamClientBasePath,o);return this.state.updateFromCallResponse(l.call),this.state.setMembers(l.members),this.state.setOwnCapabilities(l.own_capabilities),o!=null&&o.ring&&this.ringingSubject.next(!0),this.streamClient._hasConnectionID()&&(this.watching=!0,this.clientStore.registerCall(this)),await this.applyDeviceConfig(l.call.settings,!1),l},this.create=async o=>this.getOrCreate(o),this.delete=async(o={})=>this.streamClient.post(`${this.streamClientBasePath}/delete`,o),this.ring=async()=>await this.get({ring:!0}),this.notify=async()=>await this.get({notify:!0}),this.accept=async()=>this.streamClient.post(`${this.streamClientBasePath}/accept`),this.reject=async(o="decline")=>this.streamClient.post(`${this.streamClientBasePath}/reject`,{reason:o}),this.join=async({maxJoinRetries:o=3,...l}={})=>{await this.setup();const h=this.state.callingState;if([y.JOINED,y.JOINING].includes(h))throw new Error("Illegal State: call.join() shall be called only once");this.state.setCallingState(y.JOINING),o=Math.max(o,1);for(let u=0;u<o;u++){try{return this.logger("trace",`Joining call (${u})`,this.cid),await this.doJoin(l)}catch(f){if(this.logger("warn",`Failed to join call (${u})`,this.cid),u===o-1)throw this.state.setCallingState(h),f}await X(Re(u))}},this.doJoin=async o=>{var A,F,V,q;const l=Date.now(),h=this.state.callingState;this.joinCallData=o,this.logger("debug","Starting join flow"),this.state.setCallingState(y.JOINING);const u=this.reconnectStrategy===w.MIGRATE,f=this.reconnectStrategy===w.REJOIN,S=this.reconnectStrategy===w.FAST;let C=(A=this.sfuStatsReporter)==null?void 0:A.options;if(!this.credentials||!C||f||u)try{const $=await this.doJoinRequest(o);this.credentials=$.credentials,C=$.stats_options}catch($){throw this.state.callingState===y.OFFLINE||this.state.setCallingState(h),$}const k=this.sfuClient,_=k==null?void 0:k.sessionId,v=!!(k!=null&&k.isHealthy),I=f||u||!v?new H({logTag:String(++this.sfuClientTag),dispatcher:this.dispatcher,credentials:this.credentials,streamClient:this.streamClient,enableTracing:C.enable_rtc_stats,sessionId:f?void 0:_,onSignalClose:$=>this.handleSfuSignalClose(I,$)}):k;this.sfuClient=I,this.dynascaleManager.setSfuClient(I);const P=await zt();if(k!==I){const[$,jt]=await Promise.all([Jt("recvonly"),Jt("sendonly")]),ot=this.reconnectStrategy!==w.UNSPECIFIED,Vt=ot?this.getReconnectDetails(o==null?void 0:o.migrating_from,_):void 0,Fs=ot?this.currentPublishOptions||[]:this.getPreferredPublishOptions(),js=ot?[]:this.getPreferredSubscribeOptions();try{const{callState:ge,fastReconnectDeadlineSeconds:Vs,publishOptions:xs}=await I.join({subscriberSdp:$,publisherSdp:jt,clientDetails:P,fastReconnect:S,reconnectDetails:Vt,preferredPublishOptions:Fs,preferredSubscribeOptions:js});this.currentPublishOptions=xs,this.fastReconnectDeadlineSeconds=Vs,ge&&this.state.updateFromSfuCallState(ge,I.sessionId,Vt)}catch(ge){throw this.logger("warn","Join SFU request failed",ge),I.close(H.JOIN_FAILED,"Join request failed, connection considered unhealthy"),this.state.setCallingState(h),ge}}if(u||this.state.setCallingState(y.JOINED),this.hasJoinedOnce=!0,S)await this.restoreICE(I,{includeSubscriber:!1});else{const $=Lr(this.credentials.ice_servers);this.initPublisherAndSubscriber({sfuClient:I,connectionConfig:$,clientDetails:P,statsOptions:C,publishOptions:this.currentPublishOptions||[],closePreviousInstances:!u})}if(!f&&!S&&!u&&((F=this.sfuStatsReporter)==null||F.sendConnectionTime((Date.now()-l)/1e3)),f&&v){const $=w[this.reconnectStrategy];await(k==null?void 0:k.leaveAndClose(`Closing previous WS after reconnect with strategy: ${$}`))}else v||k==null||k.close(H.DISPOSE_OLD_SOCKET,"Closing unhealthy WS after reconnect");!this.deviceSettingsAppliedOnce&&this.state.settings&&(await this.applyDeviceConfig(this.state.settings,!0),this.deviceSettingsAppliedOnce=!0),(V=this.joinCallData)==null||delete V.ring,(q=this.joinCallData)==null||delete q.notify,this.reconnectStrategy=w.UNSPECIFIED,this.reconnectReason="",this.logger("info",`Joined call ${this.cid}`)},this.getReconnectDetails=(o,l)=>{var S;const h=this.reconnectStrategy,u=h===w.REJOIN,f=((S=this.publisher)==null?void 0:S.getAnnouncedTracksForReconnect())||[];return{strategy:h,announcedTracks:f,subscriptions:this.dynascaleManager.trackSubscriptions,reconnectAttempt:this.reconnectAttempts,fromSfuId:o||"",previousSessionId:u&&l||"",reason:this.reconnectReason}},this.getPreferredPublishOptions=()=>{const{preferredCodec:o,fmtpLine:l,preferredBitrate:h,maxSimulcastLayers:u}=this.clientPublishOptions||{};if(!o&&!h&&!u)return[];const f=o?Y.create({name:o.split("/").pop(),fmtp:l}):void 0,S=[ue.create({trackType:b.VIDEO,codec:f,bitrate:h,maxSpatialLayers:u})],C=this.screenShare.getSettings();return C&&S.push(ue.create({trackType:b.SCREEN_SHARE,fps:C.maxFramerate,bitrate:C.maxBitrate})),S},this.getPreferredSubscribeOptions=()=>{const{subscriberCodec:o,subscriberFmtpLine:l}=this.clientPublishOptions||{};return!o||!l?[]:[Et.create({trackType:b.VIDEO,codecs:[{name:o.split("/").pop(),fmtp:l}]})]},this.restoreICE=async(o,l={})=>{const{includeSubscriber:h=!0,includePublisher:u=!0}=l;this.subscriber&&(this.subscriber.setSfuClient(o),h&&await this.subscriber.restartIce()),this.publisher&&(this.publisher.setSfuClient(o),u&&this.publisher.isPublishing()&&await this.publisher.restartIce())},this.initPublisherAndSubscriber=o=>{var v,I,P;const{sfuClient:l,connectionConfig:h,clientDetails:u,statsOptions:f,publishOptions:S,closePreviousInstances:C}=o,{enable_rtc_stats:k}=f;C&&this.subscriber&&this.subscriber.dispose(),this.subscriber=new Nr({sfuClient:l,dispatcher:this.dispatcher,state:this.state,connectionConfig:h,logTag:String(this.sfuClientTag),enableTracing:k,onReconnectionNeeded:(A,F)=>{this.reconnect(A,F).catch(V=>{const q=`[Reconnect] Error reconnecting after a subscriber error: ${F}`;this.logger("warn",q,V)})}}),((v=this.streamClient.user)==null?void 0:v.type)==="anonymous"||(C&&this.publisher&&this.publisher.dispose(),this.publisher=new Ar({sfuClient:l,dispatcher:this.dispatcher,state:this.state,connectionConfig:h,publishOptions:S,logTag:String(this.sfuClientTag),enableTracing:k,onReconnectionNeeded:(A,F)=>{this.reconnect(A,F).catch(V=>{const q=`[Reconnect] Error reconnecting after a publisher error: ${F}`;this.logger("warn",q,V)})}})),(I=this.statsReporter)==null||I.stop(),this.statsReportingIntervalInMs>0&&(this.statsReporter=nr({subscriber:this.subscriber,publisher:this.publisher,state:this.state,datacenter:l.edgeName,pollingIntervalInMs:this.statsReportingIntervalInMs})),this.tracer.setEnabled(k),(P=this.sfuStatsReporter)==null||P.stop(),(f==null?void 0:f.reporting_interval_ms)>0&&(this.unifiedSessionId??(this.unifiedSessionId=l.sessionId),this.sfuStatsReporter=new gr(l,{clientDetails:u,options:f,subscriber:this.subscriber,publisher:this.publisher,microphone:this.microphone,camera:this.camera,state:this.state,tracer:this.tracer,unifiedSessionId:this.unifiedSessionId}),this.sfuStatsReporter.start())},this.doJoinRequest=async o=>{const l=await this.streamClient.getLocationHint(),h={...o,location:l},u=await this.streamClient.post(`${this.streamClientBasePath}/join`,h);return this.state.updateFromCallResponse(u.call),this.state.setMembers(u.members),this.state.setOwnCapabilities(u.own_capabilities),o!=null&&o.ring&&this.ringingSubject.next(!0),!(this.reconnectStrategy!==w.UNSPECIFIED)&&this.ringing&&!this.isCreatedByMe&&await this.accept(),this.streamClient._hasConnectionID()&&(this.watching=!0,this.clientStore.registerCall(this)),u},this.handleSfuSignalClose=(o,l)=>{var f,S;this.logger("debug","[Reconnect] SFU signal connection closed");const{callingState:h}=this.state;if(h===y.JOINING||h===y.RECONNECTING||h===y.IDLE||h===y.LEFT||o.isLeaving||o.isClosingClean)return;const u=(f=this.publisher)!=null&&f.isHealthy()&&((S=this.subscriber)!=null&&S.isHealthy())?w.FAST:w.REJOIN;this.reconnect(u,l).catch(C=>{this.logger("warn","[Reconnect] Error reconnecting",C)})},this.reconnect=async(o,l)=>{if(!(this.state.callingState===y.RECONNECTING||this.state.callingState===y.MIGRATING||this.state.callingState===y.RECONNECTING_FAILED))return W(this.reconnectConcurrencyTag,async()=>{var f,S,C;const h=Date.now();this.reconnectStrategy=o,this.reconnectReason=l;let u=0;do{const k=Date.now()-h;if(this.disconnectionTimeoutSeconds>0&&k/1e3>this.disconnectionTimeoutSeconds){this.logger("warn","[Reconnect] Stopping reconnection attempts after reaching disconnection timeout"),this.state.setCallingState(y.RECONNECTING_FAILED);return}this.reconnectStrategy!==w.FAST&&this.reconnectAttempts++;const v=w[this.reconnectStrategy];try{switch(await((f=this.networkAvailableTask)==null?void 0:f.promise),this.logger("info",`[Reconnect] Reconnecting with strategy ${w[this.reconnectStrategy]}`),this.reconnectStrategy){case w.UNSPECIFIED:case w.DISCONNECT:this.logger("debug",`[Reconnect] No-op strategy ${v}`);break;case w.FAST:await this.reconnectFast();break;case w.REJOIN:await this.reconnectRejoin();break;case w.MIGRATE:await this.reconnectMigrate();break;default:Ee(this.reconnectStrategy,"Unknown reconnection strategy");break}break}catch(I){if(this.state.callingState===y.OFFLINE){this.logger("debug","[Reconnect] Can't reconnect while offline, stopping reconnection attempts");break}if(I instanceof ns&&I.unrecoverable){this.logger("warn","[Reconnect] Can't reconnect due to coordinator unrecoverable error",I),this.state.setCallingState(y.RECONNECTING_FAILED);return}await X(500);const P=this.reconnectStrategy===w.MIGRATE,F=(Date.now()-h)/1e3>this.fastReconnectDeadlineSeconds||P||u>=3||!(((S=this.publisher)==null?void 0:S.isHealthy())??!0)||!(((C=this.subscriber)==null?void 0:C.isHealthy())??!0);u++;const V=F?w.REJOIN:w.FAST;this.reconnectStrategy=V,this.logger("info",`[Reconnect] ${v} (${this.reconnectAttempts}) failed. Attempting with ${w[V]}`,I)}}while(this.state.callingState!==y.JOINED&&this.state.callingState!==y.RECONNECTING_FAILED&&this.state.callingState!==y.LEFT);this.logger("info","[Reconnect] Reconnection flow finished")})},this.reconnectFast=async()=>{var l;const o=Date.now();this.reconnectStrategy=w.FAST,this.state.setCallingState(y.RECONNECTING),await this.doJoin(this.joinCallData),(l=this.sfuStatsReporter)==null||l.sendReconnectionTime(w.FAST,(Date.now()-o)/1e3)},this.reconnectRejoin=async()=>{var l;const o=Date.now();this.reconnectStrategy=w.REJOIN,this.state.setCallingState(y.RECONNECTING),await this.doJoin(this.joinCallData),await this.restorePublishedTracks(),this.restoreSubscribedTracks(),(l=this.sfuStatsReporter)==null||l.sendReconnectionTime(w.REJOIN,(Date.now()-o)/1e3)},this.reconnectMigrate=async()=>{var S,C;const o=Date.now(),l=this.sfuClient;if(!l)throw new Error("Cannot migrate without an active SFU client");this.reconnectStrategy=w.MIGRATE,this.state.setCallingState(y.MIGRATING);const h=this.subscriber,u=this.publisher;h==null||h.detachEventHandlers(),u==null||u.detachEventHandlers();const f=Ie(l.enterMigration());try{const k=l.edgeName;await this.doJoin({...this.joinCallData,migrating_from:k})}finally{(S=this.joinCallData)==null||delete S.migrating_from}await this.restorePublishedTracks(),this.restoreSubscribedTracks();try{await f(),this.state.setCallingState(y.JOINED)}finally{h==null||h.dispose(),u==null||u.dispose(),l.close(H.NORMAL_CLOSURE,"Migrating away")}(C=this.sfuStatsReporter)==null||C.sendReconnectionTime(w.MIGRATE,(Date.now()-o)/1e3)},this.registerReconnectHandlers=()=>{const o=this.on("goAway",()=>{this.reconnect(w.MIGRATE,"goAway").catch(u=>this.logger("warn","[Reconnect] Error reconnecting",u))}),l=this.on("error",u=>{const{reconnectStrategy:f,error:S}=u;f!==w.UNSPECIFIED&&(f===w.DISCONNECT?this.leave({message:"SFU instructed to disconnect"}).catch(C=>{this.logger("warn","Can't leave call after disconnect request",C)}):this.reconnect(f,(S==null?void 0:S.message)||"SFU Error").catch(C=>{this.logger("warn","[Reconnect] Error reconnecting",C)}))}),h=this.streamClient.on("network.changed",u=>{var f,S,C,k;if(this.tracer.trace("network.changed",u),u.online)this.logger("debug","[Reconnect] Going online"),(S=this.sfuClient)==null||S.close(H.DISPOSE_OLD_SOCKET,"Closing WS to reconnect after going online"),(C=this.networkAvailableTask)==null||C.resolve(),this.networkAvailableTask=void 0,(k=this.sfuStatsReporter)==null||k.start();else{if(this.logger("debug","[Reconnect] Going offline"),!this.hasJoinedOnce)return;this.lastOfflineTimestamp=Date.now();const _=Ce();_.promise.then(()=>{let v=w.FAST;this.lastOfflineTimestamp&&(Date.now()-this.lastOfflineTimestamp)/1e3>this.fastReconnectDeadlineSeconds&&(v=w.REJOIN),this.reconnect(v,"Going online").catch(I=>{this.logger("warn","[Reconnect] Error reconnecting after going online",I)})}),this.networkAvailableTask=_,(f=this.sfuStatsReporter)==null||f.stop(),this.state.setCallingState(y.OFFLINE)}});this.leaveCallHooks.add(o).add(l).add(h)},this.restorePublishedTracks=async()=>{for(const o of this.trackPublishOrder){let l;switch(o){case b.AUDIO:l=this.microphone.state.mediaStream;break;case b.VIDEO:l=this.camera.state.mediaStream;break;case b.SCREEN_SHARE:l=this.screenShare.state.mediaStream;break;case b.SCREEN_SHARE_AUDIO:case b.UNSPECIFIED:break;default:Ee(o,"Unknown track type");break}l&&await this.publish(l,o)}},this.restoreSubscribedTracks=()=>{const{remoteParticipants:o}=this.state;o.length<=0||this.dynascaleManager.applyTrackSubscriptions(void 0)},this.publishVideoStream=async o=>{await this.publish(o,b.VIDEO)},this.publishAudioStream=async o=>{await this.publish(o,b.AUDIO)},this.publishScreenShareStream=async o=>{await this.publish(o,b.SCREEN_SHARE)},this.publish=async(o,l)=>{var f;if(!this.sfuClient)throw new Error("Call not joined yet.");if(await this.sfuClient.joinTask,!this.permissionsContext.canPublish(l))throw new Error(`No permission to publish ${b[l]}`);if(!this.publisher)throw new Error("Publisher is not initialized");const[h]=Ut(l)?o.getAudioTracks():o.getVideoTracks();if(!h)throw new Error(`There is no ${b[l]} track in the stream`);if(h.readyState==="ended")throw new Error("Can't publish ended tracks.");$e(this.trackPublishOrder,l),await this.publisher.publish(h,l);const u=[l];if(l===b.SCREEN_SHARE){const[S]=o.getAudioTracks();S&&($e(this.trackPublishOrder,b.SCREEN_SHARE_AUDIO),await this.publisher.publish(S,b.SCREEN_SHARE_AUDIO),u.push(b.SCREEN_SHARE_AUDIO))}h.kind==="video"&&((f=this.sfuStatsReporter)==null||f.scheduleOne(3e3)),await this.updateLocalStreamState(o,...u)},this.stopPublish=async(...o)=>{!this.sfuClient||!this.publisher||(this.publisher.stopTracks(...o),await this.updateLocalStreamState(void 0,...o))},this.updateLocalStreamState=async(o,...l)=>{if(!this.sfuClient||!this.sfuClient.sessionId)return;await this.notifyTrackMuteState(!o,...l);const{sessionId:h}=this.sfuClient;for(const u of l){const f=Nt(u);f&&this.state.updateParticipant(h,S=>({publishedTracks:o?$e([...S.publishedTracks],u):S.publishedTracks.filter(C=>C!==u),[f]:o}))}},this.updatePublishOptions=o=>{this.logger("warn","[call.updatePublishOptions]: You are manually overriding the publish options for this call. This is not recommended, and it can cause call stability/compatibility issues. Use with caution."),this.state.callingState===y.JOINED&&this.logger("warn","Updating publish options after joining the call does not have an effect"),this.clientPublishOptions={...this.clientPublishOptions,...o}},this.notifyNoiseCancellationStarting=async()=>{var o;return(o=this.sfuClient)==null?void 0:o.startNoiseCancellation().catch(l=>{this.logger("warn","Failed to notify start of noise cancellation",l)})},this.notifyNoiseCancellationStopped=async()=>{var o;return(o=this.sfuClient)==null?void 0:o.stopNoiseCancellation().catch(l=>{this.logger("warn","Failed to notify stop of noise cancellation",l)})},this.notifyTrackMuteState=async(o,...l)=>{this.sfuClient&&await this.sfuClient.updateMuteStates(l.map(h=>({trackType:h,muted:o})))},this.startReportingStatsFor=o=>{var l;return(l=this.statsReporter)==null?void 0:l.startReportingStatsFor(o)},this.stopReportingStatsFor=o=>{var l;return(l=this.statsReporter)==null?void 0:l.stopReportingStatsFor(o)},this.setStatsReportingIntervalInMs=o=>{this.statsReportingIntervalInMs=o},this.resetReaction=o=>{this.state.updateParticipant(o,{reaction:void 0})},this.setSortParticipantsBy=o=>this.state.setSortParticipantsBy(o),this.sendReaction=async o=>this.streamClient.post(`${this.streamClientBasePath}/reaction`,o),this.blockUser=async o=>this.streamClient.post(`${this.streamClientBasePath}/block`,{user_id:o}),this.unblockUser=async o=>this.streamClient.post(`${this.streamClientBasePath}/unblock`,{user_id:o}),this.muteSelf=o=>{const l=this.currentUserId;if(l)return this.muteUser(l,o)},this.muteOthers=o=>{const l=yr(o);if(!l)return;const h=[];for(const u of this.state.remoteParticipants)u.publishedTracks.includes(l)&&h.push(u.userId);if(h.length>0)return this.muteUser(h,o)},this.muteUser=(o,l)=>this.streamClient.post(`${this.streamClientBasePath}/mute_users`,{user_ids:Array.isArray(o)?o:[o],[l]:!0}),this.muteAllUsers=o=>this.streamClient.post(`${this.streamClientBasePath}/mute_users`,{mute_all_users:!0,[o]:!0}),this.startRecording=async o=>this.streamClient.post(`${this.streamClientBasePath}/start_recording`,o||{}),this.stopRecording=async()=>this.streamClient.post(`${this.streamClientBasePath}/stop_recording`,{}),this.startTranscription=async o=>this.streamClient.post(`${this.streamClientBasePath}/start_transcription`,o),this.stopTranscription=async()=>this.streamClient.post(`${this.streamClientBasePath}/stop_transcription`),this.startClosedCaptions=async o=>{const l=this.state.setCaptioning(!0);try{return await this.streamClient.post(`${this.streamClientBasePath}/start_closed_captions`,o)}catch(h){throw l.rollback(),h}},this.stopClosedCaptions=async o=>{const l=this.state.setCaptioning(!1);try{return await this.streamClient.post(`${this.streamClientBasePath}/stop_closed_captions`,o)}catch(h){throw l.rollback(),h}},this.updateClosedCaptionSettings=o=>{this.state.updateClosedCaptionSettings(o)},this.requestPermissions=async o=>{const{permissions:l}=o;if(!l.every(u=>this.permissionsContext.canRequest(u)))throw new Error(`You are not allowed to request permissions: ${l.join(", ")}`);return this.streamClient.post(`${this.streamClientBasePath}/request_permission`,o)},this.grantPermissions=async(o,l)=>this.updateUserPermissions({user_id:o,grant_permissions:l}),this.revokePermissions=async(o,l)=>this.updateUserPermissions({user_id:o,revoke_permissions:l}),this.updateUserPermissions=async o=>this.streamClient.post(`${this.streamClientBasePath}/user_permissions`,o),this.goLive=async(o={},l)=>this.streamClient.post(`${this.streamClientBasePath}/go_live`,o,l),this.stopLive=async(o={})=>this.streamClient.post(`${this.streamClientBasePath}/stop_live`,o),this.startHLS=async()=>this.streamClient.post(`${this.streamClientBasePath}/start_broadcasting`,{}),this.stopHLS=async()=>this.streamClient.post(`${this.streamClientBasePath}/stop_broadcasting`,{}),this.startRTMPBroadcasts=async o=>this.streamClient.post(`${this.streamClientBasePath}/rtmp_broadcasts`,o),this.stopAllRTMPBroadcasts=async()=>this.streamClient.post(`${this.streamClientBasePath}/rtmp_broadcasts/stop`),this.stopRTMPBroadcast=async o=>this.streamClient.post(`${this.streamClientBasePath}/rtmp_broadcasts/${o}/stop`),this.startFrameRecording=async o=>this.streamClient.post(`${this.streamClientBasePath}/start_frame_recording`,o),this.stopFrameRecording=async()=>this.streamClient.post(`${this.streamClientBasePath}/stop_frame_recording`),this.update=async o=>{const l=await this.streamClient.patch(`${this.streamClientBasePath}`,o),{call:h,members:u,own_capabilities:f}=l;return this.state.updateFromCallResponse(h),this.state.setMembers(u),this.state.setOwnCapabilities(f),l},this.endCall=async()=>this.streamClient.post(`${this.streamClientBasePath}/mark_ended`),this.pin=o=>{this.state.updateParticipant(o,{pin:{isLocalPin:!0,pinnedAt:Date.now()}})},this.unpin=o=>{this.state.updateParticipant(o,{pin:void 0})},this.pinForEveryone=async o=>this.streamClient.post(`${this.streamClientBasePath}/pin`,o),this.unpinForEveryone=async o=>this.streamClient.post(`${this.streamClientBasePath}/unpin`,o),this.queryMembers=o=>this.streamClient.post("/call/members",{...o||{},id:this.id,type:this.type}),this.updateCallMembers=async o=>this.streamClient.post(`${this.streamClientBasePath}/members`,o),this.scheduleAutoDrop=()=>{this.cancelAutoDrop();const o=this.state.settings;if(!o||this.state.callingState!==y.RINGING)return;const l=this.isCreatedByMe?o.ring.auto_cancel_timeout_ms:o.ring.incoming_call_timeout_ms;l<=0||(this.dropTimeout=setTimeout(()=>{this.state.callingState===y.RINGING&&this.leave({reject:!0,reason:"timeout",message:`ringing timeout - ${this.isCreatedByMe?"no one accepted":"user didn't interact with incoming call screen"}`}).catch(h=>{this.logger("error","Failed to drop call",h)})},l))},this.cancelAutoDrop=()=>{clearTimeout(this.dropTimeout),this.dropTimeout=void 0},this.queryRecordings=async o=>{let l=this.streamClientBasePath;return o&&(l=`${l}/${o}`),this.streamClient.get(`${l}/recordings`)},this.queryTranscriptions=async()=>this.streamClient.get(`${this.streamClientBasePath}/transcriptions`),this.getCallStats=async o=>{const l=`${this.streamClientBasePath}/stats/${o}`;return this.streamClient.get(l)},this.getCallReport=async(o="")=>{const l=`${this.streamClientBasePath}/report`,h=o!==""?{session_id:o}:{};return this.streamClient.get(l,h)},this.submitFeedback=async(o,{reason:l,custom:h}={})=>{var C;const{sdkName:u,sdkVersion:f,...S}=sr(await zt());return this.streamClient.post(`${this.streamClientBasePath}/feedback`,{rating:o,reason:l,user_session_id:(C=this.sfuClient)==null?void 0:C.sessionId,sdk:u,sdk_version:f,custom:{...h,"x-stream-platform-data":S}})},this.sendCustomEvent=async o=>this.streamClient.post(`${this.streamClientBasePath}/event`,{custom:o}),this.applyDeviceConfig=async(o,l)=>{await this.camera.apply(o.video,l).catch(h=>{this.logger("warn","Camera init failed",h)}),await this.microphone.apply(o.audio,l).catch(h=>{this.logger("warn","Mic init failed",h)})},this.trackElementVisibility=(o,l,h)=>this.dynascaleManager.trackElementVisibility(o,l,h),this.setViewport=o=>this.dynascaleManager.setViewport(o),this.bindVideoElement=(o,l,h)=>{const u=this.dynascaleManager.bindVideoElement(o,l,h);if(u)return this.leaveCallHooks.add(u),()=>{this.leaveCallHooks.delete(u),u()}},this.bindAudioElement=(o,l,h="audioTrack")=>{const u=this.dynascaleManager.bindAudioElement(o,l,h);if(u)return this.leaveCallHooks.add(u),()=>{this.leaveCallHooks.delete(u),u()}},this.bindCallThumbnailElement=(o,l={})=>{const h=()=>{o.src=l.fallbackImageSource||"https://getstream.io/random_svg/?name=x&id=x"},u=J(this.state.thumbnails$,f=>{if(!f)return;o.addEventListener("error",h);const S=new URL(f.image_url);S.searchParams.set("w",String(o.clientWidth)),S.searchParams.set("h",String(o.clientHeight)),o.src=S.toString()});return()=>{u(),o.removeEventListener("error",h)}},this.setPreferredIncomingVideoResolution=(o,l)=>{this.dynascaleManager.setVideoTrackSubscriptionOverrides(o?{enabled:!0,dimension:o}:void 0,l),this.dynascaleManager.applyTrackSubscriptions()},this.setIncomingVideoEnabled=o=>{this.dynascaleManager.setVideoTrackSubscriptionOverrides(o?void 0:{enabled:!1}),this.dynascaleManager.applyTrackSubscriptions()},this.setDisconnectionTimeout=o=>{this.disconnectionTimeoutSeconds=o},this.type=t,this.id=i,this.cid=`${t}:${i}`,this.ringingSubject=new E(d),this.watching=p,this.streamClient=e,this.clientStore=c,this.streamClientBasePath=`/call/${this.type}/${this.id}`,this.logger=R(["Call"]);const g=lo.get(t),m=r||g.options.sortParticipantsBy;m&&this.state.setSortParticipantsBy(m),this.state.setMembers(n||[]),this.state.setOwnCapabilities(a||[]),this.state.setCallingState(d?y.RINGING:y.IDLE),this.camera=new yo(this),this.microphone=new Ro(this),this.speaker=new Ao(this),this.screenShare=new Do(this),this.dynascaleManager=new ro(this.state,this.speaker)}get ringing(){return O(this.ringingSubject)}get currentUserId(){var t;return(t=this.clientStore.connectedUser)==null?void 0:t.id}get isCreatedByMe(){var t;return((t=this.state.createdBy)==null?void 0:t.id)===this.currentUserId}}var No=null;const Uo={[-1]:"InternalSystemError",2:"AccessKeyError",3:"AuthenticationFailedError",4:"InputError",5:"AuthenticationError",6:"DuplicateUsernameError",9:"RateLimitError",16:"DoesNotExistError",17:"NotAllowedError",18:"EventNotSupportedError",19:"ChannelFeatureNotSupportedError",20:"MessageTooLongError",21:"MultipleNestingLevelError",22:"PayloadTooBigError",23:"RequestTimeoutError",24:"MaxHeaderSizeExceededError",40:"AuthErrorTokenExpired",41:"AuthErrorTokenNotValidYet",42:"AuthErrorTokenUsedBeforeIssuedAt",43:"AuthErrorTokenSignatureInvalid",44:"CustomCommandEndpointMissingError",45:"CustomCommandEndpointCallError",46:"ConnectionIDNotFoundError",60:"CoolDownError",69:"ErrWrongRegion",70:"ErrQueryChannelPermissions",71:"ErrTooManyConnections",73:"MessageModerationFailedError",99:"AppSuspendedError"};class Lo{constructor(t){this._log=(i,e={},n="info")=>{this.client.logger(n,`connection:${i}`,e)},this.setClient=i=>{this.client=i},this._buildUrl=()=>{const i=new URLSearchParams;return i.set("api_key",this.client.key),i.set("stream-auth-type",this.client.getAuthType()),i.set("X-Stream-Client",this.client.getUserAgent()),`${this.client.wsBaseURL}/connect?${i.toString()}`},this.onlineStatusChanged=i=>{i.type==="offline"?(this._log("onlineStatusChanged() - Status changing to offline"),this._setHealth(!1,!0)):i.type==="online"&&(this._log(`onlineStatusChanged() - Status changing to online. isHealthy: ${this.isHealthy}`),this.isHealthy||this._reconnect({interval:10}))},this.onopen=i=>{var r;if(this.wsID!==i)return;const e=this.client.user;if(!e){this.client.logger("error","User not set, can't connect to WS");return}const n=this.client._getToken();if(!n){this.client.logger("error","Token not set, can't connect authenticate");return}const a=JSON.stringify({token:n,user_details:{id:e.id,name:e.name,image:e.image,custom:e.custom}});this._log(`onopen() - Sending auth message ${a}`,{},"trace"),(r=this.ws)==null||r.send(a),this._log("onopen() - onopen callback",{wsID:i})},this.onmessage=(i,e)=>{var a,r;if(this.wsID!==i)return;this._log("onmessage() - onmessage callback",{event:e,wsID:i});const n=typeof e.data=="string"?JSON.parse(e.data):null;if(!this.isConnectionOpenResolved&&n&&n.type==="connection.error"&&(this.isConnectionOpenResolved=!0,n.error)){(a=this.rejectConnectionOpen)==null||a.call(this,this._errorFromWSEvent(n,!1));return}if(this.lastEvent=new Date,n&&(n.type==="health.check"||n.type==="connection.ok")&&this.scheduleNextPing(),n&&n.type==="connection.ok"&&((r=this.resolveConnectionOpen)==null||r.call(this,n),this._setHealth(!0)),n&&n.type==="connection.error"&&n.error){const{code:c}=n.error;this.isHealthy=!1,this.isConnecting=!1,this.consecutiveFailures+=1,c===ce.TOKEN_EXPIRED&&!this.client.tokenManager.isStatic()&&(clearTimeout(this.connectionCheckTimeoutRef),this._log("connect() - WS failure due to expired token, so going to try to reload token and reconnect"),this._reconnect({refreshToken:!0}))}n&&(n.received_at=new Date,this.client.dispatchEvent(n)),this.scheduleConnectionCheck()},this.onclose=(i,e)=>{var n,a;if(this.wsID===i)if(this._log("onclose() - onclose callback - "+e.code,{event:e,wsID:i}),e.code===ce.WS_CLOSED_SUCCESS){const r=new Error(`WS connection reject with error ${e.reason}`);r.reason=e.reason,r.code=e.code,r.wasClean=e.wasClean,r.target=e.target,(n=this.rejectConnectionOpen)==null||n.call(this,r),this._log(`onclose() - WS connection reject with error ${e.reason}`,{event:e})}else this.consecutiveFailures+=1,this.totalFailures+=1,this._setHealth(!1),this.isConnecting=!1,(a=this.rejectConnectionOpen)==null||a.call(this,this._errorFromWSEvent(e)),this._log("onclose() - WS connection closed. Calling reconnect ...",{event:e}),this._reconnect()},this.onerror=(i,e)=>{var n;this.wsID===i&&(this.consecutiveFailures+=1,this.totalFailures+=1,this._setHealth(!1),this.isConnecting=!1,(n=this.rejectConnectionOpen)==null||n.call(this,new Error(`WebSocket error: ${e}`)),this._log("onerror() - WS connection resulted into error",{event:e}),this._reconnect())},this._setHealth=(i,e=!1)=>{if(i!==this.isHealthy){if(this.isHealthy=i,this.isHealthy||e){this.client.dispatchEvent({type:"connection.changed",online:this.isHealthy});return}setTimeout(()=>{this.isHealthy||this.client.dispatchEvent({type:"connection.changed",online:this.isHealthy})},5e3)}},this._errorFromWSEvent=(i,e=!0)=>{let n,a,r;if(ja(i))n=i.code,r=i.reason,a=0;else{const{error:p}=i;n=p.code,r=p.message,a=p.StatusCode}const c=`WS failed with code: ${n}: ${Uo[n]||n} and reason: ${r}`;this._log(c,{event:i},"warn");const d=new Error(c);return d.code=n,d.StatusCode=a,d.isWSFailure=e,d},this._setupConnectionPromise=()=>{this.isConnectionOpenResolved=!1,this.connectionOpenSafe=Ie(new Promise((i,e)=>{this.resolveConnectionOpen=i,this.rejectConnectionOpen=e}))},this.scheduleNextPing=()=>{const i=Je();this.healthCheckTimeoutRef&&i.clearTimeout(this.healthCheckTimeoutRef),this.healthCheckTimeoutRef=i.setTimeout(()=>{var n;const e=[{type:"health.check",client_id:this.client.clientID}];try{(n=this.ws)==null||n.send(JSON.stringify(e))}catch{}},this.pingInterval)},this.scheduleConnectionCheck=()=>{clearTimeout(this.connectionCheckTimeoutRef),this.connectionCheckTimeoutRef=setTimeout(()=>{const i=new Date;this.lastEvent&&i.getTime()-this.lastEvent.getTime()>this.connectionCheckTimeout&&(this._log("scheduleConnectionCheck - going to reconnect"),this._setHealth(!1),this._reconnect())},this.connectionCheckTimeout)},this.client=t,this.consecutiveFailures=0,this.totalFailures=0,this.isConnecting=!1,this.isDisconnected=!1,this.isConnectionOpenResolved=!1,this.isHealthy=!1,this.wsID=1,this.lastEvent=null,this.pingInterval=25*1e3,this.connectionCheckTimeout=this.pingInterval+10*1e3,St(this.onlineStatusChanged)}async connect(t=15e3){if(this.isConnecting)throw Error("You've called connect twice, can only attempt 1 connection at the time");this.isDisconnected=!1;try{const i=await this._connect();this.consecutiveFailures=0,this._log(`connect() - Established ws connection with healthcheck: ${i}`)}catch(i){if(this.isHealthy=!1,this.consecutiveFailures+=1,i.code===ce.TOKEN_EXPIRED&&!this.client.tokenManager.isStatic())this._log("connect() - WS failure due to expired token, so going to try to reload token and reconnect"),this._reconnect({refreshToken:!0});else if(!i.isWSFailure)throw new Error(JSON.stringify({code:i.code,StatusCode:i.StatusCode,message:i.message,isWSFailure:i.isWSFailure}))}return await this._waitForHealthy(t)}async _waitForHealthy(t=15e3){return Promise.race([(async()=>{for(let e=0;e<=t;e+=50)try{return await this.connectionOpen}catch(n){if(e===t)throw new Error(JSON.stringify({code:n.code,StatusCode:n.StatusCode,message:n.message,isWSFailure:n.isWSFailure}));await X(50)}})(),(async()=>{throw await X(t),this.isConnecting=!1,new Error(JSON.stringify({code:"",StatusCode:"",message:"initial WS connection could not be established",isWSFailure:!0}))})()])}disconnect(t){this._log(`disconnect() - Closing the websocket connection for wsID ${this.wsID}`),this.wsID+=1,this.isConnecting=!1,this.isDisconnected=!0,this.healthCheckTimeoutRef&&Je().clearInterval(this.healthCheckTimeoutRef),this.connectionCheckTimeoutRef&&clearInterval(this.connectionCheckTimeoutRef),Ss(this.onlineStatusChanged),this.isHealthy=!1;let i;const{ws:e}=this;return e&&e.close&&e.readyState===e.OPEN?(i=new Promise(n=>{const a=r=>{this._log(`disconnect() - resolving isClosedPromise ${r?"with":"without"} close frame`,{event:r}),n()};e.onclose=a,setTimeout(a,t??1e3)}),this._log("disconnect() - Manually closed connection by calling client.disconnect()"),e.close(ce.WS_CLOSED_SUCCESS,"Manually closed connection by calling client.disconnect()")):(this._log("disconnect() - ws connection doesn't exist or it is already closed."),i=Promise.resolve()),delete this.ws,i}async _connect(){var i,e,n,a;if(this.isConnecting)return;this.isConnecting=!0;let t=!1;try{this._log("_connect() - waiting for token"),await this.client.tokenManager.tokenReady(),t=!0}catch{}try{t||(this._log("_connect() - tokenProvider failed before, so going to retry"),await this.client.tokenManager.loadToken()),this.client.isConnectionIsPromisePending||this.client._setupConnectionIdPromise(),this._setupConnectionPromise();const r=this._buildUrl();this._log(`_connect() - Connecting to ${r}`);const c=this.client.options.WebSocketImpl??WebSocket;this.ws=new c(r),this.ws.onopen=this.onopen.bind(this,this.wsID),this.ws.onclose=this.onclose.bind(this,this.wsID),this.ws.onerror=this.onerror.bind(this,this.wsID),this.ws.onmessage=this.onmessage.bind(this,this.wsID);const d=await this.connectionOpen;if(this.isConnecting=!1,d)return this.connectionID=d.connection_id,(e=(i=this.client).resolveConnectionId)==null||e.call(i,this.connectionID),d}catch(r){throw this.client._setupConnectionIdPromise(),this.isConnecting=!1,this._log("_connect() - Error - ",r),(a=(n=this.client).rejectConnectionId)==null||a.call(n,r),r}}async _reconnect(t={}){if(this._log("_reconnect() - Initiating the reconnect"),this.isConnecting||this.isHealthy){this._log("_reconnect() - Abort (1) since already connecting or healthy");return}let i=t.interval;if(i||(i=Re(this.consecutiveFailures)),await X(i),this.isConnecting||this.isHealthy){this._log("_reconnect() - Abort (2) since already connecting or healthy");return}if(this.isDisconnected){this._log("_reconnect() - Abort (3) since disconnect() is called");return}this._log("_reconnect() - Destroying current WS connection"),this._destroyCurrentWSConnection(),t.refreshToken&&await this.client.tokenManager.loadToken();try{await this._connect(),this._log("_reconnect() - Waiting for recoverCallBack"),this._log("_reconnect() - Finished recoverCallBack"),this.consecutiveFailures=0}catch(e){if(this.isHealthy=!1,this.consecutiveFailures+=1,e.code===ce.TOKEN_EXPIRED&&!this.client.tokenManager.isStatic())return this._log("_reconnect() - WS failure due to expired token, so going to try to reload token and reconnect"),this._reconnect({refreshToken:!0});e.isWSFailure&&(this._log("_reconnect() - WS failure, so going to try to reconnect"),this._reconnect())}this._log("_reconnect() - == END ==")}_destroyCurrentWSConnection(){var t;this.wsID+=1;try{(t=this==null?void 0:this.ws)==null||t.close()}catch{}}get connectionOpen(){var t;return(t=this.connectionOpenSafe)==null?void 0:t.call(this)}}function $o(s){const t=s.split(".");if(t.length!==3)return"";const i=t[1],e=Mo(i);return JSON.parse(e).user_id}const Mo=s=>{const t={},i=String.fromCharCode,e=s.length;let n,a=0,r,c,d=0,p,g="";const m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(n=0;n<64;n++)t[m.charAt(n)]=n;for(c=0;c<e;c++)for(r=t[s.charAt(c)],a=(a<<6)+r,d+=6;d>=8;)((p=a>>>(d-=8)&255)||c<e-2)&&(g+=i(p));return g};class Fo{constructor(t){this.loadTokenPromise=null,this.type="static",this.setTokenOrProvider=async(i,e,n)=>{this.user=e,this.isAnonymous=n,this.validateToken(i),gt(i)&&(this.tokenProvider=i,this.type="provider"),typeof i=="string"&&(this.token=i,this.type="static"),await this.loadToken()},this.reset=()=>{this.token=void 0,this.tokenProvider=void 0,this.type="static",this.user=void 0,this.loadTokenPromise=null},this.validateToken=i=>{if(!(this.user&&this.isAnonymous&&!i)){if(!this.secret&&!i)throw new Error("User token can not be empty");if(typeof i!="string"&&!gt(i))throw new Error("User token should either be a string or a function");if(typeof i=="string"){if(this.isAnonymous&&i==="")return;const e=$o(i);if(i!=null&&(e==null||e===""||!this.isAnonymous&&e!==this.user.id))throw new Error("userToken does not have a user_id or is not matching with user.id")}}},this.tokenReady=()=>this.loadTokenPromise,this.loadToken=()=>(this.loadTokenPromise=new Promise(async(i,e)=>{if(this.type==="static")return i(this.token);if(this.tokenProvider&&typeof this.tokenProvider!="string"){try{const n=await this.tokenProvider();this.validateToken(n),this.token=n}catch(n){return e(new Error(`Call to tokenProvider failed with message: ${n}`,{cause:n}))}i(this.token)}}),this.loadTokenPromise),this.getToken=()=>{if(this.token)return this.token;if(this.user&&!this.token)return this.token;throw new Error("User token is not set. Either client.connectUser wasn't called or client.disconnect was called")},this.isStatic=()=>this.type==="static",this.secret=t}}const ss=async(s="https://hint.stream-io-video.com/",t=2e3,i=3)=>{const e=R(["location-hint"]);let n=0,a="ERR";do{const r=new AbortController,c=setTimeout(()=>r.abort(),t);try{const p=(await fetch(s,{method:"HEAD",signal:r.signal})).headers.get("x-amz-cf-pop")||"ERR";e("debug",`Location header: ${p}`),a=p.substring(0,3)}catch(d){e("warn",`Failed to get location hint from ${s}`,d),a="ERR"}finally{clearTimeout(c)}}while(a==="ERR"&&++n<i);return a};class jo{constructor(t,i){var n;this.listeners={},this.getAuthType=()=>this.anonymous?"anonymous":"jwt",this.setBaseURL=a=>{this.baseURL=a,this.wsBaseURL=this.baseURL.replace("http","ws").replace(":3030",":8800")},this.getLocationHint=async(a,r)=>{const c=await this.locationHint;return!c||c==="ERR"?(this.locationHint=ss(a??this.options.locationHintUrl,r??this.options.locationHintTimeout),this.locationHint):c},this._getConnectionID=()=>{var a;return(a=this.wsConnection)==null?void 0:a.connectionID},this._hasConnectionID=()=>!!this._getConnectionID(),this.connectUser=async(a,r)=>{if(!a.id)throw new Error('The "id" field on the user is missing');if(this.userID===a.id&&this.connectUserTask)return this.logger("warn","Consecutive calls to connectUser is detected, ideally you should only call this function once in your app."),this.connectUserTask;if(this.userID)throw new Error("Use client.disconnect() before trying to connect as a different user. connectUser was called twice.");(this.secret||this.node)&&!this.options.allowServerSideConnect&&this.logger("warn","Please do not use connectUser server side. Use our @stream-io/node-sdk instead: https://getstream.io/video/docs/api/"),this.userID=a.id,this.anonymous=!1,await this.tokenManager.setTokenOrProvider(r,a,!1),this._setUser(a),this.connectUserTask=this.openConnection();try{return St(this.updateNetworkConnectionStatus),await this.connectUserTask}catch(c){throw this.persistUserOnConnectionFailure?await this.closeConnection():await this.disconnectUser(),c}},this._setUser=a=>{this.user=a,this.userID=a.id,this._user={...a}},this.closeConnection=async a=>{var r;await((r=this.wsConnection)==null?void 0:r.disconnect(a))},this.openConnection=async()=>{var c,d,p;if(!this.userID)throw Error("UserWithId is not set on client, use client.connectUser or client.connectAnonymousUser instead");const a=(c=this.wsPromiseSafe)==null?void 0:c.call(this);if((d=this.wsConnection)!=null&&d.isConnecting&&a)return this.logger("info","client:openConnection() - connection already in progress"),await a;if((p=this.wsConnection)!=null&&p.isHealthy&&this._hasConnectionID()){this.logger("info","client:openConnection() - openConnection called twice, healthy connection already exists");return}this._setupConnectionIdPromise(),this.clientID=`${this.userID}--${ft()}`;const r=this.connect();return this.wsPromiseSafe=Ie(r),await r},this.disconnectUser=async a=>{this.logger("info","client:disconnect() - Disconnecting the client"),delete this.user,delete this._user,delete this.userID,this.anonymous=!1,await this.closeConnection(a),Ss(this.updateNetworkConnectionStatus),this.tokenManager.reset(),this.connectionIdPromiseSafe=void 0,this.rejectConnectionId=void 0,this.resolveConnectionId=void 0},this.connectGuestUser=async a=>{this.guestUserCreatePromise=this.doAxiosRequest("post","/guest",{user:a},{publicEndpoint:!0});const r=await this.guestUserCreatePromise;return this.guestUserCreatePromise.finally(()=>this.guestUserCreatePromise=void 0),this.connectUser(r.user,r.access_token)},this.connectAnonymousUser=async(a,r)=>{var c;St(this.updateNetworkConnectionStatus),this._setupConnectionIdPromise(),this.anonymous=!0,await this.tokenManager.setTokenOrProvider(r,a,!0),this._setUser(a),(c=this.resolveConnectionId)==null||c.call(this)},this.on=(a,r)=>{var c;return this.listeners[a]||(this.listeners[a]=[]),this.logger("debug",`Adding listener for ${a} event`),(c=this.listeners[a])==null||c.push(r),()=>{this.off(a,r)}},this.off=(a,r)=>{var c;this.listeners[a]||(this.listeners[a]=[]),this.logger("debug",`Removing listener for ${a} event`),this.listeners[a]=(c=this.listeners[a])==null?void 0:c.filter(d=>d!==r)},this._setupConnectionIdPromise=()=>{this.connectionIdPromiseSafe=Ie(new Promise((a,r)=>{this.resolveConnectionId=a,this.rejectConnectionId=r}))},this._logApiRequest=(a,r,c,d)=>{bt()==="trace"&&this.logger("trace",`client: ${a} - Request - ${r}`,{payload:c,config:d})},this._logApiResponse=(a,r,c)=>{bt()==="trace"&&this.logger("trace",`client:${a} - Response - url: ${r} > status ${c.status}`,{response:c})},this._logApiError=(a,r,c)=>{this.logger("error",`client:${a} - Error - url: ${r}`,{url:r,error:c})},this.doAxiosRequest=async(a,r,c,d={})=>{var g,m;if(!d.publicEndpoint){await Promise.all([this.tokenManager.tokenReady(),this.guestUserCreatePromise]);try{await this.connectionIdPromise}catch{await((g=this.wsConnection)==null?void 0:g._waitForHealthy()),await this.connectionIdPromise}}const p=this._enrichAxiosOptions(d);try{let o;switch(this._logApiRequest(a,r,c,p),a){case"get":o=await this.axiosInstance.get(r,p);break;case"delete":o=await this.axiosInstance.delete(r,p);break;case"post":o=await this.axiosInstance.post(r,c,p);break;case"put":o=await this.axiosInstance.put(r,c,p);break;case"patch":o=await this.axiosInstance.patch(r,c,p);break;case"options":o=await this.axiosInstance.options(r,p);break;default:throw new Error("Invalid request type")}return this._logApiResponse(a,r,o),this.consecutiveFailures=0,this.handleResponse(o)}catch(o){if(o.client_request_id=(m=p.headers)==null?void 0:m["x-client-request-id"],this.consecutiveFailures+=1,o.response)return this._logApiError(a,r,o.response),o.response.data.code===ce.TOKEN_EXPIRED&&!this.tokenManager.isStatic()?(this.consecutiveFailures>1&&await X(Re(this.consecutiveFailures)),await this.tokenManager.loadToken(),await this.doAxiosRequest(a,r,c,d)):this.handleResponse(o.response);throw this._logApiError(a,r,o),o}},this.get=(a,r)=>this.doAxiosRequest("get",a,null,{params:r}),this.put=(a,r,c)=>this.doAxiosRequest("put",a,r,{params:c}),this.post=(a,r,c)=>this.doAxiosRequest("post",a,r,{params:c}),this.patch=(a,r,c)=>this.doAxiosRequest("patch",a,r,{params:c}),this.delete=(a,r)=>this.doAxiosRequest("delete",a,null,{params:r}),this.errorFromResponse=a=>{const{data:r,status:c}=a;return new ns({message:`Stream error code ${r.code}: ${r.message}`,code:r.code??null,unrecoverable:r.unrecoverable??null,response:a,status:c})},this.handleResponse=a=>{const r=a.data;if(Fa(a))throw this.errorFromResponse(a);return r},this.dispatchEvent=a=>{if(this.logger("debug",`Dispatching event: ${a.type}`,a),!!this.listeners){for(const r of this.listeners.all||[])r(a);for(const r of this.listeners[a.type]||[])r(a)}},this.connect=async()=>{if(!this.userID||!this._user)throw Error("Call connectUser or connectAnonymousUser before starting the connection");if(!this.wsBaseURL)throw Error("Websocket base url not set");if(!this.clientID)throw Error("clientID is not set");return this.wsConnection=new Lo(this),this.logger("info","StreamClient.connect: this.wsConnection.connect()"),await this.wsConnection.connect(this.defaultWSTimeout)},this.getUserAgent=()=>{if(!this.cachedUserAgent){const{clientAppIdentifier:a={}}=this.options,{sdkName:r="js",sdkVersion:c="1.25.0",...d}=a;this.cachedUserAgent=[`stream-video-${r}-v${c}`,...Object.entries(d).map(([p,g])=>`${p}=${g}`),"client_bundle=browser-esm"].join("|")}return this.cachedUserAgent},this._enrichAxiosOptions=(a={params:{},headers:{},config:{}})=>{var d;const r=a.publicEndpoint&&!this.user?void 0:this._getToken(),c=r?{Authorization:r}:void 0;return(d=a.headers)!=null&&d["x-client-request-id"]||(a.headers={...a.headers,"x-client-request-id":ft()}),{params:{user_id:this.userID,connection_id:this._getConnectionID(),api_key:this.key,...a.params},headers:{...c,"stream-auth-type":a.publicEndpoint&&!this.user?"anonymous":this.getAuthType(),"X-Stream-Client":this.getUserAgent(),...a.headers},...a.config,...this.options.axiosRequestConfig}},this._getToken=()=>this.tokenManager?this.tokenManager.getToken():null,this.updateNetworkConnectionStatus=a=>{a.type==="offline"?(this.logger("debug","device went offline"),this.dispatchEvent({type:"network.changed",online:!1})):a.type==="online"&&(this.logger("debug","device went online"),this.dispatchEvent({type:"network.changed",online:!0}))},this.key=t,this.secret=i==null?void 0:i.secret;const e=i||{browser:typeof window<"u"};this.browser=e.browser||typeof window<"u",this.node=!this.browser,this.browser&&(this.locationHint=ss(i==null?void 0:i.locationHintUrl,i==null?void 0:i.locationHintTimeout,i==null?void 0:i.locationHintMaxAttempts)),this.options={timeout:5e3,withCredentials:!1,...e},this.node&&!this.options.httpsAgent&&(this.options.httpsAgent=new No.Agent({keepAlive:!0,keepAliveMsecs:3e3})),this.setBaseURL(this.options.baseURL||"https://video.stream-io-api.com/video"),this.axiosInstance=Hs.create({...this.options,baseURL:this.baseURL}),this.wsConnection=null,this.wsPromiseSafe=null,this.connectUserTask=null,this.anonymous=!1,this.persistUserOnConnectionFailure=(n=this.options)==null?void 0:n.persistUserOnConnectionFailure,this.tokenManager=new Fo(this.secret),this.consecutiveFailures=0,this.defaultWSTimeout=this.options.defaultWsTimeout??15e3,this.logger=gt(e.logger)?e.logger:()=>null}get connectionIdPromise(){var t;return(t=this.connectionIdPromiseSafe)==null?void 0:t.call(this)}get isConnectionIsPromisePending(){var t;return((t=this.connectionIdPromiseSafe)==null?void 0:t.checkPending())??!1}get wsPromise(){var t;return(t=this.wsPromiseSafe)==null?void 0:t.call(this)}}const ut=(s,t)=>`${s}/${t.id}`,Vo=s=>{const t=(s==null?void 0:s.clientAppIdentifier)||{},i=pr();return i&&(t.sdkName=ee[i.type].toLowerCase(),t.sdkVersion=`${i.major}.${i.minor}.${i.patch}`),t},xo=(s,t)=>{const i=Vo(t),e=R(["coordinator"]);return new jo(s,{persistUserOnConnectionFailure:!0,...t,clientAppIdentifier:i,logger:e})},Ho=s=>{const{token:t,tokenProvider:i}=s;if(t&&i){let e=!1;return async function(){return e?i():(e=!0,t)}}return t||i};class se{constructor(t,i){this.effectsRegistered=!1,this.eventHandlersToUnregister=[],this.connectionConcurrencyTag=Symbol("connectionConcurrencyTag"),this.registerClientInstance=(r,c)=>{const d=ut(r,c);se._instances.has(d)&&this.logger("warn",`A StreamVideoClient already exists for ${c.id}; Prefer using getOrCreateInstance method`),se._instances.set(d,this)},this.registerEffects=()=>{this.effectsRegistered||(this.eventHandlersToUnregister.push(this.on("connection.changed",r=>{if(!r.online)return;const c=this.writeableStateStore.calls.filter(d=>d.watching).map(d=>d.cid);c.length<=0||(this.logger("info",`Rewatching calls ${c.join(", ")}`),this.queryCalls({watch:!0,filter_conditions:{cid:{$in:c}},sort:[{field:"cid",direction:1}]}).catch(d=>{this.logger("error","Failed to re-watch calls",d)}))})),this.eventHandlersToUnregister.push(this.on("call.created",r=>{var g;const{call:c,members:d}=r;if(((g=this.state.connectedUser)==null?void 0:g.id)===c.created_by.id){this.logger("warn","Received `call.created` sent by the current user");return}this.logger("info",`New call created and registered: ${c.cid}`);const p=new Te({streamClient:this.streamClient,type:c.type,id:c.id,members:d,clientStore:this.writeableStateStore});p.state.updateFromCallResponse(c),this.writeableStateStore.registerCall(p)})),this.eventHandlersToUnregister.push(this.on("call.ring",async r=>{var g;const{call:c,members:d}=r;if(((g=this.state.connectedUser)==null?void 0:g.id)===c.created_by.id){this.logger("debug","Received `call.ring` sent by the current user so ignoring the event");return}const p=this.writeableStateStore.findCall(c.type,c.id);p?await p.updateFromRingingEvent(r):await new Te({streamClient:this.streamClient,type:c.type,id:c.id,members:d,clientStore:this.writeableStateStore,ringing:!0}).get()})),this.effectsRegistered=!0)},this.connectUser=async(r,c)=>{if(r.type==="anonymous")return r.id="!anon",this.connectAnonymousUser(r,c);const d=await W(this.connectionConcurrencyTag,async()=>{const p=this.streamClient,{onConnectUserError:g,persistUserOnConnectionFailure:m}=p.options;let{maxConnectUserRetries:o=5}=p.options;o=Math.max(o,1);const l=[];for(let h=0;h<o;h++)try{return this.logger("trace",`Connecting user (${h})`,r),r.type==="guest"?await p.connectGuestUser(r):await p.connectUser(r,c)}catch(u){if(this.logger("warn",`Failed to connect a user (${h})`,u),l.push(u),h===o-1)throw g==null||g(u,l),u;m&&await p.disconnectUser(),await X(Re(h))}});return d!=null&&d.me&&this.writeableStateStore.setConnectedUser(d.me),this.registerEffects(),d},this.disconnectUser=async r=>{await W(this.connectionConcurrencyTag,async()=>{const{user:c,key:d}=this.streamClient;c&&(await this.streamClient.disconnectUser(r),c.id&&se._instances.delete(ut(d,c)),this.eventHandlersToUnregister.forEach(p=>p()),this.eventHandlersToUnregister=[],this.effectsRegistered=!1,this.writeableStateStore.setConnectedUser(void 0))})},this.on=(r,c)=>this.streamClient.on(r,c),this.off=(r,c)=>this.streamClient.off(r,c),this.call=(r,c,d={})=>(d.reuseInstance?this.writeableStateStore.findCall(r,c):void 0)??new Te({streamClient:this.streamClient,id:c,type:r,clientStore:this.writeableStateStore}),this.createGuestUser=async r=>this.streamClient.doAxiosRequest("post","/guest",r,{publicEndpoint:!0}),this.queryCalls=async(r={})=>{const c=await this.streamClient.post("/calls",r),d=[];for(const p of c.calls){const g=new Te({streamClient:this.streamClient,id:p.call.id,type:p.call.type,members:p.members,ownCapabilities:p.own_capabilities,watching:r.watch,clientStore:this.writeableStateStore});g.state.updateFromCallResponse(p.call),await g.applyDeviceConfig(p.call.settings,!1),r.watch&&(await g.setup(),this.writeableStateStore.registerCall(g)),d.push(g)}return{...c,calls:d}},this.queryCallStats=async(r={})=>this.streamClient.post("/call/stats",r),this.queryAggregateCallStats=async(r={})=>this.streamClient.post("/stats",r),this.edges=async()=>this.streamClient.get("/edges"),this.addDevice=async(r,c,d,p,g)=>await this.streamClient.post("/devices",{id:r,push_provider:c,voip_token:g,...p!=null?{user_id:p}:{},...d!=null?{push_provider_name:d}:{}}),this.addVoipDevice=async(r,c,d,p)=>await this.addDevice(r,c,d,p,!0),this.getDevices=async r=>await this.streamClient.get("/devices",r?{user_id:r}:{}),this.removeDevice=async(r,c)=>await this.streamClient.delete("/devices",{id:r,...c?{user_id:c}:{}}),this.onRingingCall=async r=>{let c=this.state.calls.find(d=>d.cid===r&&d.ringing);if(!c){const[d,p]=r.split(":");c=new Te({streamClient:this.streamClient,type:d,id:p,clientStore:this.writeableStateStore,ringing:!0}),await c.get()}return c},this.connectAnonymousUser=async(r,c)=>W(this.connectionConcurrencyTag,()=>this.streamClient.connectAnonymousUser(r,c));const e=typeof t=="string"?t:t.apiKey,n=typeof t=="string"?i:t.options;n!=null&&n.enableTimerWorker&&Fr();const a=(n==null?void 0:n.logger)||Ts;if(Va(a,(n==null?void 0:n.logLevel)||"warn"),this.logger=R(["client"]),this.streamClient=xo(e,n),this.writeableStateStore=new Qa,this.readOnlyStateStore=new za(this.writeableStateStore),typeof t!="string"&&t.user){const r=t.user;r.type==="anonymous"&&(r.id="!anon"),r.id&&this.registerClientInstance(e,r);const c=Ho(t);this.connectUser(r,c).catch(d=>{this.logger("error","Failed to connect",d)})}}static getOrCreateInstance(t){const{apiKey:i,user:e,token:n,tokenProvider:a}=t;if(!e.id&&e.type!=="anonymous")throw new Error("user.id is required for a non-anonymous user");if(!n&&!a&&e.type!=="anonymous"&&e.type!=="guest")throw new Error("tokenProvider or token is required for a authenticated users");return se._instances.get(ut(i,e))||new se(t)}get state(){return this.readOnlyStateStore}}se._instances=new Map;export{tr as C,N as O,se as S,D as V,De as a,Za as b,te as c,le as d,lo as e,Be as f,R as g,ie as h,tc as i,ic as j,y as k,ws as l,Xo as m,nc as n,ec as r,sc as s};
