var is={},dr=Object.create,Xi=Object.defineProperty,ur=Object.getOwnPropertyDescriptor,Zi=Object.getOwnPropertyNames,fr=Object.getPrototypeOf,pr=Object.prototype.hasOwnProperty,ze=(e,t)=>function(){return t||(0,e[Zi(e)[0]])((t={exports:{}}).exports,t),t.exports},gr=(e,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Zi(t))!pr.call(e,n)&&n!==s&&Xi(e,n,{get:()=>t[n],enumerable:!(i=ur(t,n))||i.enumerable});return e},Qe=(e,t,s)=>(s=e!=null?dr(fr(e)):{},gr(!e||!e.__esModule?Xi(s,"default",{value:e,enumerable:!0}):s,e)),mr=ze({"node_modules/base64-js/index.js"(e){e.byteLength=l,e.toByteArray=c,e.fromByteArray=p;var t=[],s=[],i=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(a=0,r=n.length;a<r;++a)t[a]=n[a],s[n.charCodeAt(a)]=a;var a,r;s[45]=62,s[95]=63;function o(f){var g=f.length;if(g%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var m=f.indexOf("=");m===-1&&(m=g);var w=m===g?0:4-m%4;return[m,w]}function l(f){var g=o(f),m=g[0],w=g[1];return(m+w)*3/4-w}function h(f,g,m){return(g+m)*3/4-m}function c(f){var g,m=o(f),w=m[0],b=m[1],v=new i(h(f,w,b)),C=0,S=b>0?w-4:w,U;for(U=0;U<S;U+=4)g=s[f.charCodeAt(U)]<<18|s[f.charCodeAt(U+1)]<<12|s[f.charCodeAt(U+2)]<<6|s[f.charCodeAt(U+3)],v[C++]=g>>16&255,v[C++]=g>>8&255,v[C++]=g&255;return b===2&&(g=s[f.charCodeAt(U)]<<2|s[f.charCodeAt(U+1)]>>4,v[C++]=g&255),b===1&&(g=s[f.charCodeAt(U)]<<10|s[f.charCodeAt(U+1)]<<4|s[f.charCodeAt(U+2)]>>2,v[C++]=g>>8&255,v[C++]=g&255),v}function d(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function u(f,g,m){for(var w,b=[],v=g;v<m;v+=3)w=(f[v]<<16&16711680)+(f[v+1]<<8&65280)+(f[v+2]&255),b.push(d(w));return b.join("")}function p(f){for(var g,m=f.length,w=m%3,b=[],v=16383,C=0,S=m-w;C<S;C+=v)b.push(u(f,C,C+v>S?S:C+v));return w===1?(g=f[m-1],b.push(t[g>>2]+t[g<<4&63]+"==")):w===2&&(g=(f[m-2]<<8)+f[m-1],b.push(t[g>>10]+t[g>>4&63]+t[g<<2&63]+"=")),b.join("")}}}),yr=ze({"(disabled):https"(){}}),_r=ze({"node_modules/form-data/lib/browser.js"(e,t){t.exports=typeof self=="object"?self.FormData:window.FormData}}),wr=ze({"(disabled):node_modules/jsonwebtoken/index.js"(){}}),br=ze({"(disabled):crypto"(){}}),vr=Qe(mr());function Cs(e){return typeof e=="string"}function di(e,t){return!!t&&Cs(e)}function Cr(e,t){const s=[];if(Cs(e)&&di(e,t)){for(let i=0,n=e.length;i<n;i++)if(e.charAt(i)){const a=e.charAt(i),r=t(a,i,e);s[i]=r}}else if(!Cs(e)&&!di(e,t)){for(let i=0,n=e.length;i<n;i++)if(i in e){const a=e[i],r=t(a,i,e);s[i]=r}}return s}var Sr=e=>(0,vr.fromByteArray)(new Uint8Array(Cr(e,t=>t.charCodeAt(0)))),Rr=e=>{const t={},s=String.fromCharCode,i=e.length;let n,a=0,r,o,l=0,h,c="";const d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(n=0;n<64;n++)t[d.charAt(n)]=n;for(o=0;o<i;o++)for(r=t[e.charAt(o)],a=(a<<6)+r,l+=6;l>=8;)((h=a>>>(l-=8)&255)||o<i-2)&&(c+=s(h));return c},ui=class{constructor(e,t,s){this.client=e,this.id=t,this.data=s}async create(){var s,i,n,a,r,o,l,h,c,d,u,p;const e={id:this.id,message_template:(s=this.data)==null?void 0:s.message_template,segment_ids:(i=this.data)==null?void 0:i.segment_ids,sender_id:(n=this.data)==null?void 0:n.sender_id,sender_mode:(a=this.data)==null?void 0:a.sender_mode,channel_template:(r=this.data)==null?void 0:r.channel_template,create_channels:(o=this.data)==null?void 0:o.create_channels,show_channels:(l=this.data)==null?void 0:l.show_channels,description:(h=this.data)==null?void 0:h.description,name:(c=this.data)==null?void 0:c.name,skip_push:(d=this.data)==null?void 0:d.skip_push,skip_webhook:(u=this.data)==null?void 0:u.skip_webhook,user_ids:(p=this.data)==null?void 0:p.user_ids},t=await this.client.createCampaign(e);return this.id=t.campaign.id,this.data=t.campaign,t}verifyCampaignId(){if(!this.id)throw new Error("Campaign id is missing. Either create the campaign using campaign.create() or set the id during instantiation - const campaign = client.campaign(id)")}async start(e){return this.verifyCampaignId(),await this.client.startCampaign(this.id,e)}update(e){return this.verifyCampaignId(),this.client.updateCampaign(this.id,e)}async delete(){return this.verifyCampaignId(),await this.client.deleteCampaign(this.id)}stop(){return this.verifyCampaignId(),this.client.stopCampaign(this.id)}get(e){return this.verifyCampaignId(),this.client.getCampaign(this.id,e)}};function en(e,t){return function(){return e.apply(t,arguments)}}var{toString:Er}=Object.prototype,{getPrototypeOf:Ws}=Object,Jt=(e=>t=>{const s=Er.call(t);return e[s]||(e[s]=s.slice(8,-1).toLowerCase())})(Object.create(null)),W=e=>(e=e.toLowerCase(),t=>Jt(t)===e),Kt=e=>t=>typeof t===e,{isArray:_e}=Array,qe=Kt("undefined");function xr(e){return e!==null&&!qe(e)&&e.constructor!==null&&!qe(e.constructor)&&F(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}var tn=W("ArrayBuffer");function Ur(e){let t;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?t=ArrayBuffer.isView(e):t=e&&e.buffer&&tn(e.buffer),t}var Ar=Kt("string"),F=Kt("function"),sn=Kt("number"),Yt=e=>e!==null&&typeof e=="object",Mr=e=>e===!0||e===!1,lt=e=>{if(Jt(e)!=="object")return!1;const t=Ws(e);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},Lr=W("Date"),Tr=W("File"),Ir=W("Blob"),Dr=W("FileList"),Pr=e=>Yt(e)&&F(e.pipe),Or=e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||F(e.append)&&((t=Jt(e))==="formdata"||t==="object"&&F(e.toString)&&e.toString()==="[object FormData]"))},kr=W("URLSearchParams"),Nr=e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Ge(e,t,{allOwnKeys:s=!1}={}){if(e===null||typeof e>"u")return;let i,n;if(typeof e!="object"&&(e=[e]),_e(e))for(i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else{const a=s?Object.getOwnPropertyNames(e):Object.keys(e),r=a.length;let o;for(i=0;i<r;i++)o=a[i],t.call(null,e[o],o,e)}}function nn(e,t){t=t.toLowerCase();const s=Object.keys(e);let i=s.length,n;for(;i-- >0;)if(n=s[i],t===n.toLowerCase())return n;return null}var rn=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,an=e=>!qe(e)&&e!==rn;function Ss(){const{caseless:e}=an(this)&&this||{},t={},s=(i,n)=>{const a=e&&nn(t,n)||n;lt(t[a])&&lt(i)?t[a]=Ss(t[a],i):lt(i)?t[a]=Ss({},i):_e(i)?t[a]=i.slice():t[a]=i};for(let i=0,n=arguments.length;i<n;i++)arguments[i]&&Ge(arguments[i],s);return t}var Fr=(e,t,s,{allOwnKeys:i}={})=>(Ge(t,(n,a)=>{s&&F(n)?e[a]=en(n,s):e[a]=n},{allOwnKeys:i}),e),$r=e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),qr=(e,t,s,i)=>{e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),s&&Object.assign(e.prototype,s)},Br=(e,t,s,i)=>{let n,a,r;const o={};if(t=t||{},e==null)return t;do{for(n=Object.getOwnPropertyNames(e),a=n.length;a-- >0;)r=n[a],(!i||i(r,e,t))&&!o[r]&&(t[r]=e[r],o[r]=!0);e=s!==!1&&Ws(e)}while(e&&(!s||s(e,t))&&e!==Object.prototype);return t},Vr=(e,t,s)=>{e=String(e),(s===void 0||s>e.length)&&(s=e.length),s-=t.length;const i=e.indexOf(t,s);return i!==-1&&i===s},Hr=e=>{if(!e)return null;if(_e(e))return e;let t=e.length;if(!sn(t))return null;const s=new Array(t);for(;t-- >0;)s[t]=e[t];return s},jr=(e=>t=>e&&t instanceof e)(typeof Uint8Array<"u"&&Ws(Uint8Array)),Wr=(e,t)=>{const i=(e&&e[Symbol.iterator]).call(e);let n;for(;(n=i.next())&&!n.done;){const a=n.value;t.call(e,a[0],a[1])}},zr=(e,t)=>{let s;const i=[];for(;(s=e.exec(t))!==null;)i.push(s);return i},Qr=W("HTMLFormElement"),Gr=e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(s,i,n){return i.toUpperCase()+n}),fi=(({hasOwnProperty:e})=>(t,s)=>e.call(t,s))(Object.prototype),Jr=W("RegExp"),on=(e,t)=>{const s=Object.getOwnPropertyDescriptors(e),i={};Ge(s,(n,a)=>{let r;(r=t(n,a,e))!==!1&&(i[a]=r||n)}),Object.defineProperties(e,i)},Kr=e=>{on(e,(t,s)=>{if(F(e)&&["arguments","caller","callee"].indexOf(s)!==-1)return!1;const i=e[s];if(F(i)){if(t.enumerable=!1,"writable"in t){t.writable=!1;return}t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+s+"'")})}})},Yr=(e,t)=>{const s={},i=n=>{n.forEach(a=>{s[a]=!0})};return _e(e)?i(e):i(String(e).split(t)),s},Xr=()=>{},Zr=(e,t)=>(e=+e,Number.isFinite(e)?e:t),ns="abcdefghijklmnopqrstuvwxyz",pi="0123456789",ln={DIGIT:pi,ALPHA:ns,ALPHA_DIGIT:ns+ns.toUpperCase()+pi},ea=(e=16,t=ln.ALPHA_DIGIT)=>{let s="";const{length:i}=t;for(;e--;)s+=t[Math.random()*i|0];return s};function ta(e){return!!(e&&F(e.append)&&e[Symbol.toStringTag]==="FormData"&&e[Symbol.iterator])}var sa=e=>{const t=new Array(10),s=(i,n)=>{if(Yt(i)){if(t.indexOf(i)>=0)return;if(!("toJSON"in i)){t[n]=i;const a=_e(i)?[]:{};return Ge(i,(r,o)=>{const l=s(r,n+1);!qe(l)&&(a[o]=l)}),t[n]=void 0,a}}return i};return s(e,0)},ia=W("AsyncFunction"),na=e=>e&&(Yt(e)||F(e))&&F(e.then)&&F(e.catch),y={isArray:_e,isArrayBuffer:tn,isBuffer:xr,isFormData:Or,isArrayBufferView:Ur,isString:Ar,isNumber:sn,isBoolean:Mr,isObject:Yt,isPlainObject:lt,isUndefined:qe,isDate:Lr,isFile:Tr,isBlob:Ir,isRegExp:Jr,isFunction:F,isStream:Pr,isURLSearchParams:kr,isTypedArray:jr,isFileList:Dr,forEach:Ge,merge:Ss,extend:Fr,trim:Nr,stripBOM:$r,inherits:qr,toFlatObject:Br,kindOf:Jt,kindOfTest:W,endsWith:Vr,toArray:Hr,forEachEntry:Wr,matchAll:zr,isHTMLForm:Qr,hasOwnProperty:fi,hasOwnProp:fi,reduceDescriptors:on,freezeMethods:Kr,toObjectSet:Yr,toCamelCase:Gr,noop:Xr,toFiniteNumber:Zr,findKey:nn,global:rn,isContextDefined:an,ALPHABET:ln,generateString:ea,isSpecCompliantForm:ta,toJSONObject:sa,isAsyncFn:ia,isThenable:na};function ge(e,t,s,i,n){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),s&&(this.config=s),i&&(this.request=i),n&&(this.response=n)}y.inherits(ge,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:y.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var cn=ge.prototype,hn={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{hn[e]={value:e}});Object.defineProperties(ge,hn);Object.defineProperty(cn,"isAxiosError",{value:!0});ge.from=(e,t,s,i,n,a)=>{const r=Object.create(cn);return y.toFlatObject(e,r,function(l){return l!==Error.prototype},o=>o!=="isAxiosError"),ge.call(r,e.message,t,s,i,n),r.cause=e,r.name=e.name,a&&Object.assign(r,a),r};var x=ge,ra=null;function Rs(e){return y.isPlainObject(e)||y.isArray(e)}function dn(e){return y.endsWith(e,"[]")?e.slice(0,-2):e}function gi(e,t,s){return e?e.concat(t).map(function(n,a){return n=dn(n),!s&&a?"["+n+"]":n}).join(s?".":""):t}function aa(e){return y.isArray(e)&&!e.some(Rs)}var oa=y.toFlatObject(y,{},null,function(t){return/^is[A-Z]/.test(t)});function la(e,t,s){if(!y.isObject(e))throw new TypeError("target must be an object");t=t||new FormData,s=y.toFlatObject(s,{metaTokens:!0,dots:!1,indexes:!1},!1,function(g,m){return!y.isUndefined(m[g])});const i=s.metaTokens,n=s.visitor||c,a=s.dots,r=s.indexes,l=(s.Blob||typeof Blob<"u"&&Blob)&&y.isSpecCompliantForm(t);if(!y.isFunction(n))throw new TypeError("visitor must be a function");function h(f){if(f===null)return"";if(y.isDate(f))return f.toISOString();if(!l&&y.isBlob(f))throw new x("Blob is not supported. Use a Buffer instead.");return y.isArrayBuffer(f)||y.isTypedArray(f)?l&&typeof Blob=="function"?new Blob([f]):Buffer.from(f):f}function c(f,g,m){let w=f;if(f&&!m&&typeof f=="object"){if(y.endsWith(g,"{}"))g=i?g:g.slice(0,-2),f=JSON.stringify(f);else if(y.isArray(f)&&aa(f)||(y.isFileList(f)||y.endsWith(g,"[]"))&&(w=y.toArray(f)))return g=dn(g),w.forEach(function(v,C){!(y.isUndefined(v)||v===null)&&t.append(r===!0?gi([g],C,a):r===null?g:g+"[]",h(v))}),!1}return Rs(f)?!0:(t.append(gi(m,g,a),h(f)),!1)}const d=[],u=Object.assign(oa,{defaultVisitor:c,convertValue:h,isVisitable:Rs});function p(f,g){if(!y.isUndefined(f)){if(d.indexOf(f)!==-1)throw Error("Circular reference detected in "+g.join("."));d.push(f),y.forEach(f,function(w,b){(!(y.isUndefined(w)||w===null)&&n.call(t,w,y.isString(b)?b.trim():b,g,u))===!0&&p(w,g?g.concat(b):[b])}),d.pop()}}if(!y.isObject(e))throw new TypeError("data must be an object");return p(e),t}var Xt=la;function mi(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(i){return t[i]})}function un(e,t){this._pairs=[],e&&Xt(e,this,t)}var fn=un.prototype;fn.append=function(t,s){this._pairs.push([t,s])};fn.toString=function(t){const s=t?function(i){return t.call(this,i,mi)}:mi;return this._pairs.map(function(n){return s(n[0])+"="+s(n[1])},"").join("&")};var pn=un;function ca(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function gn(e,t,s){if(!t)return e;const i=s&&s.encode||ca,n=s&&s.serialize;let a;if(n?a=n(t,s):a=y.isURLSearchParams(t)?t.toString():new pn(t,s).toString(i),a){const r=e.indexOf("#");r!==-1&&(e=e.slice(0,r)),e+=(e.indexOf("?")===-1?"?":"&")+a}return e}var ha=class{constructor(){this.handlers=[]}use(e,t,s){return this.handlers.push({fulfilled:e,rejected:t,synchronous:s?s.synchronous:!1,runWhen:s?s.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){y.forEach(this.handlers,function(s){s!==null&&e(s)})}},yi=ha,mn={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},da=typeof URLSearchParams<"u"?URLSearchParams:pn,ua=typeof FormData<"u"?FormData:null,fa=typeof Blob<"u"?Blob:null,pa=(()=>{let e;return typeof navigator<"u"&&((e=navigator.product)==="ReactNative"||e==="NativeScript"||e==="NS")?!1:typeof window<"u"&&typeof document<"u"})(),ga=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",j={classes:{URLSearchParams:da,FormData:ua,Blob:fa},isStandardBrowserEnv:pa,isStandardBrowserWebWorkerEnv:ga,protocols:["http","https","file","blob","url","data"]};function ma(e,t){return Xt(e,new j.classes.URLSearchParams,Object.assign({visitor:function(s,i,n,a){return j.isNode&&y.isBuffer(s)?(this.append(i,s.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},t))}function ya(e){return y.matchAll(/\w+|\[(\w*)]/g,e).map(t=>t[0]==="[]"?"":t[1]||t[0])}function _a(e){const t={},s=Object.keys(e);let i;const n=s.length;let a;for(i=0;i<n;i++)a=s[i],t[a]=e[a];return t}function wa(e){function t(s,i,n,a){let r=s[a++];const o=Number.isFinite(+r),l=a>=s.length;return r=!r&&y.isArray(n)?n.length:r,l?(y.hasOwnProp(n,r)?n[r]=[n[r],i]:n[r]=i,!o):((!n[r]||!y.isObject(n[r]))&&(n[r]=[]),t(s,i,n[r],a)&&y.isArray(n[r])&&(n[r]=_a(n[r])),!o)}if(y.isFormData(e)&&y.isFunction(e.entries)){const s={};return y.forEachEntry(e,(i,n)=>{t(ya(i),n,s,0)}),s}return null}var yn=wa;function ba(e,t,s){if(y.isString(e))try{return(t||JSON.parse)(e),y.trim(e)}catch(i){if(i.name!=="SyntaxError")throw i}return(s||JSON.stringify)(e)}var zs={transitional:mn,adapter:["xhr","http"],transformRequest:[function(t,s){const i=s.getContentType()||"",n=i.indexOf("application/json")>-1,a=y.isObject(t);if(a&&y.isHTMLForm(t)&&(t=new FormData(t)),y.isFormData(t))return n&&n?JSON.stringify(yn(t)):t;if(y.isArrayBuffer(t)||y.isBuffer(t)||y.isStream(t)||y.isFile(t)||y.isBlob(t))return t;if(y.isArrayBufferView(t))return t.buffer;if(y.isURLSearchParams(t))return s.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(a){if(i.indexOf("application/x-www-form-urlencoded")>-1)return ma(t,this.formSerializer).toString();if((o=y.isFileList(t))||i.indexOf("multipart/form-data")>-1){const l=this.env&&this.env.FormData;return Xt(o?{"files[]":t}:t,l&&new l,this.formSerializer)}}return a||n?(s.setContentType("application/json",!1),ba(t)):t}],transformResponse:[function(t){const s=this.transitional||zs.transitional,i=s&&s.forcedJSONParsing,n=this.responseType==="json";if(t&&y.isString(t)&&(i&&!this.responseType||n)){const r=!(s&&s.silentJSONParsing)&&n;try{return JSON.parse(t)}catch(o){if(r)throw o.name==="SyntaxError"?x.from(o,x.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:j.classes.FormData,Blob:j.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};y.forEach(["delete","get","head","post","put","patch"],e=>{zs.headers[e]={}});var Qs=zs,va=y.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Ca=e=>{const t={};let s,i,n;return e&&e.split(`
`).forEach(function(r){n=r.indexOf(":"),s=r.substring(0,n).trim().toLowerCase(),i=r.substring(n+1).trim(),!(!s||t[s]&&va[s])&&(s==="set-cookie"?t[s]?t[s].push(i):t[s]=[i]:t[s]=t[s]?t[s]+", "+i:i)}),t},_i=Symbol("internals");function Se(e){return e&&String(e).trim().toLowerCase()}function ct(e){return e===!1||e==null?e:y.isArray(e)?e.map(ct):String(e)}function Sa(e){const t=Object.create(null),s=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let i;for(;i=s.exec(e);)t[i[1]]=i[2];return t}var Ra=e=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim());function rs(e,t,s,i,n){if(y.isFunction(i))return i.call(this,t,s);if(n&&(t=s),!!y.isString(t)){if(y.isString(i))return t.indexOf(i)!==-1;if(y.isRegExp(i))return i.test(t)}}function Ea(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(t,s,i)=>s.toUpperCase()+i)}function xa(e,t){const s=y.toCamelCase(" "+t);["get","set","has"].forEach(i=>{Object.defineProperty(e,i+s,{value:function(n,a,r){return this[i].call(this,t,n,a,r)},configurable:!0})})}var Zt=class{constructor(e){e&&this.set(e)}set(e,t,s){const i=this;function n(r,o,l){const h=Se(o);if(!h)throw new Error("header name must be a non-empty string");const c=y.findKey(i,h);(!c||i[c]===void 0||l===!0||l===void 0&&i[c]!==!1)&&(i[c||o]=ct(r))}const a=(r,o)=>y.forEach(r,(l,h)=>n(l,h,o));return y.isPlainObject(e)||e instanceof this.constructor?a(e,t):y.isString(e)&&(e=e.trim())&&!Ra(e)?a(Ca(e),t):e!=null&&n(t,e,s),this}get(e,t){if(e=Se(e),e){const s=y.findKey(this,e);if(s){const i=this[s];if(!t)return i;if(t===!0)return Sa(i);if(y.isFunction(t))return t.call(this,i,s);if(y.isRegExp(t))return t.exec(i);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Se(e),e){const s=y.findKey(this,e);return!!(s&&this[s]!==void 0&&(!t||rs(this,this[s],s,t)))}return!1}delete(e,t){const s=this;let i=!1;function n(a){if(a=Se(a),a){const r=y.findKey(s,a);r&&(!t||rs(s,s[r],r,t))&&(delete s[r],i=!0)}}return y.isArray(e)?e.forEach(n):n(e),i}clear(e){const t=Object.keys(this);let s=t.length,i=!1;for(;s--;){const n=t[s];(!e||rs(this,this[n],n,e,!0))&&(delete this[n],i=!0)}return i}normalize(e){const t=this,s={};return y.forEach(this,(i,n)=>{const a=y.findKey(s,n);if(a){t[a]=ct(i),delete t[n];return}const r=e?Ea(n):String(n).trim();r!==n&&delete t[n],t[r]=ct(i),s[r]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return y.forEach(this,(s,i)=>{s!=null&&s!==!1&&(t[i]=e&&y.isArray(s)?s.join(", "):s)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const s=new this(e);return t.forEach(i=>s.set(i)),s}static accessor(e){const s=(this[_i]=this[_i]={accessors:{}}).accessors,i=this.prototype;function n(a){const r=Se(a);s[r]||(xa(i,a),s[r]=!0)}return y.isArray(e)?e.forEach(n):n(e),this}};Zt.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);y.reduceDescriptors(Zt.prototype,({value:e},t)=>{let s=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(i){this[s]=i}}});y.freezeMethods(Zt);var J=Zt;function as(e,t){const s=this||Qs,i=t||s,n=J.from(i.headers);let a=i.data;return y.forEach(e,function(o){a=o.call(s,a,n.normalize(),t?t.status:void 0)}),n.normalize(),a}function _n(e){return!!(e&&e.__CANCEL__)}function wn(e,t,s){x.call(this,e??"canceled",x.ERR_CANCELED,t,s),this.name="CanceledError"}y.inherits(wn,x,{__CANCEL__:!0});var es=wn;function Ua(e,t,s){const i=s.config.validateStatus;!s.status||!i||i(s.status)?e(s):t(new x("Request failed with status code "+s.status,[x.ERR_BAD_REQUEST,x.ERR_BAD_RESPONSE][Math.floor(s.status/100)-4],s.config,s.request,s))}var Aa=j.isStandardBrowserEnv?function(){return{write:function(s,i,n,a,r,o){const l=[];l.push(s+"="+encodeURIComponent(i)),y.isNumber(n)&&l.push("expires="+new Date(n).toGMTString()),y.isString(a)&&l.push("path="+a),y.isString(r)&&l.push("domain="+r),o===!0&&l.push("secure"),document.cookie=l.join("; ")},read:function(s){const i=document.cookie.match(new RegExp("(^|;\\s*)("+s+")=([^;]*)"));return i?decodeURIComponent(i[3]):null},remove:function(s){this.write(s,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}();function Ma(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function La(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function bn(e,t){return e&&!Ma(t)?La(e,t):t}var Ta=j.isStandardBrowserEnv?function(){const t=/(msie|trident)/i.test(navigator.userAgent),s=document.createElement("a");let i;function n(a){let r=a;return t&&(s.setAttribute("href",r),r=s.href),s.setAttribute("href",r),{href:s.href,protocol:s.protocol?s.protocol.replace(/:$/,""):"",host:s.host,search:s.search?s.search.replace(/^\?/,""):"",hash:s.hash?s.hash.replace(/^#/,""):"",hostname:s.hostname,port:s.port,pathname:s.pathname.charAt(0)==="/"?s.pathname:"/"+s.pathname}}return i=n(window.location.href),function(r){const o=y.isString(r)?n(r):r;return o.protocol===i.protocol&&o.host===i.host}}():function(){return function(){return!0}}();function Ia(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}function Da(e,t){e=e||10;const s=new Array(e),i=new Array(e);let n=0,a=0,r;return t=t!==void 0?t:1e3,function(l){const h=Date.now(),c=i[a];r||(r=h),s[n]=l,i[n]=h;let d=a,u=0;for(;d!==n;)u+=s[d++],d=d%e;if(n=(n+1)%e,n===a&&(a=(a+1)%e),h-r<t)return;const p=c&&h-c;return p?Math.round(u*1e3/p):void 0}}var Pa=Da;function wi(e,t){let s=0;const i=Pa(50,250);return n=>{const a=n.loaded,r=n.lengthComputable?n.total:void 0,o=a-s,l=i(o),h=a<=r;s=a;const c={loaded:a,total:r,progress:r?a/r:void 0,bytes:o,rate:l||void 0,estimated:l&&r&&h?(r-a)/l:void 0,event:n};c[t?"download":"upload"]=!0,e(c)}}var Oa=typeof XMLHttpRequest<"u",ka=Oa&&function(e){return new Promise(function(s,i){let n=e.data;const a=J.from(e.headers).normalize(),r=e.responseType;let o;function l(){e.cancelToken&&e.cancelToken.unsubscribe(o),e.signal&&e.signal.removeEventListener("abort",o)}let h;y.isFormData(n)&&(j.isStandardBrowserEnv||j.isStandardBrowserWebWorkerEnv?a.setContentType(!1):a.getContentType(/^\s*multipart\/form-data/)?y.isString(h=a.getContentType())&&a.setContentType(h.replace(/^\s*(multipart\/form-data);+/,"$1")):a.setContentType("multipart/form-data"));let c=new XMLHttpRequest;if(e.auth){const f=e.auth.username||"",g=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";a.set("Authorization","Basic "+btoa(f+":"+g))}const d=bn(e.baseURL,e.url);c.open(e.method.toUpperCase(),gn(d,e.params,e.paramsSerializer),!0),c.timeout=e.timeout;function u(){if(!c)return;const f=J.from("getAllResponseHeaders"in c&&c.getAllResponseHeaders()),m={data:!r||r==="text"||r==="json"?c.responseText:c.response,status:c.status,statusText:c.statusText,headers:f,config:e,request:c};Ua(function(b){s(b),l()},function(b){i(b),l()},m),c=null}if("onloadend"in c?c.onloadend=u:c.onreadystatechange=function(){!c||c.readyState!==4||c.status===0&&!(c.responseURL&&c.responseURL.indexOf("file:")===0)||setTimeout(u)},c.onabort=function(){c&&(i(new x("Request aborted",x.ECONNABORTED,e,c)),c=null)},c.onerror=function(){i(new x("Network Error",x.ERR_NETWORK,e,c)),c=null},c.ontimeout=function(){let g=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded";const m=e.transitional||mn;e.timeoutErrorMessage&&(g=e.timeoutErrorMessage),i(new x(g,m.clarifyTimeoutError?x.ETIMEDOUT:x.ECONNABORTED,e,c)),c=null},j.isStandardBrowserEnv){const f=Ta(d)&&e.xsrfCookieName&&Aa.read(e.xsrfCookieName);f&&a.set(e.xsrfHeaderName,f)}n===void 0&&a.setContentType(null),"setRequestHeader"in c&&y.forEach(a.toJSON(),function(g,m){c.setRequestHeader(m,g)}),y.isUndefined(e.withCredentials)||(c.withCredentials=!!e.withCredentials),r&&r!=="json"&&(c.responseType=e.responseType),typeof e.onDownloadProgress=="function"&&c.addEventListener("progress",wi(e.onDownloadProgress,!0)),typeof e.onUploadProgress=="function"&&c.upload&&c.upload.addEventListener("progress",wi(e.onUploadProgress)),(e.cancelToken||e.signal)&&(o=f=>{c&&(i(!f||f.type?new es(null,e,c):f),c.abort(),c=null)},e.cancelToken&&e.cancelToken.subscribe(o),e.signal&&(e.signal.aborted?o():e.signal.addEventListener("abort",o)));const p=Ia(d);if(p&&j.protocols.indexOf(p)===-1){i(new x("Unsupported protocol "+p+":",x.ERR_BAD_REQUEST,e));return}c.send(n||null)})},Es={http:ra,xhr:ka};y.forEach(Es,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}});var bi=e=>`- ${e}`,Na=e=>y.isFunction(e)||e===null||e===!1,vn={getAdapter:e=>{e=y.isArray(e)?e:[e];const{length:t}=e;let s,i;const n={};for(let a=0;a<t;a++){s=e[a];let r;if(i=s,!Na(s)&&(i=Es[(r=String(s)).toLowerCase()],i===void 0))throw new x(`Unknown adapter '${r}'`);if(i)break;n[r||"#"+a]=i}if(!i){const a=Object.entries(n).map(([o,l])=>`adapter ${o} `+(l===!1?"is not supported by the environment":"is not available in the build"));let r=t?a.length>1?`since :
`+a.map(bi).join(`
`):" "+bi(a[0]):"as no adapter specified";throw new x("There is no suitable adapter to dispatch the request "+r,"ERR_NOT_SUPPORT")}return i},adapters:Es};function os(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new es(null,e)}function vi(e){return os(e),e.headers=J.from(e.headers),e.data=as.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),vn.getAdapter(e.adapter||Qs.adapter)(e).then(function(i){return os(e),i.data=as.call(e,e.transformResponse,i),i.headers=J.from(i.headers),i},function(i){return _n(i)||(os(e),i&&i.response&&(i.response.data=as.call(e,e.transformResponse,i.response),i.response.headers=J.from(i.response.headers))),Promise.reject(i)})}var Ci=e=>e instanceof J?e.toJSON():e;function me(e,t){t=t||{};const s={};function i(h,c,d){return y.isPlainObject(h)&&y.isPlainObject(c)?y.merge.call({caseless:d},h,c):y.isPlainObject(c)?y.merge({},c):y.isArray(c)?c.slice():c}function n(h,c,d){if(y.isUndefined(c)){if(!y.isUndefined(h))return i(void 0,h,d)}else return i(h,c,d)}function a(h,c){if(!y.isUndefined(c))return i(void 0,c)}function r(h,c){if(y.isUndefined(c)){if(!y.isUndefined(h))return i(void 0,h)}else return i(void 0,c)}function o(h,c,d){if(d in t)return i(h,c);if(d in e)return i(void 0,h)}const l={url:a,method:a,data:a,baseURL:r,transformRequest:r,transformResponse:r,paramsSerializer:r,timeout:r,timeoutMessage:r,withCredentials:r,adapter:r,responseType:r,xsrfCookieName:r,xsrfHeaderName:r,onUploadProgress:r,onDownloadProgress:r,decompress:r,maxContentLength:r,maxBodyLength:r,beforeRedirect:r,transport:r,httpAgent:r,httpsAgent:r,cancelToken:r,socketPath:r,responseEncoding:r,validateStatus:o,headers:(h,c)=>n(Ci(h),Ci(c),!0)};return y.forEach(Object.keys(Object.assign({},e,t)),function(c){const d=l[c]||n,u=d(e[c],t[c],c);y.isUndefined(u)&&d!==o||(s[c]=u)}),s}var Cn="1.6.0",Gs={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{Gs[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}});var Si={};Gs.transitional=function(t,s,i){function n(a,r){return"[Axios v"+Cn+"] Transitional option '"+a+"'"+r+(i?". "+i:"")}return(a,r,o)=>{if(t===!1)throw new x(n(r," has been removed"+(s?" in "+s:"")),x.ERR_DEPRECATED);return s&&!Si[r]&&(Si[r]=!0,console.warn(n(r," has been deprecated since v"+s+" and will be removed in the near future"))),t?t(a,r,o):!0}};function Fa(e,t,s){if(typeof e!="object")throw new x("options must be an object",x.ERR_BAD_OPTION_VALUE);const i=Object.keys(e);let n=i.length;for(;n-- >0;){const a=i[n],r=t[a];if(r){const o=e[a],l=o===void 0||r(o,a,e);if(l!==!0)throw new x("option "+a+" must be "+l,x.ERR_BAD_OPTION_VALUE);continue}if(s!==!0)throw new x("Unknown option "+a,x.ERR_BAD_OPTION)}}var xs={assertOptions:Fa,validators:Gs},K=xs.validators,yt=class{constructor(e){this.defaults=e,this.interceptors={request:new yi,response:new yi}}request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=me(this.defaults,t);const{transitional:s,paramsSerializer:i,headers:n}=t;s!==void 0&&xs.assertOptions(s,{silentJSONParsing:K.transitional(K.boolean),forcedJSONParsing:K.transitional(K.boolean),clarifyTimeoutError:K.transitional(K.boolean)},!1),i!=null&&(y.isFunction(i)?t.paramsSerializer={serialize:i}:xs.assertOptions(i,{encode:K.function,serialize:K.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let a=n&&y.merge(n.common,n[t.method]);n&&y.forEach(["delete","get","head","post","put","patch","common"],p=>{delete n[p]}),t.headers=J.concat(a,n);const r=[];let o=!0;this.interceptors.request.forEach(function(f){typeof f.runWhen=="function"&&f.runWhen(t)===!1||(o=o&&f.synchronous,r.unshift(f.fulfilled,f.rejected))});const l=[];this.interceptors.response.forEach(function(f){l.push(f.fulfilled,f.rejected)});let h,c=0,d;if(!o){const p=[vi.bind(this),void 0];for(p.unshift.apply(p,r),p.push.apply(p,l),d=p.length,h=Promise.resolve(t);c<d;)h=h.then(p[c++],p[c++]);return h}d=r.length;let u=t;for(c=0;c<d;){const p=r[c++],f=r[c++];try{u=p(u)}catch(g){f.call(this,g);break}}try{h=vi.call(this,u)}catch(p){return Promise.reject(p)}for(c=0,d=l.length;c<d;)h=h.then(l[c++],l[c++]);return h}getUri(e){e=me(this.defaults,e);const t=bn(e.baseURL,e.url);return gn(t,e.params,e.paramsSerializer)}};y.forEach(["delete","get","head","options"],function(t){yt.prototype[t]=function(s,i){return this.request(me(i||{},{method:t,url:s,data:(i||{}).data}))}});y.forEach(["post","put","patch"],function(t){function s(i){return function(a,r,o){return this.request(me(o||{},{method:t,headers:i?{"Content-Type":"multipart/form-data"}:{},url:a,data:r}))}}yt.prototype[t]=s(),yt.prototype[t+"Form"]=s(!0)});var ht=yt,$a=class Sn{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let s;this.promise=new Promise(function(a){s=a});const i=this;this.promise.then(n=>{if(!i._listeners)return;let a=i._listeners.length;for(;a-- >0;)i._listeners[a](n);i._listeners=null}),this.promise.then=n=>{let a;const r=new Promise(o=>{i.subscribe(o),a=o}).then(n);return r.cancel=function(){i.unsubscribe(a)},r},t(function(a,r,o){i.reason||(i.reason=new es(a,r,o),s(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){if(this.reason){t(this.reason);return}this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const s=this._listeners.indexOf(t);s!==-1&&this._listeners.splice(s,1)}static source(){let t;return{token:new Sn(function(n){t=n}),cancel:t}}},qa=$a;function Ba(e){return function(s){return e.apply(null,s)}}function Va(e){return y.isObject(e)&&e.isAxiosError===!0}var Us={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Us).forEach(([e,t])=>{Us[t]=e});var Ha=Us;function Rn(e){const t=new ht(e),s=en(ht.prototype.request,t);return y.extend(s,ht.prototype,t,{allOwnKeys:!0}),y.extend(s,t,null,{allOwnKeys:!0}),s.create=function(n){return Rn(me(e,n))},s}var T=Rn(Qs);T.Axios=ht;T.CanceledError=es;T.CancelToken=qa;T.isCancel=_n;T.VERSION=Cn;T.toFormData=Xt;T.AxiosError=x;T.Cancel=T.CanceledError;T.all=function(t){return Promise.all(t)};T.spread=Ba;T.isAxiosError=Va;T.mergeConfig=me;T.AxiosHeaders=J;T.formToJSON=e=>yn(y.isHTMLForm(e)?new FormData(e):e);T.getAdapter=vn.getAdapter;T.HttpStatusCode=Ha;T.default=T;var Be=T,{Axios:zc,AxiosError:Qc,CanceledError:Gc,isCancel:Jc,CancelToken:Kc,VERSION:Yc,all:Xc,Cancel:Zc,isAxiosError:eh,spread:th,toFormData:sh,AxiosHeaders:ih,HttpStatusCode:nh,formToJSON:rh,getAdapter:ah,mergeConfig:oh}=Be,ja=Qe(yr()),Wa=Qe(_r()),za=25,Qa=100,ls={hasNext:!1,hasPrev:!1},Ga=100*1024*1024,Ja=10,Ka=100,Ya={created_at:!0,deleted_at:!0,pinned_at:!0,updated_at:!0,command:!0,mentioned_users:!0,quoted_message:!0,latest_reactions:!0,own_reactions:!0,reaction_counts:!0,reply_count:!0,i18n:!0,type:!0,html:!0,__html:!0,user:!0},Xa={error:!0},Za=3,eo=1e3;function En(e,t){e.then().catch(s=>{console.warn(`failed to do ${t}, ran into error: `,s)})}var ee=e=>new Promise(t=>setTimeout(t,e));function As(e){return typeof e=="function"||e instanceof Function||Object.prototype.toString.call(e)==="[object Function]"}var Ae={TOKEN_EXPIRED:40,WS_CLOSED_SUCCESS:1e3};function to(e){return e!==null&&typeof e=="object"&&(e.readable||typeof e._read=="function")}function so(e){return e!=null&&e.constructor!=null&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function io(e){return typeof window<"u"&&"File"in window&&e instanceof File}function no(e){return typeof window<"u"&&"Blob"in window&&e instanceof Blob}function ro(e){return{channel_mutes:!0,devices:!0,mutes:!0,total_unread_count:!0,unread_channels:!0,unread_count:!0,unread_threads:!0,invisible:!0,privacy_settings:!0,roles:!0,push_preferences:!0}[e]}function ao(e,t,s){const i=new Wa.default;return to(e)||so(e)||io(e)||no(e)?t?i.append("file",e,t):i.append("file",e):i.append("file",{uri:e,name:t||e.split("/").reverse()[0],contentType:s,type:s}),i}function I(e){const t=[],s=Array.isArray(e)?e:[e];for(const i of s){const n=Object.entries(i);n.length>1&&console.warn("client._buildSort() - multiple fields in a single sort object detected. Object's field order is not guaranteed");for(const[a,r]of n)t.push({field:a,direction:r})}return t}function _t(e){const t=Math.min(500+e*2e3,25e3),s=Math.min(Math.max(250,(e-1)*2e3),25e3);return Math.floor(Math.random()*(t-s)+s)}function fe(){return $()}function Re(e){let t="";for(let s=0;s<e.length;s++)t+=e[s].toString(16).padStart(2,"0");return t}function $(){const e=co(16);return e[6]=e[6]&15|64,e[8]=e[8]&191|128,Re(e.subarray(0,4))+"-"+Re(e.subarray(4,6))+"-"+Re(e.subarray(6,8))+"-"+Re(e.subarray(8,10))+"-"+Re(e.subarray(10,16))}function oo(e){const t=Math.pow(2,8*e.byteLength/e.length);for(let s=0;s<e.length;s++)e[s]=Math.random()*t}var lo=typeof crypto<"u"&&typeof(crypto==null?void 0:crypto.getRandomValues)<"u"?crypto.getRandomValues.bind(crypto):typeof msCrypto<"u"?msCrypto.getRandomValues.bind(msCrypto):oo;function co(e){const t=new Uint8Array(e);return lo(t),t}function ho(e){const t={};if(!e)return t;try{Object.getOwnPropertyNames(e).forEach(s=>{t[s]=Object.getOwnPropertyDescriptor(e,s)})}catch{return{error:"failed to serialize the error"}}return t}function uo(){const e=typeof navigator<"u"?navigator:typeof window<"u"&&window.navigator?window.navigator:void 0;return e?typeof e.onLine!="boolean"?!0:e.onLine:(console.warn("isOnline failed to access window.navigator and assume browser is online"),!0)}function xn(e){typeof window<"u"&&window.addEventListener&&(window.addEventListener("offline",e),window.addEventListener("online",e))}function Un(e){typeof window<"u"&&window.removeEventListener&&(window.removeEventListener("offline",e),window.removeEventListener("online",e))}var fo=e=>{const t=[];for(const s in e)e[s]!==void 0&&(Array.isArray(e[s])||typeof e[s]=="object"?t.push(`${s}=${encodeURIComponent(JSON.stringify(e[s]))}`):t.push(`${s}=${encodeURIComponent(e[s])}`));return t.join("&")};function P(e){const t=s=>s?{...s,created_at:e.created_at?new Date(e.created_at):new Date,deleted_at:e.deleted_at?new Date(e.deleted_at):null,pinned_at:e.pinned_at?new Date(e.pinned_at):null,reaction_groups:go(e.reaction_groups,e.reaction_counts,e.reaction_scores),status:e.status||"received",updated_at:e.updated_at?new Date(e.updated_at):new Date}:null;return{...t(e),error:e.error??null,quoted_message:t(e.quoted_message)}}function po(e){const t=s=>{if(!s)return null;const i=new Date().toISOString();return{...s,created_at:e.created_at?e.created_at.toISOString():i,deleted_at:e.deleted_at?e.deleted_at.toISOString():void 0,pinned_at:e.pinned_at?e.pinned_at.toISOString():void 0,updated_at:e.updated_at?e.updated_at.toISOString():i}};return{...t(e),quoted_message:t(e.quoted_message)}}var lh=e=>{var w;const{created_at:t,updated_at:s,deleted_at:i,error:n,status:a,latest_reactions:r,own_reactions:o,reaction_counts:l,reaction_scores:h,reply_count:c,command:d,html:u,i18n:p,quoted_message:f,mentioned_users:g,...m}=e;return{...m,pinned_at:(w=m.pinned_at)==null?void 0:w.toISOString(),mentioned_users:g==null?void 0:g.map(b=>b.id)}},An=e=>{var i;const t={...Ya,...Xa};return{...Object.fromEntries(Object.entries(e).filter(([n])=>!t[n])),pinned:!!e.pinned_at,mentioned_users:(i=e.mentioned_users)==null?void 0:i.map(n=>typeof n=="string"?n:n.id)}},Mn=({needle:e,sortedArray:t,selectKey:s,selectValueToCompare:i=a=>a,sortDirection:n="ascending"})=>{if(!t.length)return 0;let a=0,r=t.length-1,o=0;const l=()=>{o=Math.round((a+r)/2)},h=i(e);for(;a<=r;){l();const c=i(t[o]);n==="ascending"&&h<c||n==="descending"&&h>=c?r=o-1:a=o+1}if(s){const c=s(e),d=n==="ascending"?-1:1;for(let u=a+d;0<=u&&u<t.length&&i(t[u])===h;u+=d)if(s(t[u])===c)return u}return a};function Ln(e,t,s=!1,i="created_at",n=!0){const a=n||s;let r=[...e];if(s&&(r=r.filter(c=>!(c.id&&t.id===c.id))),r.length===0&&a)return r.concat(t);if(r.length===0)return r;const o=t[i].getTime(),l=r.at(-1)[i].getTime()<o;if(l&&a)return r.concat(t);if(l)return r;const h=Mn({needle:t,sortedArray:r,sortDirection:"ascending",selectValueToCompare:c=>c[i].getTime(),selectKey:c=>c.id});return!s&&t.id&&r[h]&&t.id===r[h].id?(r[h]=t,r):(a&&r.splice(h,0,t),r)}function go(e,t,s){if(e)return e;if(t&&s){const i={};for(const n of Object.keys(t))i[n]={count:t[n],sum_scores:s[n]};return i}return null}var Ve=(e,t=0,{leading:s=!1,trailing:i=!0}={})=>{let n=null,a=null,r;const o=(...l)=>(n?clearTimeout(n):s&&(r=e(...l)),i&&(a=l),n=setTimeout(()=>{a&&(r=e(...a),a=null),n=null},t),r);return o.cancel=()=>{n&&clearTimeout(n)},o.flush=()=>(n&&(clearTimeout(n),n=null,a&&(r=e(...a))),r),o},Tn=(e,t=200,{leading:s=!0,trailing:i=!1}={})=>{let n=null,a=null;return(...r)=>{if(n){i&&(a=r);return}s&&e(...r);const o=()=>{if(a){e(...a),a=null,n=setTimeout(o,t);return}n=null};n=setTimeout(o,t)}},mo=(e,t)=>t.split(".").reduce((s,i)=>{if(s&&typeof s=="object"&&i in s)return s[i]},e),yo=(e,t)=>{if(!Array.isArray(e))return[];const s=new Set;return e.filter(i=>{const n=mo(i,t);return s.has(n)?!1:(s.add(n),!0)})};function _o(e,t){let s=0,i=e.length-1;for(;s<=i;){const n=Math.floor((s+i)/2),a=e[n].created_at;if(!a){s+=1;continue}const r=new Date(a);if(r.getTime()===t.getTime())return n;r.getTime()<t.getTime()?s=n+1:i=n-1}return s}var wo=({parentSet:e,requestedPageSize:t,returnedPage:s,messagePaginationOptions:i})=>{var m,w;const n={...e.pagination};if(!(i!=null&&i.created_at_around))return n;let a,r,o,l;const h=new Date(i.created_at_around),[c,d]=[s[0],s.slice(-1)[0]],u=!!(c!=null&&c.created_at)&&new Date(c.created_at)>h,p=!!(d!=null&&d.created_at)&&new Date(d.created_at)<h,f=t>e.messages.length&&t>s.length,g=(t>e.messages.length||e.messages.length>=s.length)&&t>s.length;if(u)a=!1,o=!0,f&&(r=!1,l=!0);else if(p)r=!1,l=!0,f&&(a=!1,o=!0);else if(g)r=a=!1,o=l=!0;else{const[b,v]=[(c==null?void 0:c.id)&&c.id===((m=e.messages[0])==null?void 0:m.id),(d==null?void 0:d.id)&&d.id===((w=e.messages.slice(-1)[0])==null?void 0:w.id)];o=b,l=v;const C=Math.floor(s.length/2),S=_o(s,h);S!==-1&&(a=C<=S,r=C>=S)}return o&&typeof a<"u"&&(n.hasPrev=a),l&&typeof r<"u"&&(n.hasNext=r),n},bo=({parentSet:e,requestedPageSize:t,returnedPage:s,messagePaginationOptions:i})=>{var m,w;const n={...e.pagination},{id_around:a}=i||{};if(!a)return n;let r,o;const[l,h]=[s[0],s.slice(-1)[0]],[c,d]=[(l==null?void 0:l.id)===((m=e.messages[0])==null?void 0:m.id),(h==null?void 0:h.id)===((w=e.messages.slice(-1)[0])==null?void 0:w.id)];let u=c,p=d;const f=Math.floor(s.length/2);if((t>e.messages.length||e.messages.length>=s.length)&&t>s.length)o=r=!1,u=p=!0;else if(s[f])if(s[f].id===a)r=o=!0;else{let b;const v=[s.slice(0,f),s.slice(f)];r=o=!0;for(let C=0;C<v.length;C++)b=v[C].find(S=>S.id===a),b&&C===0&&(r=!1),b&&C===1&&(o=!1)}else return n;return u&&typeof r<"u"&&(n.hasPrev=r),p&&typeof o<"u"&&(n.hasNext=o),n},vo=({parentSet:e,requestedPageSize:t,returnedPage:s,messagePaginationOptions:i})=>{var m,w;const n={...e.pagination};let a,r;const[o,l]=[s[0],s.slice(-1)[0]],[h,c]=[(o==null?void 0:o.id)&&o.id===((m=e.messages[0])==null?void 0:m.id),(l==null?void 0:l.id)&&l.id===((w=e.messages.slice(-1)[0])==null?void 0:w.id)],d=i&&(i.created_at_after_or_equal||i.created_at_after||i.id_gt||i.id_gte),u=typeof i>"u"?!0:i.created_at_before_or_equal||i.created_at_before||i.id_lt||i.id_lte||i.offset,p=!d&&!u&&!(i!=null&&i.id_around)&&!(i!=null&&i.created_at_around),f=s.length>=t;(typeof u<"u"||p)&&(a=f),typeof d<"u"&&(r=f);const g=s.length===0;return(h||g)&&typeof a<"u"&&(n.hasPrev=a),(c||g)&&typeof r<"u"&&(n.hasNext=r),n},In=e=>{var t,s,i;return e.parentSet.messages.length<e.returnedPage.length?((t=e.logger)==null||t.call(e,"error","Corrupted message set state: parent set size < returned page size"),e.parentSet.pagination):(s=e.messagePaginationOptions)!=null&&s.created_at_around?wo(e):(i=e.messagePaginationOptions)!=null&&i.id_around?bo(e):vo(e)},Ze={},cs=async({channel:e,client:t,id:s,members:i,options:n,type:a})=>{if(!e&&!a)throw new Error("Channel or channel type have to be provided to query a channel.");const r=e||t.channel(a,s,{members:i}),o=r.id?r.cid:i&&i.length?Js(r.type,i):void 0;if(!o)throw new Error("Channel ID or channel members array have to be provided to query a channel.");const l=Ze[o];if(l)await l;else try{Ze[o]=r.watch(n),await Ze[o]}finally{delete Ze[o]}return r},Js=(e,t)=>{if(!t)return;const s=[...t].sort().join(",");if(s)return`${e}:!members-${s}`},wt=e=>{if(!e)return!1;const t=e.state.membership;return!!(t!=null&&t.pinned_at)},et=e=>{if(!e)return!1;const t=e.state.membership;return!!(t!=null&&t.archived_at)},tt=e=>e?typeof e.archived=="boolean":!1,Dn=({atIndex:e,sort:t,targetKey:s})=>{if(!t)return null;let i=null;if(Array.isArray(t))i=t[e]??null;else for(const n in t){if(n!==s)return null;i=t;break}return(i==null?void 0:i[s])??null},Ms=e=>{const t=Co({sort:e});return typeof t!="number"?!1:Math.abs(t)===1},Co=({sort:e})=>Dn({atIndex:0,sort:e,targetKey:"pinned_at"}),Pn=({channels:e})=>{let t=null;for(const s of e){if(!wt(s))break;typeof t=="number"?t++:t=0}return t},st=({channels:e,channelToMove:t,channelToMoveIndexWithinChannels:s,sort:i})=>{const n=s??e.findIndex(d=>d.cid===t.cid),a=n>=0,r=n===0,o=Ms(i),l=wt(t);if(r||o&&l)return e;const h=[...e];a&&h.splice(n,1);let c=null;return o&&(c=Pn({channels:h})),h.splice(typeof c=="number"?c+1:0,0,t),h},So=e=>!!e.getTime,On=e=>So(e.created_at),Ro=class{constructor(e){var t;this.messageSets=[],this.formatMessage=s=>P(s),this.setIsUpToDate=s=>{this.isUpToDate=s},this.removeMessageFromArray=(s,i)=>{const n=s.filter(a=>!(a.id&&i.id&&a.id===i.id));return{removed:n.length<s.length,result:n}},this.updateUserMessages=s=>{const i=(n,a)=>{var r;for(let o=0;o<n.length;o++){const l=n[o];((r=l.user)==null?void 0:r.id)===a.id&&(n[o]={...l,user:a})}};this.messageSets.forEach(n=>i(n.messages,s));for(const n in this.threads)i(this.threads[n],s);i(this.pinnedMessages,s)},this.deleteUserMessages=(s,i=!1)=>{const n=(a,r,o=!1)=>{var l;for(let h=0;h<a.length;h++){const c=a[h];((l=c.user)==null?void 0:l.id)===r.id&&(o?a[h]={cid:c.cid,created_at:c.created_at,deleted_at:r.deleted_at,id:c.id,latest_reactions:[],mentioned_users:[],own_reactions:[],parent_id:c.parent_id,reply_count:c.reply_count,status:c.status,thread_participants:c.thread_participants,type:"deleted",updated_at:c.updated_at,user:c.user}:a[h]={...c,type:"deleted",deleted_at:r.deleted_at?new Date(r.deleted_at):null})}};this.messageSets.forEach(a=>n(a.messages,s,i));for(const a in this.threads)n(this.threads[a],s,i);n(this.pinnedMessages,s,i)},this._channel=e,this.watcher_count=0,this.typing={},this.read={},this.initMessages(),this.pinnedMessages=[],this.pending_messages=[],this.threads={},this.mutedUsers=[],this.watchers={},this.members={},this.membership={},this.unreadCount=0,this.isUpToDate=!0,this.last_message_at=((t=e==null?void 0:e.state)==null?void 0:t.last_message_at)!=null?new Date(e.state.last_message_at):null}get messages(){var e;return((e=this.messageSets.find(t=>t.isCurrent))==null?void 0:e.messages)||[]}set messages(e){const t=this.messageSets.findIndex(s=>s.isCurrent);this.messageSets[t].messages=e}get latestMessages(){var e;return((e=this.messageSets.find(t=>t.isLatest))==null?void 0:e.messages)||[]}set latestMessages(e){const t=this.messageSets.findIndex(s=>s.isLatest);this.messageSets[t].messages=e}get messagePagination(){var e;return((e=this.messageSets.find(t=>t.isCurrent))==null?void 0:e.pagination)||ls}addMessageSorted(e,t=!1,s=!0,i="latest"){return this.addMessagesSorted([e],t,!1,s,i)}addMessagesSorted(e,t=!1,s=!1,i=!0,n="current"){var o;const{messagesToAdd:a,targetMessageSetIndex:r}=this.findTargetMessageSet(e,i,n);for(let l=0;l<a.length;l+=1){if(a[l].shadowed)continue;const c=a[l].created_at instanceof Date;let d;c?d=a[l]:(d=this.formatMessage(a[l]),d.user&&((o=this._channel)!=null&&o.cid)&&this._channel.getClient().state.updateUserReference(d.user,this._channel.cid),s&&d.id&&this.threads[d.id]&&delete this.threads[d.id],this.last_message_at||(this.last_message_at=new Date(d.created_at.getTime())),d.created_at.getTime()>this.last_message_at.getTime()&&(this.last_message_at=new Date(d.created_at.getTime())));const u=d.parent_id;if((!u||d.show_in_channel)&&r!==-1&&(this.messageSets[r].messages=this._addToMessageList(this.messageSets[r].messages,d,t,"created_at",i)),u&&!s){const p=this.threads[u]||[];this.threads[u]=this._addToMessageList(p,d,t,"created_at",i)}}return{messageSet:this.messageSets[r]}}addPinnedMessages(e){for(let t=0;t<e.length;t+=1)this.addPinnedMessage(e[t])}addPinnedMessage(e){this.pinnedMessages=this._addToMessageList(this.pinnedMessages,this.formatMessage(e),!1,"pinned_at")}removePinnedMessage(e){const{result:t}=this.removeMessageFromArray(this.pinnedMessages,e);this.pinnedMessages=t}addReaction(e,t,s){const i=t;let n;if(i||(n=this.findMessage(e.message_id)),!i&&!n)return;const a=i??n,r={id:a==null?void 0:a.id,parent_id:a==null?void 0:a.parent_id,pinned:a==null?void 0:a.pinned,show_in_channel:a==null?void 0:a.show_in_channel};return this._updateMessage(r,o=>{if(i){const l={...i};return i.own_reactions=this._addOwnReactionToMessage(o.own_reactions,e,s),l.own_reactions=this._channel.getClient().userID===e.user_id?i.own_reactions:o.own_reactions,this.formatMessage(l)}return n?this._addReactionToState(n,e,s):o}),i??n}_addReactionToState(e,t,s){if(e.reaction_groups||(e.reaction_groups={}),s)for(const o of e.own_reactions??[]){const l=e.reaction_groups[o.type];e.reaction_groups[o.type]={...l,count:l.count-1,sum_scores:l.sum_scores-(o.score??1)},e.reaction_groups[o.type].count<1&&delete e.reaction_groups[o.type]}const n=e.reaction_groups[t.type],a=t.score??1;e.reaction_groups[t.type]=n?{...n,count:n.count+1,sum_scores:n.sum_scores+a,last_reaction_at:t.created_at}:{count:1,first_reaction_at:t.created_at,last_reaction_at:t.created_at,sum_scores:a},e.own_reactions=this._addOwnReactionToMessage(e.own_reactions,t,s);const r=this._channel.getClient().userID;return e.latest_reactions=s?[...(e.latest_reactions||[]).filter(o=>o.user_id!==r),t]:[...e.latest_reactions||[],t],e}_addOwnReactionToMessage(e,t,s){return s?e=[]:e=this._removeOwnReactionFromMessage(e,t),e=e||[],this._channel.getClient().userID===t.user_id&&e.push(t),e}_removeOwnReactionFromMessage(e,t){return e&&e.filter(s=>s.user_id!==t.user_id||s.type!==t.type)}removeReaction(e,t){const s=t;let i;if(s||(i=this.findMessage(e.message_id)),!s&&!i)return;const n=s??i,a={id:n==null?void 0:n.id,parent_id:n==null?void 0:n.parent_id,pinned:n==null?void 0:n.pinned,show_in_channel:n==null?void 0:n.show_in_channel};return this._updateMessage(a,r=>s?(s.own_reactions=this._removeOwnReactionFromMessage(r.own_reactions,e),this.formatMessage(s)):i?this._removeReactionFromState(i,e):r),s}_removeReactionFromState(e,t){var n,a,r,o;const s=(n=e.own_reactions)==null?void 0:n.find(l=>l.type===t.type);if(s&&((a=e.reaction_groups)!=null&&a[s.type])){const l=e.reaction_groups[s.type];e.reaction_groups[s.type]={...l,count:l.count-1,sum_scores:l.sum_scores-(s.score??1)},e.reaction_groups[s.type].count<1&&delete e.reaction_groups[s.type]}e.own_reactions=(r=e.own_reactions)==null?void 0:r.filter(l=>l.type!==t.type);const i=this._channel.getClient().userID;return e.latest_reactions=(o=e.latest_reactions)==null?void 0:o.filter(l=>!(l.user_id===i&&l.type===t.type)),e}_updateQuotedMessageReferences({message:e,remove:t}){const s=n=>{var a,r;return{...n,created_at:n.created_at.toISOString(),pinned_at:(a=n.pinned_at)==null?void 0:a.toISOString(),updated_at:(r=n.updated_at)==null?void 0:r.toISOString()}},i=n=>{const a=n.reduce((r,o)=>(o.quoted_message_id===e.id&&r.push({...s(o),quoted_message:t?{...e,attachments:[]}:e}),r),[]);this.addMessagesSorted(a,!0)};e.parent_id?e.parent_id&&this.threads[e.parent_id]&&i(this.threads[e.parent_id]):this.messageSets.forEach(n=>i(n.messages))}removeQuotedMessageReferences(e){this._updateQuotedMessageReferences({message:e,remove:!0})}_updateMessage(e,t){const{parent_id:s,show_in_channel:i,pinned:n}=e;if(s&&this.threads[s]){const a=this.threads[s],r=a.findIndex(o=>o.id===e.id);r!==-1&&(a[r]=t(a[r]),this.threads[s]=a)}if(!i&&!s||i){const a=this.findMessageSetIndex(e);if(a!==-1){const r=this.messageSets[a].messages.findIndex(o=>o.id===e.id);if(r!==-1){const o=t(this.messageSets[a].messages[r]);this.messageSets[a].messages[r]=o}}}if(n){const a=this.pinnedMessages.findIndex(r=>r.id===e.id);a!==-1&&(this.pinnedMessages[a]=t(this.pinnedMessages[a]))}}_addToMessageList(e,t,s=!1,i="created_at",n=!0){return Ln(e,t,s,i,n)}removeMessage(e){let t=!1;if(e.parent_id&&this.threads[e.parent_id]){const{removed:s,result:i}=this.removeMessageFromArray(this.threads[e.parent_id],e);this.threads[e.parent_id]=i,t=s}else{const s=e.messageSetIndex??this.findMessageSetIndex(e);if(s!==-1){const{removed:i,result:n}=this.removeMessageFromArray(this.messageSets[s].messages,e);this.messageSets[s].messages=n,t=i}}return t}filterErrorMessages(){const e=this.latestMessages.filter(t=>t.type!=="error");this.latestMessages=e}clean(){const e=new Date;for(const[t,s]of Object.entries(this.typing)){const i=typeof s.received_at=="string"?new Date(s.received_at):s.received_at||new Date;e.getTime()-i.getTime()>7e3&&(delete this.typing[t],this._channel.getClient().dispatchEvent({cid:this._channel.cid,type:"typing.stop",user:{id:t}}))}}clearMessages(){this.initMessages(),this.pinnedMessages=[]}initMessages(){this.messageSets=[{messages:[],isLatest:!0,isCurrent:!0,pagination:ls}]}async loadMessageIntoState(e,t,s=25){var o;let i,n=!1,a=!1;const r=t||e;if(e==="latest"){if(this.messages===this.latestMessages)return;i=this.messageSets.findIndex(l=>l.isLatest)}else i=this.findMessageSetIndex({id:r});i!==-1&&(this.switchToMessageSet(i),n=!0),a=!t||!!((o=this.threads[t])!=null&&o.find(l=>l.id===e)),!(n&&a)&&(n||await this._channel.query({messages:{id_around:r,limit:s}},"new"),!a&&t&&await this._channel.getReplies(t,{id_around:e,limit:s}),i=this.findMessageSetIndex({id:r}),i!==-1&&this.switchToMessageSet(i))}findMessage(e,t){if(t){const i=this.threads[t];return i?i.find(n=>n.id===e):void 0}const s=this.findMessageSetIndex({id:e});if(s!==-1)return this.messageSets[s].messages.find(i=>i.id===e)}switchToMessageSet(e){const t=this.messageSets.find(s=>s.isCurrent);t&&(t.isCurrent=!1,this.messageSets[e].isCurrent=!0)}areMessageSetsOverlap(e,t){return e.some(s=>t.find(i=>s.id===i.id))}findMessageSetIndex(e){return this.messageSets.findIndex(t=>!!t.messages.find(s=>s.id===e.id))}findTargetMessageSet(e,t=!0,s="current"){let i=e,n;if(t){const a=this.messageSets.map((l,h)=>h).filter(l=>this.areMessageSetsOverlap(this.messageSets[l].messages,e));switch(s){case"new":a.length>0?n=a[0]:e.some(l=>!l.parent_id)&&(this.messageSets.push({messages:[],isCurrent:!1,isLatest:!1,pagination:ls}),n=this.messageSets.length-1);break;case"current":n=this.messageSets.findIndex(l=>l.isCurrent);break;case"latest":n=this.messageSets.findIndex(l=>l.isLatest);break;default:n=-1}const r=a.splice(0,1)[0],o=[...a];if(r!==void 0&&r!==n&&o.push(n),o.length>0){const l=this.messageSets[r],h=this.messageSets.filter((d,u)=>o.indexOf(u)!==-1);h.forEach(d=>{l.isLatest=l.isLatest||d.isLatest,l.isCurrent=l.isCurrent||d.isCurrent,l.pagination.hasPrev=d.messages[0].created_at<l.messages[0].created_at?d.pagination.hasPrev:l.pagination.hasPrev,l.pagination.hasNext=l.messages.slice(-1)[0].created_at<d.messages.slice(-1)[0].created_at?d.pagination.hasNext:l.pagination.hasNext,i=[...i,...d.messages]}),h.forEach(d=>this.messageSets.splice(this.messageSets.indexOf(d),1)),n=this.messageSets.findIndex(d=>this.areMessageSetsOverlap(d.messages,e))}}else n=this.findMessageSetIndex(e[0]);return{targetMessageSetIndex:n,messagesToAdd:i}}},Eo=e=>!!(e!=null&&e.og_scrape_url)||!!(e!=null&&e.title_link),we=e=>{var t;return!!((t=e==null?void 0:e.localMetadata)!=null&&t.id)},ch=e=>{var t;return!!((t=e==null?void 0:e.localMetadata)!=null&&t.uploadState)},kn=(e,t=[])=>e.type==="file"||!!(e.mime_type&&t.indexOf(e.mime_type)===-1&&e.type!=="video"),hh=e=>kn(e)&&we(e),Nn=e=>e.type==="image"&&!Eo(e),xo=e=>Nn(e)&&we(e),Fn=e=>e.type==="audio",dh=e=>Fn(e)&&we(e),$n=e=>e.type==="voiceRecording",uh=e=>$n(e)&&we(e),qn=(e,t=[])=>e.type==="video"||!!(e.mime_type&&t.indexOf(e.mime_type)!==-1),fh=e=>qn(e)&&we(e),Uo=e=>Fn(e)||kn(e)||Nn(e)||qn(e)||$n(e),dt=e=>!!e.lastModified&&!("uri"in e),Ao=e=>e==null||typeof e!="object"?!1:typeof FileList<"u"&&e instanceof FileList||"item"in e&&"length"in e&&!Array.isArray(e),Mo=e=>e instanceof Blob&&!(e instanceof File),he=e=>e!==null&&typeof e=="object"&&!dt(e)&&!Mo(e)&&typeof e.name=="string"&&typeof e.uri=="string"&&typeof e.size=="number"&&typeof e.type=="string",Ri=({blobsArray:e,fileName:t,mimeType:s})=>{const i=new Blob(e,{type:s});return new File([i],t,{type:i.type})},Lo=e=>{const t=e.match(/\/([^/;]+)/);return t==null?void 0:t[1]},Ei=e=>{const t=Lo(e);return`file_${new Date().toISOString()}${t?"."+t:""}`},Ee=e=>{const t=e.type;return t.startsWith("image/")&&!t.endsWith(".photoshop")},To=e=>e.startsWith("image/")&&!e.endsWith(".photoshop")?"image":e.includes("video/")?"video":e.includes("audio/")?"audio":"file",xi=e=>{if(!e)return null;if(we(e))return e;const{localMetadata:t,...s}=e;return{localMetadata:{...t??{},id:(t==null?void 0:t.id)||$()},...s}},Bn=e=>typeof e=="function",Io=()=>{},L=class{constructor(e){this.value=e,this.handlers=new Set,this.preprocessors=new Set,this.partialNext=t=>this.next(s=>({...s,...t})),this.subscribeWithSelector=(t,s)=>{let i;const n=a=>{const r=t(a);let o=typeof i>"u";for(const h in i)if(i[h]!==r[h]){o=!0;break}if(!o)return;const l=i;i=r,s(r,l)};return this.subscribe(n)}}merge(e){return new Do({original:this,merged:e})}next(e){const t=Bn(e)?e(this.value):e;if(t===this.value)return;this.preprocessors.forEach(i=>i(t,this.value));const s=this.value;this.value=t,this.handlers.forEach(i=>i(this.value,s))}getLatestValue(){return this.value}subscribe(e){return e(this.value,void 0),this.handlers.add(e),()=>{this.handlers.delete(e)}}addPreprocessor(e){return this.preprocessors.add(e),()=>{this.preprocessors.delete(e)}}},Do=class ut extends L{constructor({original:t,merged:s}){const i=t.getLatestValue(),n=s.getLatestValue();super({...i,...n}),this.next=()=>{console.warn(`${ut.name}.next is disabled, call original.next or merged.next instead`)},this.partialNext=()=>{console.warn(`${ut.name}.partialNext is disabled, call original.partialNext or merged.partialNext instead`)},this.cachedOriginalValue=i,this.cachedMergedValue=n,this.original=t,this.merged=s}subscribe(t){const s=[];if(!this.handlers.size){const i=n=>{super.next(a=>({...a,...n}))};s.push(this.original.subscribe(n=>{n!==this.cachedOriginalValue&&(this.cachedOriginalValue=n,i(n))}),this.merged.subscribe(n=>{n!==this.cachedMergedValue&&(this.cachedMergedValue=n,i(n))}))}return s.push(super.subscribe(t)),()=>{s.forEach(i=>i())}}getLatestValue(){if(!this.handlers.size){const t=this.original.getLatestValue(),s=this.merged.getLatestValue();(t!==this.cachedOriginalValue||s!==this.cachedMergedValue)&&(this.value={...t,...s},this.cachedMergedValue=s,this.cachedOriginalValue=t)}return super.getLatestValue()}addPreprocessor(){return console.warn(`${ut.name}.addPreprocessor is disabled, call original.addPreprocessor or merged.addPreprocessor instead`),Io}},re=e=>{if(!e||typeof e!="object"||Array.isArray(e))return!1;const t=Object.getPrototypeOf(e);return t===null||t===Object.prototype?!1:e.constructor&&e.constructor!==Object},Ls=(e,t,s=new Set,i=new WeakSet,n=new WeakSet)=>{if(e===t)return!0;if(e==null||t==null)return!1;const a=typeof e;if(a!==typeof t)return!1;if(a!=="object")return e!==e&&t!==t?!0:e===t;const o=e,l=t;if(i.has(o)||n.has(l))return i.has(o)&&n.has(l);if(i.add(o),n.add(l),e instanceof Date&&t instanceof Date)return i.delete(o),n.delete(l),e.getTime()===t.getTime();if(e instanceof RegExp&&t instanceof RegExp)return i.delete(o),n.delete(l),e.toString()===t.toString();if(re(e)||re(t))return i.delete(o),n.delete(l),!1;const h=Array.isArray(e),c=Array.isArray(t);if(h!==c)return i.delete(o),n.delete(l),!1;if(h&&c){const m=e,w=t;if(m.length!==w.length)return i.delete(o),n.delete(l),!1;const b=[e,t];if(s.has(b))return i.delete(o),n.delete(l),!0;s.add(b);for(let v=0;v<m.length;v++)if(!Ls(m[v],w[v],s,i,n))return s.delete(b),i.delete(o),n.delete(l),!1;return s.delete(b),i.delete(o),n.delete(l),!0}const d=e,u=t,p=Object.keys(d),f=Object.keys(u);if(p.length!==f.length)return i.delete(o),n.delete(l),!1;for(const m of f)if(!Object.prototype.hasOwnProperty.call(d,m))return i.delete(o),n.delete(l),!1;const g=[e,t];if(s.has(g))return i.delete(o),n.delete(l),!0;s.add(g);for(const m of p)if(!Ls(d[m],u[m],s,i,n))return s.delete(g),i.delete(o),n.delete(l),!1;return s.delete(g),i.delete(o),n.delete(l),!0};function Po(e,t){const s={children:{}};return Vn(e,t,s),Ks(s)}function Vn(e,t,s,i,n=new Set,a=new Set){if(Ls(e,t,new Set(n)))return;if(e==null){i!==void 0&&(s.children[String(i)]={type:"added",value:t,children:{}});return}if(typeof e=="object"&&e!==null){if(a.has(e)){i!==void 0&&(s.children[String(i)]={type:"circular",value:t,oldValue:e,children:{}});return}a.add(e)}if(typeof e!="object"||typeof t!="object"||e===null||t===null||Array.isArray(e)!==Array.isArray(t)||re(e)||re(t)){i!==void 0&&(s.children[String(i)]={type:"updated",value:t,oldValue:e,children:{}}),typeof e=="object"&&e!==null&&a.delete(e);return}const o=e,l=t,h=i!==void 0?{type:"updated",children:{},oldValue:e,value:t}:s;i!==void 0&&(s.children[String(i)]=h);const c=[e,t];if(n.has(c)){typeof e=="object"&&e!==null&&a.delete(e);return}n.add(c);const d=new Set([...Object.keys(o),...Object.getOwnPropertySymbols(o),...Object.keys(l),...Object.getOwnPropertySymbols(l)]);for(const u of d){const p=o[u],f=l[u];if(u in l){if(!(u in o)){h.children[String(u)]={type:"added",value:f,children:{}};continue}Vn(p,f,h,u,n,a)}}n.delete(c),typeof e=="object"&&e!==null&&a.delete(e)}function Hn(e={}){const{trackDiff:t=!1}=e;return function({target:i,source:n,customizer:a}){const r=Array.isArray(n)?n:[n],o=t?structuredClone(i):void 0;function l(m,w,b,v,C,S){const U=a==null?void 0:a(m,w,b,v,C,S);return U!==void 0?(Object.defineProperty(v,b,{value:U,enumerable:!0,writable:!0,configurable:!0}),!0):!1}function h(m,w){if(m===null||typeof m>"u"||!Array.isArray(m)&&typeof m!="object")return w;if(m&&typeof m=="object"){const b=re(m),v=re(w);return b||v?v?w:m:Array.isArray(m)?[...m]:{...m}}return Array.isArray(w)?[]:{}}function c(m,w,b,v,C){const S=w[b],U=m[b];if(!l(U,S,b,m,w,v))if(S&&typeof S=="object"){if(!v.has(S)){const q=h(U,S);if(Object.defineProperty(m,b,{value:q,enumerable:!0,writable:!0,configurable:!0}),re(q))return;C.push({target:q,source:S,sourceKey:b,parentTarget:m})}}else S!==void 0&&(m[b]=S)}function d(m,w,b,v){const C=[...Object.keys(w),...Object.getOwnPropertySymbols(w)];for(const S of C)c(m,w,S,b,v)}function u({target:m,source:w,sourceKey:b,parentTarget:v},C,S){if(C.has(w)){t&&b&&v&&Object.defineProperty(v,b,{value:m,enumerable:!0,writable:!0,configurable:!0});return}!C.has(m)&&!C.has(w)&&(C.add(m),C.add(w),d(m,w,C,S),C.delete(w),C.delete(m))}function p(m,w,b=new Set){if(b.has(m)||b.has(w))return{...m};const v={...m},C=[];for(b.add(v),b.add(w),d(v,w,b,C);C.length;)u(C.pop(),b,C);return b.delete(w),b.delete(v),v}const f=r.reduce((m,w)=>p(m,w),{...i}),g=t&&o?Po(o,f):null;return{result:f,diff:g}}}function Ks(e){const t={};let s=!1;for(const i in e.children){const n=Ks(e.children[i]);n&&(t[i]=n,s=!0)}return e.type||s?{...e,children:t}:null}function He(e,t,s){return Hn()({target:e,source:t,customizer:s}).result}function jn(e,t,s){const i=Hn({trackDiff:!0}),{result:n,diff:a}=i({target:e,source:t,customizer:s});return{result:n,diff:Ks(a??{children:{}})||{children:{}}}}var Ui=({message:e})=>{var t;return{attachments:(t=(e==null?void 0:e.attachments)??[])==null?void 0:t.filter(({og_scrape_url:s})=>!s).map(s=>{const i=Uo(s)?{id:$(),uploadState:"finished"}:{id:$()};return{...s,localMetadata:i}})}},Oo=class{constructor({composer:e,message:t}){this.setCustomUploadFn=s=>{this.composer.updateConfig({attachments:{doUploadRequest:s}})},this.initState=({message:s}={})=>{this.state.next(Ui({message:s}))},this.getAttachmentIndex=s=>{const i=this.attachmentsById;return this.attachments.indexOf(i[s])},this.prepareAttachmentUpdate=s=>{const i=this.attachments,n=[...this.attachments],a=this.getAttachmentIndex(s.localMetadata.id);if(a===-1)return null;const r=jn(i[a],s);if(r.diff&&Object.keys(r.diff.children).length){const l=xi(r.result);if(l)return n.splice(a,1,l),n}return null},this.updateAttachment=s=>{const i=this.prepareAttachmentUpdate(s);i&&this.state.partialNext({attachments:i})},this.upsertAttachments=s=>{if(!s.length)return;let i=[...this.attachments],n=!1;s.forEach(a=>{const r=this.prepareAttachmentUpdate(a);if(r)i=r,n=!0;else{const o=xi(a);o&&(i.push(o),n=!0)}}),n&&this.state.partialNext({attachments:i})},this.removeAttachments=s=>{this.state.partialNext({attachments:this.attachments.filter(i=>{var n;return!s.includes((n=i.localMetadata)==null?void 0:n.id)})})},this.getUploadConfigCheck=async s=>{var p,f;const i=this.channel.getClient();let n;i.appSettingsPromise?n=await i.appSettingsPromise:n=await i.getAppSettings();const a=Ee(s)?(p=n==null?void 0:n.app)==null?void 0:p.image_upload_config:(f=n==null?void 0:n.app)==null?void 0:f.file_upload_config;if(!a)return{uploadBlocked:!1};const{allowed_file_extensions:r,allowed_mime_types:o,blocked_file_extensions:l,blocked_mime_types:h,size_limit:c}=a,d=c||Ga,u=s.type;if(dt(s)||he(s)){if(r!=null&&r.length&&!r.some(g=>s.name.toLowerCase().endsWith(g.toLowerCase())))return{uploadBlocked:!0,reason:"allowed_file_extensions"};if(l!=null&&l.length&&l.some(g=>s.name.toLowerCase().endsWith(g.toLowerCase())))return{uploadBlocked:!0,reason:"blocked_file_extensions"}}return o!=null&&o.length&&!o.some(g=>g.toLowerCase()===(u==null?void 0:u.toLowerCase()))?{uploadBlocked:!0,reason:"allowed_mime_types"}:h!=null&&h.length&&h.some(g=>g.toLowerCase()===(u==null?void 0:u.toLowerCase()))?{uploadBlocked:!0,reason:"blocked_mime_types"}:s.size&&s.size>d?{uploadBlocked:!0,reason:"size_limit"}:{uploadBlocked:!1}},this.fileToLocalUploadAttachment=async s=>{var r;const i=he(s)||dt(s)?s:Ri({blobsArray:[s],fileName:Ei(s.type),mimeType:s.type}),n=await this.getUploadConfigCheck(i),a={file_size:i.size,mime_type:i.type,localMetadata:{file:i,id:$(),uploadPermissionCheck:n,uploadState:n.uploadBlocked?"blocked":"pending"},type:To(i.type)};return a[Ee(i)?"fallback":"title"]=i.name,Ee(i)&&(a.localMetadata.previewUri=he(s)?s.uri:(r=URL.createObjectURL)==null?void 0:r.call(URL,s),he(s)&&s.height&&s.width&&(a.original_height=s.height,a.original_width=s.width)),he(s)&&s.thumb_url&&(a.thumb_url=s.thumb_url),a},this.ensureLocalUploadAttachment=async s=>{var n;if(!((n=s.localMetadata)!=null&&n.file)||!s.localMetadata.id){this.client.notifications.addError({message:"File is required for upload attachment",origin:{emitter:"AttachmentManager",context:{attachment:s}},options:{type:"validation:attachment:file:missing"}});return}if(!this.fileUploadFilter(s))return;const i=await this.fileToLocalUploadAttachment(s.localMetadata.file);return s.localMetadata.id&&(i.localMetadata.id=s.localMetadata.id),i},this.doDefaultUploadRequest=async s=>{if(he(s))return this.channel[Ee(s)?"sendImage":"sendFile"](s.uri,s.name,s.type);const i=dt(s)?s:Ri({blobsArray:[s],fileName:Ei(s.type),mimeType:s.type}),{duration:n,...a}=await this.channel[Ee(s)?"sendImage":"sendFile"](i);return a},this.doUploadRequest=async s=>{const i=this.config.doUploadRequest;return i?await i(s):this.doDefaultUploadRequest(s)},this.uploadAttachment=async s=>{var r;if(!this.isUploadEnabled)return;const i=await this.ensureLocalUploadAttachment(s);if(typeof i>"u")return;if(i.localMetadata.uploadState==="blocked")return this.upsertAttachments([i]),this.client.notifications.addError({message:"The attachment upload was blocked",origin:{emitter:"AttachmentManager",context:{attachment:s,blockedAttachment:i}},options:{type:"validation:attachment:upload:blocked",metadata:{reason:(r=i.localMetadata.uploadPermissionCheck)==null?void 0:r.reason}}}),i;this.upsertAttachments([{...s,localMetadata:{...s.localMetadata,uploadState:"uploading"}}]);let n;try{n=await this.doUploadRequest(i.localMetadata.file)}catch(o){const l=o instanceof Error?o.message:"unknown error",h={...s,localMetadata:{...s.localMetadata,uploadState:"failed"}};return this.client.notifications.addError({message:"Error uploading attachment",origin:{emitter:"AttachmentManager",context:{attachment:s,failedAttachment:h}},options:{type:"api:attachment:upload:failed",metadata:{reason:l},originalError:o instanceof Error?o:void 0}}),this.updateAttachment(h),h}if(!n){this.removeAttachments([s.localMetadata.id]);return}const a={...s,localMetadata:{...s.localMetadata,uploadState:"finished"}};return xo(a)?(a.localMetadata.previewUri&&(URL.revokeObjectURL(a.localMetadata.previewUri),delete a.localMetadata.previewUri),a.image_url=n.file):a.asset_url=n.file,n.thumb_url&&(a.thumb_url=n.thumb_url),this.updateAttachment(a),a},this.uploadFiles=async s=>{if(!this.isUploadEnabled)return;const i=Ao(s)?Array.from(s):s,n=await Promise.all(i.map(this.fileToLocalUploadAttachment));return Promise.all(n.filter(this.fileUploadFilter).slice(0,this.availableUploadSlots).map(this.uploadAttachment))},this.composer=e,this.state=new L(Ui({message:t})),this.attachmentsByIdGetterCache={attachmentsById:{},attachments:[]}}get attachmentsById(){const{attachments:e}=this.state.getLatestValue();return e!==this.attachmentsByIdGetterCache.attachments&&(this.attachmentsByIdGetterCache.attachments=e,this.attachmentsByIdGetterCache.attachmentsById=e.reduce((t,s)=>{var i;return s.localMetadata.id&&(t[i=s.localMetadata.id]??(t[i]=s)),t},{})),this.attachmentsByIdGetterCache.attachmentsById}get client(){return this.composer.client}get channel(){return this.composer.channel}get config(){return this.composer.config.attachments}get acceptedFiles(){return this.config.acceptedFiles}set acceptedFiles(e){this.composer.updateConfig({attachments:{acceptedFiles:e}})}get fileUploadFilter(){return this.config.fileUploadFilter}set fileUploadFilter(e){this.composer.updateConfig({attachments:{fileUploadFilter:e}})}get maxNumberOfFilesPerMessage(){return this.config.maxNumberOfFilesPerMessage}set maxNumberOfFilesPerMessage(e){e!==this.maxNumberOfFilesPerMessage&&this.composer.updateConfig({attachments:{maxNumberOfFilesPerMessage:e}})}get attachments(){return this.state.getLatestValue().attachments}get hasUploadPermission(){var e,t;return!!((t=(e=this.channel.data)==null?void 0:e.own_capabilities)!=null&&t.includes("upload-file"))}get isUploadEnabled(){return this.hasUploadPermission&&this.availableUploadSlots>0}get successfulUploads(){return this.getUploadsByState("finished")}get successfulUploadsCount(){return this.successfulUploads.length}get uploadsInProgressCount(){return this.getUploadsByState("uploading").length}get failedUploadsCount(){return this.getUploadsByState("failed").length}get blockedUploadsCount(){return this.getUploadsByState("blocked").length}get pendingUploadsCount(){return this.getUploadsByState("pending").length}get availableUploadSlots(){return this.config.maxNumberOfFilesPerMessage-this.successfulUploadsCount-this.uploadsInProgressCount}getUploadsByState(e){return Object.values(this.attachments).filter(({localMetadata:t})=>t.uploadState===e)}},ko="aaa1rp3bb0ott3vie4c1le2ogado5udhabi7c0ademy5centure6ountant0s9o1tor4d0s1ult4e0g1ro2tna4f0l1rica5g0akhan5ency5i0g1rbus3force5tel5kdn3l0ibaba4pay4lfinanz6state5y2sace3tom5m0azon4ericanexpress7family11x2fam3ica3sterdam8nalytics7droid5quan4z2o0l2partments8p0le4q0uarelle8r0ab1mco4chi3my2pa2t0e3s0da2ia2sociates9t0hleta5torney7u0ction5di0ble3o3spost5thor3o0s4w0s2x0a2z0ure5ba0by2idu3namex4d1k2r0celona5laycard4s5efoot5gains6seball5ketball8uhaus5yern5b0c1t1va3cg1n2d1e0ats2uty4er2ntley5rlin4st0buy5t2f1g1h0arti5i0ble3d1ke2ng0o3o1z2j1lack0friday9ockbuster8g1omberg7ue3m0s1w2n0pparibas9o0ats3ehringer8fa2m1nd2o0k0ing5sch2tik2on4t1utique6x2r0adesco6idgestone9oadway5ker3ther5ussels7s1t1uild0ers6siness6y1zz3v1w1y1z0h3ca0b1fe2l0l1vinklein9m0era3p2non3petown5ital0one8r0avan4ds2e0er0s4s2sa1e1h1ino4t0ering5holic7ba1n1re3c1d1enter4o1rn3f0a1d2g1h0anel2nel4rity4se2t2eap3intai5ristmas6ome4urch5i0priani6rcle4sco3tadel4i0c2y3k1l0aims4eaning6ick2nic1que6othing5ud3ub0med6m1n1o0ach3des3ffee4llege4ogne5m0mbank4unity6pany2re3uter5sec4ndos3struction8ulting7tact3ractors9oking4l1p2rsica5untry4pon0s4rses6pa2r0edit0card4union9icket5own3s1uise0s6u0isinella9v1w1x1y0mru3ou3z2dad1nce3ta1e1ing3sun4y2clk3ds2e0al0er2s3gree4livery5l1oitte5ta3mocrat6ntal2ist5si0gn4v2hl2iamonds6et2gital5rect0ory7scount3ver5h2y2j1k1m1np2o0cs1tor4g1mains5t1wnload7rive4tv2ubai3nlop4pont4rban5vag2r2z2earth3t2c0o2deka3u0cation8e1g1mail3erck5nergy4gineer0ing9terprises10pson4quipment8r0icsson6ni3s0q1tate5t1u0rovision8s2vents5xchange6pert3osed4ress5traspace10fage2il1rwinds6th3mily4n0s2rm0ers5shion4t3edex3edback6rrari3ero6i0delity5o2lm2nal1nce1ial7re0stone6mdale6sh0ing5t0ness6j1k1lickr3ghts4r2orist4wers5y2m1o0o0d1tball6rd1ex2sale4um3undation8x2r0ee1senius7l1ogans4ntier7tr2ujitsu5n0d2rniture7tbol5yi3ga0l0lery3o1up4me0s3p1rden4y2b0iz3d0n2e0a1nt0ing5orge5f1g0ee3h1i0ft0s3ves2ing5l0ass3e1obal2o4m0ail3bh2o1x2n1odaddy5ld0point6f2o0dyear5g0le4p1t1v2p1q1r0ainger5phics5tis4een3ipe3ocery4up4s1t1u0cci3ge2ide2tars5ru3w1y2hair2mburg5ngout5us3bo2dfc0bank7ealth0care8lp1sinki6re1mes5iphop4samitsu7tachi5v2k0t2m1n1ockey4ldings5iday5medepot5goods5s0ense7nda3rse3spital5t0ing5t0els3mail5use3w2r1sbc3t1u0ghes5yatt3undai7ibm2cbc2e1u2d1e0ee3fm2kano4l1m0amat4db2mo0bilien9n0c1dustries8finiti5o2g1k1stitute6urance4e4t0ernational10uit4vestments10o1piranga7q1r0ish4s0maili5t0anbul7t0au2v3jaguar4va3cb2e0ep2tzt3welry6io2ll2m0p2nj2o0bs1urg4t1y2p0morgan6rs3uegos4niper7kaufen5ddi3e0rryhotels6logistics9properties14fh2g1h1i0a1ds2m1ndle4tchen5wi3m1n1oeln3matsu5sher5p0mg2n2r0d1ed3uokgroup8w1y0oto4z2la0caixa5mborghini8er3ncaster6d0rover6xess5salle5t0ino3robe5w0yer5b1c1ds2ease3clerc5frak4gal2o2xus4gbt3i0dl2fe0insurance9style7ghting6ke2lly3mited4o2ncoln4k2psy3ve1ing5k1lc1p2oan0s3cker3us3l1ndon4tte1o3ve3pl0financial11r1s1t0d0a3u0ndbeck6xe1ury5v1y2ma0drid4if1son4keup4n0agement7go3p1rket0ing3s4riott5shalls7ttel5ba2c0kinsey7d1e0d0ia3et2lbourne7me1orial6n0u2rckmsd7g1h1iami3crosoft7l1ni1t2t0subishi9k1l0b1s2m0a2n1o0bi0le4da2e1i1m1nash3ey2ster5rmon3tgage6scow4to0rcycles9v0ie4p1q1r1s0d2t0n1r2u0seum3ic4v1w1x1y1z2na0b1goya4me2vy3ba2c1e0c1t0bank4flix4work5ustar5w0s2xt0direct7us4f0l2g0o2hk2i0co2ke1on3nja3ssan1y5l1o0kia3rton4w0ruz3tv4p1r0a1w2tt2u1yc2z2obi1server7ffice5kinawa6layan0group9lo3m0ega4ne1g1l0ine5oo2pen3racle3nge4g0anic5igins6saka4tsuka4t2vh3pa0ge2nasonic7ris2s1tners4s1y3y2ccw3e0t2f0izer5g1h0armacy6d1ilips5one2to0graphy6s4ysio5ics1tet2ures6d1n0g1k2oneer5zza4k1l0ace2y0station9umbing5s3m1n0c2ohl2ker3litie5rn2st3r0america6xi3ess3ime3o0d0uctions8f1gressive8mo2perties3y5tection8u0dential9s1t1ub2w0c2y2qa1pon3uebec3st5racing4dio4e0ad1lestate6tor2y4cipes5d0stone5umbrella9hab3ise0n3t2liance6n0t0als5pair3ort3ublican8st0aurant8view0s5xroth6ich0ardli6oh3l1o1p2o0cks3deo3gers4om3s0vp3u0gby3hr2n2w0e2yukyu6sa0arland6fe0ty4kura4le1on3msclub4ung5ndvik0coromant12ofi4p1rl2s1ve2xo3b0i1s2c0b1haeffler7midt4olarships8ol3ule3warz5ience5ot3d1e0arch3t2cure1ity6ek2lect4ner3rvices6ven3w1x0y3fr2g1h0angrila6rp3ell3ia1ksha5oes2p0ping5uji3w3i0lk2na1gles5te3j1k0i0n2y0pe4l0ing4m0art3ile4n0cf3o0ccer3ial4ftbank4ware6hu2lar2utions7ng1y2y2pa0ce3ort2t3r0l2s1t0ada2ples4r1tebank4farm7c0group6ockholm6rage3e3ream4udio2y3yle4u0cks3pplies3y2ort5rf1gery5zuki5v1watch4iss4x1y0dney4stems6z2tab1ipei4lk2obao4rget4tamotors6r2too4x0i3c0i2d0k2eam2ch0nology8l1masek5nnis4va3f1g1h0d1eater2re6iaa2ckets5enda4ps2res2ol4j0maxx4x2k0maxx5l1m0all4n1o0day3kyo3ols3p1ray3shiba5tal3urs3wn2yota3s3r0ade1ing4ining5vel0ers0insurance16ust3v2t1ube2i1nes3shu4v0s2w1z2ua1bank3s2g1k1nicom3versity8o2ol2ps2s1y1z2va0cations7na1guard7c1e0gas3ntures6risign5mgensberater2ung14sicherung10t2g1i0ajes4deo3g1king4llas4n1p1rgin4sa1ion4va1o3laanderen9n1odka3lvo3te1ing3o2yage5u2wales2mart4ter4ng0gou5tch0es6eather0channel12bcam3er2site5d0ding5ibo2r3f1hoswho6ien2ki2lliamhill9n0dows4e1ners6me2olterskluwer11odside6rk0s2ld3w2s1tc1f3xbox3erox4ihuan4n2xx2yz3yachts4hoo3maxun5ndex5e1odobashi7ga2kohama6u0tube6t1un3za0ppos4ra3ero3ip2m1one3uerich6w2",No="121342632165322333335355455655552435435422463632574574330355524444661154543332344423364211133222221212112052232222232212222223222241112222224322321222",ye=(e,t)=>{for(const s in t)e[s]=t[s];return e},Ts="numeric",Is="ascii",Ds="alpha",Te="asciinumeric",Me="alphanumeric",Ps="domain",Wn="emoji",Fo="scheme",$o="slashscheme",hs="whitespace";function qo(e,t){return e in t||(t[e]=[]),t[e]}function ne(e,t,s){t[Ts]&&(t[Te]=!0,t[Me]=!0),t[Is]&&(t[Te]=!0,t[Ds]=!0),t[Te]&&(t[Me]=!0),t[Ds]&&(t[Me]=!0),t[Me]&&(t[Ps]=!0),t[Wn]&&(t[Ps]=!0);for(const i in t){const n=qo(i,s);n.indexOf(e)<0&&n.push(e)}}function Bo(e,t){const s={};for(const i in t)t[i].indexOf(e)>=0&&(s[i]=!0);return s}function O(e=null){this.j={},this.jr=[],this.jd=null,this.t=e}O.groups={};O.prototype={accepts(){return!!this.t},go(e){const t=this,s=t.j[e];if(s)return s;for(let i=0;i<t.jr.length;i++){const n=t.jr[i][0],a=t.jr[i][1];if(a&&n.test(e))return a}return t.jd},has(e,t=!1){return t?e in this.j:!!this.go(e)},ta(e,t,s,i){for(let n=0;n<e.length;n++)this.tt(e[n],t,s,i)},tr(e,t,s,i){i=i||O.groups;let n;return t&&t.j?n=t:(n=new O(t),s&&i&&ne(t,s,i)),this.jr.push([e,n]),n},ts(e,t,s,i){let n=this;const a=e.length;if(!a)return n;for(let r=0;r<a-1;r++)n=n.tt(e[r]);return n.tt(e[a-1],t,s,i)},tt(e,t,s,i){i=i||O.groups;const n=this;if(t&&t.j)return n.j[e]=t,t;const a=t;let r,o=n.go(e);if(o?(r=new O,ye(r.j,o.j),r.jr.push.apply(r.jr,o.jr),r.jd=o.jd,r.t=o.t):r=new O,a){if(i)if(r.t&&typeof r.t=="string"){const l=ye(Bo(r.t,i),s);ne(a,l,i)}else s&&ne(a,s,i);r.t=a}return n.j[e]=r,r}};var R=(e,t,s,i,n)=>e.ta(t,s,i,n),M=(e,t,s,i,n)=>e.tr(t,s,i,n),Ai=(e,t,s,i,n)=>e.ts(t,s,i,n),_=(e,t,s,i,n)=>e.tt(t,s,i,n),G="WORD",Os="UWORD",zn="ASCIINUMERICAL",Qn="ALPHANUMERICAL",je="LOCALHOST",ks="TLD",Ns="UTLD",ft="SCHEME",de="SLASH_SCHEME",Ys="NUM",Fs="WS",Xs="NL",Ie="OPENBRACE",De="CLOSEBRACE",bt="OPENBRACKET",vt="CLOSEBRACKET",Ct="OPENPAREN",St="CLOSEPAREN",Rt="OPENANGLEBRACKET",Et="CLOSEANGLEBRACKET",xt="FULLWIDTHLEFTPAREN",Ut="FULLWIDTHRIGHTPAREN",At="LEFTCORNERBRACKET",Mt="RIGHTCORNERBRACKET",Lt="LEFTWHITECORNERBRACKET",Tt="RIGHTWHITECORNERBRACKET",It="FULLWIDTHLESSTHAN",Dt="FULLWIDTHGREATERTHAN",Pt="AMPERSAND",Zs="APOSTROPHE",Ot="ASTERISK",X="AT",kt="BACKSLASH",Nt="BACKTICK",Ft="CARET",Z="COLON",ei="COMMA",$t="DOLLAR",V="DOT",qt="EQUALS",ti="EXCLAMATION",N="HYPHEN",Pe="PERCENT",Bt="PIPE",Vt="PLUS",Ht="POUND",Oe="QUERY",si="QUOTE",Gn="FULLWIDTHMIDDLEDOT",ii="SEMI",H="SLASH",ke="TILDE",jt="UNDERSCORE",Jn="EMOJI",Wt="SYM",Kn=Object.freeze({__proto__:null,WORD:G,UWORD:Os,ASCIINUMERICAL:zn,ALPHANUMERICAL:Qn,LOCALHOST:je,TLD:ks,UTLD:Ns,SCHEME:ft,SLASH_SCHEME:de,NUM:Ys,WS:Fs,NL:Xs,OPENBRACE:Ie,CLOSEBRACE:De,OPENBRACKET:bt,CLOSEBRACKET:vt,OPENPAREN:Ct,CLOSEPAREN:St,OPENANGLEBRACKET:Rt,CLOSEANGLEBRACKET:Et,FULLWIDTHLEFTPAREN:xt,FULLWIDTHRIGHTPAREN:Ut,LEFTCORNERBRACKET:At,RIGHTCORNERBRACKET:Mt,LEFTWHITECORNERBRACKET:Lt,RIGHTWHITECORNERBRACKET:Tt,FULLWIDTHLESSTHAN:It,FULLWIDTHGREATERTHAN:Dt,AMPERSAND:Pt,APOSTROPHE:Zs,ASTERISK:Ot,AT:X,BACKSLASH:kt,BACKTICK:Nt,CARET:Ft,COLON:Z,COMMA:ei,DOLLAR:$t,DOT:V,EQUALS:qt,EXCLAMATION:ti,HYPHEN:N,PERCENT:Pe,PIPE:Bt,PLUS:Vt,POUND:Ht,QUERY:Oe,QUOTE:si,FULLWIDTHMIDDLEDOT:Gn,SEMI:ii,SLASH:H,TILDE:ke,UNDERSCORE:jt,EMOJI:Jn,SYM:Wt}),z=/[a-z]/,xe=new RegExp("\\p{L}","u"),ds=new RegExp("\\p{Emoji}","u"),Q=/\d/,us=/\s/,Mi="\r",fs=`
`,Vo="",Ho="",ps="",it=null,nt=null;function jo(e=[]){const t={};O.groups=t;const s=new O;it==null&&(it=Li(ko)),nt==null&&(nt=Li(No)),_(s,"'",Zs),_(s,"{",Ie),_(s,"}",De),_(s,"[",bt),_(s,"]",vt),_(s,"(",Ct),_(s,")",St),_(s,"<",Rt),_(s,">",Et),_(s,"",xt),_(s,"",Ut),_(s,"",At),_(s,"",Mt),_(s,"",Lt),_(s,"",Tt),_(s,"",It),_(s,"",Dt),_(s,"&",Pt),_(s,"*",Ot),_(s,"@",X),_(s,"`",Nt),_(s,"^",Ft),_(s,":",Z),_(s,",",ei),_(s,"$",$t),_(s,".",V),_(s,"=",qt),_(s,"!",ti),_(s,"-",N),_(s,"%",Pe),_(s,"|",Bt),_(s,"+",Vt),_(s,"#",Ht),_(s,"?",Oe),_(s,'"',si),_(s,"/",H),_(s,";",ii),_(s,"~",ke),_(s,"_",jt),_(s,"\\",kt),_(s,"",Gn);const i=M(s,Q,Ys,{[Ts]:!0});M(i,Q,i);const n=M(i,z,zn,{[Te]:!0}),a=M(i,xe,Qn,{[Me]:!0}),r=M(s,z,G,{[Is]:!0});M(r,Q,n),M(r,z,r),M(n,Q,n),M(n,z,n);const o=M(s,xe,Os,{[Ds]:!0});M(o,z),M(o,Q,a),M(o,xe,o),M(a,Q,a),M(a,z),M(a,xe,a);const l=_(s,fs,Xs,{[hs]:!0}),h=_(s,Mi,Fs,{[hs]:!0}),c=M(s,us,Fs,{[hs]:!0});_(s,ps,c),_(h,fs,l),_(h,ps,c),M(h,us,c),_(c,Mi),_(c,fs),M(c,us,c),_(c,ps,c);const d=M(s,ds,Jn,{[Wn]:!0});_(d,"#"),M(d,ds,d),_(d,Vo,d);const u=_(d,Ho);_(u,"#"),M(u,ds,d);const p=[[z,r],[Q,n]],f=[[z,null],[xe,o],[Q,a]];for(let g=0;g<it.length;g++)Y(s,it[g],ks,G,p);for(let g=0;g<nt.length;g++)Y(s,nt[g],Ns,Os,f);ne(ks,{tld:!0,ascii:!0},t),ne(Ns,{utld:!0,alpha:!0},t),Y(s,"file",ft,G,p),Y(s,"mailto",ft,G,p),Y(s,"http",de,G,p),Y(s,"https",de,G,p),Y(s,"ftp",de,G,p),Y(s,"ftps",de,G,p),ne(ft,{scheme:!0,ascii:!0},t),ne(de,{slashscheme:!0,ascii:!0},t),e=e.sort((g,m)=>g[0]>m[0]?1:-1);for(let g=0;g<e.length;g++){const m=e[g][0],b=e[g][1]?{[Fo]:!0}:{[$o]:!0};m.indexOf("-")>=0?b[Ps]=!0:z.test(m)?Q.test(m)?b[Te]=!0:b[Is]=!0:b[Ts]=!0,Ai(s,m,m,b)}return Ai(s,"localhost",je,{ascii:!0}),s.jd=new O(Wt),{start:s,tokens:ye({groups:t},Kn)}}function Yn(e,t){const s=Wo(t.replace(/[A-Z]/g,o=>o.toLowerCase())),i=s.length,n=[];let a=0,r=0;for(;r<i;){let o=e,l=null,h=0,c=null,d=-1,u=-1;for(;r<i&&(l=o.go(s[r]));)o=l,o.accepts()?(d=0,u=0,c=o):d>=0&&(d+=s[r].length,u++),h+=s[r].length,a+=s[r].length,r++;a-=d,r-=u,h-=d,n.push({t:c.t,v:t.slice(a-h,a),s:a-h,e:a})}return n}function Wo(e){const t=[],s=e.length;let i=0;for(;i<s;){let n=e.charCodeAt(i),a,r=n<55296||n>56319||i+1===s||(a=e.charCodeAt(i+1))<56320||a>57343?e[i]:e.slice(i,i+2);t.push(r),i+=r.length}return t}function Y(e,t,s,i,n){let a;const r=t.length;for(let o=0;o<r-1;o++){const l=t[o];e.j[l]?a=e.j[l]:(a=new O(i),a.jr=n.slice(),e.j[l]=a),e=a}return a=new O(s),a.jr=n.slice(),e.j[t[r-1]]=a,a}function Li(e){const t=[],s=[];let i=0,n="0123456789";for(;i<e.length;){let a=0;for(;n.indexOf(e[i+a])>=0;)a++;if(a>0){t.push(s.join(""));for(let r=parseInt(e.substring(i,i+a),10);r>0;r--)s.pop();i+=a}else s.push(e[i]),i++}return t}var We={defaultProtocol:"http",events:null,format:Ti,formatHref:Ti,nl2br:!1,tagName:"a",target:null,rel:null,validate:!0,truncate:1/0,className:null,attributes:null,ignoreTags:[],render:null};function ni(e,t=null){let s=ye({},We);e&&(s=ye(s,e instanceof ni?e.o:e));const i=s.ignoreTags,n=[];for(let a=0;a<i.length;a++)n.push(i[a].toUpperCase());this.o=s,t&&(this.defaultRender=t),this.ignoreTags=n}ni.prototype={o:We,ignoreTags:[],defaultRender(e){return e},check(e){return this.get("validate",e.toString(),e)},get(e,t,s){const i=t!=null;let n=this.o[e];return n&&(typeof n=="object"?(n=s.t in n?n[s.t]:We[e],typeof n=="function"&&i&&(n=n(t,s))):typeof n=="function"&&i&&(n=n(t,s.t,s)),n)},getObj(e,t,s){let i=this.o[e];return typeof i=="function"&&t!=null&&(i=i(t,s.t,s)),i},render(e){const t=e.render(this);return(this.get("render",null,e)||this.defaultRender)(t,e.t,e)}};function Ti(e){return e}function Xn(e,t){this.t="token",this.v=e,this.tk=t}Xn.prototype={isLink:!1,toString(){return this.v},toHref(e){return this.toString()},toFormattedString(e){const t=this.toString(),s=e.get("truncate",t,this),i=e.get("format",t,this);return s&&i.length>s?i.substring(0,s)+"":i},toFormattedHref(e){return e.get("formatHref",this.toHref(e.get("defaultProtocol")),this)},startIndex(){return this.tk[0].s},endIndex(){return this.tk[this.tk.length-1].e},toObject(e=We.defaultProtocol){return{type:this.t,value:this.toString(),isLink:this.isLink,href:this.toHref(e),start:this.startIndex(),end:this.endIndex()}},toFormattedObject(e){return{type:this.t,value:this.toFormattedString(e),isLink:this.isLink,href:this.toFormattedHref(e),start:this.startIndex(),end:this.endIndex()}},validate(e){return e.get("validate",this.toString(),this)},render(e){const t=this,s=this.toHref(e.get("defaultProtocol")),i=e.get("formatHref",s,this),n=e.get("tagName",s,t),a=this.toFormattedString(e),r={},o=e.get("className",s,t),l=e.get("target",s,t),h=e.get("rel",s,t),c=e.getObj("attributes",s,t),d=e.getObj("events",s,t);return r.href=i,o&&(r.class=o),l&&(r.target=l),h&&(r.rel=h),c&&ye(r,c),{tagName:n,attributes:r,content:a,eventListeners:d}}};function ts(e,t){class s extends Xn{constructor(n,a){super(n,a),this.t=e}}for(const i in t)s.prototype[i]=t[i];return s.t=e,s}var Ii=ts("email",{isLink:!0,toHref(){return"mailto:"+this.toString()}}),Di=ts("text"),zo=ts("nl"),rt=ts("url",{isLink:!0,toHref(e=We.defaultProtocol){return this.hasProtocol()?this.v:`${e}://${this.v}`},hasProtocol(){const e=this.tk;return e.length>=2&&e[0].t!==je&&e[1].t===Z}}),k=e=>new O(e);function Qo({groups:e}){const t=e.domain.concat([Pt,Ot,X,kt,Nt,Ft,$t,qt,N,Ys,Pe,Bt,Vt,Ht,H,Wt,ke,jt]),s=[Z,ei,V,ti,Pe,Oe,si,ii,Rt,Et,Ie,De,vt,bt,Ct,St,xt,Ut,At,Mt,Lt,Tt,It,Dt],i=[Pt,Zs,Ot,kt,Nt,Ft,$t,qt,N,Ie,De,Pe,Bt,Vt,Ht,Oe,H,Wt,ke,jt],n=k(),a=_(n,ke);R(a,i,a),R(a,e.domain,a);const r=k(),o=k(),l=k();R(n,e.domain,r),R(n,e.scheme,o),R(n,e.slashscheme,l),R(r,i,a),R(r,e.domain,r);const h=_(r,X);_(a,X,h),_(o,X,h),_(l,X,h);const c=_(a,V);R(c,i,a),R(c,e.domain,a);const d=k();R(h,e.domain,d),R(d,e.domain,d);const u=_(d,V);R(u,e.domain,d);const p=k(Ii);R(u,e.tld,p),R(u,e.utld,p),_(h,je,p);const f=_(d,N);_(f,N,f),R(f,e.domain,d),R(p,e.domain,d),_(p,V,u),_(p,N,f);const g=_(p,Z);R(g,e.numeric,Ii);const m=_(r,N),w=_(r,V);_(m,N,m),R(m,e.domain,r),R(w,i,a),R(w,e.domain,r);const b=k(rt);R(w,e.tld,b),R(w,e.utld,b),R(b,e.domain,r),R(b,i,a),_(b,V,w),_(b,N,m),_(b,X,h);const v=_(b,Z),C=k(rt);R(v,e.numeric,C);const S=k(rt),U=k();R(S,t,S),R(S,s,U),R(U,t,S),R(U,s,U),_(b,H,S),_(C,H,S);const q=_(o,Z),Ke=_(l,Z),Ye=_(Ke,H),oe=_(Ye,H);R(o,e.domain,r),_(o,V,w),_(o,N,m),R(l,e.domain,r),_(l,V,w),_(l,N,m),R(q,e.domain,S),_(q,H,S),_(q,Oe,S),R(oe,e.domain,S),R(oe,t,S),_(oe,H,S);const ve=[[Ie,De],[bt,vt],[Ct,St],[Rt,Et],[xt,Ut],[At,Mt],[Lt,Tt],[It,Dt]];for(let le=0;le<ve.length;le++){const[Ce,ce]=ve[le],E=_(S,Ce);_(U,Ce,E),_(E,ce,S);const A=k(rt);R(E,t,A);const B=k();R(E,s),R(A,t,A),R(A,s,B),R(B,t,A),R(B,s,B),_(A,ce,S),_(B,ce,S)}return _(n,je,b),_(n,Xs,zo),{start:n,tokens:Kn}}function Go(e,t,s){let i=s.length,n=0,a=[],r=[];for(;n<i;){let o=e,l=null,h=null,c=0,d=null,u=-1;for(;n<i&&!(l=o.go(s[n].t));)r.push(s[n++]);for(;n<i&&(h=l||o.go(s[n].t));)l=null,o=h,o.accepts()?(u=0,d=o):u>=0&&u++,n++,c++;if(u<0)n-=c,n<i&&(r.push(s[n]),n++);else{r.length>0&&(a.push(gs(Di,t,r)),r=[]),n-=u,c-=u;const p=d.t,f=s.slice(n-c,n);a.push(gs(p,t,f))}}return r.length>0&&a.push(gs(Di,t,r)),a}function gs(e,t,s){const i=s[0].s,n=s[s.length-1].e,a=t.slice(i,n);return new e(a,s)}var D={scanner:null,parser:null,tokenQueue:[],pluginQueue:[],customSchemes:[],initialized:!1};function Jo(){D.scanner=jo(D.customSchemes);for(let e=0;e<D.tokenQueue.length;e++)D.tokenQueue[e][1]({scanner:D.scanner});D.parser=Qo(D.scanner.tokens);for(let e=0;e<D.pluginQueue.length;e++)D.pluginQueue[e][1]({scanner:D.scanner,parser:D.parser});return D.initialized=!0,D}function Zn(e){return D.initialized||Jo(),Go(D.parser.start,e,Yn(D.scanner.start,e))}Zn.scan=Yn;function Ko(e,t=null,s=null){if(t&&typeof t=="object"){if(s)throw Error(`linkifyjs: Invalid link type ${t}; must be a string`);s=t,t=null}const i=new ni(s),n=Zn(e),a=[];for(let r=0;r<n.length;r++){const o=n[r];o.isLink&&(!t||o.t===t)&&i.check(o)&&a.push(o.toFormattedObject(i))}return a}var Yo={debounceURLEnrichmentMs:1500,enabled:!1,findURLFn:e=>Ko(e,"url",{defaultProtocol:"https"}).reduce((t,s)=>{try{const i=new URL(s.href);s.isLink&&/^[a-zA-Z0-9-.]+\.[a-zA-Z]{2,}$/.test(i.hostname)&&t.push(s.href)}catch{}return t},[])},Xo={acceptedFiles:[],fileUploadFilter:()=>!0,maxNumberOfFilesPerMessage:Ja},Zo={enabled:!0,publishTypingEvents:!0},el={attachments:Xo,drafts:{enabled:!1},linkPreviews:Yo,text:Zo},Pi=e=>e?{message:{},custom:{}}:{message:{},custom:{}},tl=class{constructor({composer:e,message:t}){this.isMessageDataEqual=(s,i)=>JSON.stringify(s.message)===JSON.stringify(i==null?void 0:i.message),this.initState=({message:s}={})=>{this.state.next(Pi({composer:this.composer}))},this.composer=e,this.state=new L(Pi({}))}get customMessageData(){return this.state.getLatestValue().message}get customComposerData(){return this.state.getLatestValue().custom}setMessageData(e){this.state.partialNext({message:{...this.state.getLatestValue().message,...e}})}setCustomData(e){this.state.partialNext({custom:{...this.state.getLatestValue().custom,...e}})}},sl=e=>new Map(e.map(t=>[t.og_scrape_url,t])),Oi=({message:e})=>{var t;return e?{previews:((t=e.attachments)==null?void 0:t.reduce((s,i)=>(i.og_scrape_url&&s.set(i.og_scrape_url,{...i,status:"loaded"}),s),new Map))??new Map}:{previews:new Map}},ae=class te{constructor({composer:t,message:s}){this.shouldDiscardEnrichQueries=!1,this.initState=({message:i}={})=>{this.state.next(Oi({message:this.enabled?i:void 0}))},this._findAndEnrichUrls=async i=>{if(!this.enabled)return;const n=this.config.findURLFn(i);if(this.shouldDiscardEnrichQueries=!n.length,this.shouldDiscardEnrichQueries){this.state.next({previews:new Map});return}const a=new Map(Array.from(this.previews).filter(([o])=>n.includes(o)||n.includes(o+"/"))),r=n.filter(o=>{const l=this.previews;return!(l.get(o)||l.get(o+"/"))}).map(o=>({og_scrape_url:o.trim(),status:"loading"}));r.length&&(this.state.partialNext({previews:new Map([...a,...sl(r)])}),await Promise.all(r.map(async o=>{try{const{duration:l,...h}=await this.client.enrichURL(o.og_scrape_url);if(this.shouldDiscardEnrichQueries)return;this.previews.has(o.og_scrape_url)&&this.updatePreview(o.og_scrape_url,{status:"loaded",...h})}catch{this.previews.has(o.og_scrape_url)&&this.updatePreview(o.og_scrape_url,{status:"failed"})}return o})))},this.cancelURLEnrichment=()=>{this.findAndEnrichUrls.cancel(),this.findAndEnrichUrls.flush()},this.clearPreviews=()=>{const i=this.previews,n=new Map;i.forEach((a,r)=>{te.previewIsDismissed(a)&&n.set(r,a)}),this.state.partialNext({previews:n})},this.updatePreview=(i,n)=>{var l;if(!i)return;const a=this.previews.get(i),r=n.status??((l=this.previews.get(i))==null?void 0:l.status)??"pending";let o=n;if(a){const h=jn(a,n);if(!h.diff||Object.keys(h.diff).length===0)return;o=h.result}this.state.partialNext({previews:new Map(this.previews).set(i,{...o,og_scrape_url:i,status:r})})},this.dismissPreview=i=>{var a;const n=this.previews.get(i);n&&((a=this.onLinkPreviewDismissed)==null||a.call(this,n),this.updatePreview(i,{status:"dismissed"}))},this.composer=t,this.state=new L(Oi({message:this.enabled?s:void 0})),this.findAndEnrichUrls=Ve(this._findAndEnrichUrls.bind(this),this.config.debounceURLEnrichmentMs)}get client(){return this.composer.client}get channel(){return this.composer.channel}get previews(){return this.state.getLatestValue().previews}get loadingPreviews(){return Array.from(this.previews.values()).filter(t=>te.previewIsLoading(t))}get loadedPreviews(){return Array.from(this.previews.values()).filter(t=>te.previewIsLoaded(t))}get dismissedPreviews(){return Array.from(this.previews.values()).filter(t=>te.previewIsDismissed(t))}get failedPreviews(){return Array.from(this.previews.values()).filter(t=>te.previewIsFailed(t))}get pendingPreviews(){return Array.from(this.previews.values()).filter(t=>te.previewIsPending(t))}get config(){return this.composer.config.linkPreviews}get debounceURLEnrichmentMs(){return this.config.debounceURLEnrichmentMs}set debounceURLEnrichmentMs(t){this.cancelURLEnrichment(),this.findAndEnrichUrls=Ve(this._findAndEnrichUrls.bind(this),this.config.debounceURLEnrichmentMs),this.composer.updateConfig({linkPreviews:{debounceURLEnrichmentMs:t}})}get enabled(){var t;return!!((t=this.channel.getConfig())!=null&&t.url_enrichment)&&this.composer.config.linkPreviews.enabled}set enabled(t){t!==this.enabled&&this.composer.updateConfig({linkPreviews:{enabled:t}})}get findURLFn(){return this.config.findURLFn}set findURLFn(t){this.composer.updateConfig({linkPreviews:{findURLFn:t}})}get onLinkPreviewDismissed(){return this.config.onLinkPreviewDismissed}set onLinkPreviewDismissed(t){this.composer.updateConfig({linkPreviews:{onLinkPreviewDismissed:t}})}};ae.previewIsLoading=e=>e.status==="loading";ae.previewIsLoaded=e=>e.status==="loaded";ae.previewIsDismissed=e=>e.status==="dismissed";ae.previewIsFailed=e=>e.status==="failed";ae.previewIsPending=e=>e.status==="pending";ae.getPreviewData=e=>{const{status:t,...s}=e;return s};var ri=ae,il=nl(rl),$s=new Map;function nl(e){return function(s,i){const{cb:n,onContinued:a}=e(s,i),r=$s.get(s);r==null||r.onContinued();const o=r?r.promise.then(n,n):n();return $s.set(s,{promise:o,onContinued:a}),o}}function rl(e,t){const s=new AbortController;return{cb:()=>s.signal.aborted?Promise.resolve("canceled"):t(s.signal).finally(()=>{s.signal.aborted||$s.delete(e)}),onContinued:()=>s.abort()}}var Je=class{constructor(){this.middleware=[],this.id=$()}use(e){return this.middleware=this.middleware.concat(e),this}replace(e){const t=[...this.middleware];return e.forEach(s=>{const i=this.middleware.findIndex(n=>n.id===s.id);i>=0?t.splice(i,1,s):t.push(s)}),this.middleware=t,this}insert({middleware:e,position:t,unique:s}){s&&e.forEach(r=>{const o=this.middleware.findIndex(l=>l.id===r.id);o>=0&&this.middleware.splice(o,1)});const i=t.after||t.before,n=this.middleware.findIndex(r=>r.id===i),a=t.after?n+1:n;return this.middleware.splice(a,0,...e),this}setOrder(e){this.middleware=e.map(t=>this.middleware.find(s=>s.id===t)).filter(Boolean)}async executeMiddlewareChain({eventName:e,initialValue:t}){let s=-1;const i=async(a,r,o)=>{if(a<=s)throw new Error("next() called multiple times");if(s=a,a===this.middleware.length||o&&["complete","discard"].includes(o))return{state:r,status:o};const c=this.middleware[a].handlers[e];return c?await c({state:r,next:g=>i(a+1,g),complete:g=>i(a+1,g,"complete"),discard:()=>i(a+1,r,"discard"),forward:()=>i(a+1,r)}):i(a+1,r,o)},n=await il(`middleware-execution-${this.id}-${e}`,async a=>{const r=await i(0,t);return a.aborted?"canceled":r});return n==="canceled"?{state:t,status:"discard"}:n}async execute({eventName:e,initialValue:t}){return await this.executeMiddlewareChain({eventName:e,initialValue:t})}},ai=/^([2-9]|10)$/,al=100,ki=e=>!e.trim(),Ne={enforce_unique_vote:()=>({max_votes_allowed:void 0}),max_votes_allowed:({data:e,value:t})=>e.enforce_unique_vote&&t?{max_votes_allowed:"Enforce unique vote is enabled"}:!t.match(/^[0-9]+$/)&&t?{max_votes_allowed:"Only numbers are allowed"}:(t==null?void 0:t.length)>1&&!t.match(ai)?{max_votes_allowed:"Type a number from 2 to 10"}:{max_votes_allowed:void 0},options:({value:e})=>{const t={},s=new Set;return e.forEach(i=>{s.has(i.text)&&i.text.length?t[i.id]="Option already exists":s.add(i.text)}),Object.keys(t).length>0?{options:t}:{options:void 0}}},ol={name:({currentError:e,value:t})=>t&&e?{name:void 0}:{name:typeof e=="string"?e:void 0}},ll={max_votes_allowed:({value:e})=>e&&!e.match(ai)?{max_votes_allowed:"Type a number from 2 to 10"}:{max_votes_allowed:void 0},name:({value:e})=>ki(e)?{name:"Question is required"}:{name:void 0},options:e=>{var i;const t=(i=Ne.options)==null?void 0:i.call(Ne,e),s=(t==null?void 0:t.options)??{};return e.value.forEach((n,a)=>{const r=a===e.value.length-1;ki(n.text)&&!r&&(s[n.id]="Option is empty")}),Object.keys(s).length>0?{options:s}:{options:void 0}}},cl=e=>!Array.isArray(e)&&typeof(e==null?void 0:e.index)=="number"&&typeof(e==null?void 0:e.text)=="string",hl={enforce_unique_vote:({value:e})=>({enforce_unique_vote:e,max_votes_allowed:""}),options:({value:e,data:t})=>{if(Array.isArray(e))return{options:e.map(c=>({id:c.id,text:c.text.trim()}))};const{index:s,text:i}=e,n=t.options||[],a=n&&n.slice(s+1).length>0&&!i,r=n.slice(0,s),o=n.slice(s+1),l=[...r,...a?[]:[{...n[s],text:i}],...o];return n.length<al&&!l.some(c=>!c.text.trim())&&l.push({id:$(),text:""}),{options:l}}},dl=({processors:e,validators:t}={})=>{const s=({state:i,validators:n,processors:a})=>{const{previousState:r,targetFields:o}=i;let l;if(!a&&cl(o.options)){const c=[...r.data.options],d=r.data.options[o.options.index];d&&(d.text=o.options.text,c.splice(o.options.index,1,d)),l={...o,options:c}}else a?l=Object.entries(o).reduce((c,[d,u])=>{const p=a[d];return c={...c,...p?p({data:r.data,value:u}):{[d]:u}},c},{}):l=o;const h=Object.keys(o).reduce((c,d)=>{const u=n[d];if(u){const p=u({currentError:r.errors[d],data:r.data,value:l[d]});c={...c,...p}}return c},{});return{newData:l,newErrors:h}};return{id:"stream-io/poll-composer-state-processing",handlers:{handleFieldChange:({state:i,next:n,forward:a})=>{if(!i.targetFields)return a();const{previousState:r,injectedFieldErrors:o}=i,{newData:l,newErrors:h}=s({processors:{...hl,...e==null?void 0:e.handleFieldChange},state:i,validators:{...Ne,...ol,...t==null?void 0:t.handleFieldChange}});return n({...i,nextState:{...r,data:{...r.data,...l},errors:{...r.errors,...h,...o}}})},handleFieldBlur:({state:i,next:n,forward:a})=>{if(!i.targetFields)return a();const{previousState:r}=i,{newData:o,newErrors:l}=s({processors:e==null?void 0:e.handleFieldBlur,state:i,validators:{...Ne,...ll,...t==null?void 0:t.handleFieldBlur}});return n({...i,nextState:{...r,data:{...r.data,...o},errors:{...r.errors,...l,...i.injectedFieldErrors}}})}}}},ul=e=>({id:"stream-io/poll-composer-composition",handlers:{compose:({discard:t,forward:s})=>e.pollComposer.canCreatePoll?s():t()}}),fl=class extends Je{constructor({composer:e}){super(),this.use([ul(e)])}},pl=class extends Je{constructor(){super(),this.use([dl()])}},gl=class extends Error{constructor(e,{code:t,status:s,response:i}){super(e),this.name="ErrorFromResponse",this.code=t,this.response=i,this.status=s}toJSON(){const e=[["status",this.status],["code",this.code]],t=[];for(const[s,i]of e)typeof i<"u"&&i!==null&&t.push(`${s}: ${i}`);return{message:`(${t.join(", ")}) - ${this.message}`,stack:this.stack,name:this.name,code:this.code,status:this.status}}},ml=(e=>(e.anonymous="anonymous",e.public="public",e))(ml||{}),yl=class{constructor({composer:e}){this.initState=()=>{this.state.next(this.initialState)},this.updateFields=async(t,s)=>{const{state:i,status:n}=await this.stateMiddlewareExecutor.execute({eventName:"handleFieldChange",initialValue:{nextState:{...this.state.getLatestValue()},previousState:{...this.state.getLatestValue()},targetFields:t,injectedFieldErrors:s}});n!=="discard"&&this.state.next(i.nextState)},this.handleFieldBlur=async t=>{const s=await this.stateMiddlewareExecutor.execute({eventName:"handleFieldBlur",initialValue:{nextState:{...this.state.getLatestValue()},previousState:{...this.state.getLatestValue()},targetFields:{[t]:this.state.getLatestValue().data[t]}}});s.status!=="discard"&&this.state.next(s.state.nextState)},this.compose=async()=>{var n;const{data:t,errors:s}=this.state.getLatestValue(),i=await this.compositionMiddlewareExecutor.execute({eventName:"compose",initialValue:{data:{...t,max_votes_allowed:t.max_votes_allowed?parseInt(t.max_votes_allowed):void 0,options:(n=t.options)==null?void 0:n.filter(a=>a.text.trim()).map(a=>({text:a.text}))},errors:s}});if(i.status!=="discard")return i.state},this.composer=e,this.state=new L(this.initialState),this.compositionMiddlewareExecutor=new fl({composer:e}),this.stateMiddlewareExecutor=new pl}get initialState(){var e;return{data:{allow_answers:!1,allow_user_suggested_options:!1,description:"",enforce_unique_vote:!0,id:$(),max_votes_allowed:"",name:"",options:[{id:$(),text:""}],user_id:(e=this.composer.client.user)==null?void 0:e.id,voting_visibility:"public"},errors:{}}}get allow_answers(){return this.state.getLatestValue().data.allow_answers}get allow_user_suggested_options(){return this.state.getLatestValue().data.allow_user_suggested_options}get description(){return this.state.getLatestValue().data.description}get enforce_unique_vote(){return this.state.getLatestValue().data.enforce_unique_vote}get id(){return this.state.getLatestValue().data.id}get max_votes_allowed(){return this.state.getLatestValue().data.max_votes_allowed}get name(){return this.state.getLatestValue().data.name}get options(){return this.state.getLatestValue().data.options}get user_id(){return this.state.getLatestValue().data.user_id}get voting_visibility(){return this.state.getLatestValue().data.voting_visibility}get canCreatePoll(){var r,o;const{data:e,errors:t}=this.state.getLatestValue(),s=e.options.filter(l=>!!l.text.trim()).length>0,i=!!e.name,n=parseInt(((o=(r=e.max_votes_allowed)==null?void 0:r.match(ai))==null?void 0:o[0])||""),a=e.max_votes_allowed===""||!!n&&(2<=n||n<=10);return s&&i&&a&&Object.values(t).filter(l=>!!l).length===0}},er=e=>{const{localMetadata:t,...s}=e;return s},_l=e=>({id:"stream-io/message-composer-middleware/attachments",handlers:{compose:({state:t,next:s,discard:i,forward:n})=>{const{attachmentManager:a}=e;if(!a)return n();if(a.uploadsInProgressCount>0)return e.client.notifications.addWarning({message:"Wait until all attachments have uploaded",origin:{emitter:"MessageComposer",context:{composer:e}}}),i();const r=(t.message.attachments??[]).concat(a.successfulUploads.map(er));return r.length?s({...t,localMessage:{...t.localMessage,attachments:r},message:{...t.message,attachments:r}}):n()}}}),wl=e=>({id:"stream-io/message-composer-middleware/draft-attachments",handlers:{compose:({state:t,next:s,forward:i})=>{const{attachmentManager:n}=e;if(!n)return i();const a=n.successfulUploads,r=a.length?(t.draft.attachments??[]).concat(a.map(er)):void 0;return s({...t,draft:{...t.draft,attachments:r}})}}}),bl=e=>({id:"stream-io/message-composer-middleware/data-cleanup",handlers:{compose:({state:t,next:s})=>{var a,r,o;const i={type:((a=e.editedMessage)==null?void 0:a.type)??"regular"},n=e.editedMessage?An(e.editedMessage):void 0;return s({...t,localMessage:P({...e.editedMessage,...t.localMessage,...i}),message:{...n,...t.message,...i},sendOptions:e.editedMessage&&((r=t.sendOptions)!=null&&r.skip_enrich_url)?{skip_enrich_url:(o=t.sendOptions)==null?void 0:o.skip_enrich_url}:t.sendOptions})}}}),vl=e=>({id:"stream-io/message-composer-middleware/custom-data",handlers:{compose:({state:t,next:s,forward:i})=>{const n=e.customDataManager.customMessageData;return n?s({...t,localMessage:{...t.localMessage,...n},message:{...t.message,...n}}):i()}}}),Cl=e=>({id:"stream-io/message-composer-middleware/draft-custom-data",handlers:{compose:({state:t,next:s,forward:i})=>{const n=e.customDataManager.customMessageData;return n?s({...t,draft:{...t.draft,...n}}):i()}}}),Sl=e=>({id:"stream-io/message-composer-middleware/data-validation",handlers:{compose:async({state:t,discard:s,forward:i})=>{var h;const{maxLengthOnSend:n}=e.config.text??{},a=t.message.text??"",r=li(a)&&!((h=t.message.attachments)!=null&&h.length)&&!t.message.poll_id,o=typeof n=="number"&&a.length>n,l=e.editedMessage&&!e.lastChangeOriginIsLocal;return r||l||o?await s():await i()}}}),Rl=e=>({id:"stream-io/message-composer-middleware/draft-data-validation",handlers:{compose:async({state:t,discard:s,forward:i})=>{var r;const n=!li(t.draft.text??"")||((r=t.draft.attachments)==null?void 0:r.length)||t.draft.poll_id||t.draft.quoted_message_id;return e.lastChangeOriginIsLocal&&n?await i():await s()}}}),El=e=>({id:"stream-io/message-composer-middleware/link-previews",handlers:{compose:({state:t,next:s,forward:i})=>{const{linkPreviewsManager:n}=e;if(!n)return i();n.cancelURLEnrichment();const a=n.loadingPreviews.length>0,r=n.dismissedPreviews.length>0,o=n.loadingPreviews.length>0?[]:n.loadedPreviews.map(d=>ri.getPreviewData(d)),l=(t.message.attachments??[]).concat(o);if(!l.length)return i();const h={...t.sendOptions};return(!a&&o.length>0||r)&&(h.skip_enrich_url=!0),s({...t,message:{...t.message,attachments:l},localMessage:{...t.localMessage,attachments:l},sendOptions:h})}}}),xl=e=>({id:"stream-io/message-composer-middleware/draft-link-previews",handlers:{compose:({state:t,next:s,forward:i})=>{const{linkPreviewsManager:n}=e;if(!n)return i();n.cancelURLEnrichment();const a=n.loadedPreviews.map(r=>ri.getPreviewData(r));return a.length?s({...t,draft:{...t.draft,attachments:(t.draft.attachments??[]).concat(a)}}):i()}}}),Ul=e=>({id:"stream-io/message-composer-middleware/text-composition",handlers:{compose:({state:t,next:s,forward:i})=>{if(!e.textComposer)return i();const{mentionedUsers:n,text:a}=e.textComposer,r=Array.from(new Set(n.filter(({id:o,name:l})=>a.includes(`@${o}`)||a.includes(`@${l}`))));return!a&&r.length===0?i():s({...t,localMessage:{...t.localMessage,mentioned_users:r,text:a},message:{...t.message,mentioned_users:r.map(o=>o.id),text:a}})}}}),Al=e=>({id:"stream-io/message-composer-middleware/draft-text-composition",handlers:{compose:({state:t,next:s,forward:i})=>{if(!e.textComposer)return i();const{maxLengthOnSend:n}=e.config.text??{},{mentionedUsers:a,text:r}=e.textComposer,o=a.length?Array.from(new Set(a.filter(({id:h,name:c})=>r.includes(`@${h}`)||r.includes(`@${c}`)))):void 0,l=typeof n=="number"&&r.length>n?r.slice(0,n):r;return s({...t,draft:{...t.draft,mentioned_users:o==null?void 0:o.map(h=>h.id),text:l}})}}}),Ml=e=>({id:"stream-io/message-composer-middleware/own-state",handlers:{compose:({state:t,next:s})=>{const i={};return e.quotedMessage&&(i.quoted_message_id=e.quotedMessage.id),e.pollId&&(i.poll_id=e.pollId),e.showReplyInChannel&&(i.show_in_channel=!0),s({...t,localMessage:{...t.localMessage,...i,quoted_message:e.quotedMessage??void 0},message:{...t.message,...i}})}}}),Ll=e=>({id:"stream-io/message-composer-middleware/draft-own-state",handlers:{compose:({state:t,next:s})=>{const i={};return e.quotedMessage&&(i.quoted_message_id=e.quotedMessage.id),e.pollId&&(i.poll_id=e.pollId),e.showReplyInChannel&&(i.show_in_channel=!0),s({...t,draft:{...t.draft,...i}})}}}),Tl=e=>({id:"stream-io/message-composer-middleware/user-data-injection",handlers:{compose:({state:t,next:s,forward:i})=>{if(!e.client.user)return i();const{channel_mutes:n,devices:a,mutes:r,...o}=e.client.user;return s({...t,localMessage:{...t.localMessage,user:o,user_id:o.id}})}}}),Il={attachments:[],mentioned_users:[],parent_id:void 0,quoted_message:void 0,text:""},Dl=e=>({id:"stream-io/message-composer-middleware/poll-only",handlers:{compose:({state:t,complete:s,forward:i})=>{const n=e.pollId,a=!!e.editedMessage,r=!!e.threadId;return!n||r||a?i():s({...t,localMessage:{...t.localMessage,...Il,poll_id:n},message:{id:t.localMessage.id,poll_id:n}})}}}),Pl=class extends Je{constructor({composer:e}){super(),this.use([Tl(e),Dl(e),Ul(e),_l(e),El(e),Ml(e),vl(e),Sl(e),bl(e)])}},Ol=class extends Je{constructor({composer:e}){super(),this.use([Al(e),wl(e),xl(e),Ll(e),Cl(e),Rl(e)])}},oi={debounceMs:300,pageSize:10},tr=class{constructor(e){this.activate=()=>{this.isActive||this.state.partialNext({isActive:!0})},this.deactivate=()=>{this.isActive&&this.state.partialNext({isActive:!1})},this.canExecuteQuery=s=>{const i=typeof s<"u",n=s??this.searchQuery;return!!(this.isActive&&!this.isLoading&&(this.hasNext||i)&&n)};const{pageSize:t}={...oi,...e};this.pageSize=t,this.state=new L(this.initialState)}get lastQueryError(){return this.state.getLatestValue().lastQueryError}get hasNext(){return this.state.getLatestValue().hasNext}get hasResults(){return Array.isArray(this.state.getLatestValue().items)}get isActive(){return this.state.getLatestValue().isActive}get isLoading(){return this.state.getLatestValue().isLoading}get initialState(){return{hasNext:!0,isActive:!1,isLoading:!1,items:void 0,lastQueryError:void 0,next:void 0,offset:0,searchQuery:""}}get items(){return this.state.getLatestValue().items}get next(){return this.state.getLatestValue().next}get offset(){return this.state.getLatestValue().offset}get searchQuery(){return this.state.getLatestValue().searchQuery}getStateBeforeFirstQuery(e){return{...this.initialState,isActive:this.isActive,isLoading:!0,searchQuery:e}}getStateAfterQuery(e,t){return{...this.state.getLatestValue(),lastQueryError:void 0,...e,isLoading:!1,items:t?e.items:[...this.items??[],...e.items||[]]}}prepareStateForQuery(e){const t=typeof e<"u",s=e??this.searchQuery;return t?this.state.next(this.getStateBeforeFirstQuery(e??"")):this.state.partialNext({isLoading:!0}),{searchString:s,hasNewSearchQuery:t}}updatePaginationStateFromQuery(e){const{items:t,next:s}=e,i={};return s||s===null?(i.next=s,i.hasNext=!!s):(i.offset=(this.offset??0)+t.length,i.hasNext=t.length===this.pageSize),i}resetState(){this.state.next(this.initialState)}resetStateAndActivate(){this.resetState(),this.activate()}},ss=class extends tr{constructor(e){const{debounceMs:t}={...oi,...e};super(e),this.setDebounceOptions=({debounceMs:s})=>{this.searchDebounced=Ve(this.executeQuery.bind(this),s)},this.search=s=>this.searchDebounced(s),this.setDebounceOptions({debounceMs:t})}async executeQuery(e){if(!this.canExecuteQuery(e))return;const{hasNewSearchQuery:t,searchString:s}=this.prepareStateForQuery(e);let i={};try{const n=await this.query(s);if(!n)return;const{items:a}=n;i=this.updatePaginationStateFromQuery(n),i.items=await this.filterQueryResults(a)}catch(n){i.lastQueryError=n}finally{this.state.next(this.getStateAfterQuery(i,t))}}cancelScheduledQuery(){this.searchDebounced.cancel()}},kl=class extends tr{constructor(e){const{debounceMs:t}={...oi,...e};super(e),this.setDebounceOptions=({debounceMs:s})=>{this.searchDebounced=Ve(this.executeQuery.bind(this),s)},this.search=s=>this.searchDebounced(s),this.setDebounceOptions({debounceMs:t})}executeQuery(e){if(!this.canExecuteQuery(e))return;const{hasNewSearchQuery:t,searchString:s}=this.prepareStateForQuery(e);let i={};try{const n=this.query(s);if(!n)return;const{items:a}=n;i=this.updatePaginationStateFromQuery(n),i.items=this.filterQueryResults(a)}catch(n){i.lastQueryError=n}finally{this.state.next(this.getStateAfterQuery(i,t))}}cancelScheduledQuery(){this.searchDebounced.cancel()}},ph=class{constructor({config:e,sources:t}={}){this.addSource=s=>{this.state.partialNext({sources:[...this.sources,s]})},this.getSource=s=>this.sources.find(i=>i.type===s),this.removeSource=s=>{const i=this.sources.filter(n=>n.type!==s);i.length!==this.sources.length&&this.state.partialNext({sources:i})},this.activateSource=s=>{const i=this.getSource(s);!i||i.isActive||(this.config.keepSingleActiveSource&&this.sources.forEach(n=>{n.type!==s&&n.deactivate()}),i.activate(),this.state.partialNext({sources:[...this.sources]}))},this.deactivateSource=s=>{const i=this.getSource(s);i!=null&&i.isActive&&this.activeSources.length!==1&&(i.deactivate(),this.state.partialNext({sources:[...this.sources]}))},this.activate=()=>{this.activeSources.length||(this.config.keepSingleActiveSource?this.sources.slice(0,1):this.sources).forEach(i=>i.activate()),!this.isActive&&this.state.partialNext({isActive:!0})},this.search=async s=>{const i=this.activeSources;this.state.partialNext({searchQuery:s}),await Promise.all(i.map(n=>n.search(s)))},this.cancelSearchQueries=()=>{this.activeSources.forEach(s=>s.cancelScheduledQuery())},this.clear=()=>{this.cancelSearchQueries(),this.sources.forEach(s=>s.state.next({...s.initialState,isActive:s.isActive})),this.state.next(s=>({...s,isActive:!0,queriesInProgress:[],searchQuery:""}))},this.exit=()=>{this.cancelSearchQueries(),this.sources.forEach(s=>s.state.next({...s.initialState,isActive:s.isActive})),this.state.next(s=>({...s,isActive:!1,queriesInProgress:[],searchQuery:""}))},this.state=new L({isActive:!1,searchQuery:"",sources:t??[]}),this._internalState=new L({}),this.config={keepSingleActiveSource:!0,...e}}get hasNext(){return this.sources.some(e=>e.hasNext)}get sources(){return this.state.getLatestValue().sources}get activeSources(){return this.state.getLatestValue().sources.filter(e=>e.isActive)}get isActive(){return this.state.getLatestValue().isActive}get searchQuery(){return this.state.getLatestValue().searchQuery}get searchSourceTypes(){return this.sources.map(e=>e.type)}},gh=class extends ss{constructor(e,t){super(t),this.type="users",this.client=e}async query(e){const t={$or:[{id:{$autocomplete:e}},{name:{$autocomplete:e}}],...this.filters},s={id:1,...this.sort},i={...this.searchOptions,limit:this.pageSize,offset:this.offset},{users:n}=await this.client.queryUsers(t,s,i);return{items:n}}filterQueryResults(e){return e.filter(t=>{var s;return t.id!==((s=this.client.user)==null?void 0:s.id)})}},mh=class extends ss{constructor(e,t){super(t),this.type="channels",this.client=e}async query(e){const t={members:{$in:[this.client.userID]},name:{$autocomplete:e},...this.filters},s=this.sort??{},i={...this.searchOptions,limit:this.pageSize,offset:this.offset};return{items:await this.client.queryChannels(t,s,i)}}filterQueryResults(e){return e}},yh=class extends ss{constructor(e,t){super(t),this.type="messages",this.client=e}async query(e){if(!this.client.userID)return{items:[]};const t={members:{$in:[this.client.userID]},...this.messageSearchChannelFilters},s={text:e,type:"regular",...this.messageSearchFilters},i={created_at:-1,...this.messageSearchSort},n={limit:this.pageSize,next:this.next,sort:i},{next:a,results:r}=await this.client.search(t,s,n),o=r.map(({message:c})=>c),l=Array.from(o.reduce((c,d)=>(d.cid&&!this.client.activeChannels[d.cid]&&c.add(d.cid),c),new Set));return l.length===0||await this.client.queryChannels({cid:{$in:l},...this.channelQueryFilters},{last_message_at:-1,...this.channelQuerySort},this.channelQueryOptions),{items:o,next:a}}filterQueryResults(e){return e}},sr=({trigger:e,text:t,isCommand:s=!1,acceptTrailingSpaces:i=!0})=>{const n=`[^\\s${e}]*`,a=t.match(new RegExp(s?`^[${e}]${n}$`:i?`(?!^|\\W)?[${e}]${n}\\s?${n}$`:`(?!^|\\W)?[${e}]${n}$`,"g"));return a&&a[a.length-1].trim()},Nl=e=>{const t=e.match(/^\/(\S+)\s+.*/);return t&&t[1]},ir=({insertText:e,selection:t,text:s,trigger:i})=>{const n=s.slice(0,t.end),a=s.slice(t.end),r=n.lastIndexOf(i);return{text:n.slice(0,r)+e+a,selection:{start:r+e.length,end:r+e.length}}};function Fl(e){return e.replace(/[-[\]{}()*+?.,/\\^$|#]/g,"\\$&")}var $l=({displayName:e,searchToken:t})=>({tokenizedDisplayName:{token:t,parts:t?e.split(new RegExp(`(${Fl(t)})`,"gi")).filter(Boolean):[e]}}),ql=class extends kl{constructor(e,t){super(t),this.type="commands",this.canExecuteQuery=s=>{const i=typeof s<"u";return this.isActive&&!this.isLoading&&(this.hasNext||i)},this.channel=e}getStateBeforeFirstQuery(e){const t=super.getStateBeforeFirstQuery(e),{items:s}=this.state.getLatestValue();return{...t,items:s}}query(e){const t=this.channel.getConfig(),i=((t==null?void 0:t.commands)||[]).filter(n=>!!(n.name&&n.name.toLowerCase().indexOf(e.toLowerCase())!==-1));return i.sort((n,a)=>{var l,h;let r=(l=n.name)==null?void 0:l.toLowerCase(),o=(h=a.name)==null?void 0:h.toLowerCase();if((r==null?void 0:r.indexOf(e))===0&&(r=`0${r}`),(o==null?void 0:o.indexOf(e))===0&&(o=`0${o}`),r!=null&&o!=null){if(r<o)return-1;if(r>o)return 1}return 0}),{items:i.map(n=>({...n,id:n.name})),next:null}}filterQueryResults(e){return e}},Bl={minChars:1,trigger:"/"},Vl=(e,t)=>{const s=He(Bl,{});let i=new ql(e);return i.activate(),{id:"stream-io/text-composer/commands-middleware",handlers:{onChange:({state:n,next:a,complete:r,forward:o})=>{var p;if(!n.selection)return o();const l=n.text.slice(0,n.selection.end),h=Nl(l);if(h){const f=i==null?void 0:i.query(h).items[0];if(f)return a({...n,command:f,suggestions:void 0})}const c=sr({trigger:s.trigger,text:l,acceptTrailingSpaces:!1,isCommand:!0});if(c&&c.length===s.minChars&&i.resetStateAndActivate(),!c||c.length<s.minChars){const f=((p=n.suggestions)==null?void 0:p.trigger)===s.trigger,g={...n};return f&&delete g.suggestions,a(g)}return r({...n,command:null,suggestions:{query:c.slice(1),searchSource:i,trigger:s.trigger}})},onSuggestionItemSelect:({state:n,next:a,forward:r})=>{var l;const{selectedSuggestion:o}=n.change??{};return!o||((l=n.suggestions)==null?void 0:l.trigger)!==s.trigger?r():(i.resetStateAndActivate(),a({...n,...ir({insertText:`/${o.name} `,selection:n.selection,text:n.text,trigger:s.trigger}),command:o,suggestions:void 0}))}}}},Ni={a:"|||||||",c:"|",e:"|||||",i:"|||||",n:"|",o:"||||||||",u:"|||||||"},ms=e=>e?Object.keys(Ni).reduce((t,s)=>t.replace(new RegExp(Ni[s],"g"),s),e):"",Fi=(e,t)=>{if(e.length===0)return t.length;if(t.length===0)return e.length;const s=[];let i;for(i=0;i<=t.length;i++)s[i]=[i];let n;for(n=0;n<=e.length;n++)s[0][n]=n;for(i=1;i<=t.length;i++)for(n=1;n<=e.length;n++)t.charAt(i-1)===e.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[t.length][e.length]},Hl=class extends ss{constructor(e,t){const{mentionAllAppUsers:s,textComposerText:i,transliterate:n,...a}=t||{};super(a),this.type="mentions",this.canExecuteQuery=r=>{const o=typeof r<"u";return this.isActive&&!this.isLoading&&(o||this.hasNext)},this.transliterate=r=>r,this.getMembersAndWatchers=()=>{const r=Object.values(this.channel.state.members??{}).map(({user:c})=>c),o=Object.values(this.channel.state.watchers??{}),l=[...r,...o],h={};return l.forEach(c=>{c&&!h[c.id]&&(h[c.id]=c)}),Object.values(h)},this.searchMembersLocally=r=>{const{textComposerText:o}=this.config;return o?this.getMembersAndWatchers().filter(l=>{if(l.id===this.client.userID)return!1;if(!r)return!0;const h=this.transliterate(ms(l.id)).toLowerCase(),c=this.transliterate(ms(l.name)).toLowerCase(),d=this.transliterate(ms(r)).toLowerCase(),u=3,p=o.slice(-4).includes("@");if(c){const g=Fi(d,c);if(c.includes(d)||g<=u&&p)return!0}const f=Fi(d,h);return h.includes(d)||f<=u&&p}).sort((l,h)=>{if(!this.memberSort)return(l.name||"").localeCompare(h.name||"");for(const[c,d]of Object.entries(this.memberSort)){const u=l[c],p=h[c];if(u!==p)return d===1?String(u||"").localeCompare(String(p||"")):String(p||"").localeCompare(String(u||""))}return 0}):[]},this.prepareQueryUsersParams=r=>({filters:{$or:[{id:{$autocomplete:r}},{name:{$autocomplete:r}}],...this.userFilters},sort:this.userSort??[{name:1},{id:1}],options:{...this.searchOptions,limit:this.pageSize,offset:this.offset}}),this.prepareQueryMembersParams=r=>{let l=[{user_id:1}];return this.memberSort?Array.isArray(this.memberSort)?l=this.memberSort[0]:Object.keys(this.memberSort).length===1&&(l=this.memberSort):l=[{user_id:1}],{filters:this.memberFilters??{name:{$autocomplete:r}},sort:l,options:{...this.searchOptions,limit:this.pageSize,offset:this.offset}}},this.queryUsers=async r=>{const{filters:o,sort:l,options:h}=this.prepareQueryUsersParams(r),{users:c}=await this.client.queryUsers(o,l,h);return c},this.queryMembers=async r=>{const{filters:o,sort:l,options:h}=this.prepareQueryMembersParams(r);return(await this.channel.queryMembers(o,l,h)).members.map(d=>d.user)},this.filterMutes=r=>{const{textComposerText:o}=this.config;if(!o)return[];const{mutedUsers:l}=this.client;return o.includes("/unmute")&&!l.length?[]:l.length?o.includes("/unmute")?r.filter(h=>l.some(c=>c.target.id===h.id)):r.filter(h=>l.every(c=>c.target.id!==h.id)):r},this.client=e.getClient(),this.channel=e,this.config={mentionAllAppUsers:s,textComposerText:i},n&&(this.transliterate=n)}get allMembersLoadedWithInitialChannelQuery(){return Object.keys(this.channel.state.members||{}).length<Ka}getStateBeforeFirstQuery(e){const t=super.getStateBeforeFirstQuery(e),{items:s}=this.state.getLatestValue();return{...t,items:s}}async query(e){let t;const s=this.allMembersLoadedWithInitialChannelQuery||!e;return this.config.mentionAllAppUsers?t=await this.queryUsers(e):s?t=this.searchMembersLocally(e):t=await this.queryMembers(e),{items:t.map(i=>({...i,...$l({displayName:i.name||i.id,searchToken:this.searchQuery})}))}}filterQueryResults(e){return this.filterMutes(e)}},jl={minChars:1,trigger:"@"},Wl=e=>{const{tokenizedDisplayName:t,...s}=e;return s},zl=(e,t)=>{const s=He(jl,{});let i;return i=new Hl(e),i.activate(),{id:"stream-io/text-composer/mentions-middleware",handlers:{onChange:({state:n,next:a,complete:r,forward:o})=>{var d;if(!n.selection)return o();const l=sr({trigger:s.trigger,text:n.text.slice(0,n.selection.end)});if(l&&l.length===s.minChars&&i.resetStateAndActivate(),!l||l.length<s.minChars){const u=((d=n.suggestions)==null?void 0:d.trigger)===s.trigger,p={...n};return u&&delete p.suggestions,a(p)}return i.config.textComposerText=n.text,r({...n,suggestions:{query:l.slice(1),searchSource:i,trigger:s.trigger}})},onSuggestionItemSelect:({state:n,complete:a,forward:r})=>{var l;const{selectedSuggestion:o}=n.change??{};return!o||((l=n.suggestions)==null?void 0:l.trigger)!==s.trigger?r():(i.resetStateAndActivate(),a({...n,...ir({insertText:`@${o.name||o.id} `,selection:n.selection,text:n.text,trigger:s.trigger}),mentionedUsers:n.mentionedUsers.concat(Wl(o)),suggestions:void 0}))}}}},Ql=e=>({id:"stream-io/text-composer/pre-validation-middleware",handlers:{onChange:({state:t,next:s,forward:i})=>{const{maxLengthOnEdit:n}=e.config.text??{};return typeof n=="number"&&t.text.length>n?(t.text=t.text.slice(0,n),s({...t,text:t.text})):i()},onSuggestionItemSelect:({forward:t})=>t()}}),Gl=class extends Je{constructor({composer:e}){super(),this.use([Ql(e),zl(e.channel),Vl(e.channel)])}async execute({eventName:e,initialValue:t}){var a;const s=await this.executeMiddlewareChain({eventName:e,initialValue:t}),{query:i,searchSource:n}=s.state.suggestions??{};return(a=n==null?void 0:n.search(i))==null||a.catch(console.error),s}},li=e=>{const t=e.trim();return t===""||t===">"||t==="``````"||t==="``"||t==="**"||t==="____"||t==="__"||t==="****"},$i=({composer:e,message:t})=>{if(!t){const i=e.config.text.defaultValue??"";return{command:null,mentionedUsers:[],text:i,selection:{start:i.length,end:i.length}}}const s=t.text??"";return{mentionedUsers:(t.mentioned_users??[]).map(i=>typeof i=="string"?{id:i}:i),text:s,selection:{start:s.length,end:s.length}}},Jl=class{constructor({composer:e,message:t}){this.initState=({message:s}={})=>{this.state.next($i({composer:this.composer,message:s}))},this.upsertMentionedUser=s=>{const i=[...this.mentionedUsers],n=i.findIndex(a=>a.id===s.id);n>=0?(i.splice(n,1,s),this.state.partialNext({mentionedUsers:i})):(i.push(s),this.state.partialNext({mentionedUsers:i}))},this.getMentionedUser=s=>this.state.getLatestValue().mentionedUsers.find(i=>i.id===s),this.removeMentionedUser=s=>{const i=this.mentionedUsers.findIndex(a=>a.id===s);if(i===-1)return;const n=[...this.mentionedUsers];n.splice(i,1),this.state.partialNext({mentionedUsers:n})},this.setCommand=s=>{var i;(s==null?void 0:s.name)!==((i=this.command)==null?void 0:i.name)&&this.state.partialNext({command:s})},this.setText=s=>{!this.enabled||s===this.text||this.state.partialNext({text:s})},this.setSelection=s=>{const i=s.start!==this.selection.start||s.end!==this.selection.end;!this.enabled||!i||this.state.partialNext({selection:s})},this.insertText=async({text:s,selection:i})=>{if(!this.enabled)return;const n=i??this.selection,{maxLengthOnEdit:a}=this.composer.config.text??{},r=this.text,o=[r.slice(0,n.start),s,r.slice(n.end)].join(""),l=o.slice(0,typeof a=="number"?a:o.length),h=r.slice(0,n.start).length+s.length,c=h>=l.length?l.length:r.slice(0,h).length;await this.handleChange({text:l,selection:{start:c,end:c}})},this.wrapSelection=({head:s="",selection:i,tail:n=""})=>{if(!this.enabled)return;const a=i??this.selection,r=this.text.slice(0,a.start),o=this.text.slice(a.start,a.end),l=this.text.slice(a.end),h={start:r.length+s.length,end:r.length+s.length+o.length};this.state.partialNext({text:[r,s,o,n,l].join(""),selection:h})},this.setSuggestions=s=>{this.state.partialNext({suggestions:s})},this.closeSuggestions=()=>{const{suggestions:s}=this.state.getLatestValue();s&&this.state.partialNext({suggestions:void 0})},this.handleChange=async({text:s,selection:i})=>{if(!this.enabled)return;const n=await this.middlewareExecutor.execute({eventName:"onChange",initialValue:{...this.state.getLatestValue(),text:s,selection:i}});n.status!=="discard"&&(this.state.next(n.state),this.config.publishTypingEvents&&s&&En(this.channel.keystroke(this.composer.threadId??void 0),"start typing event"))},this.handleSelect=async s=>{if(!this.enabled)return;const i=await this.middlewareExecutor.execute({eventName:"onSuggestionItemSelect",initialValue:{...this.state.getLatestValue(),change:{selectedSuggestion:s}}});(i==null?void 0:i.status)!=="discard"&&this.state.next(i.state)},this.composer=e,this.state=new L($i({composer:e,message:t})),this.middlewareExecutor=new Gl({composer:e})}get channel(){return this.composer.channel}get config(){return this.composer.config.text}get enabled(){return this.composer.config.text.enabled}set enabled(e){e!==this.enabled&&this.composer.updateConfig({text:{enabled:e}})}get defaultValue(){return this.composer.config.text.defaultValue}set defaultValue(e){e!==this.defaultValue&&this.composer.updateConfig({text:{defaultValue:e}})}get maxLengthOnEdit(){return this.composer.config.text.maxLengthOnEdit}set maxLengthOnEdit(e){e!==this.maxLengthOnEdit&&this.composer.updateConfig({text:{maxLengthOnEdit:e}})}get maxLengthOnSend(){return this.composer.config.text.maxLengthOnSend}set maxLengthOnSend(e){e!==this.maxLengthOnSend&&this.composer.updateConfig({text:{maxLengthOnSend:e}})}get publishTypingEvents(){return this.composer.config.text.publishTypingEvents}set publishTypingEvents(e){e!==this.publishTypingEvents&&this.composer.updateConfig({text:{publishTypingEvents:e}})}get command(){return this.state.getLatestValue().command}get mentionedUsers(){return this.state.getLatestValue().mentionedUsers}get selection(){return this.state.getLatestValue().selection}get suggestions(){return this.state.getLatestValue().suggestions}get text(){return this.state.getLatestValue().text}get textIsEmpty(){return li(this.text)}setMentionedUsers(e){this.state.partialNext({mentionedUsers:e})}clearCommand(){this.state.partialNext({command:null})}},qs=class Bs{constructor(){this.unsubscribeFunctions=new Set,this.refCount=0}get hasSubscriptions(){return this.unsubscribeFunctions.size>0}addUnsubscribeFunction(t){this.unsubscribeFunctions.add(t)}incrementRefCount(){return++this.refCount}unregisterSubscriptions(){return this.refCount>1?(this.refCount--,Bs.symbol):(this.unsubscribeFunctions.forEach(t=>t()),this.unsubscribeFunctions.clear(),this.refCount=0,Bs.symbol)}};qs.symbol=Symbol(qs.name);var be=qs,ys=50,Kl=[{created_at:-1}],Yl=1e3,Xl={active_participant_count:!0,channel:!0,channel_cid:!0,created_at:!0,created_by:!0,created_by_user_id:!0,deleted_at:!0,draft:!0,last_message_at:!0,latest_replies:!0,parent_message:!0,parent_message_id:!0,participant_count:!0,read:!0,reply_count:!0,thread_participants:!0,title:!0,updated_at:!0},qi=e=>{const t={};for(const s in e){if(Xl[s])continue;const i=s;t[i]=e[i]}return t},Fe=class extends be{constructor({client:e,threadData:t}){super(),this.failedRepliesMap=new Map,this.activate=()=>{this.state.partialNext({active:!0})},this.deactivate=()=>{this.state.partialNext({active:!1})},this.reload=async()=>{if(!this.state.getLatestValue().isLoading){this.state.partialNext({isLoading:!0});try{const n=await this.client.getThread(this.id,{watch:!0});this.hydrateState(n)}finally{this.state.partialNext({isLoading:!1})}}},this.hydrateState=n=>{if(n===this)return;if(n.id!==this.id)throw new Error("Cannot hydrate thread's state using thread with different threadId");const{createdAt:a,custom:r,title:o,deletedAt:l,parentMessage:h,participants:c,read:d,replyCount:u,replies:p,updatedAt:f}=n.state.getLatestValue(),g=Array.from(this.failedRepliesMap.values());this.state.partialNext({title:o,createdAt:a,custom:r,deletedAt:l,parentMessage:h,participants:c,read:d,replyCount:u,replies:g.length?p.concat(g):p,updatedAt:f,isStateStale:!1})},this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeThreadUpdated()),this.addUnsubscribeFunction(this.subscribeMarkActiveThreadRead()),this.addUnsubscribeFunction(this.subscribeReloadActiveStaleThread()),this.addUnsubscribeFunction(this.subscribeMarkThreadStale()),this.addUnsubscribeFunction(this.subscribeNewReplies()),this.addUnsubscribeFunction(this.subscribeRepliesRead()),this.addUnsubscribeFunction(this.subscribeMessageDeleted()),this.addUnsubscribeFunction(this.subscribeMessageUpdated()))},this.subscribeThreadUpdated=()=>this.client.on("thread.updated",n=>{if(!n.thread||n.thread.parent_message_id!==this.id)return;const a=n.thread;this.state.partialNext({title:a.title,updatedAt:new Date(a.updated_at),deletedAt:a.deleted_at?new Date(a.deleted_at):null,custom:qi(a)})}).unsubscribe,this.subscribeMarkActiveThreadRead=()=>this.state.subscribeWithSelector(n=>({active:n.active,unreadMessageCount:Bi(this.client.userID)(n)}),({active:n,unreadMessageCount:a})=>{!n||!a||this.throttledMarkAsRead()}),this.subscribeReloadActiveStaleThread=()=>this.state.subscribeWithSelector(n=>({active:n.active,isStateStale:n.isStateStale}),({active:n,isStateStale:a})=>{n&&a&&this.reload()}),this.subscribeMarkThreadStale=()=>this.client.on("user.watching.stop",n=>{var r,o;const{channel:a}=this.state.getLatestValue();!this.client.userID||this.client.userID!==((r=n.user)==null?void 0:r.id)||((o=n.channel)==null?void 0:o.cid)!==a.cid||this.state.partialNext({isStateStale:!0})}).unsubscribe,this.subscribeNewReplies=()=>this.client.on("message.new",n=>{var h,c,d;if(!this.client.userID||((h=n.message)==null?void 0:h.parent_id)!==this.id)return;const a=((c=n.message.user)==null?void 0:c.id)===this.client.userID,{active:r,read:o}=this.state.getLatestValue();this.upsertReplyLocally({message:n.message,timestampChanged:a}),r&&this.throttledMarkAsRead();const l={};for(const u of Object.keys(o)){const p=o[u];if(p){let f=p;u===((d=n.user)==null?void 0:d.id)?f={...f,lastReadAt:n.created_at?new Date(n.created_at):new Date,user:n.user,unreadMessageCount:0}:r&&u===this.client.userID||(f={...f,unreadMessageCount:p.unreadMessageCount+1}),l[u]=f}}this.state.partialNext({read:l})}).unsubscribe,this.subscribeRepliesRead=()=>this.client.on("message.read",n=>{if(!n.user||!n.created_at||!n.thread||n.thread.parent_message_id!==this.id)return;const a=n.user.id,r=n.created_at,o=n.user;this.state.next(l=>({...l,read:{...l.read,[a]:{lastReadAt:new Date(r),user:o,lastReadMessageId:n.last_read_message_id,unreadMessageCount:0}}}))}).unsubscribe,this.subscribeMessageDeleted=()=>this.client.on("message.deleted",n=>{n.message&&(n.message.parent_id===this.id&&(n.hard_delete?this.deleteReplyLocally({message:n.message}):this.upsertReplyLocally({message:n.message})),n.message.id===this.id&&this.updateParentMessageLocally({message:n.message}))}).unsubscribe,this.subscribeMessageUpdated=()=>{const a=["message.updated","reaction.new","reaction.deleted","reaction.updated"].map(r=>this.client.on(r,o=>{o.message&&this.updateParentMessageOrReplyLocally(o.message)}).unsubscribe);return()=>a.forEach(r=>r())},this.unregisterSubscriptions=()=>{const n=super.unregisterSubscriptions();return this.state.partialNext({isStateStale:!0}),n},this.deleteReplyLocally=({message:n})=>{var l;const{replies:a}=this.state.getLatestValue(),r=Mn({needle:P(n),sortedArray:a,sortDirection:"ascending",selectValueToCompare:h=>h.created_at.getTime(),selectKey:h=>h.id});if(((l=a[r])==null?void 0:l.id)!==n.id)return;const o=[...a];o.splice(r,1),this.state.partialNext({replies:o})},this.upsertReplyLocally=({message:n,timestampChanged:a=!1})=>{if(n.parent_id!==this.id)throw new Error("Reply does not belong to this thread");const r=P(n);n.status==="failed"?this.failedRepliesMap.set(r.id,r):this.failedRepliesMap.has(n.id)&&this.failedRepliesMap.delete(n.id),this.state.next(o=>({...o,replies:Ln(o.replies,r,a)}))},this.updateParentMessageLocally=({message:n})=>{if(n.id!==this.id)throw new Error("Message does not belong to this thread");this.state.next(a=>{const r=P(n);return{...a,deletedAt:r.deleted_at,parentMessage:r,replyCount:n.reply_count??a.replyCount}})},this.updateParentMessageOrReplyLocally=n=>{n.parent_id===this.id&&this.upsertReplyLocally({message:n}),!n.parent_id&&n.id===this.id&&this.updateParentMessageLocally({message:n})},this.markAsRead=async({force:n=!1}={})=>this.ownUnreadCount===0&&!n?null:await this.channel.markRead({thread_id:this.id}),this.throttledMarkAsRead=Tn(()=>this.markAsRead(),Yl,{trailing:!0}),this.queryReplies=({limit:n=ys,sort:a=Kl,...r}={})=>this.channel.getReplies(this.id,{limit:n,...r},a),this.loadNextPage=({limit:n=ys}={})=>this.loadPage(n),this.loadPrevPage=({limit:n=ys}={})=>this.loadPage(-n),this.loadPage=async n=>{var d;const{pagination:a}=this.state.getLatestValue(),[r,o,l]=n>0?["isLoadingNext","nextCursor","push"]:["isLoadingPrev","prevCursor","unshift"];if(a[r]||a[o]===null)return;const h={[n>0?"id_gt":"id_lt"]:a[o]},c=Math.abs(n);this.state.partialNext({pagination:{...a,[r]:!0}});try{const u=await this.queryReplies({...h,limit:c}),p=u.messages.map(P),f=((d=p.at(n>0?-1:0))==null?void 0:d.id)??null;this.state.next(g=>{let m=g.replies;return p.length>0&&(m=[...g.replies],m[l](...p)),{...g,replies:m,pagination:{...g.pagination,[o]:u.messages.length<c?null:f,[r]:!1}}})}catch(u){this.client.logger("error",u.message),this.state.next(p=>({...p,pagination:{...p.pagination,[r]:!1}}))}};const s=e.channel(t.channel.type,t.channel.id,{name:t.channel.name});s._hydrateMembers({members:t.channel.members??[],overrideCurrentState:!1});const i=e.userID?[{user:{id:e.userID},unread_messages:0,last_read:new Date().toISOString()}]:[];this.state=new L({active:!1,isLoading:!1,isStateStale:!1,channel:s,createdAt:new Date(t.created_at),deletedAt:t.deleted_at?new Date(t.deleted_at):null,pagination:ec(t),parentMessage:P(t.parent_message),participants:t.thread_participants,read:Zl(!t.read||t.read.length===0?i:t.read),replies:t.latest_replies.map(P),replyCount:t.reply_count??0,updatedAt:t.updated_at?new Date(t.updated_at):null,title:t.title,custom:qi(t)}),this.id=t.parent_message_id,this.client=e,this.messageComposer=new zt({client:e,composition:t.draft,compositionContext:this})}get channel(){return this.state.getLatestValue().channel}get hasStaleState(){return this.state.getLatestValue().isStateStale}get ownUnreadCount(){return Bi(this.client.userID)(this.state.getLatestValue())}},Zl=e=>e.reduce((t,s)=>(t[s.user.id]={user:s.user,lastReadMessageId:s.last_read_message_id,unreadMessageCount:s.unread_messages??0,lastReadAt:new Date(s.last_read)},t),{}),ec=e=>{var s;return{nextCursor:null,prevCursor:e.latest_replies.length===e.reply_count?null:((s=e.latest_replies.at(0))==null?void 0:s.id)??null,isLoadingNext:!1,isLoadingPrev:!1}},Bi=e=>t=>{var s;return e&&((s=t.read[e])==null?void 0:s.unreadMessageCount)||0},$e=e=>!!(e!=null&&e.message),tc=e=>{let t=null,s=new Date().getTime();return $e(e)?s=t=new Date(e.created_at).getTime():e&&On(e)&&(s=new Date(e.updated_at).getTime()),{lastChange:{draftUpdate:t,stateUpdate:s}}},Vi=e=>{if(!e)return{draftId:null,id:zt.generateId(),pollId:null,quotedMessage:null,showReplyInChannel:!1};const t=e.quoted_message;let s,i=null,n=zt.generateId();return $e(e)?(s=e.message,i=e.message.id):(s=e,n=e.id),{draftId:i,id:n,pollId:s.poll_id??null,quotedMessage:t?P(t):null,showReplyInChannel:!1}},nr=class Vs extends be{constructor({composition:t,config:s,compositionContext:i,client:n}){if(super(),this.initState=({composition:r}={})=>{this.editingAuditState.partialNext(this.initEditingAuditState(r));const o=typeof r>"u"?r:$e(r)?r.message:P(r);this.attachmentManager.initState({message:o}),this.linkPreviewsManager.initState({message:o}),this.textComposer.initState({message:o}),this.pollComposer.initState(),this.customDataManager.initState({message:o}),this.state.next(Vi(r)),r&&!$e(r)&&o&&On(o)&&(this.editedMessage=o)},this.initStateFromChannelResponse=r=>{var o;this.channel.cid===r.channel.cid&&(r.draft?this.initState({composition:r.draft}):this.state.getLatestValue().draftId&&(this.clear(),(o=this.client.offlineDb)==null||o.executeQuerySafely(l=>l.deleteDraft({cid:this.channel.cid,parent_id:void 0}),{method:"deleteDraft"})))},this.initEditingAuditState=r=>tc(r),this.registerDraftEventSubscriptions=()=>{const r=this.subscribeDraftUpdated(),o=this.subscribeDraftDeleted();return()=>{r(),o()}},this.registerSubscriptions=()=>(this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeMessageComposerSetupStateChange()),this.addUnsubscribeFunction(this.subscribeMessageUpdated()),this.addUnsubscribeFunction(this.subscribeMessageDeleted()),this.addUnsubscribeFunction(this.subscribeTextComposerStateChanged()),this.addUnsubscribeFunction(this.subscribeAttachmentManagerStateChanged()),this.addUnsubscribeFunction(this.subscribeLinkPreviewsManagerStateChanged()),this.addUnsubscribeFunction(this.subscribePollComposerStateChanged()),this.addUnsubscribeFunction(this.subscribeCustomDataManagerStateChanged()),this.addUnsubscribeFunction(this.subscribeMessageComposerStateChanged()),this.addUnsubscribeFunction(this.subscribeMessageComposerConfigStateChanged())),this.incrementRefCount(),()=>this.unregisterSubscriptions()),this.subscribeMessageUpdated=()=>{const o=["message.updated","reaction.new","reaction.deleted","reaction.updated"].map(l=>this.client.on(l,h=>{var c;h.message&&(h.message.id===this.id&&this.initState({composition:h.message}),(c=this.quotedMessage)!=null&&c.id&&h.message.id===this.quotedMessage.id&&this.setQuotedMessage(P(h.message)))}).unsubscribe);return()=>o.forEach(l=>l())},this.subscribeMessageComposerSetupStateChange=()=>{let r=null;const o=this.client._messageComposerSetupState.subscribeWithSelector(({setupFunction:l})=>({setup:l}),({setup:l})=>{r==null||r(),r=(l==null?void 0:l({composer:this}))??null});return()=>{r==null||r(),o()}},this.subscribeMessageDeleted=()=>this.client.on("message.deleted",r=>{r.message&&(r.message.id===this.id?this.clear():this.quotedMessage&&r.message.id===this.quotedMessage.id&&this.setQuotedMessage(null))}).unsubscribe,this.subscribeDraftUpdated=()=>this.client.on("draft.updated",r=>{const o=r.draft;!o||(o.parent_id??null)!==(this.threadId??null)||o.channel_cid!==this.channel.cid||this.initState({composition:o})}).unsubscribe,this.subscribeDraftDeleted=()=>this.client.on("draft.deleted",r=>{const o=r.draft;!o||(o.parent_id??null)!==(this.threadId??null)||o.channel_cid!==this.channel.cid||(this.logDraftUpdateTimestamp(),!this.compositionIsEmpty&&this.clear())}).unsubscribe,this.subscribeTextComposerStateChanged=()=>this.textComposer.state.subscribeWithSelector(({text:r})=>[r],([r],o)=>{if(!(typeof o>"u")){if(this.logStateUpdateTimestamp(),this.compositionIsEmpty){this.deleteDraft();return}this.linkPreviewsManager.enabled&&(r?this.linkPreviewsManager.findAndEnrichUrls(r):this.linkPreviewsManager.clearPreviews())}}),this.subscribeAttachmentManagerStateChanged=()=>this.attachmentManager.state.subscribe((r,o)=>{if(!(typeof o>"u")&&(this.logStateUpdateTimestamp(),this.compositionIsEmpty)){this.deleteDraft();return}}),this.subscribeLinkPreviewsManagerStateChanged=()=>this.linkPreviewsManager.state.subscribe((r,o)=>{if(!(typeof o>"u")&&(this.logStateUpdateTimestamp(),this.compositionIsEmpty)){this.deleteDraft();return}}),this.subscribePollComposerStateChanged=()=>this.pollComposer.state.subscribe((r,o)=>{if(!(typeof o>"u")&&(this.logStateUpdateTimestamp(),this.compositionIsEmpty)){this.deleteDraft();return}}),this.subscribeCustomDataManagerStateChanged=()=>this.customDataManager.state.subscribe((r,o)=>{typeof o<"u"&&!this.customDataManager.isMessageDataEqual(r,o)&&this.logStateUpdateTimestamp()}),this.subscribeMessageComposerStateChanged=()=>this.state.subscribe((r,o)=>{typeof o>"u"||(this.logStateUpdateTimestamp(),this.compositionIsEmpty&&this.deleteDraft())}),this.subscribeMessageComposerConfigStateChanged=()=>{let r;const o=this.configState.subscribeWithSelector(l=>({textDefaultValue:l.text.defaultValue,draftsEnabled:l.drafts.enabled}),({textDefaultValue:l,draftsEnabled:h})=>{this.textComposer.text===""&&l&&this.textComposer.insertText({text:l,selection:{start:0,end:0}}),h&&!r?r=this.registerDraftEventSubscriptions():!h&&r&&(r(),r=null)});return()=>{r==null||r(),o()}},this.setQuotedMessage=r=>{this.state.partialNext({quotedMessage:r})},this.toggleShowReplyInChannel=()=>{this.state.partialNext({showReplyInChannel:!this.showReplyInChannel})},this.clear=()=>{this.setQuotedMessage(null),this.initState()},this.restore=()=>{const{editedMessage:r}=this;if(r){this.initState({composition:r});return}this.clear()},this.compose=async()=>{var h;const r=((h=this.editedMessage)==null?void 0:h.created_at)??new Date,l=await this.compositionMiddlewareExecutor.execute({eventName:"compose",initialValue:{message:{id:this.id,parent_id:this.threadId??void 0,type:"regular"},localMessage:{attachments:[],created_at:r,deleted_at:null,error:void 0,id:this.id,mentioned_users:[],parent_id:this.threadId??void 0,pinned_at:null,reaction_groups:null,status:this.editedMessage?this.editedMessage.status:"sending",text:"",type:"regular",updated_at:r},sendOptions:{}}});if(l.status!=="discard")return l.state},this.composeDraft=async()=>{const{state:r,status:o}=await this.draftCompositionMiddlewareExecutor.execute({eventName:"compose",initialValue:{draft:{id:this.id,parent_id:this.threadId??void 0,text:""}}});if(o!=="discard")return r},this.createDraft=async()=>{if(this.editedMessage||!this.config.drafts.enabled)return;const r=await this.composeDraft();if(!r)return;const{draft:o}=r;if(this.state.partialNext({draftId:o.id}),this.client.offlineDb)try{const l={channel_cid:this.channel.cid,created_at:new Date().toISOString(),message:o,parent_id:o.parent_id,quoted_message:this.quotedMessage?po(this.quotedMessage):void 0};await this.client.offlineDb.upsertDraft({draft:l})}catch(l){this.client.logger("error","offlineDb:upsertDraft",{tags:["channel","offlineDb"],error:l})}this.logDraftUpdateTimestamp(),await this.channel.createDraft(o)},this.deleteDraft=async()=>{if(this.editedMessage||!this.config.drafts.enabled||!this.draftId)return;this.state.partialNext({draftId:null});const r=this.threadId??void 0;if(this.client.offlineDb)try{await this.client.offlineDb.deleteDraft({cid:this.channel.cid,parent_id:r})}catch(o){this.client.logger("error","offlineDb:deleteDraft",{tags:["channel","offlineDb"],error:o})}this.logDraftUpdateTimestamp(),await this.channel.deleteDraft({parent_id:r})},this.getDraft=async()=>{var o,l;if(this.editedMessage||!this.config.drafts.enabled||!this.client.userID)return;const r=await((o=this.client.offlineDb)==null?void 0:o.getDraft({cid:this.channel.cid,userId:this.client.userID,parent_id:this.threadId??void 0}));r&&this.initState({composition:r});try{const h=await this.channel.getDraft({parent_id:this.threadId??void 0}),{draft:c}=h;if(!c)return;(l=this.client.offlineDb)==null||l.executeQuerySafely(d=>d.upsertDraft({draft:c}),{method:"upsertDraft"}),this.initState({composition:c})}catch{this.client.notifications.add({message:"Failed to get the draft",origin:{emitter:"MessageComposer",context:{composer:this}}})}},this.createPoll=async()=>{const r=await this.pollComposer.compose();if(!(!r||!r.data.id))try{const o=await this.client.polls.createPoll(r.data);this.state.partialNext({pollId:o==null?void 0:o.id})}catch(o){throw this.client.notifications.addError({message:"Failed to create the poll",origin:{emitter:"MessageComposer",context:{composer:this}},options:{type:"api:poll:create:failed",metadata:{reason:o.message},originalError:o instanceof Error?o:void 0}}),o}},this.compositionContext=i,this.configState=new L(He(el,s??{})),i instanceof pe)this.channel=i;else if(i instanceof Fe)this.channel=i.channel;else if(i.cid){const[r,o]=i.cid.split(":");this.channel=n.channel(r,o)}else throw new Error("MessageComposer requires composition context pointing to channel (channel or context.cid)");let a;$e(t)?a=t.message:t&&(a=P(t),this.editedMessage=a),this.attachmentManager=new Oo({composer:this,message:a}),this.linkPreviewsManager=new ri({composer:this,message:a}),this.textComposer=new Jl({composer:this,message:a}),this.pollComposer=new yl({composer:this}),this.customDataManager=new tl({composer:this,message:a}),this.editingAuditState=new L(this.initEditingAuditState(t)),this.state=new L(Vi(t)),this.compositionMiddlewareExecutor=new Pl({composer:this}),this.draftCompositionMiddlewareExecutor=new Ol({composer:this})}static evaluateContextType(t){return t instanceof pe?"channel":t instanceof Fe?"thread":typeof t.legacyThreadId=="string"?"legacy_thread":"message"}static constructTag(t){return`${this.evaluateContextType(t)}_${t.id}`}get config(){return this.configState.getLatestValue()}updateConfig(t){this.configState.partialNext(He(this.config,t))}get contextType(){return Vs.evaluateContextType(this.compositionContext)}get tag(){return Vs.constructTag(this.compositionContext)}get threadId(){return this.compositionContext instanceof pe?null:this.compositionContext instanceof Fe?this.compositionContext.id:typeof this.compositionContext.legacyThreadId=="string"?this.compositionContext.legacyThreadId:typeof this.compositionContext.parent_id=="string"?this.compositionContext.parent_id:null}get client(){return this.channel.getClient()}get id(){return this.state.getLatestValue().id}get draftId(){return this.state.getLatestValue().draftId}get lastChange(){return this.editingAuditState.getLatestValue().lastChange}get quotedMessage(){return this.state.getLatestValue().quotedMessage}get pollId(){return this.state.getLatestValue().pollId}get showReplyInChannel(){return this.state.getLatestValue().showReplyInChannel}get hasSendableData(){return this.client.offlineDb?!this.compositionIsEmpty:!!(!this.attachmentManager.uploadsInProgressCount&&(!this.textComposer.textIsEmpty||this.attachmentManager.successfulUploadsCount>0)||this.pollId)}get compositionIsEmpty(){return!this.quotedMessage&&this.textComposer.textIsEmpty&&!this.attachmentManager.attachments.length&&!this.pollId}get lastChangeOriginIsLocal(){var a;const s=this.lastChange.draftUpdate===null&&!this.editedMessage,i=!!((a=this.editedMessage)!=null&&a.updated_at)&&new Date(this.editedMessage.updated_at).getTime()<this.lastChange.stateUpdate,n=!!this.lastChange.draftUpdate&&this.lastChange.draftUpdate<this.lastChange.stateUpdate;return i||n||s}logStateUpdateTimestamp(){this.editingAuditState.partialNext({lastChange:{...this.lastChange,stateUpdate:new Date().getTime()}})}logDraftUpdateTimestamp(){if(!this.config.drafts.enabled)return;const t=new Date().getTime();this.editingAuditState.partialNext({lastChange:{draftUpdate:t,stateUpdate:t}})}};nr.generateId=$;var zt=nr,pe=class{constructor(e,t,s,i){this.create=async r=>{const o={...r,watch:!1,state:!1,presence:!1};return await this.query(o,"latest")},this._callChannelListeners=r=>{const o=this,l=[];o.listeners.all&&l.push(...o.listeners.all),o.listeners[r.type]&&l.push(...o.listeners[r.type]);for(const h of l)typeof h!="string"&&h(r)},this._channelURL=()=>{if(!this.id)throw new Error("channel id is not defined");return`${this.getClient().baseURL}/channels/${encodeURIComponent(this.type)}/${encodeURIComponent(this.id)}`};const n=/^[\w_-]+$/,a=/^[\w!_-]+$/;if(!n.test(t))throw new Error(`Invalid chat type ${t}, letters, numbers and "_-" are allowed`);if(typeof s=="string"&&!a.test(s))throw new Error(`Invalid chat id ${s}, letters, numbers and "!-_" are allowed`);this._client=e,this.type=t,this.id=s,this.data=i,this._data={...i},this.cid=`${t}:${s}`,this.listeners={},this.state=new Ro(this),this.initialized=!1,this.offlineMode=!1,this.lastTypingEvent=null,this.isTyping=!1,this.disconnected=!1,this.messageComposer=new zt({client:this._client,compositionContext:this})}getClient(){if(this.disconnected===!0)throw Error("You can't use a channel after client.disconnect() was called");return this._client}getConfig(){return this.getClient().configs[this.cid]}async _sendMessage(e,t){return await this.getClient().post(this._channelURL()+"/message",{message:e,...t})}async sendMessage(e,t){try{const s=this.getClient().offlineDb;if(s){const i=e.id;if(i)return await s.queueTask({task:{channelId:this.id,channelType:this.type,messageId:i,payload:[e,t],type:"send-message"}})}}catch(s){this._client.logger("error","offlineDb:send-message",{tags:["channel","offlineDb"],error:s})}return await this._sendMessage(e,t)}sendFile(e,t,s,i){return this.getClient().sendFile(`${this._channelURL()}/file`,e,t,s,i)}sendImage(e,t,s,i){return this.getClient().sendFile(`${this._channelURL()}/image`,e,t,s,i)}deleteFile(e){return this.getClient().delete(`${this._channelURL()}/file`,{url:e})}deleteImage(e){return this.getClient().delete(`${this._channelURL()}/image`,{url:e})}async sendEvent(e){return this._checkInitialized(),await this.getClient().post(this._channelURL()+"/event",{event:e})}async search(e,t={}){if(t.offset&&t.next)throw Error("Cannot specify offset with next");const s={filter_conditions:{cid:this.cid},...t,sort:t.sort?I(t.sort):void 0};if(typeof e=="string")s.query=e;else if(typeof e=="object")s.message_filter_conditions=e;else throw Error(`Invalid type ${typeof e} for query parameter`);return await this.getClient().wsPromise,await this.getClient().get(this.getClient().baseURL+"/search",{payload:s})}async queryMembers(e,t=[],s={}){var r;let i;const n=this.type;let a;return this.id?i=this.id:(r=this.data)!=null&&r.members&&Array.isArray(this.data.members)&&(a=this.data.members),await this.getClient().get(this.getClient().baseURL+"/members",{payload:{type:n,id:i,members:a,sort:I(t),filter_conditions:e,...s}})}async updateMemberPartial(e,t){const s=new URL(`${this._channelURL()}/member`);return t!=null&&t.userId&&s.searchParams.append("user_id",t.userId),await this.getClient().patch(s.toString(),e)}async partialUpdateMember(e,t){if(!e)throw Error("Please specify the user id");return await this.getClient().patch(this._channelURL()+`/member/${encodeURIComponent(e)}`,t)}async sendReaction(e,t,s){if(!e)throw Error("Message id is missing");if(!t||Object.keys(t).length===0)throw Error("Reaction object is missing");try{const i=this.getClient().offlineDb;if(i)return await i.queueTask({task:{channelId:this.id,channelType:this.type,messageId:e,payload:[e,t,s],type:"send-reaction"}})}catch(i){this._client.logger("error","offlineDb:send-reaction",{tags:["channel","offlineDb"],error:i})}return this._sendReaction(e,t,s)}async _sendReaction(e,t,s){if(!e)throw Error("Message id is missing");if(!t||Object.keys(t).length===0)throw Error("Reaction object is missing");return await this.getClient().post(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/reaction`,{reaction:t,...s})}async deleteReaction(e,t,s){if(this._checkInitialized(),!t||!e)throw Error("Deleting a reaction requires specifying both the message and reaction type");try{const i=this.getClient().offlineDb;if(i){const n=this.state.messages.find(({id:r})=>r===e),a={created_at:"",updated_at:"",message_id:e,type:t,user_id:this.getClient().userID??s};return n&&await i.deleteReaction({message:n,reaction:a}),await i.queueTask({task:{channelId:this.id,channelType:this.type,messageId:e,payload:[e,t],type:"delete-reaction"}})}}catch(i){this._client.logger("error","offlineDb:delete-reaction",{tags:["channel","offlineDb"],error:i})}return await this._deleteReaction(e,t,s)}async _deleteReaction(e,t,s){if(this._checkInitialized(),!t||!e)throw Error("Deleting a reaction requires specifying both the message and reaction type");const i=this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/reaction/${encodeURIComponent(t)}`;return s?await this.getClient().delete(i,{user_id:s}):await this.getClient().delete(i,{})}async update(e={},t,s){return["config","cid","created_by","id","member_count","type","created_at","updated_at","last_message_at","own_capabilities"].forEach(n=>{delete e[n]}),await this._update({message:t,data:e,...s})}async updatePartial(e){var i,n;const t=await this.getClient().patch(this._channelURL(),e),s=[...t.channel.own_capabilities||[]].sort().join()!==[...Array.isArray((i=this.data)==null?void 0:i.own_capabilities)?(n=this.data)==null?void 0:n.own_capabilities:[]].sort().join();return this.data=t.channel,s&&this.getClient().dispatchEvent({type:"capabilities.changed",cid:this.cid,own_capabilities:t.channel.own_capabilities}),t}async enableSlowMode(e){const t=await this.getClient().post(this._channelURL(),{cooldown:e});return this.data=t.channel,t}async disableSlowMode(){const e=await this.getClient().post(this._channelURL(),{cooldown:0});return this.data=e.channel,e}async delete(e={}){return await this.getClient().delete(this._channelURL(),{...e})}async truncate(e={}){return await this.getClient().post(this._channelURL()+"/truncate",e)}async acceptInvite(e={}){return await this._update({accept_invite:!0,...e})}async rejectInvite(e={}){return await this._update({reject_invite:!0,...e})}async addMembers(e,t,s={}){return await this._update({add_members:e,message:t,...s})}async addModerators(e,t,s={}){return await this._update({add_moderators:e,message:t,...s})}async assignRoles(e,t,s={}){return await this._update({assign_roles:e,message:t,...s})}async inviteMembers(e,t,s={}){return await this._update({invites:e,message:t,...s})}async removeMembers(e,t,s={}){return await this._update({remove_members:e,message:t,...s})}async demoteModerators(e,t,s={}){return await this._update({demote_moderators:e,message:t,...s})}async _update(e){const t=await this.getClient().post(this._channelURL(),e);return this.data=t.channel,t}async mute(e={}){return await this.getClient().post(this.getClient().baseURL+"/moderation/mute/channel",{channel_cid:this.cid,...e})}async unmute(e={}){return await this.getClient().post(this.getClient().baseURL+"/moderation/unmute/channel",{channel_cid:this.cid,...e})}async archive(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw Error("A user_id is required for archiving a channel");return(await this.partialUpdateMember(s,{set:{archived:!0}})).channel_member}async unarchive(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw Error("A user_id is required for unarchiving a channel");return(await this.partialUpdateMember(s,{set:{archived:!1}})).channel_member}async pin(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw new Error("A user_id is required for pinning a channel");return(await this.partialUpdateMember(s,{set:{pinned:!0}})).channel_member}async unpin(e={}){const t=this.getClient(),s=e.user_id||t.userID;if(!s)throw new Error("A user_id is required for unpinning a channel");return(await this.partialUpdateMember(s,{set:{pinned:!1}})).channel_member}muteStatus(){return this._checkInitialized(),this.getClient()._muteStatus(this.cid)}sendAction(e,t){if(this._checkInitialized(),!e)throw Error("Message id is missing");return this.getClient().post(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/action`,{message_id:e,form_data:t,id:this.id,type:this.type})}async keystroke(e,t){if(!this._isTypingIndicatorsEnabled())return;const s=new Date,i=this.lastTypingEvent&&s.getTime()-this.lastTypingEvent.getTime();this.lastKeyStroke=s,this.isTyping=!0,(i===null||i>2e3)&&(this.lastTypingEvent=new Date,await this.sendEvent({type:"typing.start",parent_id:e,...t||{}}))}async updateAIState(e,t,s={}){await this.sendEvent({...s,type:"ai_indicator.update",message_id:e,ai_state:t})}async clearAIIndicator(){await this.sendEvent({type:"ai_indicator.clear"})}async stopAIResponse(){await this.sendEvent({type:"ai_indicator.stop"})}async stopTyping(e,t){this._isTypingIndicatorsEnabled()&&(this.lastTypingEvent=null,this.isTyping=!1,await this.sendEvent({type:"typing.stop",parent_id:e,...t||{}}))}_isTypingIndicatorsEnabled(){var e,t,s,i,n;return!((e=this.getConfig())!=null&&e.typing_events)||!((t=this.getClient().wsConnection)!=null&&t.isHealthy)?!1:((n=(i=(s=this.getClient().user)==null?void 0:s.privacy_settings)==null?void 0:i.typing_indicators)==null?void 0:n.enabled)??!0}lastMessage(){let e=this.state.latestMessages.length-5;e<0&&(e=0);const t=this.state.latestMessages.length+1,s=this.state.latestMessages.slice(e,t);return s.sort((i,n)=>n.created_at.getTime()-i.created_at.getTime()),s[0]}async markRead(e={}){var t;return this._checkInitialized(),!((t=this.getConfig())!=null&&t.read_events)&&!this.getClient()._isUsingServerAuth()?Promise.resolve(null):await this.getClient().post(this._channelURL()+"/read",{...e})}async markUnread(e){var t;return this._checkInitialized(),!((t=this.getConfig())!=null&&t.read_events)&&!this.getClient()._isUsingServerAuth()?Promise.resolve(null):await this.getClient().post(this._channelURL()+"/unread",{...e})}clean(){this.lastKeyStroke&&new Date().getTime()-this.lastKeyStroke.getTime()>1e3&&this.isTyping&&En(this.stopTyping(),"stop typing event"),this.state.clean()}async watch(e){const t={state:!0,watch:!0,presence:!1};await this.getClient().wsPromise,this.getClient()._hasConnectionID()||(t.watch=!1);const s={...t,...e},i=await this.query(s,"latest");return this.initialized=!0,this.data=i.channel,this._client.logger("info",`channel:watch() - started watching channel ${this.cid}`,{tags:["channel"],channel:this}),i}async stopWatching(){const e=await this.getClient().post(this._channelURL()+"/stop-watching",{});return this._client.logger("info",`channel:watch() - stopped watching channel ${this.cid}`,{tags:["channel"],channel:this}),e}async getReplies(e,t,s){const i=s?I(s):void 0,n=await this.getClient().get(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/replies`,{sort:i,...t});return n.messages&&this.state.addMessagesSorted(n.messages),n}async getPinnedMessages(e,t=[]){return await this.getClient().get(this._channelURL()+"/pinned_messages",{payload:{...e,sort:I(t)}})}getReactions(e,t){return this.getClient().get(this.getClient().baseURL+`/messages/${encodeURIComponent(e)}/reactions`,{...t})}getMessagesById(e){return this.getClient().get(this._channelURL()+"/messages",{ids:e.join(",")})}lastRead(){const{userID:e}=this.getClient();if(e)return this.state.read[e]?this.state.read[e].last_read:null}_countMessageAsUnread(e){var t,s,i,n;return!(e.shadowed||e.silent||e.parent_id&&!e.show_in_channel||((t=e.user)==null?void 0:t.id)===this.getClient().userID||(s=e.user)!=null&&s.id&&this.getClient().userMuteStatus(e.user.id)||Array.isArray((i=this.data)==null?void 0:i.own_capabilities)&&!((n=this.data)!=null&&n.own_capabilities.includes("read-events"))||this.muteStatus().muted)}countUnread(e){if(!e)return this.state.unreadCount;let t=0;for(let s=0;s<this.state.latestMessages.length;s+=1){const i=this.state.latestMessages[s];i.created_at>e&&this._countMessageAsUnread(i)&&t++}return t}countUnreadMentions(){var i;const e=this.lastRead(),t=this.getClient().userID;let s=0;for(let n=0;n<this.state.latestMessages.length;n+=1){const a=this.state.latestMessages[n];this._countMessageAsUnread(a)&&(!e||a.created_at>e)&&((i=a.mentioned_users)!=null&&i.some(r=>r.id===t))&&s++}return s}async query(e={},t="current"){var o,l,h,c,d,u,p;await this.getClient().wsPromise;const s=((o=e.created_by)==null?void 0:o.id)??e.created_by_id??((h=(l=this._data)==null?void 0:l.created_by)==null?void 0:h.id)??((c=this._data)==null?void 0:c.created_by_id);this.getClient()._isUsingServerAuth()&&typeof s!="string"&&this.getClient().logger("warn","Either `created_by` (with `id` property) or `created_by_id` are missing from both `Channel._data` and `options` parameter");let i=`${this.getClient().baseURL}/channels/${encodeURIComponent(this.type)}`;this.id&&(i+=`/${encodeURIComponent(this.id)}`);const n=await this.getClient().post(i+"/query",{data:this._data,state:!0,...e});if(!this.id){this.id=n.channel.id,this.cid=n.channel.cid;const f=Js(this.type,n.members.map(g=>{var m;return g.user_id||((m=g.user)==null?void 0:m.id)||""}));f&&f in this.getClient().activeChannels&&delete this.getClient().activeChannels[f],!(this.cid in this.getClient().activeChannels)&&this.getClient()._cacheEnabled()&&(this.getClient().activeChannels[this.cid]=this)}this.getClient()._addChannelConfig(n.channel);const{messageSet:a}=this._initializeState(n,t);a.pagination={...a.pagination,...In({parentSet:a,messagePaginationOptions:e==null?void 0:e.messages,requestedPageSize:((d=e==null?void 0:e.messages)==null?void 0:d.limit)??Qa,returnedPage:n.messages,logger:this.getClient().logger})},this.getClient().polls.hydratePollCache(n.messages,!0),this.getClient().reminders.hydrateState(n.messages),this.messageComposer.initStateFromChannelResponse(n);const r=[...n.channel.own_capabilities||[]].sort().join()!==[...this.data&&Array.isArray((u=this.data)==null?void 0:u.own_capabilities)?this.data.own_capabilities:[]].sort().join();return this.data=n.channel,this.offlineMode=!1,r&&this.getClient().dispatchEvent({type:"capabilities.changed",cid:this.cid,own_capabilities:n.channel.own_capabilities}),this.getClient().dispatchEvent({type:"channels.queried",queriedChannels:{channels:[n],isLatestMessageSet:a.isLatest}}),(p=this.getClient().offlineDb)==null||p.executeQuerySafely(f=>{var g;return(g=f.upsertChannels)==null?void 0:g.call(f,{channels:[n],isLatestMessagesSet:a.isLatest})},{method:"upsertChannels"}),n}async banUser(e,t){return this._checkInitialized(),await this.getClient().banUser(e,{...t,type:this.type,id:this.id})}async hide(e=null,t=!1){return this._checkInitialized(),await this.getClient().post(`${this._channelURL()}/hide`,{user_id:e,clear_history:t})}async show(e=null){return this._checkInitialized(),await this.getClient().post(`${this._channelURL()}/show`,{user_id:e})}async unbanUser(e){return this._checkInitialized(),await this.getClient().unbanUser(e,{type:this.type,id:this.id})}async shadowBan(e,t){return this._checkInitialized(),await this.getClient().shadowBan(e,{...t,type:this.type,id:this.id})}async removeShadowBan(e){return this._checkInitialized(),await this.getClient().removeShadowBan(e,{type:this.type,id:this.id})}async vote(e,t,s){return await this.getClient().castPollVote(e,t,s)}async removeVote(e,t,s){return await this.getClient().removePollVote(e,t,s)}async _createDraft(e){return await this.getClient().post(this._channelURL()+"/draft",{message:e})}async createDraft(e){try{const t=this.getClient().offlineDb;if(t)return await t.queueTask({task:{channelId:this.id,channelType:this.type,threadId:e.parent_id,payload:[e],type:"create-draft"}})}catch(t){this._client.logger("error","offlineDb:create-draft",{tags:["channel","offlineDb"],error:t})}return this._createDraft(e)}async _deleteDraft({parent_id:e}={}){return await this.getClient().delete(this._channelURL()+"/draft",{parent_id:e})}async deleteDraft(e={}){const{parent_id:t}=e;try{const s=this.getClient().offlineDb;if(s)return await s.queueTask({task:{channelId:this.id,channelType:this.type,threadId:t,payload:[e],type:"delete-draft"}})}catch(s){this._client.logger("error","offlineDb:delete-draft",{tags:["channel","offlineDb"],error:s})}return this._deleteDraft(e)}async getDraft({parent_id:e}={}){return await this.getClient().get(this._channelURL()+"/draft",{parent_id:e})}on(e,t){const s=t?e:"all",i=t||e;return s in this.listeners||(this.listeners[s]=[]),this._client.logger("info",`Attaching listener for ${s} event on channel ${this.cid}`,{tags:["event","channel"],channel:this}),this.listeners[s].push(i),{unsubscribe:()=>{this._client.logger("info",`Removing listener for ${s} event from channel ${this.cid}`,{tags:["event","channel"],channel:this}),this.listeners[s]=this.listeners[s].filter(n=>n!==i)}}}off(e,t){const s=t?e:"all",i=t||e;s in this.listeners||(this.listeners[s]=[]),this._client.logger("info",`Removing listener for ${s} event from channel ${this.cid}`,{tags:["event","channel"],channel:this}),this.listeners[s]=this.listeners[s].filter(n=>n!==i)}_handleChannelEvent(e){var i,n,a,r,o,l,h,c,d,u,p,f,g,m,w,b,v,C,S,U,q,Ke,Ye,oe,ve,le,Ce,ce;const t=this;this._client.logger("info",`channel:_handleChannelEvent - Received event of type { ${e.type} } on ${this.cid}`,{tags:["event","channel"],channel:this});const s=t.state;switch(e.type){case"typing.start":(i=e.user)!=null&&i.id&&(s.typing[e.user.id]=e);break;case"typing.stop":(n=e.user)!=null&&n.id&&delete s.typing[e.user.id];break;case"message.read":(a=e.user)!=null&&a.id&&e.created_at&&(s.read[e.user.id]={last_read:new Date(e.created_at),last_read_message_id:e.last_read_message_id,user:e.user,unread_messages:0},((r=e.user)==null?void 0:r.id)===((o=this.getClient().user)==null?void 0:o.id)&&(s.unreadCount=0));break;case"user.watching.start":case"user.updated":(l=e.user)!=null&&l.id&&(s.watchers[e.user.id]=e.user);break;case"user.watching.stop":(h=e.user)!=null&&h.id&&delete s.watchers[e.user.id];break;case"message.deleted":e.message&&(this._extendEventWithOwnReactions(e),e.hard_delete?s.removeMessage(e.message):s.addMessageSorted(e.message,!1,!1),s.removeQuotedMessageReferences(e.message),e.message.pinned&&s.removePinnedMessage(e.message));break;case"message.new":if(e.message){const E=((c=e.user)==null?void 0:c.id)===((d=this.getClient().user)==null?void 0:d.id),A=e.message.parent_id&&!e.message.show_in_channel;if((this.state.isUpToDate||A)&&s.addMessageSorted(e.message,E),e.message.pinned&&s.addPinnedMessage(e.message),E||A)break;if((u=e.user)!=null&&u.id)for(const Xe in s.read)Xe===e.user.id?s.read[e.user.id]={last_read:new Date(e.created_at),user:e.user,unread_messages:0}:s.read[Xe].unread_messages+=1;this._countMessageAsUnread(e.message)&&(s.unreadCount=s.unreadCount+1)}break;case"message.updated":case"message.undeleted":e.message&&(this._extendEventWithOwnReactions(e),s.addMessageSorted(e.message,!1,!1),s._updateQuotedMessageReferences({message:e.message}),e.message.pinned?s.addPinnedMessage(e.message):s.removePinnedMessage(e.message));break;case"channel.truncated":if((p=e.channel)!=null&&p.truncated_at){const E=+new Date(e.channel.truncated_at);s.messageSets.forEach((A,B)=>{A.messages.forEach(({created_at:Xe,id:hr})=>{E>+Xe&&s.removeMessage({id:hr,messageSetIndex:B})})}),s.pinnedMessages.forEach(({id:A,created_at:B})=>{E>+B&&s.removePinnedMessage({id:A})}),s.unreadCount=this.countUnread(new Date(e.channel.truncated_at))}else s.clearMessages(),s.unreadCount=0;e.message&&(s.addMessageSorted(e.message),e.message.pinned&&s.addPinnedMessage(e.message));break;case"member.added":case"member.updated":{const E={...e.member};E.pinned_at===null&&delete E.pinned_at,E.archived_at===null&&delete E.archived_at,E!=null&&E.user&&(s.members={...s.members,[E.user.id]:E},(f=t.data)!=null&&f.member_count&&e.type==="member.added"&&(t.data.member_count+=1));const A=this.getClient().userID;typeof A=="string"&&typeof((g=E==null?void 0:E.user)==null?void 0:g.id)=="string"&&E.user.id===A&&(s.membership=E);break}case"member.removed":if((m=e.user)!=null&&m.id){const E={...s.members};delete E[e.user.id],s.members=E,(w=t.data)!=null&&w.member_count&&(t.data.member_count=Math.max(t.data.member_count-1,0))}break;case"notification.mark_unread":{if(!(((b=e.user)==null?void 0:b.id)===((v=this.getClient().user)==null?void 0:v.id)&&e.user))break;const A=e.unread_messages??0;s.read[e.user.id]={first_unread_message_id:e.first_unread_message_id,last_read:new Date(e.last_read_at),last_read_message_id:e.last_read_message_id,user:e.user,unread_messages:A},s.unreadCount=A;break}case"channel.updated":if(e.channel){((C=e.channel)==null?void 0:C.frozen)!==void 0&&e.channel.frozen!==((S=t.data)==null?void 0:S.frozen)&&this.query({state:!1,messages:{limit:0},watchers:{limit:0}});const A={...e.channel,hidden:((U=e.channel)==null?void 0:U.hidden)??((q=t.data)==null?void 0:q.hidden),own_capabilities:((Ke=e.channel)==null?void 0:Ke.own_capabilities)??((Ye=t.data)==null?void 0:Ye.own_capabilities)};t.data=A}break;case"reaction.new":if(e.message&&e.reaction){const{message:E,reaction:A}=e;e.message=s.addReaction(A,E)}break;case"reaction.deleted":if(e.message&&e.reaction){const{message:E,reaction:A}=e;e.message=s.removeReaction(A,E)}break;case"reaction.updated":if(e.message&&e.reaction){const{message:E,reaction:A}=e;e.message=s.addReaction(A,E,!0)}break;case"channel.hidden":t.data={...t.data,hidden:!0},e.clear_history&&s.clearMessages();break;case"channel.visible":t.data={...t.data,hidden:!1},(oe=this.getClient().offlineDb)==null||oe.handleChannelVisibilityEvent({event:e});break;case"user.banned":if(!((ve=e.user)!=null&&ve.id))break;s.members[e.user.id]={...s.members[e.user.id]||{},shadow_banned:!!e.shadow,banned:!e.shadow,user:{...((le=s.members[e.user.id])==null?void 0:le.user)||{},...e.user}};break;case"user.unbanned":if(!((Ce=e.user)!=null&&Ce.id))break;s.members[e.user.id]={...s.members[e.user.id]||{},shadow_banned:!1,banned:!1,user:{...((ce=s.members[e.user.id])==null?void 0:ce.user)||{},...e.user}};break}e.watcher_count!==void 0&&(t.state.watcher_count=e.watcher_count)}_checkInitialized(){if(!this.initialized&&!this.offlineMode&&!this.getClient()._isUsingServerAuth())throw Error(`Channel ${this.cid} hasn't been initialized yet. Make sure to call .watch() and wait for it to resolve`)}_initializeState(e,t="latest"){const{state:s,user:i,userID:n}=this.getClient();if(e.members){this._hydrateMembers({members:e.members});for(const o of e.members)o.user&&s.updateUserReference(o.user,this.cid)}this.state.membership=e.membership||{};const a=e.messages||[];this.state.messages||this.state.initMessages();const{messageSet:r}=this.state.addMessagesSorted(a,!1,!0,!0,t);if(this.state.pinnedMessages||(this.state.pinnedMessages=[]),this.state.addPinnedMessages(e.pinned_messages||[]),e.pending_messages&&(this.state.pending_messages=e.pending_messages),e.watcher_count!==void 0&&(this.state.watcher_count=e.watcher_count),e.watchers)for(const o of e.watchers)o&&(s.updateUserReference(o,this.cid),this.state.watchers[o.id]=o);if(n!=null){const o=this.state.last_message_at||new Date;i&&(this.state.read[i.id]={user:i,last_read:o,unread_messages:0})}if(e.read)for(const o of e.read)this.state.read[o.user.id]={last_read:new Date(o.last_read),last_read_message_id:o.last_read_message_id,unread_messages:o.unread_messages??0,user:o.user},o.user.id===(i==null?void 0:i.id)&&(this.state.unreadCount=this.state.read[o.user.id].unread_messages);return{messageSet:r}}_extendEventWithOwnReactions(e){if(!e.message)return;const t=this.state.findMessage(e.message.id,e.message.parent_id);t&&(e.message.own_reactions=t.own_reactions)}_hydrateMembers({members:e,overrideCurrentState:t=!0}){const s=e.reduce((i,n)=>(n.user&&(i[n.user.id]=n),i),{});t?this.state.members=s:!t&&e.length&&(this.state.members={...this.state.members,...s})}_disconnect(){this._client.logger("info",`channel:disconnect() - Disconnecting the channel ${this.cid}`,{tags:["connection","channel"],channel:this}),this.disconnected=!0,this.state.setIsUpToDate(!1)}},Hi=class{constructor({client:e}){this.client=e,this.users={},this.userChannelReferences={}}updateUsers(e){for(const t of e)this.updateUser(t)}updateUser(e){e!=null&&this.client._cacheEnabled()&&(this.users[e.id]=e)}updateUserReference(e,t){e==null||!this.client._cacheEnabled()||(this.updateUser(e),this.userChannelReferences[e.id]||(this.userChannelReferences[e.id]={}),this.userChannelReferences[e.id][t]=!0)}deleteAllChannelReference(e){for(const t in this.userChannelReferences)delete this.userChannelReferences[t][e]}},ue=null;typeof WebSocket<"u"?ue=WebSocket:typeof MozWebSocket<"u"?ue=MozWebSocket:typeof global<"u"?ue=global.WebSocket||global.MozWebSocket:typeof window<"u"?ue=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(ue=self.WebSocket||self.MozWebSocket);var sc=ue,ic=class{constructor(){this.connectionStartTimestamp=null,this.wsTotalFailures=0,this.wsConsecutiveFailures=0,this.instanceClientId=fe()}},Le=async(e,t)=>{for(let i=0;i<3;i++){try{await Be.post(`https://chat-insights.getstream.io/insights/${e}`,t)}catch{await ee((i+1)*3e3);continue}break}};function nc(e,t){return{...t,...rr(e)}}function rr(e){var s;const{client:t}=e;return{ready_state:(s=e.ws)==null?void 0:s.readyState,url:e._buildUrl(),api_key:t.key,start_ts:t.insightMetrics.connectionStartTimestamp,end_ts:new Date().getTime(),auth_type:t.getAuthType(),token:t.tokenManager.token,user_id:t.userID,user_details:t._user,device:t.options.device,client_id:e.connectionID,ws_details:e.ws,ws_consecutive_failures:t.insightMetrics.wsConsecutiveFailures,ws_total_failures:t.insightMetrics.wsTotalFailures,request_id:e.requestID,online:typeof navigator<"u"?navigator==null?void 0:navigator.onLine:null,user_agent:typeof navigator<"u"?navigator==null?void 0:navigator.userAgent:null,instance_client_id:t.insightMetrics.instanceClientId}}function rc(e){return rr(e)}var ac=e=>e.code!==void 0,oc=e=>e.error!==void 0,lc=class{constructor({client:e}){this._buildUrl=()=>{const t=this.client._buildWSPayload(this.requestID),s=this.client.tokenManager.getToken(),i=this.client.options.wsUrlParams,n=new URLSearchParams(i);return n.set("json",t),n.set("api_key",this.client.key),n.set("authorization",`${s}`),n.set("stream-auth-type",this.client.getAuthType()),n.set("X-Stream-Client",this.client.getUserAgent()),`${this.client.wsBaseURL}/connect?${n.toString()}`},this.onlineStatusChanged=t=>{t.type==="offline"?(this._log("onlineStatusChanged() - Status changing to offline"),this._setHealth(!1)):t.type==="online"&&(this._log(`onlineStatusChanged() - Status changing to online. isHealthy: ${this.isHealthy}`),this.isHealthy||this._reconnect({interval:10}))},this.onopen=t=>{this.wsID===t&&this._log("onopen() - onopen callback",{wsID:t})},this.onmessage=(t,s)=>{var n,a;if(this.wsID!==t)return;this._log("onmessage() - onmessage callback",{event:s,wsID:t});const i=typeof s.data=="string"?JSON.parse(s.data):null;if(!this.isResolved&&i){if(this.isResolved=!0,i.error){(n=this.rejectPromise)==null||n.call(this,this._errorFromWSEvent(i,!1));return}(a=this.resolvePromise)==null||a.call(this,i),this._setHealth(!0)}this.lastEvent=new Date,i&&i.type==="health.check"&&this.scheduleNextPing(),this.client.handleEvent(s),this.scheduleConnectionCheck()},this.onclose=(t,s)=>{var i,n;if(this.wsID===t)if(this._log("onclose() - onclose callback - "+s.code,{event:s,wsID:t}),s.code===Ae.WS_CLOSED_SUCCESS){const a=new Error(`WS connection reject with error ${s.reason}`);a.reason=s.reason,a.code=s.code,a.wasClean=s.wasClean,a.target=s.target,(i=this.rejectPromise)==null||i.call(this,a),this._log(`onclose() - WS connection reject with error ${s.reason}`,{event:s})}else this.consecutiveFailures+=1,this.totalFailures+=1,this._setHealth(!1),this.isConnecting=!1,(n=this.rejectPromise)==null||n.call(this,this._errorFromWSEvent(s)),this._log("onclose() - WS connection closed. Calling reconnect ...",{event:s}),this._reconnect()},this.onerror=(t,s)=>{var i;this.wsID===t&&(this.consecutiveFailures+=1,this.totalFailures+=1,this._setHealth(!1),this.isConnecting=!1,(i=this.rejectPromise)==null||i.call(this,this._errorFromWSEvent(s)),this._log("onerror() - WS connection resulted into error",{event:s}),this._reconnect())},this._setHealth=t=>{if(t!==this.isHealthy){if(this.isHealthy=t,this.isHealthy){this.client.dispatchEvent({type:"connection.changed",online:this.isHealthy});return}setTimeout(()=>{this.isHealthy||this.client.dispatchEvent({type:"connection.changed",online:this.isHealthy})},5e3)}},this._errorFromWSEvent=(t,s=!0)=>{let i,n,a;ac(t)&&(i=t.code,n="unknown",a=t.reason),oc(t)&&(i=t.error.code,n=t.error.StatusCode,a=t.error.message),this._log(`_errorFromWSEvent() - WS failed with code ${i}`,{event:t},"warn");const r=new Error(`WS failed with code ${i} and reason - ${a}`);return r.code=i,r.StatusCode=n,r.isWSFailure=s,r},this._setupConnectionPromise=()=>{this.isResolved=!1,this.connectionOpen=new Promise((t,s)=>{this.resolvePromise=t,this.rejectPromise=s})},this.scheduleNextPing=()=>{this.healthCheckTimeoutRef&&clearTimeout(this.healthCheckTimeoutRef),this.healthCheckTimeoutRef=setTimeout(()=>{var s;const t=[{type:"health.check",client_id:this.client.clientID}];try{(s=this.ws)==null||s.send(JSON.stringify(t))}catch{}},this.pingInterval)},this.scheduleConnectionCheck=()=>{this.connectionCheckTimeoutRef&&clearTimeout(this.connectionCheckTimeoutRef),this.connectionCheckTimeoutRef=setTimeout(()=>{const t=new Date;this.lastEvent&&t.getTime()-this.lastEvent.getTime()>this.connectionCheckTimeout&&(this._log("scheduleConnectionCheck - going to reconnect"),this._setHealth(!1),this._reconnect())},this.connectionCheckTimeout)},this.client=e,this.consecutiveFailures=0,this.totalFailures=0,this.isConnecting=!1,this.isDisconnected=!1,this.isResolved=!1,this.isHealthy=!1,this.wsID=1,this.lastEvent=null,this.pingInterval=25*1e3,this.connectionCheckTimeout=this.pingInterval+10*1e3,xn(this.onlineStatusChanged)}_log(e,t={},s="info"){this.client.logger(s,"connection:"+e,{tags:["connection"],...t})}setClient(e){this.client=e}async connect(e=15e3){if(this.isConnecting)throw Error("You've called connect twice, can only attempt 1 connection at the time");this.isDisconnected=!1;try{const t=await this._connect();this.consecutiveFailures=0,this._log(`connect() - Established ws connection with healthcheck: ${t}`)}catch(t){this.isHealthy=!1,this.consecutiveFailures+=1;const s=t;if(s.code===Ae.TOKEN_EXPIRED&&!this.client.tokenManager.isStatic())this._log("connect() - WS failure due to expired token, so going to try to reload token and reconnect"),this._reconnect({refreshToken:!0});else if(!s.isWSFailure)throw new Error(JSON.stringify({code:s.code,StatusCode:s.StatusCode,message:s.message,isWSFailure:s.isWSFailure}))}return await this._waitForHealthy(e)}_waitForHealthy(e=15e3){return Promise.race([(async()=>{for(let s=0;s<=e;s+=50)try{return await this.connectionOpen}catch(i){if(s===e)throw new Error(JSON.stringify({code:i.code,StatusCode:i.StatusCode,message:i.message,isWSFailure:i.isWSFailure}));await ee(50)}})(),(async()=>{throw await ee(e),this.isConnecting=!1,new Error(JSON.stringify({code:"",StatusCode:"",message:"initial WS connection could not be established",isWSFailure:!0}))})()])}disconnect(e){this._log(`disconnect() - Closing the websocket connection for wsID ${this.wsID}`),this.wsID+=1,this.isConnecting=!1,this.isDisconnected=!0,this.healthCheckTimeoutRef&&clearInterval(this.healthCheckTimeoutRef),this.connectionCheckTimeoutRef&&clearInterval(this.connectionCheckTimeoutRef),Un(this.onlineStatusChanged),this.isHealthy=!1,this.ws&&this.ws.removeAllListeners&&this.ws.removeAllListeners();let t;const{ws:s}=this;return s&&s.close&&s.readyState===s.OPEN?(t=new Promise(i=>{const n=a=>{this._log(`disconnect() - resolving isClosedPromise ${a?"with":"without"} close frame`,{event:a}),i()};s.onclose=n,setTimeout(n,e??1e3)}),this._log("disconnect() - Manually closed connection by calling client.disconnect()"),s.close(Ae.WS_CLOSED_SUCCESS,"Manually closed connection by calling client.disconnect()")):(this._log("disconnect() - ws connection doesn't exist or it is already closed."),t=Promise.resolve()),delete this.ws,t}async _connect(){if(this.isConnecting||this.isDisconnected&&this.client.options.enableWSFallback)return;this.isConnecting=!0,this.requestID=fe(),this.client.insightMetrics.connectionStartTimestamp=new Date().getTime();let e=!1;try{this._log("_connect() - waiting for token"),await this.client.tokenManager.tokenReady(),e=!0}catch{}try{e||(this._log("_connect() - tokenProvider failed before, so going to retry"),await this.client.tokenManager.loadToken()),this._setupConnectionPromise();const t=this._buildUrl();this._log(`_connect() - Connecting to ${t}`,{wsURL:t,requestID:this.requestID}),this.ws=new sc(t),this.ws.onopen=this.onopen.bind(this,this.wsID),this.ws.onclose=this.onclose.bind(this,this.wsID),this.ws.onerror=this.onerror.bind(this,this.wsID),this.ws.onmessage=this.onmessage.bind(this,this.wsID);const s=await this.connectionOpen;if(this.isConnecting=!1,s)return this.connectionID=s.connection_id,this.client.insightMetrics.wsConsecutiveFailures>0&&this.client.options.enableInsights&&(Le("ws_success_after_failure",rc(this)),this.client.insightMetrics.wsConsecutiveFailures=0),s}catch(t){if(this.isConnecting=!1,this._log("_connect() - Error - ",t),this.client.options.enableInsights){this.client.insightMetrics.wsConsecutiveFailures++,this.client.insightMetrics.wsTotalFailures++;const s=nc(this,ho(t));Le==null||Le("ws_fatal",s)}throw t}}async _reconnect(e={}){if(this._log("_reconnect() - Initiating the reconnect"),this.isConnecting||this.isHealthy){this._log("_reconnect() - Abort (1) since already connecting or healthy");return}let t=e.interval;if(t||(t=_t(this.consecutiveFailures)),await ee(t),this.isConnecting||this.isHealthy){this._log("_reconnect() - Abort (2) since already connecting or healthy");return}if(this.isDisconnected&&this.client.options.enableWSFallback){this._log("_reconnect() - Abort (3) since disconnect() is called");return}this._log("_reconnect() - Destroying current WS connection"),this._destroyCurrentWSConnection(),e.refreshToken&&await this.client.tokenManager.loadToken();try{await this._connect(),this._log("_reconnect() - Waiting for recoverCallBack"),await this.client.recoverState(),this._log("_reconnect() - Finished recoverCallBack"),this.consecutiveFailures=0}catch(s){if(this.isHealthy=!1,this.consecutiveFailures+=1,s.code===Ae.TOKEN_EXPIRED&&!this.client.tokenManager.isStatic())return this._log("_reconnect() - WS failure due to expired token, so going to try to reload token and reconnect"),this._reconnect({refreshToken:!0});s.isWSFailure&&(this._log("_reconnect() - WS failure, so going to try to reconnect"),this._reconnect())}this._log("_reconnect() - == END ==")}_destroyCurrentWSConnection(){var e,t;this.wsID+=1;try{(e=this==null?void 0:this.ws)==null||e.removeAllListeners(),(t=this==null?void 0:this.ws)==null||t.close()}catch{}}},pt=Qe(wr()),ji=Qe(br());function ar(e,t,s={},i={}){if(typeof t!="string")throw new TypeError("userId should be a string");const n={user_id:t,...s};if(pt.default==null||pt.default.sign==null)throw Error("Unable to find jwt crypto, if you are getting this error is probably because you are trying to generate tokens on browser or React Native (or other environment where crypto functions are not available). Please Note: token should only be generated server-side.");const a=Object.assign({algorithm:"HS256",noTimestamp:!0},i);return n.iat&&(a.noTimestamp=!1),pt.default.sign(n,e,a)}function Wi(e,t={}){const s={server:!0},i=Object.assign({algorithm:"HS256",noTimestamp:!0},t);return pt.default.sign(s,e,i)}function cc(e){const t=e.split(".");if(t.length!==3)return"";const s=t[1],i=Rr(s);return JSON.parse(i).user_id}function hc(e){return["eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9",Sr(JSON.stringify({user_id:e})),"devtoken"].join(".")}function dc(e,t,s){const i=Buffer.from(t,"utf8"),n=ji.default.createHmac("sha256",i).update(e).digest("hex");try{return ji.default.timingSafeEqual(Buffer.from(n),Buffer.from(s))}catch{return!1}}var uc=class{constructor(e){this.setTokenOrProvider=async(t,s)=>{this.validateToken(t,s),this.user=s,As(t)&&(this.tokenProvider=t,this.type="provider"),typeof t=="string"&&(this.token=t,this.type="static"),!t&&this.user&&this.secret&&(this.token=ar(this.secret,s.id,{},{}),this.type="static"),await this.loadToken()},this.reset=()=>{this.token=void 0,this.tokenProvider=void 0,this.type="static",this.user=void 0,this.loadTokenPromise=null},this.validateToken=(t,s)=>{if(!(s&&s.anon&&!t)){if(!this.secret&&!t)throw new Error("User token can not be empty");if(t&&typeof t!="string"&&!As(t))throw new Error("user token should either be a string or a function");if(typeof t=="string"){if(s.anon&&t==="")return;const i=cc(t);if(t!=null&&(i==null||i===""||i!==s.id))throw new Error("userToken does not have a user_id or is not matching with user.id")}}},this.tokenReady=()=>this.loadTokenPromise,this.loadToken=()=>(this.loadTokenPromise=new Promise(async(t,s)=>{if(this.type==="static")return t(this.token);if(this.tokenProvider&&typeof this.tokenProvider!="string"){try{this.token=await this.tokenProvider()}catch(i){return s(new Error(`Call to tokenProvider failed with message: ${i}`,{cause:i}))}t(this.token)}}),this.loadTokenPromise),this.getToken=()=>{if(this.token)return this.token;if(this.user&&this.user.anon&&!this.token)return this.token;if(this.secret)return Wi(this.secret);throw new Error("Both secret and user tokens are not set. Either client.connectUser wasn't called or client.disconnect was called")},this.isStatic=()=>this.type==="static",this.loadTokenPromise=null,e&&(this.secret=e),this.type="static",this.secret&&(this.token=Wi(this.secret))}},fc={"-1":{name:"InternalSystemError",retryable:!0},2:{name:"AccessKeyError",retryable:!1},3:{name:"AuthenticationFailedError",retryable:!0},4:{name:"InputError",retryable:!1},6:{name:"DuplicateUsernameError",retryable:!1},9:{name:"RateLimitError",retryable:!0},16:{name:"DoesNotExistError",retryable:!1},17:{name:"NotAllowedError",retryable:!1},18:{name:"EventNotSupportedError",retryable:!1},19:{name:"ChannelFeatureNotSupportedError",retryable:!1},20:{name:"MessageTooLongError",retryable:!1},21:{name:"MultipleNestingLevelError",retryable:!1},22:{name:"PayloadTooBigError",retryable:!1},23:{name:"RequestTimeoutError",retryable:!0},24:{name:"MaxHeaderSizeExceededError",retryable:!1},40:{name:"AuthErrorTokenExpired",retryable:!1},41:{name:"AuthErrorTokenNotValidYet",retryable:!1},42:{name:"AuthErrorTokenUsedBeforeIssuedAt",retryable:!1},43:{name:"AuthErrorTokenSignatureInvalid",retryable:!1},44:{name:"CustomCommandEndpointMissingError",retryable:!1},45:{name:"CustomCommandEndpointCallError",retryable:!0},46:{name:"ConnectionIDNotFoundError",retryable:!1},60:{name:"CoolDownError",retryable:!0},69:{name:"ErrWrongRegion",retryable:!1},70:{name:"ErrQueryChannelPermissions",retryable:!1},71:{name:"ErrTooManyConnections",retryable:!0},99:{name:"AppSuspendedError",retryable:!1}};function pc(e){return e.code!==void 0}function zi(e){if(!e.code)return!1;const t=fc[`${e.code}`];return t?t.retryable:!1}function gc(e){return e.code===46}function mc(e){if(typeof e.isWSFailure=="boolean")return e.isWSFailure;try{return JSON.parse(e.message).isWSFailure}catch{return!1}}function yc(e){return!e.status||e.status<200||300<=e.status}var _c=class{constructor({client:e}){this._onlineStatusChanged=t=>{var s;if(this._log(`_onlineStatusChanged() - ${t.type}`),t.type==="offline"){this._setState("CLOSED"),(s=this.cancelToken)==null||s.cancel("disconnect() is called"),this.cancelToken=void 0;return}t.type==="online"&&this.state==="CLOSED"&&this.connect(!0)},this._req=async(t,s,i)=>{var n;!this.cancelToken&&!t.close&&(this.cancelToken=Be.CancelToken.source());try{const a=await this.client.doAxiosRequest("get",this.client.baseURL.replace(":3030",":8900")+"/longpoll",void 0,{config:{...s,cancelToken:(n=this.cancelToken)==null?void 0:n.token},params:t});return this.consecutiveFailures=0,a}catch(a){if(this.consecutiveFailures+=1,i&&zi(a))return this._log("_req() - Retryable error, retrying request"),await ee(_t(this.consecutiveFailures)),this._req(t,s,i);throw a}},this._poll=async()=>{var t;for(;this.state==="CONNECTED";)try{const s=await this._req({},{timeout:3e4},!0);if((t=s.events)!=null&&t.length)for(let i=0;i<s.events.length;i++)this.client.dispatchEvent(s.events[i])}catch(s){if(Be.isCancel(s)){this._log("_poll() - axios canceled request");return}if(gc(s)){this._log("_poll() - ConnectionID error, connecting without ID..."),this._setState("DISCONNECTED"),this.connect(!0);return}if(pc(s)&&!zi(s)){this._setState("CLOSED");return}await ee(_t(this.consecutiveFailures))}},this.connect=async(t=!1)=>{if(this.state==="CONNECTING"){this._log("connect() - connecting already in progress",{reconnect:t},"warn");return}if(this.state==="CONNECTED"){this._log("connect() - already connected and polling",{reconnect:t},"warn");return}this._setState("CONNECTING"),this.connectionID=void 0;try{const{event:s}=await this._req({json:this.client._buildWSPayload()},{timeout:8e3},t);return this._setState("CONNECTED"),this.connectionID=s.connection_id,this.client.dispatchEvent(s),this._poll(),t&&this.client.recoverState(),s}catch(s){throw this._setState("CLOSED"),s}},this.isHealthy=()=>!!this.connectionID&&this.state==="CONNECTED",this.disconnect=async(t=2e3)=>{var i;Un(this._onlineStatusChanged),this._setState("DISCONNECTED"),(i=this.cancelToken)==null||i.cancel("disconnect() is called"),this.cancelToken=void 0;const s=this.connectionID;this.connectionID=void 0;try{await this._req({close:!0,connection_id:s},{timeout:t},!1),this._log("disconnect() - Closed connectionID")}catch(n){this._log("disconnect() - Failed",{err:n},"error")}},this.client=e,this.state="INIT",this.consecutiveFailures=0,xn(this._onlineStatusChanged)}_log(e,t={},s="info"){this.client.logger(s,"WSConnectionFallback:"+e,{tags:["connection_fallback","connection"],...t})}_setState(e){this._log(`_setState() - ${e}`),this.state==="CONNECTING"&&e==="CONNECTED"&&this.client.dispatchEvent({type:"connection.changed",online:!0}),(e==="CLOSED"||e==="DISCONNECTED")&&this.client.dispatchEvent({type:"connection.changed",online:!1}),this.state=e}},Qi=class{constructor(e,t,s,i){this.client=e,this.type=t,this.id=s,this.data=i}create(){var t,s,i,n,a;const e={name:(t=this.data)==null?void 0:t.name,filter:(s=this.data)==null?void 0:s.filter,description:(i=this.data)==null?void 0:i.description,all_sender_channels:(n=this.data)==null?void 0:n.all_sender_channels,all_users:(a=this.data)==null?void 0:a.all_users};return this.client.createSegment(this.type,this.id,e)}verifySegmentId(){if(!this.id)throw new Error("Segment id is missing. Either create the segment using segment.create() or set the id during instantiation - const segment = client.segment(id)")}get(){return this.verifySegmentId(),this.client.getSegment(this.id)}update(e){return this.verifySegmentId(),this.client.updateSegment(this.id,e)}addTargets(e){return this.verifySegmentId(),this.client.addSegmentTargets(this.id,e)}removeTargets(e){return this.verifySegmentId(),this.client.removeSegmentTargets(this.id,e)}delete(){return this.verifySegmentId(),this.client.deleteSegment(this.id)}targetExists(e){return this.verifySegmentId(),this.client.segmentTargetExists(this.id,e)}queryTargets(e={},t=[],s={}){return this.verifySegmentId(),this.client.querySegmentTargets(this.id,e,t,s)}},at={user:"stream:user",message:"stream:chat:v1:message",userprofile:"stream:v1:user_profile"},wc=class{constructor(e){this.client=e}flagUser(e,t,s={}){return this.flag(at.user,e,"",t,s)}flagMessage(e,t,s={}){return this.flag(at.message,e,"",t,s)}async flag(e,t,s,i,n={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/flag",{entity_type:e,entity_id:t,entity_creator_id:s,reason:i,...n})}async muteUser(e,t={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/mute",{target_ids:[e],...t})}async unmuteUser(e,t){return await this.client.post(this.client.baseURL+"/api/v2/moderation/unmute",{target_ids:[e],...t})}async getUserModerationReport(e,t={}){return await this.client.get(this.client.baseURL+"/api/v2/moderation/user_report",{user_id:e,...t})}async queryReviewQueue(e={},t=[],s={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/review_queue",{filter:e,sort:I(t),...s})}async upsertConfig(e){return await this.client.post(this.client.baseURL+"/api/v2/moderation/config",e)}async getConfig(e,t){return await this.client.get(this.client.baseURL+"/api/v2/moderation/config/"+e,t)}async deleteConfig(e,t){return await this.client.delete(this.client.baseURL+"/api/v2/moderation/config/"+e,t)}async queryConfigs(e,t,s={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/configs",{filter:e,sort:t,...s})}async submitAction(e,t,s={}){return await this.client.post(this.client.baseURL+"/api/v2/moderation/submit_action",{action_type:e,item_id:t,...s})}async check(e,t,s,i,n,a){return await this.client.post(this.client.baseURL+"/api/v2/moderation/check",{entity_type:e,entity_id:t,entity_creator_id:s,moderation_payload:i,config_key:n,options:a})}async checkUserProfile(e,t){if(!t.username&&!t.image)throw new Error("Either username or image must be provided");const s={};return t.username&&(s.texts=[t.username]),t.image&&(s.images=[t.image]),await this.check(at.userprofile,e,e,s,"user_profile:default",{force_sync:!0,test_mode:!0})}async addCustomFlags(e,t,s,i,n){return await this.client.post(this.client.baseURL+"/api/v2/moderation/custom_check",{entity_type:e,entity_id:t,entity_creator_id:s,moderation_payload:i,flags:n})}async addCustomMessageFlags(e,t){return await this.addCustomFlags(at.message,e,"",{},t)}},bc=1e3,Gi=25,Ji={active:!1,isThreadOrderStale:!1,threads:[],unreadThreadCount:0,unseenThreadIds:[],lastConnectionDropAt:null,pagination:{isLoading:!1,isLoadingNext:!1,nextCursor:null},ready:!1},vc=class extends be{constructor({client:e}){super(),this.resetState=()=>{this.state.next(Ji)},this.activate=()=>{this.state.partialNext({active:!0})},this.deactivate=()=>{this.state.partialNext({active:!1})},this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeUnreadThreadsCountChange()),this.addUnsubscribeFunction(this.subscribeManageThreadSubscriptions()),this.addUnsubscribeFunction(this.subscribeReloadOnActivation()),this.addUnsubscribeFunction(this.subscribeNewReplies()),this.addUnsubscribeFunction(this.subscribeRecoverAfterConnectionDrop()),this.addUnsubscribeFunction(this.subscribeChannelDeleted()))},this.subscribeUnreadThreadsCountChange=()=>{const{unread_threads:t=0}=this.client.user??{};this.state.partialNext({unreadThreadCount:t});const s=["health.check","notification.mark_read","notification.thread_message_new","notification.channel_deleted"].map(i=>this.client.on(i,n=>{const{unread_threads:a}=n.me??n;typeof a=="number"&&this.state.partialNext({unreadThreadCount:a})}).unsubscribe);return()=>s.forEach(i=>i())},this.subscribeChannelDeleted=()=>this.client.on("notification.channel_deleted",t=>{const{cid:s}=t,{threads:i}=this.state.getLatestValue(),n=i.filter(a=>a.channel.cid!==s);this.state.partialNext({threads:n})}).unsubscribe,this.subscribeManageThreadSubscriptions=()=>this.state.subscribeWithSelector(t=>({threads:t.threads}),({threads:t},s)=>{const{threads:i=[]}=s??{},n=i.filter(a=>a!==this.threadsById[a.id]);t.forEach(a=>a.registerSubscriptions()),n.forEach(a=>a.unregisterSubscriptions())}),this.subscribeReloadOnActivation=()=>this.state.subscribeWithSelector(t=>({active:t.active}),({active:t})=>{t&&this.reload()}),this.subscribeNewReplies=()=>this.client.on("notification.thread_message_new",t=>{var a;const s=(a=t.message)==null?void 0:a.parent_id;if(!s)return;const{unseenThreadIds:i,ready:n}=this.state.getLatestValue();n&&(this.threadsById[s]?this.state.partialNext({isThreadOrderStale:!0}):i.includes(s)||this.state.partialNext({unseenThreadIds:i.concat(s)}))}).unsubscribe,this.subscribeRecoverAfterConnectionDrop=()=>{const t=this.client.on("connection.changed",n=>{n.online===!1&&this.state.next(a=>a.lastConnectionDropAt?a:{...a,lastConnectionDropAt:new Date})}).unsubscribe,s=Tn(()=>{const{lastConnectionDropAt:n}=this.state.getLatestValue();n&&this.reload({force:!0})},bc,{trailing:!0}),i=this.client.on("connection.recovered",s).unsubscribe;return()=>{t(),i()}},this.unregisterSubscriptions=()=>(this.state.getLatestValue().threads.forEach(t=>t.unregisterSubscriptions()),super.unregisterSubscriptions()),this.reload=async({force:t=!1}={})=>{const{threads:s,unseenThreadIds:i,isThreadOrderStale:n,pagination:a,ready:r}=this.state.getLatestValue();if(a.isLoading||!t&&r&&!i.length&&!n)return;const o=s.length+i.length;try{this.state.next(c=>({...c,pagination:{...c.pagination,isLoading:!0}}));const l=await this.queryThreads({limit:Math.min(o,Gi)||Gi}),h=[];for(const c of l.threads){const d=this.threadsById[c.id];d?(h.push(d),d.hasStaleState&&d.hydrateState(c)):h.push(c)}this.state.next(c=>({...c,threads:h,unseenThreadIds:[],isThreadOrderStale:!1,pagination:{...c.pagination,isLoading:!1,nextCursor:l.next??null},ready:!0}))}catch(l){this.client.logger("error",l.message),this.state.next(h=>({...h,pagination:{...h.pagination,isLoading:!1}}))}},this.queryThreads=(t={})=>this.client.queryThreads({limit:25,participant_limit:10,reply_limit:10,watch:!0,...t}),this.loadNextPage=async(t={})=>{const{pagination:s}=this.state.getLatestValue();if(!(s.isLoadingNext||!s.nextCursor))try{this.state.partialNext({pagination:{...s,isLoadingNext:!0}});const i=await this.queryThreads({...t,next:s.nextCursor});this.state.next(n=>({...n,threads:i.threads.length?n.threads.concat(i.threads):n.threads,pagination:{...n.pagination,nextCursor:i.next??null,isLoadingNext:!1}}))}catch(i){this.client.logger("error",i.message),this.state.next(n=>({...n,pagination:{...n.pagination,isLoadingNext:!1}}))}},this.client=e,this.state=new L(Ji),this.threadsByIdGetterCache={threads:[],threadsById:{}}}get threadsById(){const{threads:e}=this.state.getLatestValue();if(e===this.threadsByIdGetterCache.threads)return this.threadsByIdGetterCache.threadsById;const t=e.reduce((s,i)=>(s[i.id]=i,s),{});return this.threadsByIdGetterCache.threads=e,this.threadsByIdGetterCache.threadsById=t,t}},Cc=e=>e.type==="poll.updated",Sc=e=>e.type==="poll.closed",Rc=e=>e.type==="poll.vote_casted",Ec=e=>e.type==="poll.vote_changed",xc=e=>e.type==="poll.vote_removed",se=e=>!!(e!=null&&e.answer_text),Uc=class{constructor({client:e,poll:t}){this.getInitialStateFromPollResponse=s=>{const{own_votes:i,id:n,...a}=s,{ownAnswer:r,ownVotes:o}=(i==null?void 0:i.reduce((l,h)=>(se(h)?l.ownAnswer=h:l.ownVotes.push(h),l),{ownVotes:[]}))??{ownVotes:[]};return{...a,lastActivityAt:new Date,maxVotedOptionIds:Ue(a.vote_counts_by_option),ownAnswer:r,ownVotesByOptionId:Ac(o)}},this.upsertOfflineDb=()=>{var s;(s=this.client.offlineDb)==null||s.executeQuerySafely(i=>i.upsertPoll({poll:Lc(this)}),{method:"upsertPoll"})},this.reinitializeState=s=>{this.state.partialNext(this.getInitialStateFromPollResponse(s))},this.handlePollUpdated=s=>{var a;if((a=s.poll)!=null&&a.id&&s.poll.id!==this.id||!Cc(s))return;const{id:i,...n}=Mc(s.poll);this.state.partialNext({...n,lastActivityAt:new Date(s.created_at)}),this.upsertOfflineDb()},this.handlePollClosed=s=>{var i;(i=s.poll)!=null&&i.id&&s.poll.id!==this.id||Sc(s)&&(this.state.partialNext({is_closed:!0,lastActivityAt:new Date(s.created_at)}),this.upsertOfflineDb())},this.handleVoteCasted=s=>{var c;if((c=s.poll)!=null&&c.id&&s.poll.id!==this.id||!Rc(s))return;const i=this.data,n=s.poll_vote.user_id===this.client.userID;let a=[...i.latest_answers],r=i.ownAnswer;const o=i.ownVotesByOptionId;let l=i.maxVotedOptionIds;n&&(se(s.poll_vote)?r=s.poll_vote:s.poll_vote.option_id&&(o[s.poll_vote.option_id]=s.poll_vote)),se(s.poll_vote)?a=[s.poll_vote,...a]:l=Ue(s.poll.vote_counts_by_option);const h=_s(s.poll);this.state.partialNext({...h,latest_answers:a,lastActivityAt:new Date(s.created_at),ownAnswer:r,ownVotesByOptionId:o,maxVotedOptionIds:l}),this.upsertOfflineDb()},this.handleVoteChanged=s=>{var c;if((c=s.poll)!=null&&c.id&&s.poll.id!==this.id||!Ec(s))return;const i=this.data,n=s.poll_vote.user_id===this.client.userID;let a=[...i.latest_answers],r=i.ownAnswer,o=i.ownVotesByOptionId,l=i.maxVotedOptionIds;n?se(s.poll_vote)?(a=[s.poll_vote,...a.filter(d=>d.id!==s.poll_vote.id)],r=s.poll_vote):s.poll_vote.option_id&&(s.poll.enforce_unique_vote?o={[s.poll_vote.option_id]:s.poll_vote}:(o=Object.entries(o).reduce((d,[u,p])=>(u!==s.poll_vote.option_id&&p.id===s.poll_vote.id||(d[u]=p),d),{}),o[s.poll_vote.option_id]=s.poll_vote),(r==null?void 0:r.id)===s.poll_vote.id&&(r=void 0),l=Ue(s.poll.vote_counts_by_option)):se(s.poll_vote)?a=[s.poll_vote,...a]:l=Ue(s.poll.vote_counts_by_option);const h=_s(s.poll);this.state.partialNext({...h,latest_answers:a,lastActivityAt:new Date(s.created_at),ownAnswer:r,ownVotesByOptionId:o,maxVotedOptionIds:l}),this.upsertOfflineDb()},this.handleVoteRemoved=s=>{var c;if((c=s.poll)!=null&&c.id&&s.poll.id!==this.id||!xc(s))return;const i=this.data,n=s.poll_vote.user_id===this.client.userID;let a=[...i.latest_answers],r=i.ownAnswer;const o={...i.ownVotesByOptionId};let l=i.maxVotedOptionIds;se(s.poll_vote)?(a=a.filter(d=>d.id!==s.poll_vote.id),n&&(r=void 0)):(l=Ue(s.poll.vote_counts_by_option),n&&s.poll_vote.option_id&&delete o[s.poll_vote.option_id]);const h=_s(s.poll);this.state.partialNext({...h,latest_answers:a,lastActivityAt:new Date(s.created_at),ownAnswer:r,ownVotesByOptionId:o,maxVotedOptionIds:l}),this.upsertOfflineDb()},this.query=async s=>{const{poll:i}=await this.client.getPoll(s);return this.state.partialNext({...i,lastActivityAt:new Date}),i},this.update=async s=>await this.client.updatePoll({...s,id:this.id}),this.partialUpdate=async s=>await this.client.partialUpdatePoll(this.id,s),this.close=async()=>await this.client.closePoll(this.id),this.delete=async()=>await this.client.deletePoll(this.id),this.createOption=async s=>await this.client.createPollOption(this.id,s),this.updateOption=async s=>await this.client.updatePollOption(this.id,s),this.deleteOption=async s=>await this.client.deletePollOption(this.id,s),this.castVote=async(s,i)=>{const{max_votes_allowed:n,ownVotesByOptionId:a}=this.data;if(n&&n===Object.keys(a).length){let o=Object.values(a)[0];Object.values(a).slice(1).forEach(l=>{(!(o!=null&&o.created_at)||new Date(l.created_at)<new Date(o.created_at))&&(o=l)}),o!=null&&o.id&&await this.removeVote(o.id,i)}return await this.client.castPollVote(i,this.id,{option_id:s})},this.removeVote=async(s,i)=>await this.client.removePollVote(i,this.id,s),this.addAnswer=async(s,i)=>await this.client.addPollAnswer(i,this.id,s),this.removeAnswer=async(s,i)=>await this.client.removePollVote(i,this.id,s),this.queryAnswers=async s=>await this.client.queryPollAnswers(this.id,s.filter,s.sort,s.options),this.queryOptionVotes=async s=>await this.client.queryPollVotes(this.id,s.filter,s.sort,s.options),this.client=e,this.id=t.id,this.state=new L(this.getInitialStateFromPollResponse(t))}get data(){return this.state.getLatestValue()}};function Ue(e){let t=0,s=[];for(const[i,n]of Object.entries(e??{}))n>t?(s=[i],t=n):n===t&&s.push(i);return s}function Ac(e){return e?e.reduce((t,s)=>(se(s)||!s.option_id||(t[s.option_id]=s),t),{}):{}}function Mc(e){return{allow_answers:e.allow_answers,allow_user_suggested_options:e.allow_user_suggested_options,description:e.description,enforce_unique_vote:e.enforce_unique_vote,id:e.id,is_closed:e.is_closed,max_votes_allowed:e.max_votes_allowed,name:e.name,options:e.options,voting_visibility:e.voting_visibility}}function Lc(e){const{lastActivityAt:t,maxVotedOptionIds:s,ownVotesByOptionId:i,ownAnswer:n,...a}=e.data,r=[...Object.values(i),...n?[n]:[]].sort((o,l)=>Date.parse(o.created_at)-Date.parse(l.created_at));return{...a,own_votes:r,id:e.id}}function _s(e){return{answers_count:e.answers_count,latest_votes_by_option:e.latest_votes_by_option,vote_count:e.vote_count,vote_counts_by_option:e.vote_counts_by_option}}var Tc=class extends be{constructor({client:e}){super(),this.pollCache=new Map,this.fromState=t=>this.pollCache.get(t),this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeMessageNew()),this.addUnsubscribeFunction(this.subscribePollUpdated()),this.addUnsubscribeFunction(this.subscribePollClosed()),this.addUnsubscribeFunction(this.subscribeVoteCasted()),this.addUnsubscribeFunction(this.subscribeVoteChanged()),this.addUnsubscribeFunction(this.subscribeVoteRemoved()))},this.createPoll=async t=>{const{poll:s}=await this.client.createPoll(t);return s.vote_counts_by_option||(s.vote_counts_by_option={}),this.setOrOverwriteInCache(s),this.fromState(s.id)},this.getPoll=async t=>{const s=this.fromState(t);if(s)return this.client.getPoll(t).then(({poll:n})=>this.setOrOverwriteInCache(n,!0)),s;const{poll:i}=await this.client.getPoll(t);return this.setOrOverwriteInCache(i),this.fromState(t)},this.queryPolls=async(t,s=[],i={})=>{const{polls:n,next:a}=await this.client.queryPolls(t,s,i);return{polls:n.map(o=>(this.setOrOverwriteInCache(o,!0),this.fromState(o.id))),next:a}},this.hydratePollCache=(t,s)=>{for(const i of t){if(!i.poll)continue;const n=i.poll;this.setOrOverwriteInCache(n,s)}},this.setOrOverwriteInCache=(t,s)=>{if(!this.client._cacheEnabled())return;const i=this.fromState(t.id);if(i)s&&i.reinitializeState(t);else{const n=new Uc({client:this.client,poll:t});this.pollCache.set(n.id,n)}},this.subscribePollUpdated=()=>this.client.on("poll.updated",t=>{var s,i;(s=t.poll)!=null&&s.id&&((i=this.fromState(t.poll.id))==null||i.handlePollUpdated(t))}).unsubscribe,this.subscribePollClosed=()=>this.client.on("poll.closed",t=>{var s,i;(s=t.poll)!=null&&s.id&&((i=this.fromState(t.poll.id))==null||i.handlePollClosed(t))}).unsubscribe,this.subscribeVoteCasted=()=>this.client.on("poll.vote_casted",t=>{var s,i;(s=t.poll)!=null&&s.id&&((i=this.fromState(t.poll.id))==null||i.handleVoteCasted(t))}).unsubscribe,this.subscribeVoteChanged=()=>this.client.on("poll.vote_changed",t=>{var s,i;(s=t.poll)!=null&&s.id&&((i=this.fromState(t.poll.id))==null||i.handleVoteChanged(t))}).unsubscribe,this.subscribeVoteRemoved=()=>this.client.on("poll.vote_removed",t=>{var s,i;(s=t.poll)!=null&&s.id&&((i=this.fromState(t.poll.id))==null||i.handleVoteRemoved(t))}).unsubscribe,this.subscribeMessageNew=()=>this.client.on("message.new",t=>{const{message:s}=t;if(s){const i=P(s);this.hydratePollCache([i])}}).unsubscribe,this.client=e}get data(){return this.pollCache}},Ki={"channel.deleted":"channelDeletedHandler","channel.hidden":"channelHiddenHandler","channel.truncated":"channelTruncatedHandler","channel.updated":"channelUpdatedHandler","channel.visible":"channelVisibleHandler","message.new":"newMessageHandler","member.updated":"memberUpdatedHandler","notification.added_to_channel":"notificationAddedToChannelHandler","notification.message_new":"notificationNewMessageHandler","notification.removed_from_channel":"notificationRemovedFromChannelHandler"},Ic={abortInFlightQuery:!1,allowNotLoadedChannelPromotionForEvent:{"channel.visible":!0,"message.new":!0,"notification.added_to_channel":!0,"notification.message_new":!0},lockChannelOrder:!1},ws={limit:10,offset:0},Dc=class extends be{constructor({client:e,eventHandlerOverrides:t={},options:s={}}){super(),this.eventHandlers=new Map,this.eventHandlerOverrides=new Map,this.options={},this.stateOptions={},this.setChannels=i=>{var o;this.state.next(l=>{const{channels:h}=l,c=Bn(i)?i(h):i;return h===c?l:{...l,channels:c}});const{channels:n,pagination:{filters:a,sort:r}}=this.state.getLatestValue();(o=this.client.offlineDb)==null||o.executeQuerySafely(l=>l.upsertCidsForQuery({cids:n.map(h=>h.cid),filters:a,sort:r}),{method:"upsertCidsForQuery"})},this.setEventHandlerOverrides=(i={})=>{const n=Object.entries(i).reduce((a,[r,o])=>(o&&(a[r]=o),a),{});this.eventHandlerOverrides=new Map(Object.entries(n))},this.setOptions=(i={})=>{this.options={...Ic,...i}},this.executeChannelsQuery=async(i,n=0)=>{var d;const{filters:a,sort:r,options:o,stateOptions:l}=i,{offset:h,limit:c}={...ws,...o};try{const u=await this.client.queryChannels(a,r,o,l),p=h+((u==null?void 0:u.length)??0),f={...o,offset:p},{pagination:g}=this.state.getLatestValue();this.state.partialNext({channels:u,pagination:{...g,hasNext:((u==null?void 0:u.length)??0)>=c,isLoading:!1,options:f},initialized:!0,error:void 0}),(d=this.client.offlineDb)==null||d.executeQuerySafely(m=>m.upsertCidsForQuery({cids:u.map(w=>w.cid),filters:g.filters,sort:g.sort}),{method:"upsertCidsForQuery"})}catch(u){if(n>=Za){console.warn(u);const p=new Error(`Maximum number of retries reached in queryChannels. Last error message is: ${u}`);this.state.partialNext({error:p});return}return await ee(eo),this.executeChannelsQuery(i,n+1)}},this.queryChannels=async(i,n=[],a={},r={})=>{var d,u;const{pagination:{isLoading:o,filters:l},initialized:h}=this.state.getLatestValue();if(o&&!this.options.abortInFlightQuery&&JSON.stringify(l)===JSON.stringify(i))return;const c={filters:i,sort:n,options:a,stateOptions:r};try{if(this.stateOptions=r,this.state.next(p=>({...p,pagination:{...p.pagination,isLoading:!0,isLoadingNext:!1,filters:i,sort:n,options:a},error:void 0})),(d=this.client.offlineDb)!=null&&d.getChannelsForQuery&&((u=this.client.user)!=null&&u.id)){if(!h){const p=await this.client.offlineDb.getChannelsForQuery({userId:this.client.user.id,filters:i,sort:n});if(p){const f=this.client.hydrateActiveChannels(p,{offlineMode:!0,skipInitialization:[]});this.state.partialNext({channels:f})}}if(!this.client.offlineDb.syncManager.syncStatus){this.client.offlineDb.syncManager.scheduleSyncStatusChangeCallback(this.id,async()=>{await this.executeChannelsQuery(c)});return}}await this.executeChannelsQuery(c)}catch(p){throw this.client.logger("error",p.message),this.state.next(f=>({...f,pagination:{...f.pagination,isLoading:!1}})),p}},this.loadNext=async()=>{const{pagination:i,initialized:n}=this.state.getLatestValue(),{filters:a,sort:r,options:o,isLoadingNext:l,hasNext:h}=i;if(!(!n||l||!h))try{const{offset:c,limit:d}={...ws,...o};this.state.partialNext({pagination:{...i,isLoading:!1,isLoadingNext:!0}});const u=await this.client.queryChannels(a,r,o,this.stateOptions),{channels:p}=this.state.getLatestValue(),f=c+((u==null?void 0:u.length)??0),g={...o,offset:f};this.state.partialNext({channels:yo([...p||[],...u],"cid"),pagination:{...i,hasNext:((u==null?void 0:u.length)??0)>=d,isLoading:!1,isLoadingNext:!1,options:g}})}catch(c){throw this.client.logger("error",c.message),this.state.next(d=>({...d,pagination:{...d.pagination,isLoadingNext:!1}})),c}},this.notificationAddedToChannelHandler=async i=>{var d;const{id:n,type:a,members:r}=(i==null?void 0:i.channel)??{};if(!a||!((d=this.options.allowNotLoadedChannelPromotionForEvent)!=null&&d["notification.added_to_channel"]))return;const o=await cs({client:this.client,id:n,members:r==null?void 0:r.reduce((u,{user:p,user_id:f})=>{const g=f||(p==null?void 0:p.id);return g&&u.push(g),u},[]),type:a}),{pagination:l,channels:h}=this.state.getLatestValue();if(!h)return;const{sort:c}=l??{};this.setChannels(st({channels:h,channelToMove:o,sort:c}))},this.channelDeletedHandler=i=>{const{channels:n}=this.state.getLatestValue();if(!n)return;const a=[...n],r=a.findIndex(o=>{var l;return o.cid===(i.cid||((l=i.channel)==null?void 0:l.cid))});r<0||(a.splice(r,1),this.setChannels(a))},this.channelHiddenHandler=this.channelDeletedHandler,this.newMessageHandler=i=>{var w;const{pagination:n,channels:a}=this.state.getLatestValue();if(!a)return;const{filters:r,sort:o}=n??{},l=i.channel_type,h=i.channel_id;if(!l||!h)return;const c=this.client.channel(l,h),d=a.indexOf(c),u=d>=0,p=wt(c),f=et(c),g=tt(r),m=Ms(o);g&&f&&!r.archived||g&&!f&&r.archived||m&&p||this.options.lockChannelOrder||!u&&!((w=this.options.allowNotLoadedChannelPromotionForEvent)!=null&&w["message.new"])||this.setChannels(st({channels:a,channelToMove:c,channelToMoveIndexWithinChannels:d,sort:o}))},this.notificationNewMessageHandler=async i=>{var p;const{id:n,type:a}=(i==null?void 0:i.channel)??{};if(!n||!a)return;const r=await cs({client:this.client,id:n,type:a}),{channels:o,pagination:l}=this.state.getLatestValue(),{filters:h,sort:c}=l??{},d=tt(h),u=et(r);!o||d&&u&&!h.archived||d&&!u&&h.archived||!((p=this.options.allowNotLoadedChannelPromotionForEvent)!=null&&p["notification.message_new"])||this.setChannels(st({channels:o,channelToMove:r,sort:c}))},this.channelVisibleHandler=async i=>{var p;const{channel_type:n,channel_id:a}=i;if(!n||!a)return;const r=await cs({client:this.client,id:i.channel_id,type:i.channel_type}),{channels:o,pagination:l}=this.state.getLatestValue(),{sort:h,filters:c}=l??{},d=tt(c),u=et(r);!o||d&&u&&!c.archived||d&&!u&&c.archived||!((p=this.options.allowNotLoadedChannelPromotionForEvent)!=null&&p["channel.visible"])||this.setChannels(st({channels:o,channelToMove:r,sort:h}))},this.notificationRemovedFromChannelHandler=this.channelDeletedHandler,this.memberUpdatedHandler=i=>{var S;const{pagination:n,channels:a}=this.state.getLatestValue(),{filters:r,sort:o}=n;if(!((S=i.member)!=null&&S.user)||i.member.user.id!==this.client.userID||!i.channel_type||!i.channel_id)return;const l=i.channel_type,h=i.channel_id,c=Ms(o),d=tt(r),u=Dn({atIndex:0,sort:o,targetKey:"pinned_at"});if(!a||!c&&!d||this.options.lockChannelOrder)return;const p=this.client.channel(l,h),f=a.indexOf(p),g=f>=0,m=wt(p),w=et(p),b=[...a];if(g&&b.splice(f,1),d&&!w&&(r!=null&&r.archived)||d&&w&&!(r!=null&&r.archived)){this.setChannels(b);return}let v=null;(u===1||u===-1&&!m)&&(v=Pn({channels:b}));const C=typeof v=="number"?v+1:0;a[C]!==p&&(b.splice(C,0,p),this.setChannels(b))},this.subscriptionOrOverride=i=>{const n=Ki[i.type],a=this.eventHandlers.get(n),r=this.eventHandlerOverrides.get(n);if(r&&typeof r=="function"){r(this.setChannels,i);return}a&&typeof a=="function"&&a(i)},this.registerSubscriptions=()=>{if(!this.hasSubscriptions)for(const i of Object.keys(Ki))this.addUnsubscribeFunction(this.client.on(i,this.subscriptionOrOverride).unsubscribe)},this.id=`channel-manager-${$()}`,this.client=e,this.state=new L({channels:[],pagination:{isLoading:!1,isLoadingNext:!1,hasNext:!1,filters:{},sort:{},options:ws},initialized:!1,error:void 0}),this.setEventHandlerOverrides(t),this.setOptions(s),this.eventHandlers=new Map(Object.entries({channelDeletedHandler:this.channelDeletedHandler,channelHiddenHandler:this.channelHiddenHandler,channelVisibleHandler:this.channelVisibleHandler,memberUpdatedHandler:this.memberUpdatedHandler,newMessageHandler:this.newMessageHandler,notificationAddedToChannelHandler:this.notificationAddedToChannelHandler,notificationNewMessageHandler:this.notificationNewMessageHandler,notificationRemovedFromChannelHandler:this.notificationRemovedFromChannelHandler}))}},ot=3e3,Pc={durations:{error:ot,info:ot,success:ot,warning:ot}},Oc=class{constructor(e={}){this.timeouts=new Map,this.store=new L({notifications:[]}),this.config=He(Pc,e)}get notifications(){return this.store.getLatestValue().notifications}get warning(){return this.notifications.filter(e=>e.severity==="warning")}get error(){return this.notifications.filter(e=>e.severity==="error")}get info(){return this.notifications.filter(e=>e.severity==="info")}get success(){return this.notifications.filter(e=>e.severity==="success")}add({message:e,origin:t,options:s={}}){const i=$(),n=Date.now(),a=s.severity||"info",r=s.duration??this.config.durations[a],o={id:i,message:e,origin:t,type:s==null?void 0:s.type,severity:a,createdAt:n,expiresAt:n+r,actions:s.actions,metadata:s.metadata,originalError:s.originalError};if(this.store.partialNext({notifications:[...this.store.getLatestValue().notifications,o]}),o.expiresAt){const l=setTimeout(()=>{this.remove(i)},s.duration||this.config.durations[o.severity]);this.timeouts.set(i,l)}return i}addError({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"error"}})}addWarning({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"warning"}})}addInfo({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"info"}})}addSuccess({message:e,origin:t,options:s}){return this.add({message:e,origin:t,options:{...s,severity:"success"}})}remove(e){const t=this.timeouts.get(e);t&&(clearTimeout(t),this.timeouts.delete(e)),this.store.partialNext({notifications:this.store.getLatestValue().notifications.filter(s=>s.id!==e)})}clear(){this.timeouts.forEach(e=>clearTimeout(e)),this.timeouts.clear(),this.store.partialNext({notifications:[]})}},Qt=60*1e3,ci=60*Qt,hi=24*ci,kc=7*hi,bs={minute:{lower:Qt,upper:ci},hour:{upper:hi}},or=2*kc,Nc=class{constructor({reminder:e,config:t}){this.timeout=null,this.stopRefreshBoundaryMs=or,this.getRefreshIntervalLength=()=>{if(!this.reminder.remindAt)return null;const s=Math.abs(Gt(this.reminder.remindAt.getTime()));let i;return s===0?i=Qt:s<bs.minute.lower?i=s:s<=bs.minute.upper?i=Qt:s<=bs.hour.upper?i=ci:i=hi,i},this.init=()=>{var a;if(!this.reminder.remindAt)return null;const s=this.getRefreshIntervalLength();if(s===null)return null;if(((a=this.reminder.remindAt)==null?void 0:a.getTime())+this.stopRefreshBoundaryMs-Date.now()<=0){this.timeout=null;return}this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.reminder.refreshTimeLeft(),this.init()},s)},this.clear=()=>{this.timeout&&(clearInterval(this.timeout),this.timeout=null)},this.reminder=e,typeof(t==null?void 0:t.stopRefreshBoundaryMs)=="number"&&(this.stopRefreshBoundaryMs=t.stopRefreshBoundaryMs)}},Gt=e=>e-new Date().getTime(),lr=class Hs{constructor({data:t,config:s}){this.setState=i=>{this.state.next(n=>{const a={...n,...Hs.toStateValue(i)};return a.remind_at&&(a.timeLeftMs=Gt(a.remind_at.getTime())),a}),i.remind_at?this.initTimer():i.remind_at||this.clearTimer()},this.refreshTimeLeft=()=>{this.remindAt&&this.state.partialNext({timeLeftMs:Gt(this.remindAt.getTime())})},this.initTimer=()=>{this.timer.init()},this.clearTimer=()=>{this.timer.clear()},this.state=new L(Hs.toStateValue(t)),this.timer=new Nc({reminder:this,config:s}),this.initTimer()}get id(){return this.state.getLatestValue().message_id}get remindAt(){return this.state.getLatestValue().remind_at}get timeLeftMs(){return this.state.getLatestValue().timeLeftMs}};lr.toStateValue=e=>({...e,created_at:new Date(e.created_at),message:e.message||null,remind_at:e.remind_at?new Date(e.remind_at):null,timeLeftMs:e.remind_at?Gt(new Date(e.remind_at).getTime()):null,updated_at:new Date(e.updated_at),user:e.user||null});var Fc=lr,$c={debounceMs:300,pageSize:10},qc=class{constructor(e){this._isCursorPagination=!1,this.setDebounceOptions=({debounceMs:i})=>{this._executeQueryDebounced=Ve(this.executeQuery.bind(this),i)},this.canExecuteQuery=i=>!this.isLoading&&i==="next"&&this.hasNext||i==="prev"&&this.hasPrev,this.next=()=>this.executeQuery({direction:"next"}),this.prev=()=>this.executeQuery({direction:"prev"}),this.nextDebounced=()=>{this._executeQueryDebounced({direction:"next"})},this.prevDebounced=()=>{this._executeQueryDebounced({direction:"prev"})};const{debounceMs:t,pageSize:s}={...$c,...e};this.pageSize=s,this.state=new L(this.initialState),this.setDebounceOptions({debounceMs:t})}get lastQueryError(){return this.state.getLatestValue().lastQueryError}get hasNext(){return this.state.getLatestValue().hasNext}get hasPrev(){return this.state.getLatestValue().hasPrev}get hasResults(){return Array.isArray(this.state.getLatestValue().items)}get isLoading(){return this.state.getLatestValue().isLoading}get initialState(){return{hasNext:!0,hasPrev:!0,isLoading:!1,items:void 0,lastQueryError:void 0,cursor:void 0,offset:0}}get items(){return this.state.getLatestValue().items}get cursor(){return this.state.getLatestValue().cursor}get offset(){return this.state.getLatestValue().offset}getStateBeforeFirstQuery(){return{...this.initialState,isLoading:!0}}getStateAfterQuery(e,t){return{...this.state.getLatestValue(),lastQueryError:void 0,...e,isLoading:!1,items:t?e.items:[...this.items??[],...e.items||[]]}}async executeQuery({direction:e}){if(!this.canExecuteQuery(e))return;const t=typeof this.items>"u";t?this.state.next(this.getStateBeforeFirstQuery()):this.state.partialNext({isLoading:!0});const s={};try{const i=await this.query({direction:e});if(!i)return;const{items:n,next:a,prev:r}=i;t&&(a||r)&&(this._isCursorPagination=!0),this._isCursorPagination?(s.cursor={next:a||null,prev:r||null},s.hasNext=!!a,s.hasPrev=!!r):(s.offset=(this.offset??0)+n.length,s.hasNext=n.length===this.pageSize),s.items=await this.filterQueryResults(n)}catch(i){s.lastQueryError=i}finally{this.state.next(this.getStateAfterQuery(s,t))}}cancelScheduledQuery(){this._executeQueryDebounced.cancel()}resetState(){this.state.next(this.initialState)}},Bc=class extends qc{constructor(e,t){super(t),this.query=async({direction:s})=>{var o;const i=(o=this.cursor)==null?void 0:o[s],{reminders:n,next:a,prev:r}=await this.client.queryReminders({filter:this.filters,sort:this.sort,limit:this.pageSize,[s]:i});return{items:n,next:a,prev:r}},this.filterQueryResults=s=>s,this.client=e}get filters(){return this._filters}get sort(){return this._sort}set filters(e){this._filters=e,this.resetState()}set sort(e){this._sort=e,this.resetState()}},js=60*1e3,gt=60*js,Vc=24*gt,Yi={scheduledOffsetsMs:[2*js,30*js,gt,2*gt,8*gt,Vc],stopTimerRefreshBoundaryMs:or},Hc=e=>e.message.match("already has reminder created for this message_id"),jc=e=>e.message.match("reminder does not exist"),cr=class mt extends be{constructor({client:t,config:s}){super(),this.upsertToState=({data:i,overwrite:n=!0})=>{if(!this.client._cacheEnabled())return;const a=this.getFromState(i.message_id);if(a)n&&a.setState(i);else{const r=new Fc({data:i,config:{stopRefreshBoundaryMs:this.stopTimerRefreshBoundaryMs}});this.state.partialNext({reminders:new Map(this.reminders.set(i.message_id,r))})}return a},this.removeFromState=i=>{const n=this.getFromState(i);if(!n)return;n.clearTimer();const a=this.reminders;a.delete(i),this.state.partialNext({reminders:new Map(a)})},this.hydrateState=i=>{i.forEach(({reminder:n})=>{n&&this.upsertToState({data:n})})},this.initTimers=()=>{this.reminders.forEach(i=>i.initTimer())},this.clearTimers=()=>{this.reminders.forEach(i=>i.clearTimer())},this.registerSubscriptions=()=>{this.hasSubscriptions||(this.addUnsubscribeFunction(this.subscribeReminderCreated()),this.addUnsubscribeFunction(this.subscribeReminderUpdated()),this.addUnsubscribeFunction(this.subscribeReminderDeleted()),this.addUnsubscribeFunction(this.subscribeNotificationReminderDue()),this.addUnsubscribeFunction(this.subscribeMessageDeleted()),this.addUnsubscribeFunction(this.subscribeMessageUndeleted()),this.addUnsubscribeFunction(this.subscribePaginatorStateUpdated()),this.addUnsubscribeFunction(this.subscribeConfigStateUpdated()))},this.subscribeReminderCreated=()=>this.client.on("reminder.created",i=>{if(!mt.isReminderWsEventPayload(i))return;const{reminder:n}=i;this.upsertToState({data:n})}).unsubscribe,this.subscribeReminderUpdated=()=>this.client.on("reminder.updated",i=>{if(!mt.isReminderWsEventPayload(i))return;const{reminder:n}=i;this.upsertToState({data:n})}).unsubscribe,this.subscribeReminderDeleted=()=>this.client.on("reminder.deleted",i=>{mt.isReminderWsEventPayload(i)&&this.removeFromState(i.message_id)}).unsubscribe,this.subscribeMessageDeleted=()=>this.client.on("message.deleted",i=>{var n;(n=i.message)!=null&&n.id&&this.removeFromState(i.message.id)}).unsubscribe,this.subscribeMessageUndeleted=()=>this.client.on("message.undeleted",i=>{var n;(n=i.message)!=null&&n.reminder&&this.upsertToState({data:i.message.reminder})}).unsubscribe,this.subscribeNotificationReminderDue=()=>this.client.on("notification.reminder_due",()=>null).unsubscribe,this.subscribePaginatorStateUpdated=()=>this.paginator.state.subscribeWithSelector(({items:i})=>[i],([i])=>{if(i)for(const n of i)this.upsertToState({data:n})}),this.subscribeConfigStateUpdated=()=>this.configState.subscribeWithSelector(({stopTimerRefreshBoundaryMs:i})=>({stopTimerRefreshBoundaryMs:i}),({stopTimerRefreshBoundaryMs:i},n)=>{typeof i=="number"&&i!==(n==null?void 0:n.stopTimerRefreshBoundaryMs)&&this.reminders.forEach(a=>{a.timer&&(a.timer.stopRefreshBoundaryMs=i)})}),this.upsertReminder=async i=>{const{messageId:n}=i;if(this.getFromState(n))try{return await this.updateReminder(i)}catch(a){if(jc(a))return await this.createReminder(i);throw a}else try{return await this.createReminder(i)}catch(a){if(Hc(a))return await this.updateReminder(i);throw a}},this.createReminder=async i=>{const{reminder:n}=await this.client.createReminder(i);return this.upsertToState({data:n,overwrite:!1})},this.updateReminder=async i=>{const{reminder:n}=await this.client.updateReminder(i);return this.upsertToState({data:n})},this.deleteReminder=async i=>{await this.client.deleteReminder(i),this.removeFromState(i)},this.queryNextReminders=async()=>{await this.paginator.next()},this.queryPreviousReminders=async()=>{await this.paginator.prev()},this.client=t,this.configState=new L({scheduledOffsetsMs:(s==null?void 0:s.scheduledOffsetsMs)??Yi.scheduledOffsetsMs,stopTimerRefreshBoundaryMs:(s==null?void 0:s.stopTimerRefreshBoundaryMs)??Yi.stopTimerRefreshBoundaryMs}),this.state=new L({reminders:new Map}),this.paginator=new Bc(t)}updateConfig(t){typeof t.stopTimerRefreshBoundaryMs=="number"&&t.stopTimerRefreshBoundaryMs!==this.stopTimerRefreshBoundaryMs&&this.reminders.forEach(s=>{s.timer.stopRefreshBoundaryMs=t==null?void 0:t.stopTimerRefreshBoundaryMs}),this.configState.partialNext(t)}get stopTimerRefreshBoundaryMs(){return this.configState.getLatestValue().stopTimerRefreshBoundaryMs}get scheduledOffsetsMs(){return this.configState.getLatestValue().scheduledOffsetsMs}get reminders(){return this.state.getLatestValue().reminders}getFromState(t){return this.reminders.get(t)}};cr.isReminderWsEventPayload=e=>!!e.reminder&&(e.type.startsWith("reminder.")||e.type==="notification.reminder_due");var Wc=cr;function vs(e){return typeof e=="string"||e instanceof String}var _h=class ie{constructor(t,s,i){var a;this.nextRequestAbortController=null,this._messageComposerSetupState=new L({setupFunction:null}),this._getConnectionID=()=>{var r,o;return((r=this.wsConnection)==null?void 0:r.connectionID)||((o=this.wsFallback)==null?void 0:o.connectionID)},this._hasConnectionID=()=>!!this._getConnectionID(),this.setMessageComposerSetupFunction=r=>{this._messageComposerSetupState.partialNext({setupFunction:r})},this.connectUser=async(r,o)=>{if(!r.id)throw new Error('The "id" field on the user is missing');if(this.userID===r.id&&this.setUserPromise)return console.warn("Consecutive calls to connectUser is detected, ideally you should only call this function once in your app."),this.setUserPromise;if(this.userID)throw new Error("Use client.disconnect() before trying to connect as a different user. connectUser was called twice.");(this._isUsingServerAuth()||this.node)&&!this.options.allowServerSideConnect&&console.warn('Please do not use connectUser server side. connectUser impacts MAU and concurrent connection usage and thus your bill. If you have a valid use-case, add "allowServerSideConnect: true" to the client options to disable this warning.'),this.userID=r.id,this.anonymous=!1;const l=this._setToken(r,o);this._setUser(r);const h=this.openConnection();this.setUserPromise=Promise.all([l,h]).then(c=>c[1]);try{return await this.setUserPromise}catch(c){throw this.persistUserOnConnectionFailure?this.closeConnection():this.disconnectUser(),c}},this.setUser=this.connectUser,this._setToken=(r,o)=>this.tokenManager.setTokenOrProvider(o,r),this.closeConnection=async r=>{var o,l,h;return this.cleaningIntervalRef!=null&&(clearInterval(this.cleaningIntervalRef),this.cleaningIntervalRef=void 0),await Promise.all([(o=this.wsConnection)==null?void 0:o.disconnect(r),(l=this.wsFallback)==null?void 0:l.disconnect(r)]),(h=this.offlineDb)==null||h.executeQuerySafely(async c=>{this.userID&&await c.upsertUserSyncStatus({userId:this.userID,lastSyncedAt:new Date().toString()})},{method:"upsertUserSyncStatus"}),Promise.resolve()},this.createChannelManager=({eventHandlerOverrides:r={},options:o={}})=>new Dc({client:this,eventHandlerOverrides:r,options:o}),this.openConnection=()=>{var r,o,l;if(!this.userID)throw Error("User is not set on client, use client.connectUser or client.connectAnonymousUser instead");if((r=this.wsConnection)!=null&&r.isConnecting&&this.wsPromise)return this.logger("info","client:openConnection() - connection already in progress",{tags:["connection","client"]}),this.wsPromise;if(((o=this.wsConnection)!=null&&o.isHealthy||(l=this.wsFallback)!=null&&l.isHealthy())&&this._hasConnectionID()){this.logger("info","client:openConnection() - openConnection called twice, healthy connection already exists",{tags:["connection","client"]});return}return this.clientID=`${this.userID}--${fe()}`,this.wsPromise=this.connect(),this._startCleaning(),this.wsPromise},this._setupConnection=this.openConnection,this._normalizeDate=r=>{if(r instanceof Date&&(r=r.toISOString()),r==="")throw new Error("Don't pass blank string for since, use null instead if resetting the token revoke");return r},this.disconnectUser=r=>{this.logger("info","client:disconnect() - Disconnecting the client",{tags:["connection","client"]}),delete this.user,delete this._user,delete this.userID,this.anonymous=!1;const o=this.closeConnection(r);for(const l of Object.values(this.activeChannels))l._disconnect();return this.activeChannels={},this.state=new Hi({client:this}),this.threads.resetState(),setTimeout(this.tokenManager.reset),o},this.disconnect=this.disconnectUser,this.connectAnonymousUser=()=>{(this._isUsingServerAuth()||this.node)&&!this.options.allowServerSideConnect&&console.warn('Please do not use connectUser server side. connectUser impacts MAU and concurrent connection usage and thus your bill. If you have a valid use-case, add "allowServerSideConnect: true" to the client options to disable this warning.'),this.anonymous=!0,this.userID=fe();const r={id:this.userID,anon:!0};return this._setToken(r,""),this._setUser(r),this._setupConnection()},this.setAnonymousUser=this.connectAnonymousUser,this.doAxiosRequest=async(r,o,l,h={})=>{var d;await this.tokenManager.tokenReady();const c=this._enrichAxiosOptions(h);try{let u;switch(this._logApiRequest(r,o,l,c),r){case"get":u=await this.axiosInstance.get(o,c);break;case"delete":u=await this.axiosInstance.delete(o,c);break;case"post":u=await this.axiosInstance.post(o,l,c);break;case"postForm":u=await this.axiosInstance.postForm(o,l,c);break;case"put":u=await this.axiosInstance.put(o,l,c);break;case"patch":u=await this.axiosInstance.patch(o,l,c);break;case"options":u=await this.axiosInstance.options(o,c);break;default:throw new Error("Invalid request type")}return this._logApiResponse(r,o,u),this.consecutiveFailures=0,this.handleResponse(u)}catch(u){if(u.client_request_id=(d=c.headers)==null?void 0:d["x-client-request-id"],this._logApiError(r,o,u),this.consecutiveFailures+=1,u.response)return u.response.data.code===Ae.TOKEN_EXPIRED&&!this.tokenManager.isStatic()?(this.consecutiveFailures>1&&await ee(_t(this.consecutiveFailures)),this.tokenManager.loadToken(),await this.doAxiosRequest(r,o,l,h)):this.handleResponse(u.response);throw u}},this.dispatchEvent=r=>{var c;r.received_at||(r.received_at=new Date);const o=this._handleClientEvent(r),l=r.cid,h=l?this.activeChannels[l]:void 0;h&&h._handleChannelEvent(r),this._callClientListeners(r),h&&h._callChannelListeners(r),o.forEach(d=>d()),(c=this.offlineDb)==null||c.executeQuerySafely(d=>d.handleEvent({event:r}),{method:`handleEvent;${r.type}`})},this.handleEvent=r=>{const o=r.data,l=JSON.parse(o);this.dispatchEvent(l)},this._updateMemberWatcherReferences=r=>{const o=this.state.userChannelReferences[r.id]||{};for(const l in o){const h=this.activeChannels[l];h!=null&&h.state&&(h.state.members[r.id]&&(h.state.members[r.id].user=r),h.state.watchers[r.id]&&(h.state.watchers[r.id]=r),h.state.read[r.id]&&(h.state.read[r.id].user=r))}},this._updateUserReferences=this._updateMemberWatcherReferences,this._updateUserMessageReferences=r=>{const o=this.state.userChannelReferences[r.id]||{};for(const l in o){const h=this.activeChannels[l];if(!h)continue;const c=h.state;c==null||c.updateUserMessages(r)}},this._deleteUserMessageReference=(r,o=!1)=>{const l=this.state.userChannelReferences[r.id]||{};for(const h in l){const c=this.activeChannels[h];if(c){const d=c.state;d==null||d.deleteUserMessages(r,o)}}},this._handleUserEvent=r=>{if(r.user){if(r.type==="user.presence.changed"||r.type==="user.updated"){if(r.user.id===this.userID){const o={...this.user},l={...this._user};for(const h in this.user){if(h in r.user||ro(h))continue;const c=h;delete o[c],delete l[c]}for(const h in l){const c=h;c in r.user&&(l[c]=r.user[c])}this._user=l,this.user={...o,...r.user}}this.state.updateUser(r.user),this._updateMemberWatcherReferences(r.user)}r.type==="user.updated"&&this._updateUserMessageReferences(r.user),r.type==="user.deleted"&&r.user.deleted_at&&(r.mark_messages_deleted||r.hard_delete)&&this._deleteUserMessageReference(r.user,r.hard_delete)}},this._callClientListeners=r=>{const o=this,l=[];o.listeners.all&&l.push(...o.listeners.all),o.listeners[r.type]&&l.push(...o.listeners[r.type]);for(const h of l)h(r)},this.recoverState=async()=>{this.logger("info",`client:recoverState() - Start of recoverState with connectionID ${this._getConnectionID()}`,{tags:["connection"]});const r=Object.keys(this.activeChannels);r.length&&this.recoverStateOnReconnect?(this.logger("info",`client:recoverState() - Start the querying of ${r.length} channels`,{tags:["connection","client"]}),await this.queryChannels({cid:{$in:r}},{last_message_at:-1},{limit:30}),this.logger("info","client:recoverState() - Querying channels finished",{tags:["connection","client"]}),this.dispatchEvent({type:"connection.recovered"})):this.dispatchEvent({type:"connection.recovered"}),this.wsPromise=Promise.resolve(),this.setUserPromise=Promise.resolve()},this.getChannelByMembers=(r,o)=>{const l=(o.members??[]).map(u=>typeof u=="string"?u:u.user_id??""),h=l.sort().join(","),c=Js(r,l);if(!c)throw Error("Please specify atleast one member when creating unique conversation");for(const u in this.activeChannels){const p=this.activeChannels[u];if(!p.disconnected&&(u===c||u.indexOf(`${r}:!members-`)===0&&Object.keys(p.state.members).sort().join(",")===h))return p}const d=new pe(this,r,void 0,o);return this._cacheEnabled()&&(this.activeChannels[c]=d),d},this.getChannelById=(r,o,l)=>{if(typeof o=="string"&&~o.indexOf(":"))throw Error(`Invalid channel id ${o}, can't contain the : character`);const h=`${r}:${o}`;if(h in this.activeChannels&&this.activeChannels[h]&&!this.activeChannels[h].disconnected){const d=this.activeChannels[h];return Object.keys(l).length>0&&(d.data={...d.data,...l},d._data={...d._data,...l}),d}const c=new pe(this,r,o,l);return this._cacheEnabled()&&(this.activeChannels[c.cid]=c),c},this.updateUsers=this.upsertUsers,this.updateUser=this.upsertUser,this._unblockMessage=this.unblockMessage,this.markAllRead=this.markChannelsRead,this._isUsingServerAuth=()=>!!this.secret,this._cacheEnabled=()=>!this._isUsingServerAuth()||!this.options.disableCache,this._buildWSPayload=r=>JSON.stringify({user_id:this.userID,user_details:this._user,device:this.options.device,client_request_id:r}),this.key=t,this.listeners={},this.state=new Hi({client:this}),this.mutedChannels=[],this.mutedUsers=[],this.moderation=new wc(this),this.notifications=(i==null?void 0:i.notifications)??new Oc,s&&vs(s)&&(this.secret=s);const n=i||(s&&!vs(s)?s:{});this.browser=typeof n.browser<"u"?n.browser:typeof window<"u",this.node=!this.browser,this.options={timeout:3e3,withCredentials:!1,warmUp:!1,recoverStateOnReconnect:!0,disableCache:!1,wsUrlParams:new URLSearchParams({}),...n},this.node&&!this.options.httpsAgent&&(this.options.httpsAgent=new ja.default.Agent({keepAlive:!0,keepAliveMsecs:3e3})),this.axiosInstance=Be.create(this.options),this.setBaseURL(this.options.baseURL||"https://chat.stream-io-api.com"),typeof process<"u"&&"env"in process&&is.STREAM_LOCAL_TEST_RUN&&this.setBaseURL("http://localhost:3030"),typeof process<"u"&&"env"in process&&is.STREAM_LOCAL_TEST_HOST&&this.setBaseURL("http://"+is.STREAM_LOCAL_TEST_HOST),this.wsConnection=null,this.wsPromise=null,this.setUserPromise=null,this.activeChannels={},this.configs={},this.anonymous=!1,this.persistUserOnConnectionFailure=(a=this.options)==null?void 0:a.persistUserOnConnectionFailure,this.tokenManager=new uc(this.secret),this.consecutiveFailures=0,this.insightMetrics=new ic,this.defaultWSTimeoutWithFallback=6*1e3,this.defaultWSTimeout=15*1e3,this.axiosInstance.defaults.paramsSerializer=fo,this.logger=As(n.logger)?n.logger:()=>null,this.recoverStateOnReconnect=this.options.recoverStateOnReconnect,this.threads=new vc({client:this}),this.polls=new Tc({client:this}),this.reminders=new Wc({client:this})}static getInstance(t,s,i){return ie._instance||(typeof s=="string"?ie._instance=new ie(t,s,i):ie._instance=new ie(t,s)),ie._instance}setOfflineDBApi(t){this.offlineDb||(this.offlineDb=t)}devToken(t){return hc(t)}getAuthType(){return this.anonymous?"anonymous":"jwt"}setBaseURL(t){this.baseURL=t,this.wsBaseURL=this.baseURL.replace("http","ws").replace(":3030",":8800")}_setUser(t){this.user=t,this.userID=t.id,this._user={...t}}async updateAppSettings(t){const s=t.apn_config;return s!=null&&s.p12_cert&&(t={...t,apn_config:{...s,p12_cert:Buffer.from(s.p12_cert).toString("base64")}}),await this.patch(this.baseURL+"/app",t)}async revokeTokens(t){return await this.updateAppSettings({revoke_tokens_issued_before:this._normalizeDate(t)})}async revokeUserToken(t,s){return await this.revokeUsersToken([t],s)}async revokeUsersToken(t,s){s===void 0?s=new Date().toISOString():s=this._normalizeDate(s);const i=[];for(const n of t)i.push({id:n,set:{revoke_tokens_issued_before:s}});return await this.partialUpdateUsers(i)}async getAppSettings(){return this.appSettingsPromise=this.get(this.baseURL+"/app"),await this.appSettingsPromise}async testPushSettings(t,s={}){return await this.post(this.baseURL+"/check_push",{user_id:t,...s.messageID?{message_id:s.messageID}:{},...s.apnTemplate?{apn_template:s.apnTemplate}:{},...s.firebaseTemplate?{firebase_template:s.firebaseTemplate}:{},...s.firebaseDataTemplate?{firebase_data_template:s.firebaseDataTemplate}:{},...s.skipDevices?{skip_devices:!0}:{},...s.pushProviderName?{push_provider_name:s.pushProviderName}:{},...s.pushProviderType?{push_provider_type:s.pushProviderType}:{}})}async testSQSSettings(t={}){return await this.post(this.baseURL+"/check_sqs",t)}async testSNSSettings(t={}){return await this.post(this.baseURL+"/check_sns",t)}async setGuestUser(t){let s;this.anonymous=!0;try{s=await this.post(this.baseURL+"/guest",{user:t})}catch(l){throw this.anonymous=!1,l}this.anonymous=!1;const{created_at:i,updated_at:n,last_active:a,online:r,...o}=s.user;return await this.connectUser(o,s.access_token)}createToken(t,s,i){if(this.secret==null)throw Error("tokens can only be created server-side using the API Secret");const n={};return s&&(n.exp=s),i&&(n.iat=i),ar(this.secret,t,n,{})}on(t,s){const i=s?t:"all",n=s||t;return i in this.listeners||(this.listeners[i]=[]),this.logger("info",`Attaching listener for ${i} event`,{tags:["event","client"]}),this.listeners[i].push(n),{unsubscribe:()=>{this.logger("info",`Removing listener for ${i} event`,{tags:["event","client"]}),this.listeners[i]=this.listeners[i].filter(a=>a!==n)}}}off(t,s){const i=s?t:"all",n=s||t;i in this.listeners||(this.listeners[i]=[]),this.logger("info",`Removing listener for ${i} event`,{tags:["event","client"]}),this.listeners[i]=this.listeners[i].filter(a=>a!==n)}_logApiRequest(t,s,i,n){this.logger("info",`client: ${t} - Request - ${s}`,{tags:["api","api_request","client"],url:s,payload:i,config:n})}_logApiResponse(t,s,i){this.logger("info",`client:${t} - Response - url: ${s} > status ${i.status}`,{tags:["api","api_response","client"],url:s,response:i})}_logApiError(t,s,i){this.logger("error",`client:${t} - Error - url: ${s}`,{tags:["api","api_response","client"],url:s,error:i})}get(t,s){return this.doAxiosRequest("get",t,null,{params:s})}put(t,s){return this.doAxiosRequest("put",t,s)}post(t,s){return this.doAxiosRequest("post",t,s)}patch(t,s){return this.doAxiosRequest("patch",t,s)}delete(t,s){return this.doAxiosRequest("delete",t,null,{params:s})}sendFile(t,s,i,n,a){const r=ao(s,i,n||"multipart/form-data");return a!=null&&r.append("user",JSON.stringify(a)),this.doAxiosRequest("postForm",t,r,{headers:r.getHeaders?r.getHeaders():{},config:{timeout:0,maxContentLength:1/0,maxBodyLength:1/0}})}errorFromResponse(t){const s=typeof t.data.code<"u"?`StreamChat error code ${t.data.code}: ${t.data.message}`:`StreamChat error HTTP code: ${t.status}`;return new gl(s,{code:t.data.code??null,response:t,status:t.status})}handleResponse(t){const s=t.data;if(yc(t))throw this.errorFromResponse(t);return s}_handleClientEvent(t){var n,a,r;const s=this,i=[];if(this.logger("info",`client:_handleClientEvent - Received event of type { ${t.type} }`,{tags:["event","client"],event:t}),(t.type==="user.presence.changed"||t.type==="user.updated"||t.type==="user.deleted")&&this._handleUserEvent(t),t.type==="health.check"&&t.me&&(s.user=t.me,s.state.updateUser(t.me),s.mutedChannels=t.me.channel_mutes,s.mutedUsers=t.me.mutes),t.channel&&t.type==="notification.message_new"){const{channel:o}=t;this._addChannelConfig(o)}if(t.type==="notification.channel_mutes_updated"&&((n=t.me)!=null&&n.channel_mutes)&&(this.mutedChannels=t.me.channel_mutes),t.type==="notification.mutes_updated"&&((a=t.me)!=null&&a.mutes)&&(this.mutedUsers=t.me.mutes),t.type==="notification.mark_read"&&t.unread_channels===0&&Object.keys(this.activeChannels).forEach(l=>this.activeChannels[l].state.unreadCount=0),(t.type==="channel.deleted"||t.type==="notification.channel_deleted")&&t.cid){const{cid:o}=t;s.state.deleteAllChannelReference(o),(r=this.activeChannels[t.cid])==null||r._disconnect(),i.push(()=>{o&&delete this.activeChannels[o]})}return i}_muteStatus(t){var i;let s;for(let n=0;n<this.mutedChannels.length;n++){const a=this.mutedChannels[n];if(((i=a.channel)==null?void 0:i.cid)===t){s={muted:a.expires?new Date(a.expires).getTime()>new Date().getTime():!0,createdAt:a.created_at?new Date(a.created_at):new Date,expiresAt:a.expires?new Date(a.expires):null};break}}return s||{muted:!1,createdAt:null,expiresAt:null}}async connect(){if(!this.userID||!this._user)throw Error("Call connectUser or connectAnonymousUser before starting the connection");if(!this.wsBaseURL)throw Error("Websocket base url not set");if(!this.clientID)throw Error("clientID is not set");!this.wsConnection&&(this.options.warmUp||this.options.enableInsights)&&this._sayHi(),this.options.wsConnection&&this.node?(this.options.wsConnection.setClient(this),this.wsConnection=this.options.wsConnection):this.wsConnection=new lc({client:this});try{return this.wsFallback?await this.wsFallback.connect():await this.wsConnection.connect(this.options.enableWSFallback?this.defaultWSTimeoutWithFallback:this.defaultWSTimeout)}catch(t){if(this.options.enableWSFallback&&mc(t)&&uo())return this.logger("info","client:connect() - WS failed, fallback to longpoll",{tags:["connection","client"]}),this.dispatchEvent({type:"transport.changed",mode:"longpoll"}),this.wsConnection._destroyCurrentWSConnection(),this.wsConnection.disconnect().then(),this.wsFallback=new _c({client:this}),await this.wsFallback.connect();throw t}}_sayHi(){const t=fe(),s={headers:{"x-client-request-id":t}};this.doAxiosRequest("get",this.baseURL+"/hi",null,s).catch(i=>{this.options.enableInsights&&Le("http_hi_failed",{api_key:this.key,err:i,client_request_id:t})})}async queryUsers(t,s=[],i={}){const n={presence:!1};await this.wsPromise,this._hasConnectionID()||(n.presence=!1);const a=await this.get(this.baseURL+"/users",{payload:{filter_conditions:t,sort:I(s),...n,...i}});return this.state.updateUsers(a.users),a}async queryBannedUsers(t={},s=[],i={}){return await this.get(this.baseURL+"/query_banned_users",{payload:{filter_conditions:t,sort:I(s),...i}})}async queryMessageFlags(t={},s={}){return await this.get(this.baseURL+"/moderation/flags/message",{payload:{filter_conditions:t,...s}})}async queryChannelsRequest(t,s=[],i={}){const n={state:!0,watch:!0,presence:!1};await this.wsPromise,this._hasConnectionID()||(n.watch=!1);const a={filter_conditions:t,sort:I(s),...n,...i};return(await this.post(this.baseURL+"/channels",a)).channels}async queryChannels(t,s=[],i={},n={}){var r;const a=await this.queryChannelsRequest(t,s,i);return this.dispatchEvent({type:"channels.queried",queriedChannels:{channels:a,isLatestMessageSet:!0}}),a!=null&&a.length&&((r=this.offlineDb)!=null&&r.upsertChannels)&&await this.offlineDb.upsertChannels({channels:a,isLatestMessagesSet:!0}),this.hydrateActiveChannels(a,n,i)}async queryReactions(t,s,i=[],n={}){var r;const a={filter:s,sort:I(i),...n};if((r=this.offlineDb)!=null&&r.getReactions&&!n.next)try{const o=await this.offlineDb.getReactions({messageId:t,filters:s,sort:i,limit:n.limit});o&&this.dispatchEvent({type:"offline_reactions.queried",offlineReactions:o})}catch(o){this.logger("warn","An error has occurred while querying offline reactions",{error:o})}return await this.wsPromise,await this.post(this.baseURL+"/messages/"+encodeURIComponent(t)+"/reactions",a)}hydrateActiveChannels(t=[],s={},i){const{skipInitialization:n,offlineMode:a=!1}=s,r=[];for(const o of t){this._addChannelConfig(o.channel);const l=this.channel(o.channel.type,o.channel.id);l.data=o.channel,l.offlineMode=a,l.initialized=!a,l.push_preferences=o.push_preferences;let h;if(n===void 0){const{messageSet:c}=l._initializeState(o,"latest");h=c}else if(!n.includes(o.channel.id)){l.state.clearMessages();const{messageSet:c}=l._initializeState(o,"latest");h=c}h&&(h.pagination={...h.pagination,...In({parentSet:h,requestedPageSize:(i==null?void 0:i.message_limit)||za,returnedPage:o.messages,logger:this.logger})},this.polls.hydratePollCache(o.messages,!0),this.reminders.hydrateState(o.messages)),l.messageComposer.initStateFromChannelResponse(o),r.push(l)}return r}async search(t,s,i={}){if(i.offset&&i.next)throw Error("Cannot specify offset with next");const n={filter_conditions:t,...i,sort:i.sort?I(i.sort):void 0};if(typeof s=="string")n.query=s;else if(typeof s=="object")n.message_filter_conditions=s;else throw Error(`Invalid type ${typeof s} for query parameter`);return await this.wsPromise,await this.get(this.baseURL+"/search",{payload:n})}setLocalDevice(t){var s,i,n;if((s=this.wsConnection)!=null&&s.isConnecting&&this.wsPromise||((i=this.wsConnection)!=null&&i.isHealthy||(n=this.wsFallback)!=null&&n.isHealthy())&&this._hasConnectionID())throw new Error("you can only set device before opening a websocket connection");this.options.device=t}async addDevice(t,s,i,n){return await this.post(this.baseURL+"/devices",{id:t,push_provider:s,...i!=null?{user_id:i}:{},...n!=null?{push_provider_name:n}:{}})}async getDevices(t){return await this.get(this.baseURL+"/devices",t?{user_id:t}:{})}async getUnreadCount(t){return await this.get(this.baseURL+"/unread",t?{user_id:t}:{})}async getUnreadCountBatch(t){return await this.post(this.baseURL+"/unread_batch",{user_ids:t})}async setPushPreferences(t){return await this.post(this.baseURL+"/push_preferences",{preferences:t})}async removeDevice(t,s){return await this.delete(this.baseURL+"/devices",{id:t,...s?{user_id:s}:{}})}getRateLimits(t){const{serverSide:s,web:i,android:n,ios:a,endpoints:r}=t||{};return this.get(this.baseURL+"/rate_limits",{server_side:s,web:i,android:n,ios:a,endpoints:r?r.join(","):void 0})}_addChannelConfig({cid:t,config:s}){this._cacheEnabled()&&(this.configs[t]=s)}channel(t,s,i={}){var n;if(!this.userID&&!this._isUsingServerAuth())throw Error("Call connectUser or connectAnonymousUser before creating a channel");if(~t.indexOf(":"))throw new Error(`Invalid channel group ${t}, can't contain the : character`);return s&&typeof s=="object"?this.getChannelByMembers(t,s):!s&&typeof i=="object"&&((n=i.members)!=null&&n.length)?this.getChannelByMembers(t,i):s?this.getChannelById(t,s,i):new pe(this,t,void 0,i)}async partialUpdateUser(t){return await this.partialUpdateUsers([t])}async upsertUsers(t){const s={};for(const i of t){if(!i.id)throw Error("User ID is required when updating a user");s[i.id]=i}return await this.post(this.baseURL+"/users",{users:s})}upsertUser(t){return this.upsertUsers([t])}async partialUpdateUsers(t){for(const s of t)if(!s.id)throw Error("User ID is required when updating a user");return await this.patch(this.baseURL+"/users",{users:t})}async deleteUser(t,s){return await this.delete(this.baseURL+`/users/${encodeURIComponent(t)}`,s)}async restoreUsers(t){return await this.post(this.baseURL+"/users/restore",{user_ids:t})}async reactivateUser(t,s){return await this.post(this.baseURL+`/users/${encodeURIComponent(t)}/reactivate`,{...s})}async reactivateUsers(t,s){return await this.post(this.baseURL+"/users/reactivate",{user_ids:t,...s})}async deactivateUser(t,s){return await this.post(this.baseURL+`/users/${encodeURIComponent(t)}/deactivate`,{...s})}async deactivateUsers(t,s){return await this.post(this.baseURL+"/users/deactivate",{user_ids:t,...s})}async exportUser(t,s){return await this.get(this.baseURL+`/users/${encodeURIComponent(t)}/export`,{...s})}async banUser(t,s){return await this.post(this.baseURL+"/moderation/ban",{target_user_id:t,...s})}async unbanUser(t,s){return await this.delete(this.baseURL+"/moderation/ban",{target_user_id:t,...s})}async shadowBan(t,s){return await this.banUser(t,{shadow:!0,...s})}async removeShadowBan(t,s){return await this.unbanUser(t,{shadow:!0,...s})}async blockUser(t,s){return await this.post(this.baseURL+"/users/block",{blocked_user_id:t,...s?{user_id:s}:{}})}async getBlockedUsers(t){return await this.get(this.baseURL+"/users/block",{...t?{user_id:t}:{}})}async unBlockUser(t,s){return await this.post(this.baseURL+"/users/unblock",{blocked_user_id:t,...s?{user_id:s}:{}})}async getSharedLocations(){return await this.get(this.baseURL+"/users/live_locations")}async muteUser(t,s,i={}){return await this.post(this.baseURL+"/moderation/mute",{target_id:t,...s?{user_id:s}:{},...i})}async unmuteUser(t,s){return await this.post(this.baseURL+"/moderation/unmute",{target_id:t,...s?{user_id:s}:{}})}userMuteStatus(t){if(!this.user||!this.wsPromise)throw new Error("Make sure to await connectUser() first.");for(let s=0;s<this.mutedUsers.length;s+=1)if(this.mutedUsers[s].target.id===t)return!0;return!1}async flagMessage(t,s={}){return await this.post(this.baseURL+"/moderation/flag",{target_message_id:t,...s})}async flagUser(t,s={}){return await this.post(this.baseURL+"/moderation/flag",{target_user_id:t,...s})}async unflagMessage(t,s={}){return await this.post(this.baseURL+"/moderation/unflag",{target_message_id:t,...s})}async unflagUser(t,s={}){return await this.post(this.baseURL+"/moderation/unflag",{target_user_id:t,...s})}async _queryFlags(t={},s={}){return await this.post(this.baseURL+"/moderation/flags",{filter_conditions:t,...s})}async _queryFlagReports(t={},s={}){return await this.post(this.baseURL+"/moderation/reports",{filter_conditions:t,...s})}async _reviewFlagReport(t,s,i={}){return await this.patch(this.baseURL+`/moderation/reports/${encodeURIComponent(t)}`,{review_result:s,...i})}async unblockMessage(t,s={}){return await this.post(this.baseURL+"/moderation/unblock_message",{target_message_id:t,...s})}async markChannelsRead(t={}){await this.post(this.baseURL+"/channels/read",{...t})}createCommand(t){return this.post(this.baseURL+"/commands",t)}getCommand(t){return this.get(this.baseURL+`/commands/${encodeURIComponent(t)}`)}updateCommand(t,s){return this.put(this.baseURL+`/commands/${encodeURIComponent(t)}`,s)}deleteCommand(t){return this.delete(this.baseURL+`/commands/${encodeURIComponent(t)}`)}listCommands(){return this.get(this.baseURL+"/commands")}createChannelType(t){const s=Object.assign({},{commands:["all"]},t);return this.post(this.baseURL+"/channeltypes",s)}getChannelType(t){return this.get(this.baseURL+`/channeltypes/${encodeURIComponent(t)}`)}updateChannelType(t,s){return this.put(this.baseURL+`/channeltypes/${encodeURIComponent(t)}`,s)}deleteChannelType(t){return this.delete(this.baseURL+`/channeltypes/${encodeURIComponent(t)}`)}listChannelTypes(){return this.get(this.baseURL+"/channeltypes")}async translateMessage(t,s){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/translate`,{language:s})}async translate(t,s,i){return await this.post(this.baseURL+"/translate",{text:t,source_language:i,destination_language:s})}_normalizeExpiration(t){let s=null;if(typeof t=="number"){const i=new Date;i.setSeconds(i.getSeconds()+t),s=i.toISOString()}else vs(t)?s=t:t instanceof Date&&(s=t.toISOString());return s}_validateAndGetMessageId(t,s){let i;if(typeof t=="string")i=t;else{if(!t.id)throw Error(s);i=t.id}return i}pinMessage(t,s,i,n){const a=this._validateAndGetMessageId(t,"Please specify the message id when calling unpinMessage");return this.partialUpdateMessage(a,{set:{pinned:!0,pin_expires:this._normalizeExpiration(s),pinned_at:this._normalizeExpiration(n)}},i)}unpinMessage(t,s){const i=this._validateAndGetMessageId(t,"Please specify the message id when calling unpinMessage");return this.partialUpdateMessage(i,{set:{pinned:!1}},s)}async updateMessage(t,s,i){if(!t.id)throw Error("Please specify the message.id when calling updateMessage");const n=An(t);return typeof s=="string"?n.user_id=s:typeof(s==null?void 0:s.id)=="string"&&(n.user_id=s.id),await this.post(this.baseURL+`/messages/${encodeURIComponent(t.id)}`,{message:n,...i})}async partialUpdateMessage(t,s,i,n){if(!t)throw Error("Please specify the message.id when calling partialUpdateMessage");let a;return typeof i=="string"?a={id:i}:typeof(i==null?void 0:i.id)=="string"&&(a={id:i.id}),await this.put(this.baseURL+`/messages/${encodeURIComponent(t)}`,{...s,...n,user:a})}async deleteMessage(t,s){try{if(this.offlineDb)return s?await this.offlineDb.hardDeleteMessage({id:t}):await this.offlineDb.softDeleteMessage({id:t}),await this.offlineDb.queueTask({task:{messageId:t,payload:[t,s],type:"delete-message"}})}catch(i){this.logger("error","offlineDb:deleteMessage",{tags:["channel","offlineDb"],error:i})}return this._deleteMessage(t,s)}async _deleteMessage(t,s){let i={};return s&&(i={hard:!0}),await this.delete(this.baseURL+`/messages/${encodeURIComponent(t)}`,i)}async undeleteMessage(t,s){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/undelete`,{undeleted_by:s})}async getMessage(t,s){return await this.get(this.baseURL+`/messages/${encodeURIComponent(t)}`,{...s})}async queryThreads(t={}){const s={limit:10,participant_limit:10,reply_limit:3,watch:!0,...t},i={...s};s.filter&&Object.keys(s.filter).length>0&&(i.filter=s.filter),s.sort&&(Array.isArray(s.sort)?s.sort.length>0:Object.keys(s.sort).length>0)&&(i.sort=I(s.sort));const n=await this.post(`${this.baseURL}/threads`,i);return{threads:n.threads.map(a=>new Fe({client:this,threadData:a})),next:n.next}}async getThread(t,s={}){if(!t)throw new Error("Please specify the messageId when calling getThread");const i={participant_limit:100,reply_limit:3,watch:!0,...s},n=await this.get(`${this.baseURL}/threads/${encodeURIComponent(t)}`,i);return new Fe({client:this,threadData:n.thread})}async partialUpdateThread(t,s){if(!t)throw Error("Please specify the message id when calling partialUpdateThread");const i=["created_at","id","last_message_at","type","updated_at","user","reply_count","participants","channel","custom"];for(const n in{...s.set,...s.unset})if(i.includes(n))throw Error(`You cannot set ${n} field on Thread object. ${n} is reserved for server-side use. Please omit ${n} from your set object.`);return await this.patch(`${this.baseURL}/threads/${encodeURIComponent(t)}`,s)}getUserAgent(){if(this.userAgent)return this.userAgent;const t="9.10.0",s="browser-esm";let i="";this.sdkIdentifier?i=`stream-chat-${this.sdkIdentifier.name}-v${this.sdkIdentifier.version}-llc-v${t}`:i=`stream-chat-js-v${t}-${this.node?"node":"browser"}`;const{os:n,model:a}=this.deviceIdentifier??{};return[["os",n],["device_model",a],["client_bundle",s]].reduce((r,[o,l])=>l&&l.length>0?r.concat(`|${o}=${l}`):r,i)}setUserAgent(t){this.userAgent=t}_enrichAxiosOptions(t={params:{},headers:{},config:{}}){var l;const s=this._getToken(),i=s?{Authorization:s}:void 0;let n=null;this.nextRequestAbortController!==null&&(n=this.nextRequestAbortController.signal,this.nextRequestAbortController=null),(l=t.headers)!=null&&l["x-client-request-id"]||(t.headers={...t.headers,"x-client-request-id":fe()});const{params:a,headers:r,...o}=this.options.axiosRequestConfig||{};return{params:{user_id:this.userID,connection_id:this._getConnectionID(),api_key:this.key,...t.params,...a||{}},headers:{...i,"stream-auth-type":this.getAuthType(),"X-Stream-Client":this.getUserAgent(),...t.headers,...r||{}},...n?{signal:n}:{},...t.config,...o||{}}}_getToken(){return!this.tokenManager||this.anonymous?null:this.tokenManager.getToken()}_startCleaning(){const t=this;this.cleaningIntervalRef==null&&(this.cleaningIntervalRef=setInterval(()=>{for(const s of Object.values(t.activeChannels))s.clean()},500))}verifyWebhook(t,s){return!!this.secret&&dc(t,this.secret,s)}getPermission(t){return this.get(`${this.baseURL}/permissions/${encodeURIComponent(t)}`)}createPermission(t){return this.post(`${this.baseURL}/permissions`,{...t})}updatePermission(t,s){return this.put(`${this.baseURL}/permissions/${encodeURIComponent(t)}`,{...s})}deletePermission(t){return this.delete(`${this.baseURL}/permissions/${encodeURIComponent(t)}`)}listPermissions(){return this.get(`${this.baseURL}/permissions`)}createRole(t){return this.post(`${this.baseURL}/roles`,{name:t})}listRoles(){return this.get(`${this.baseURL}/roles`)}deleteRole(t){return this.delete(`${this.baseURL}/roles/${encodeURIComponent(t)}`)}sync(t,s,i={}){return this.post(`${this.baseURL}/sync`,{channel_cids:t,last_sync_at:s,...i})}async sendUserCustomEvent(t,s){return await this.post(`${this.baseURL}/users/${encodeURIComponent(t)}/event`,{event:s})}createBlockList(t){return this.post(`${this.baseURL}/blocklists`,t)}listBlockLists(t){return this.get(`${this.baseURL}/blocklists`,t)}getBlockList(t,s){return this.get(`${this.baseURL}/blocklists/${encodeURIComponent(t)}`,s)}updateBlockList(t,s){return this.put(`${this.baseURL}/blocklists/${encodeURIComponent(t)}`,s)}deleteBlockList(t,s){return this.delete(`${this.baseURL}/blocklists/${encodeURIComponent(t)}`,s)}exportChannels(t,s={}){const i={channels:t,...s};return this.post(`${this.baseURL}/export_channels`,i)}exportUsers(t){return this.post(`${this.baseURL}/export/users`,t)}exportChannel(t,s){return this.exportChannels([t],s)}getExportChannelStatus(t){return this.get(`${this.baseURL}/export_channels/${encodeURIComponent(t)}`)}campaign(t,s){return t&&typeof t=="object"?new ui(this,null,t):new ui(this,t,s)}segment(t,s,i){return typeof s=="string"?new Qi(this,t,s,i):new Qi(this,t,null,s)}validateServerSideAuth(){if(!this.secret)throw new Error("Campaigns is a server-side only feature. Please initialize the client with a secret to use this feature.")}createSegment(t,s,i){this.validateServerSideAuth();const n={id:s,type:t,...i};return this.post(this.baseURL+"/segments",n)}createUserSegment(t,s){return this.validateServerSideAuth(),this.createSegment("user",t,s)}createChannelSegment(t,s){return this.validateServerSideAuth(),this.createSegment("channel",t,s)}getSegment(t){return this.validateServerSideAuth(),this.get(this.baseURL+`/segments/${encodeURIComponent(t)}`)}updateSegment(t,s){return this.validateServerSideAuth(),this.put(this.baseURL+`/segments/${encodeURIComponent(t)}`,s)}addSegmentTargets(t,s){this.validateServerSideAuth();const i={target_ids:s};return this.post(this.baseURL+`/segments/${encodeURIComponent(t)}/addtargets`,i)}querySegmentTargets(t,s={},i=[],n={}){return this.validateServerSideAuth(),this.post(this.baseURL+`/segments/${encodeURIComponent(t)}/targets/query`,{filter:s||{},sort:i||[],...n})}removeSegmentTargets(t,s){this.validateServerSideAuth();const i={target_ids:s};return this.post(this.baseURL+`/segments/${encodeURIComponent(t)}/deletetargets`,i)}querySegments(t,s,i={}){return this.validateServerSideAuth(),this.post(this.baseURL+"/segments/query",{filter:t,sort:s,...i})}deleteSegment(t){return this.validateServerSideAuth(),this.delete(this.baseURL+`/segments/${encodeURIComponent(t)}`)}segmentTargetExists(t,s){return this.validateServerSideAuth(),this.get(this.baseURL+`/segments/${encodeURIComponent(t)}/target/${encodeURIComponent(s)}`)}createCampaign(t){return this.validateServerSideAuth(),this.post(this.baseURL+"/campaigns",{...t})}getCampaign(t,s){return this.validateServerSideAuth(),this.get(this.baseURL+`/campaigns/${encodeURIComponent(t)}`,{...s==null?void 0:s.users})}startCampaign(t,s){return this.validateServerSideAuth(),this.post(this.baseURL+`/campaigns/${encodeURIComponent(t)}/start`,{scheduled_for:s==null?void 0:s.scheduledFor,stop_at:s==null?void 0:s.stopAt})}async queryCampaigns(t,s,i){return this.validateServerSideAuth(),await this.post(this.baseURL+"/campaigns/query",{filter:t,sort:s,...i||{}})}updateCampaign(t,s){return this.validateServerSideAuth(),this.put(this.baseURL+`/campaigns/${encodeURIComponent(t)}`,s)}deleteCampaign(t){return this.validateServerSideAuth(),this.delete(this.baseURL+`/campaigns/${encodeURIComponent(t)}`)}stopCampaign(t){return this.validateServerSideAuth(),this.post(this.baseURL+`/campaigns/${encodeURIComponent(t)}/stop`)}enrichURL(t){return this.get(this.baseURL+"/og",{url:t})}getTask(t){return this.get(`${this.baseURL}/tasks/${encodeURIComponent(t)}`)}async deleteChannels(t,s={}){return await this.post(this.baseURL+"/channels/delete",{cids:t,...s})}async deleteUsers(t,s={}){if(typeof s.user<"u"&&!["soft","hard","pruning"].includes(s.user))throw new Error("Invalid delete user options. user must be one of [soft hard pruning]");if(typeof s.conversations<"u"&&!["soft","hard"].includes(s.conversations))throw new Error("Invalid delete user options. conversations must be one of [soft hard]");if(typeof s.messages<"u"&&!["soft","hard","pruning"].includes(s.messages))throw new Error("Invalid delete user options. messages must be one of [soft hard pruning]");return await this.post(this.baseURL+"/users/delete",{user_ids:t,...s})}async _createImportURL(t){return await this.post(this.baseURL+"/import_urls",{filename:t})}async _createImport(t,s={mode:"upsert"}){return await this.post(this.baseURL+"/imports",{path:t,...s})}async _getImport(t){return await this.get(this.baseURL+`/imports/${encodeURIComponent(t)}`)}async _listImports(t){return await this.get(this.baseURL+"/imports",t)}async upsertPushProvider(t){return await this.post(this.baseURL+"/push_providers",{push_provider:t})}async deletePushProvider({type:t,name:s}){return await this.delete(this.baseURL+`/push_providers/${encodeURIComponent(t)}/${encodeURIComponent(s)}`)}async listPushProviders(){return await this.get(this.baseURL+"/push_providers")}createAbortControllerForNextRequest(){return this.nextRequestAbortController=new AbortController}async commitMessage(t){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/commit`)}async createPoll(t,s){return await this.post(this.baseURL+"/polls",{...t,...s?{user_id:s}:{}})}async getPoll(t,s){return await this.get(this.baseURL+`/polls/${encodeURIComponent(t)}`,s?{user_id:s}:{})}async updatePoll(t,s){return await this.put(this.baseURL+"/polls",{...t,...s?{user_id:s}:{}})}async partialUpdatePoll(t,s,i){return await this.patch(this.baseURL+`/polls/${encodeURIComponent(t)}`,{...s,...i?{user_id:i}:{}})}async deletePoll(t,s){return await this.delete(this.baseURL+`/polls/${encodeURIComponent(t)}`,{...s?{user_id:s}:{}})}closePoll(t,s){return this.partialUpdatePoll(t,{set:{is_closed:!0}},s)}async createPollOption(t,s,i){return await this.post(this.baseURL+`/polls/${encodeURIComponent(t)}/options`,{...s,...i?{user_id:i}:{}})}async getPollOption(t,s,i){return await this.get(this.baseURL+`/polls/${encodeURIComponent(t)}/options/${encodeURIComponent(s)}`,i?{user_id:i}:{})}async updatePollOption(t,s,i){return await this.put(this.baseURL+`/polls/${encodeURIComponent(t)}/options`,{...s,...i?{user_id:i}:{}})}async deletePollOption(t,s,i){return await this.delete(this.baseURL+`/polls/${encodeURIComponent(t)}/options/${encodeURIComponent(s)}`,i?{user_id:i}:{})}async castPollVote(t,s,i,n){return await this.post(this.baseURL+`/messages/${encodeURIComponent(t)}/polls/${encodeURIComponent(s)}/vote`,{vote:i,...n?{user_id:n}:{}})}addPollAnswer(t,s,i,n){return this.castPollVote(t,s,{answer_text:i},n)}async removePollVote(t,s,i,n){return await this.delete(this.baseURL+`/messages/${encodeURIComponent(t)}/polls/${encodeURIComponent(s)}/vote/${encodeURIComponent(i)}`,{...n?{user_id:n}:{}})}async queryPolls(t={},s=[],i={},n){const a=n?`?user_id=${n}`:"";return await this.post(this.baseURL+`/polls/query${a}`,{filter:t,sort:I(s),...i})}async queryPollVotes(t,s={},i=[],n={},a){const r=a?`?user_id=${a}`:"";return await this.post(this.baseURL+`/polls/${encodeURIComponent(t)}/votes${r}`,{filter:s,sort:I(i),...n})}async queryPollAnswers(t,s={},i=[],n={},a){const r=a?`?user_id=${a}`:"";return await this.post(this.baseURL+`/polls/${encodeURIComponent(t)}/votes${r}`,{filter:{...s,is_answer:!0},sort:I(i),...n})}async queryMessageHistory(t={},s=[],i={}){return await this.post(this.baseURL+"/messages/history",{filter:t,sort:I(s),...i})}async updateFlags(t,s,i={}){return await this.post(this.baseURL+"/automod/v1/moderation/update_flags",{message_ids:t,reviewed_by:s,...i})}async queryDrafts(t={}){const s={...t,sort:t.sort?I(t.sort):void 0};return await this.post(this.baseURL+"/drafts/query",s)}async createReminder({messageId:t,...s}){return await this.post(`${this.baseURL}/messages/${t}/reminders`,s)}async updateReminder({messageId:t,...s}){return await this.patch(`${this.baseURL}/messages/${t}/reminders`,s)}async deleteReminder(t,s){return await this.delete(`${this.baseURL}/messages/${t}/reminders`,s?{user_id:s}:{})}async queryReminders({filter:t,sort:s,...i}={}){return await this.post(`${this.baseURL}/reminders/query`,{filter_conditions:t,sort:s&&I(s),...i})}async updateLocation(t){return await this.put(this.baseURL+"/users/live_locations",t)}uploadFile(t,s,i,n){return this.sendFile(`${this.baseURL}/uploads/file`,t,s,i,n)}uploadImage(t,s,i,n){return this.sendFile(`${this.baseURL}/uploads/image`,t,s,i,n)}deleteFile(t){return this.delete(`${this.baseURL}/uploads/file`,{url:t})}deleteImage(t){return this.delete(`${this.baseURL}/uploads/image`,{url:t})}},wh=class{constructor(e,t){if(!e)throw new Error("Size must be greater than 0");this.keys=[],this.size=e,this.map=new Map,this.dispose=(t==null?void 0:t.dispose)??null}add(e,t){var i;if(this.keys.indexOf(e)>-1)this.keys.splice(this.keys.indexOf(e),1);else if(this.keys.length>=this.size){const n=this.keys.shift();if(n){const a=this.peek(n);a&&((i=this.dispose)==null||i.call(this,n,a)),this.map.delete(n)}}this.keys.push(e),this.map.set(e,t)}peek(e){return this.map.get(e)}get(e){const t=this.peek(e);return t&&this.keys.indexOf(e)!==this.size-1&&(this.keys.splice(this.keys.indexOf(e),1),this.keys.push(e)),t}};export{mh as C,wh as F,ri as L,zt as M,L as S,gh as U,ml as V,ch as a,Eo as b,uh as c,dh as d,fh as e,P as f,xo as g,hh as h,se as i,we as j,Nn as k,qn as l,Fn as m,$n as n,kn as o,lh as p,ph as q,yh as r,_h as s};
